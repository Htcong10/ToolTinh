using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data;
using busLogManagement;
using CMISLibrary;

namespace busBillingCalculation
{
    public class clsDetailDataCalculation
    {


        //Tinh san luong chi tiet theo toan bo cac bo chi so cua diem do
        public string DetailDataCalculation_11(DataSet dsCustomerData, ref DS_CALCULATIONTABLES dsCalculation, DataSet dsStaticCatalog)
        {
            try
            {
                string strMa_DDo = "";
                DataRow[] rows;
                DataRow drSan_Luong;
                Decimal sl = 0, so_ngaydmuc = 0;
                Decimal id_chiso = 0, IsNew = 0; //Kiem tra co phai diem do treo moi hay khong
                DateTime ngay_dau, ngay_cuoi;
                //Tinh so ngay dinh muc
                DateTime ngay_dkymin, ngay_ckymax;
                int thangDM_min = 0, thangDM_max, namDM_min = 0, namDM_max = 0, thangDM = 0, namDM = 0;
                //Khai bao bien phuc vu cho kiem tra doi gia
                DataRowView drwCS = null;
                Decimal IsChangePrice = 0;
                string strBCS = "", strBCS_Old = "", strMa_DDo_Old = "";
                Decimal sl_ss = 0;
                Decimal id_chiso_ss = 0; //Kiem tra co phai diem do treo moi hay khong
                DateTime ngay_dau_ss, ngay_cuoi_ss;
                DateTime ngay_hluc;
                DateTime ngay_CKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_CKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_DKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_DKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                string strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";
                DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                dwGia.Sort = "NGAY_HLUC";

                DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";
                //Ket thuc
                //Day du lieu vao bang SL_1
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_1") == false)
                    return "NotExistsSL_1";

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull";
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                    return "NotExistsGCS_CHISO";
                ngay_dau = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                ngay_dau_ss = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cuoi_ss = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));

                #region Cac diem do chinh ghep tong, cac diem do khong co quan he ghep tong
                //Lay du lieu tu bang GCS_CHISO vao SAN_LUONG
                foreach (DataRow drDDo in dsCustomerData.Tables["HDG_DIEM_DO"].Rows)
                {
                    //Kiem tra co doi gia nha nuoc khong
                    IsChangePrice = 0;
                    strMa_DDo = drDDo["MA_DDO"].ToString().Trim();
                    if (strMa_DDo == "PD06000076251001")
                    {
                    }
                    ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_dkymin = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                    {
                        ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                        ngay_dkymin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                    }
                    else
                    {
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                            {
                                ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                ngay_dkymin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            }
                            else
                            {
                                //Co diem do nhung ko co chi so, ko tinh
                                continue;
                            }
                        }
                        else
                        {
                            //Co diem do nhung ko co chi so, ko tinh
                            continue;
                        }
                    }
                    dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                    foreach (DataRowView drwGia in dwGia)
                    {

                        strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                        strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                        strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                        strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                        strKhoang_DAp = "";

                        //Tim khoang tham chieu cap dien ap
                        dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                        foreach (DataRowView drCapDA in dwTChieuDA)
                        {
                            ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                            {
                                if (ngay_ckymax == ngay_hluc)
                                {
                                    //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                    //se tinh toan bo vao bac thang cua bang gia cu
                                    continue;
                                }
                            }

                            if (ngay_ckymax >= ngay_hluc)
                            {
                                strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                break;
                            }
                        }

                        if (strKhoang_DAp != "")
                        {
                            dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                            foreach (DataRowView drGia in dwGiaNhomNN)
                            {
                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                {
                                    if (ngay_ckymax == ngay_hluc)
                                    {
                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                        //se tinh toan bo vao bac thang cua bang gia cu
                                        continue;
                                    }
                                }

                                if (ngay_ckymax >= ngay_hluc && ngay_dkymin < ngay_hluc)
                                {
                                    //Co doi gia
                                    IsChangePrice = 1;
                                    break;
                                }
                            }
                        }

                        if (IsChangePrice == 1)
                        {
                            break;
                        }
                    }

                    //Bo sung 22/12/2012: neu co dong CCS tuong duong voi doi gia, se phai tach ra thanh 2 khoang
                    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length != 0)
                    {
                        IsChangePrice = 1;
                    }

                    if (IsChangePrice == 1)
                    {
                        //Co doi gia

                        DataView dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO<>'DUP'";
                        foreach (DataRowView drw in dwCS)
                        {
                            //strMa_DDo = Convert.ToString(drw["MA_DDO"]);
                            strBCS = Convert.ToString(drw["BCS"]);
                            ngay_CKy = Convert.ToDateTime(drw["NGAY_CKY"]);
                            ngay_DKy = Convert.ToDateTime(drw["NGAY_DKY"]);
                            if (strMa_DDo == "PD01000009218001")
                            {
                                strMa_DDo = "PD01000009218001";
                            }

                            //so sanh 3 gia tri de xem da chuyen den gia tri ke tiep hay chua
                            if (strMa_DDo == strMa_DDo_Old && strBCS == strBCS_Old && ngay_CKy == ngay_CKy_Old && ngay_DKy == ngay_DKy_Old)
                            {
                                //Chua chuyen, thuc hien tinh luy tien san luong va tim max(chiso_id)
                                sl_ss = sl_ss + Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                                id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                                ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                                ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                                if (id_chiso < id_chiso_ss)
                                {
                                    id_chiso = id_chiso_ss;
                                }
                                if (ngay_dau > ngay_dau_ss)
                                {
                                    ngay_dau = ngay_dau_ss;
                                }
                                if (ngay_cuoi < ngay_cuoi_ss)
                                {
                                    ngay_cuoi = ngay_cuoi_ss;
                                }
                            }
                            else
                            {


                                if (strMa_DDo_Old != "")
                                {
                                    //Tinh lai so ngay dinh muc neu chua duoc tinh 
                                    //if (so_ngaydmuc == 0)
                                    //{
                                    IsNew = 0;
                                    ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    thangDM_min = ngay_dkymin.Month;
                                    namDM_min = ngay_dkymin.Year;
                                    thangDM_max = ngay_ckymax.Month;
                                    namDM_max = ngay_ckymax.Year;

                                    if (namDM_min == namDM_max)
                                    {
                                        if (thangDM_min == thangDM_max)
                                        {
                                            //Kiem tra xem co phai diem do treo moi hay khong
                                            //if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                            //{
                                            //    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                            //    {
                                            //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                            //    }
                                            //    else
                                            //    {
                                            IsNew = 1;
                                            //    }
                                            //}
                                            //else
                                            //{
                                            //    IsNew = 0;
                                            //}

                                            if (IsNew == 1)
                                            {
                                                //La khach hang phat trien moi
                                                thangDM = thangDM_min;
                                                namDM = namDM_min;
                                            }
                                            else
                                            {
                                                //Khong la khach hang phat trien moi
                                                //Kiem tra xem co phai truong hop thao cong to hay khong
                                                if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                                {
                                                    thangDM = thangDM_min;
                                                    namDM = namDM_min;
                                                }
                                                else
                                                {
                                                    if (thangDM_min == 1)
                                                    {
                                                        thangDM = 12;
                                                        namDM = namDM_min - 1;
                                                    }
                                                    else
                                                    {
                                                        thangDM = thangDM_min - 1;
                                                        namDM = namDM_min;
                                                    }
                                                }
                                            }
                                        }
                                        else
                                            if (thangDM_min < thangDM_max)
                                        {
                                            namDM = namDM_min;
                                            thangDM = thangDM_max - 1;
                                        }
                                    }
                                    else
                                        if (namDM_min < namDM_max)
                                        if (thangDM_max <= 1)
                                        {
                                            namDM = namDM_min;
                                            thangDM = 12;
                                        }
                                        else
                                        {
                                            namDM = namDM_max;
                                            thangDM = thangDM_max - 1;
                                        }

                                    so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                                    //}

                                    //Day du lieu vao bang SL_1
                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                    drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                    drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                                    drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                                    drSan_Luong["ID_CHISO"] = id_chiso_ss;
                                    drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                                    drSan_Luong["BCS"] = drwCS["BCS"];
                                    drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                                    drSan_Luong["NGAY_DAU"] = ngay_dau_ss;
                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi_ss;
                                    drSan_Luong["SAN_LUONG"] = sl_ss;
                                    drSan_Luong["DTUONG_GIA"] = "";
                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                    drSan_Luong["KY"] = drwCS["KY"];
                                    drSan_Luong["THANG"] = drwCS["THANG"];
                                    drSan_Luong["NAM"] = drwCS["NAM"];
                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                    //Gan lai cac gia tri san luong va chiso_id
                                    sl_ss = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                                    id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                                    ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                                    ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);
                                }
                                else
                                {
                                    //Gan lai cac gia tri san luong va chiso_id
                                    sl_ss = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                                    id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                                    ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                                    ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);
                                    if (id_chiso < id_chiso_ss)
                                    {
                                        id_chiso = id_chiso_ss;
                                    }
                                    if (ngay_dau > ngay_dau_ss)
                                    {
                                        ngay_dau = ngay_dau_ss;
                                    }
                                    if (ngay_cuoi < ngay_cuoi_ss)
                                    {
                                        ngay_cuoi = ngay_cuoi_ss;
                                    }
                                }

                                //sl = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);
                                id_chiso = Convert.ToDecimal(drw["ID_CHISO"]);
                                ngay_dau = Convert.ToDateTime(drw["NGAY_DKY"]);
                                ngay_cuoi = Convert.ToDateTime(drw["NGAY_CKY"]);
                            }
                            //Gan gia tri moi
                            strMa_DDo_Old = strMa_DDo;
                            strBCS_Old = strBCS;
                            ngay_CKy_Old = ngay_CKy;
                            ngay_DKy_Old = ngay_DKy;

                            drwCS = drw;
                            sl = sl_ss;
                        }
                    }
                    else
                    {
                        DataView dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                        DataView dwCS_CSC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        foreach (DataRowView dr in dwCS)
                        {
                            if (Convert.ToString(dr["LOAI_CHISO"]) != "DUP")
                            {
                                strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                                IsNew = 0;

                                //if (strMa_DDo == "PP01000101861001")
                                //{
                                //    strMa_DDo = "PP01000101861001";
                                //}
                                rows = dsCalculation.Tables["SL_1"].Select("MA_DDO = '" + strMa_DDo + "'");
                                if (rows.Length != 0)
                                    //Da thuc hien day du lieu vao bang SAN_LUONG
                                    continue;
                                else
                                {
                                    //Tinh so ngay dinh muc
                                    ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    thangDM_min = ngay_dkymin.Month;
                                    namDM_min = ngay_dkymin.Year;
                                    thangDM_max = ngay_ckymax.Month;
                                    namDM_max = ngay_ckymax.Year;

                                    if (namDM_min == namDM_max)
                                    {
                                        if (thangDM_min == thangDM_max)
                                        {
                                            //Kiem tra xem co phai diem do treo moi hay khong
                                            //if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                            //{
                                            //    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                            //    {
                                            //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                            //    }
                                            //    else
                                            //    {
                                            IsNew = 1;
                                            //    }
                                            //}
                                            //else
                                            //{
                                            //    IsNew = 0;
                                            //}

                                            if (IsNew == 1)
                                            {
                                                //La khach hang phat trien moi
                                                thangDM = thangDM_min;
                                                namDM = namDM_min;
                                            }
                                            else
                                            {
                                                //Khong la khach hang phat trien moi
                                                //Kiem tra xem co phai truong hop thao cong to hay khong
                                                if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                                {
                                                    thangDM = thangDM_min;
                                                    namDM = namDM_min;
                                                }
                                                else
                                                {
                                                    if (thangDM_min == 1)
                                                    {
                                                        thangDM = 12;
                                                        namDM = namDM_min - 1;
                                                    }
                                                    else
                                                    {
                                                        thangDM = thangDM_min - 1;
                                                        namDM = namDM_min;
                                                    }
                                                }
                                            }
                                        }
                                        else
                                            if (thangDM_min < thangDM_max)
                                        {
                                            namDM = namDM_min;
                                            thangDM = thangDM_max - 1;
                                        }
                                    }
                                    else
                                        if (namDM_min < namDM_max)
                                        if (thangDM_max <= 1)
                                        {
                                            namDM = namDM_min;
                                            thangDM = 12;
                                        }
                                        else
                                        {
                                            namDM = namDM_max;
                                            thangDM = thangDM_max - 1;
                                        }

                                    so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));

                                    //KT
                                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'");
                                    sl = 0;
                                    if (rows.Length != 0)
                                    {
                                        dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO='CSC'";
                                        dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                        if (dwCS_CSC.Count > 0)
                                        {
                                            id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'"));

                                            ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                            DataRow[] arr_CSC_KT = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP' ");
                                            foreach (DataRowView drv in dwCS_CSC)
                                            {                                                
                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_KT)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                    drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                    drSan_Luong["BCS"] = drv["BCS"];
                                                    drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = drv["KY"];
                                                    drSan_Luong["THANG"] = drv["THANG"];
                                                    drSan_Luong["NAM"] = drv["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }

                                                ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                            }
                                            //Xử lý đoạn còn lại

                                            sl = 0;
                                            foreach (DataRow drCS_Temp in arr_CSC_KT)
                                            {
                                                DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                {
                                                    sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                }
                                            }
                                            if (sl != 0)
                                            {
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Them du lieu vao bang SL_1
                                            sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'"));
                                            if (sl != 0)
                                            {
                                                //Neu <> 0 moi day vao SL_1
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'"));
                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }

                                    }

                                    //BT
                                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'");
                                    sl = 0;
                                    if (rows.Length != 0)
                                    {
                                        dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO='CSC'";
                                        dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                        if (dwCS_CSC.Count > 0)
                                        {
                                            id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'"));

                                            ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                            DataRow[] arr_CSC_BT = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP' ");
                                            foreach (DataRowView drv in dwCS_CSC)
                                            {
                                                
                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_BT)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                    drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                    drSan_Luong["BCS"] = drv["BCS"];
                                                    drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = drv["KY"];
                                                    drSan_Luong["THANG"] = drv["THANG"];
                                                    drSan_Luong["NAM"] = drv["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }

                                                ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                            }
                                            //Xử lý đoạn còn lại

                                            sl = 0;
                                            foreach (DataRow drCS_Temp in arr_CSC_BT)
                                            {
                                                DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                {
                                                    sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                }
                                            }
                                            if (sl != 0)
                                            {
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Them du lieu vao bang SL_1
                                            sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'"));
                                            if (sl != 0)
                                            {
                                                //Neu <> 0 moi day vao SL_1
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'"));
                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                    }

                                    //CD
                                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'");
                                    sl = 0;
                                    if (rows.Length != 0)
                                    {
                                        dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO='CSC'";
                                        dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                        if (dwCS_CSC.Count > 0)
                                        {
                                            id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'"));

                                            ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                            DataRow[] arr_CSC_CD = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP' ");
                                            foreach (DataRowView drv in dwCS_CSC)
                                            {
                                                
                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_CD)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                    drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                    drSan_Luong["BCS"] = drv["BCS"];
                                                    drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = drv["KY"];
                                                    drSan_Luong["THANG"] = drv["THANG"];
                                                    drSan_Luong["NAM"] = drv["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }

                                                ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                            }
                                            //Xử lý đoạn còn lại

                                            sl = 0;
                                            foreach (DataRow drCS_Temp in arr_CSC_CD)
                                            {
                                                DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                {
                                                    sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                }
                                            }
                                            if (sl != 0)
                                            {
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Them du lieu vao bang SL_1
                                            sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'"));
                                            if (sl != 0)
                                            {
                                                //Neu <> 0 moi day vao SL_1
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'"));
                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                    }
                                    //TD
                                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'");
                                    sl = 0;
                                    if (rows.Length != 0)
                                    {
                                        dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO='CSC'";
                                        dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                        if (dwCS_CSC.Count > 0)
                                        {
                                            id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'"));

                                            ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                            DataRow[] arr_CSC_TD = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP' ");
                                            foreach (DataRowView drv in dwCS_CSC)
                                            {
                                                
                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_TD)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                    drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                    drSan_Luong["BCS"] = drv["BCS"];
                                                    drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = drv["KY"];
                                                    drSan_Luong["THANG"] = drv["THANG"];
                                                    drSan_Luong["NAM"] = drv["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }

                                                ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                            }
                                            //Xử lý đoạn còn lại

                                            sl = 0;
                                            foreach (DataRow drCS_Temp in arr_CSC_TD)
                                            {
                                                DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                {
                                                    sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                }
                                            }
                                            if (sl != 0)
                                            {
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Them du lieu vao bang SL_1
                                            sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'"));
                                            if (sl != 0)
                                            {
                                                //Neu <> 0 moi day vao SL_1
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'"));
                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                    }
                                    //VC
                                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'");
                                    sl = 0;
                                    if (rows.Length != 0)
                                    {
                                        //Them du lieu vao bang SL_1
                                        sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'"));
                                        if (sl != 0)
                                        {
                                            //Neu <> 0 moi day vao SL_1
                                            id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'"));
                                            ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                            if (rows.Length != 0)
                                            {
                                                drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                drSan_Luong["ID_CHISO"] = id_chiso;
                                                drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                drSan_Luong["BCS"] = rows[0]["BCS"];
                                                drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                drSan_Luong["SAN_LUONG"] = sl;
                                                drSan_Luong["DTUONG_GIA"] = "";
                                                drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                drSan_Luong["KY"] = rows[0]["KY"];
                                                drSan_Luong["THANG"] = rows[0]["THANG"];
                                                drSan_Luong["NAM"] = rows[0]["NAM"];
                                                drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                            }
                                        }
                                        else
                                        {

                                            //CMIS-10274
                                            ////sl = 0: Kiểm tra nếu tồn tại trong HDG_QHE_DDO với loại quan hệ 32 thì vẫn đẩy vào
                                            bool isExistsCosfiBQ = false;
                                            if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") && dsCustomerData.Tables["HDG_QHE_DDO"].Rows.Count > 0)
                                            {
                                                DataRow[] arrQheCosfiBQ = dsCustomerData.Tables["HDG_QHE_DDO"].Select("(MA_DDO_CHINH='" + strMa_DDo + "' or MA_DDO_PHU='" + strMa_DDo + "') and LOAI_QHE='32'");
                                                if (arrQheCosfiBQ != null && arrQheCosfiBQ.Length > 0)
                                                    isExistsCosfiBQ = true;
                                            }
                                            if (isExistsCosfiBQ)
                                            {
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'"));
                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                rows = dsCustomerData.Tables["GCS_CHISO"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }


                }
                if (strMa_DDo_Old != "")
                {
                    //Tinh lai so ngay dinh muc neu chua duoc tinh 
                    //if (so_ngaydmuc == 0)
                    //{
                    IsNew = 0;
                    ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    thangDM_min = ngay_dkymin.Month;
                    namDM_min = ngay_dkymin.Year;
                    thangDM_max = ngay_ckymax.Month;
                    namDM_max = ngay_ckymax.Year;

                    if (namDM_min == namDM_max)
                    {
                        if (thangDM_min == thangDM_max)
                        {
                            //Kiem tra xem co phai diem do treo moi hay khong
                            //if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                            //{
                            //    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                            //    {
                            //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                            //    }
                            //    else
                            //    {
                            IsNew = 1;
                            //    }
                            //}
                            //else
                            //{
                            //    IsNew = 0;
                            //}

                            if (IsNew == 1)
                            {
                                //La khach hang phat trien moi
                                thangDM = thangDM_min;
                                namDM = namDM_min;
                            }
                            else
                            {
                                //Khong la khach hang phat trien moi
                                //Kiem tra xem co phai truong hop thao cong to hay khong
                                if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                {
                                    thangDM = thangDM_min;
                                    namDM = namDM_min;
                                }
                                else
                                {
                                    if (thangDM_min == 1)
                                    {
                                        thangDM = 12;
                                        namDM = namDM_min - 1;
                                    }
                                    else
                                    {
                                        thangDM = thangDM_min - 1;
                                        namDM = namDM_min;
                                    }
                                }
                            }
                        }
                        else
                            if (thangDM_min < thangDM_max)
                        {
                            namDM = namDM_min;
                            thangDM = thangDM_max - 1;
                        }
                    }
                    else
                        if (namDM_min < namDM_max)
                        if (thangDM_max <= 1)
                        {
                            namDM = namDM_min;
                            thangDM = 12;
                        }
                        else
                        {
                            namDM = namDM_max;
                            thangDM = thangDM_max - 1;
                        }

                    so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                    //}
                    //Day dong cuoi cung vao CSDL
                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                    drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                    drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                    drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                    drSan_Luong["ID_CHISO"] = id_chiso_ss;
                    drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                    drSan_Luong["BCS"] = drwCS["BCS"];
                    drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                    drSan_Luong["NGAY_DAU"] = ngay_dau_ss;
                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi_ss;
                    drSan_Luong["SAN_LUONG"] = sl_ss;
                    drSan_Luong["DTUONG_GIA"] = "";
                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                    drSan_Luong["KY"] = drwCS["KY"];
                    drSan_Luong["THANG"] = drwCS["THANG"];
                    drSan_Luong["NAM"] = drwCS["NAM"];
                    drSan_Luong["CHANGE_PRICE"] = "1";
                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                }
                //dsCalculation.Tables["SL_1"].AcceptChanges();
                #endregion

                #region Cac diem do phu ghep tong
                if (dsCustomerData.Tables["HDG_DIEM_DO_GT"] != null)
                {
                    dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                    dwGia.Sort = "NGAY_HLUC";
                    //Khởi tạo các biến kiểm tra
                    strMa_DDo = "";
                    strMa_DDo_Old = "";
                    IsNew = 0;
                    ngay_CKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_CKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_DKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_DKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    strBCS = "";
                    strBCS_Old = "";
                    sl = 0;
                    id_chiso = -1;
                    id_chiso_ss = -1;
                    ngay_dau = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_dau_ss = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_cuoi_ss = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    foreach (DataRow drDDo in dsCustomerData.Tables["HDG_DIEM_DO_GT"].Rows)
                    {
                        //Kiem tra co doi gia nha nuoc khong
                        IsChangePrice = 0;
                        strMa_DDo = drDDo["MA_DDO"].ToString().Trim();
                        if (strMa_DDo == "PQ02000198792002")
                        {
                        }
                        ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        ngay_dkymin = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                        {
                            ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            ngay_dkymin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO") == true)
                            {
                                if (dsCustomerData.Tables.Contains("GCS_CHISO") && dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                {
                                    ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                    ngay_dkymin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                }
                                else
                                {
                                    //Co diem do nhung ko co chi so, ko tinh
                                    continue;
                                }
                            }
                            else
                            {
                                //Co diem do nhung ko co chi so, ko tinh
                                continue;
                            }
                        }
                        dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        foreach (DataRowView drwGia in dwGia)
                        {

                            strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                            strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                            strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                            strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                            strKhoang_DAp = "";

                            //Tim khoang tham chieu cap dien ap
                            dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                            foreach (DataRowView drCapDA in dwTChieuDA)
                            {
                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                {
                                    if (ngay_ckymax == ngay_hluc)
                                    {
                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                        //se tinh toan bo vao bac thang cua bang gia cu
                                        continue;
                                    }
                                }

                                if (ngay_ckymax >= ngay_hluc)
                                {
                                    strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                    break;
                                }
                            }

                            if (strKhoang_DAp != "")
                            {
                                dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                foreach (DataRowView drGia in dwGiaNhomNN)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                    {
                                        if (ngay_ckymax == ngay_hluc)
                                        {
                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                            //se tinh toan bo vao bac thang cua bang gia cu
                                            continue;
                                        }
                                    }

                                    if (ngay_ckymax >= ngay_hluc && ngay_dkymin < ngay_hluc)
                                    {
                                        //Co doi gia
                                        IsChangePrice = 1;
                                        break;
                                    }
                                }
                            }

                            if (IsChangePrice == 1)
                            {
                                break;
                            }
                        }

                        //Bo sung 22/12/2012: Neu co chot chi so doi gia thi se phan 2 khoang gia cu gia moi
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length != 0)
                        {
                            IsChangePrice = 1;
                        }

                        if (IsChangePrice == 1)
                        {
                            //Co doi gia                           

                            DataView dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO<>'DUP'";
                            foreach (DataRowView drw in dwCS)
                            {
                                strMa_DDo = Convert.ToString(drw["MA_DDO"]);
                                strBCS = Convert.ToString(drw["BCS"]);
                                ngay_CKy = Convert.ToDateTime(drw["NGAY_CKY"]);
                                ngay_DKy = Convert.ToDateTime(drw["NGAY_DKY"]);
                                //if (strMa_DDo == "PQ02000198238001")
                                //{
                                //    strMa_DDo = "PQ02000198238001";
                                //}

                                //so sanh 3 gia tri de xem da chuyen den gia tri ke tiep hay chua
                                if (strMa_DDo == strMa_DDo_Old && strBCS == strBCS_Old && ngay_CKy == ngay_CKy_Old && ngay_DKy == ngay_DKy_Old)
                                {
                                    //Chua chuyen, thuc hien tinh luy tien san luong va tim max(chiso_id)
                                    sl_ss = sl_ss + Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                                    id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                                    ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                                    ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                                    if (id_chiso < id_chiso_ss)
                                    {
                                        id_chiso = id_chiso_ss;
                                    }
                                    if (ngay_dau > ngay_dau_ss)
                                    {
                                        ngay_dau = ngay_dau_ss;
                                    }
                                    if (ngay_cuoi < ngay_cuoi_ss)
                                    {
                                        ngay_cuoi = ngay_cuoi_ss;
                                    }
                                }
                                else
                                {
                                    //Gan lai cac gia tri san luong va chiso_id

                                    if (strMa_DDo_Old != "")
                                    {
                                        //Tinh lai so ngay dinh muc neu chua duoc tinh 
                                        //if (so_ngaydmuc == 0)
                                        //{
                                        IsNew = 0;
                                        ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        thangDM_min = ngay_dkymin.Month;
                                        namDM_min = ngay_dkymin.Year;
                                        thangDM_max = ngay_ckymax.Month;
                                        namDM_max = ngay_ckymax.Year;

                                        if (namDM_min == namDM_max)
                                        {
                                            if (thangDM_min == thangDM_max)
                                            {
                                                //Kiem tra xem co phai diem do treo moi hay khong
                                                //if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                                //{
                                                //    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                                //    {
                                                //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                                //    }
                                                //    else
                                                //    {
                                                IsNew = 1;
                                                //    }
                                                //}
                                                //else
                                                //{
                                                //    IsNew = 0;
                                                //}

                                                if (IsNew == 1)
                                                {
                                                    //La khach hang phat trien moi
                                                    thangDM = thangDM_min;
                                                    namDM = namDM_min;
                                                }
                                                else
                                                {
                                                    //Khong la khach hang phat trien moi
                                                    //Kiem tra xem co phai truong hop thao cong to hay khong
                                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                                    {
                                                        thangDM = thangDM_min;
                                                        namDM = namDM_min;
                                                    }
                                                    else
                                                    {
                                                        if (thangDM_min == 1)
                                                        {
                                                            thangDM = 12;
                                                            namDM = namDM_min - 1;
                                                        }
                                                        else
                                                        {
                                                            thangDM = thangDM_min - 1;
                                                            namDM = namDM_min;
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                                if (thangDM_min < thangDM_max)
                                            {
                                                namDM = namDM_min;
                                                thangDM = thangDM_max - 1;
                                            }
                                        }
                                        else
                                            if (namDM_min < namDM_max)
                                            if (thangDM_max <= 1)
                                            {
                                                namDM = namDM_min;
                                                thangDM = 12;
                                            }
                                            else
                                            {
                                                namDM = namDM_max;
                                                thangDM = thangDM_max - 1;
                                            }

                                        so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                                        //}

                                        //Day du lieu vao bang SL_1
                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                        drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                        drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                                        drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                                        drSan_Luong["ID_CHISO"] = id_chiso_ss;
                                        drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                                        drSan_Luong["BCS"] = drwCS["BCS"];
                                        drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                                        drSan_Luong["NGAY_DAU"] = ngay_dau_ss;
                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi_ss;
                                        drSan_Luong["SAN_LUONG"] = sl_ss;
                                        drSan_Luong["DTUONG_GIA"] = "";
                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                        drSan_Luong["KY"] = drwCS["KY"];
                                        drSan_Luong["THANG"] = drwCS["THANG"];
                                        drSan_Luong["NAM"] = drwCS["NAM"];
                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                        sl_ss = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                                        id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                                        ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                                        ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                                    }
                                    else
                                    {
                                        sl_ss = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                                        id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                                        ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                                        ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                                        if (id_chiso < id_chiso_ss)
                                        {
                                            id_chiso = id_chiso_ss;
                                        }
                                        if (ngay_dau > ngay_dau_ss)
                                        {
                                            ngay_dau = ngay_dau_ss;
                                        }
                                        if (ngay_cuoi < ngay_cuoi_ss)
                                        {
                                            ngay_cuoi = ngay_cuoi_ss;
                                        }
                                    }

                                    //sl = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);
                                    id_chiso = Convert.ToDecimal(drw["ID_CHISO"]);
                                    ngay_dau = Convert.ToDateTime(drw["NGAY_DKY"]);
                                    ngay_cuoi = Convert.ToDateTime(drw["NGAY_CKY"]);
                                }
                                //Gan gia tri moi
                                strMa_DDo_Old = strMa_DDo;
                                strBCS_Old = strBCS;
                                ngay_CKy_Old = ngay_CKy;
                                ngay_DKy_Old = ngay_DKy;
                                drwCS = drw;
                                sl = sl_ss;
                            }

                            //Tinh lai so ngay dinh muc neu chua duoc tinh 


                        }
                        else
                        {
                            DataView dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            DataView dwCS_CSC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                            foreach (DataRowView dr in dwCS)
                            {
                                if (Convert.ToString(dr["LOAI_CHISO"]) != "DUP")
                                {
                                    strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                                    IsNew = 0;

                                    rows = dsCalculation.Tables["SL_1"].Select("MA_DDO = '" + strMa_DDo + "'");
                                    if (rows.Length != 0)
                                        //Da thuc hien day du lieu vao bang SL_1
                                        continue;
                                    else
                                    {
                                        //Tinh so ngay dinh muc
                                        ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        thangDM_min = ngay_dkymin.Month;
                                        namDM_min = ngay_dkymin.Year;
                                        thangDM_max = ngay_ckymax.Month;
                                        namDM_max = ngay_ckymax.Year;

                                        if (namDM_min == namDM_max)
                                        {
                                            if (thangDM_min == thangDM_max)
                                            {
                                                //Kiem tra xem co phai diem do treo moi hay khong
                                                //if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                                //{
                                                //    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                                //    {
                                                //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                                //    }
                                                //    else
                                                //    {
                                                IsNew = 1;
                                                //    }
                                                //}
                                                //else
                                                //{
                                                //    IsNew = 0;
                                                //}

                                                if (IsNew == 1)
                                                {
                                                    //La khach hang phat trien moi
                                                    thangDM = thangDM_min;
                                                    namDM = namDM_min;
                                                }
                                                else
                                                {
                                                    //Khong la khach hang phat trien moi
                                                    //Kiem tra xem co phai truong hop thao cong to hay khong
                                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                                    {
                                                        thangDM = thangDM_min;
                                                        namDM = namDM_min;
                                                    }
                                                    else
                                                    {
                                                        if (thangDM_min == 1)
                                                        {
                                                            thangDM = 12;
                                                            namDM = namDM_min - 1;
                                                        }
                                                        else
                                                        {
                                                            thangDM = thangDM_min - 1;
                                                            namDM = namDM_min;
                                                        }
                                                    }
                                                    //if (thangDM_min == 1)
                                                    //{
                                                    //    thangDM = 12;
                                                    //    namDM = namDM_min - 1;
                                                    //}
                                                    //else
                                                    //{
                                                    //    thangDM = thangDM_min - 1;
                                                    //    namDM = namDM_min;
                                                    //}
                                                }
                                                //if (thangDM_min == 1)
                                                //{
                                                //    thangDM = 12;
                                                //    namDM = namDM_min - 1;
                                                //}
                                                //else
                                                //{
                                                //    thangDM = thangDM_min - 1;
                                                //    namDM = namDM_min;
                                                //}
                                            }
                                            else
                                                if (thangDM_min < thangDM_max)
                                            {
                                                namDM = namDM_min;
                                                thangDM = thangDM_max - 1;
                                            }
                                        }
                                        else
                                            if (namDM_min < namDM_max)
                                            if (thangDM_max <= 1)
                                            {
                                                namDM = namDM_min;
                                                thangDM = 12;
                                            }
                                            else
                                            {
                                                namDM = namDM_max;
                                                thangDM = thangDM_max - 1;
                                            }

                                        so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));

                                        //KT
                                        rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'");
                                        sl = 0;
                                        if (rows.Length != 0)
                                        {
                                            dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO='CSC'";
                                            dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                            if (dwCS_CSC.Count > 0)
                                            {
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'"));

                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                                DataRow[] arr_CSC_KT = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP' ");
                                                foreach (DataRowView drv in dwCS_CSC)
                                                {
                                                    
                                                    sl = 0;
                                                    foreach (DataRow drCS_Temp in arr_CSC_KT)
                                                    {
                                                        DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                        if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                        {
                                                            sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                        }
                                                    }
                                                    if (sl != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                        drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                        drSan_Luong["BCS"] = drv["BCS"];
                                                        drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = drv["KY"];
                                                        drSan_Luong["THANG"] = drv["THANG"];
                                                        drSan_Luong["NAM"] = drv["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }

                                                    ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                                }
                                                //Xử lý đoạn còn lại

                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_KT)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Them du lieu vao bang SL_1
                                                sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'"));
                                                if (sl != 0)
                                                {
                                                    //Neu <> 0 moi day vao SL_1
                                                    id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'"));
                                                    ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                        }

                                        //BT
                                        rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'");
                                        sl = 0;
                                        if (rows.Length != 0)
                                        {
                                            dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO='CSC'";
                                            dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                            if (dwCS_CSC.Count > 0)
                                            {
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'"));

                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                                DataRow[] arr_CSC_BT = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP' ");
                                                foreach (DataRowView drv in dwCS_CSC)
                                                {
                                                   
                                                    sl = 0;
                                                    foreach (DataRow drCS_Temp in arr_CSC_BT)
                                                    {
                                                        DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                        if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                        {
                                                            sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                        }
                                                    }
                                                    if (sl != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                        drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                        drSan_Luong["BCS"] = drv["BCS"];
                                                        drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = drv["KY"];
                                                        drSan_Luong["THANG"] = drv["THANG"];
                                                        drSan_Luong["NAM"] = drv["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }

                                                    ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                                }
                                                //Xử lý đoạn còn lại

                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_BT)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Them du lieu vao bang SL_1
                                                sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'"));
                                                if (sl != 0)
                                                {
                                                    //Neu <> 0 moi day vao SL_1
                                                    id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'"));
                                                    ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'BT' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                        }

                                        //CD
                                        rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'");
                                        sl = 0;
                                        if (rows.Length != 0)
                                        {
                                            dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO='CSC'";
                                            dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                            if (dwCS_CSC.Count > 0)
                                            {
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'"));

                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                                DataRow[] arr_CSC_CD = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP' ");
                                                foreach (DataRowView drv in dwCS_CSC)
                                                {
                                                    
                                                    sl = 0;
                                                    foreach (DataRow drCS_Temp in arr_CSC_CD)
                                                    {
                                                        DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                        if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                        {
                                                            sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                        }
                                                    }
                                                    if (sl != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                        drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                        drSan_Luong["BCS"] = drv["BCS"];
                                                        drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = drv["KY"];
                                                        drSan_Luong["THANG"] = drv["THANG"];
                                                        drSan_Luong["NAM"] = drv["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }

                                                    ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                                }
                                                //Xử lý đoạn còn lại

                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_CD)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Them du lieu vao bang SL_1
                                                sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'"));
                                                if (sl != 0)
                                                {
                                                    //Neu <> 0 moi day vao SL_1
                                                    id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'"));
                                                    ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'CD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                        }
                                        //TD
                                        rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'");
                                        sl = 0;
                                        if (rows.Length != 0)
                                        {
                                            dwCS_CSC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO='CSC'";
                                            dwCS_CSC.Sort = "NGAY_CKY ASC, NGAY_DKY ASC";
                                            if (dwCS_CSC.Count > 0)
                                            {
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'"));

                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                                DataRow[] arr_CSC_TD = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP' ");
                                                foreach (DataRowView drv in dwCS_CSC)
                                                {
                                                    
                                                    sl = 0;
                                                    foreach (DataRow drCS_Temp in arr_CSC_TD)
                                                    {
                                                        DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                        if (dtNgayCKy >= ngay_dau && dtNgayCKy <= Convert.ToDateTime(drv["NGAY_CKY"]))
                                                        {
                                                            sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                        }
                                                    }
                                                    if (sl != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = drv["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = drv["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = drv["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = drv["ID_CHISO"];
                                                        drSan_Luong["ID_BCS"] = drv["ID_BCS"];
                                                        drSan_Luong["BCS"] = drv["BCS"];
                                                        drSan_Luong["SO_CTO"] = drv["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = Convert.ToDateTime(drv["NGAY_CKY"]);
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = drv["KY"];
                                                        drSan_Luong["THANG"] = drv["THANG"];
                                                        drSan_Luong["NAM"] = drv["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }

                                                    ngay_dau = Convert.ToDateTime(drv["NGAY_CKY"]).AddDays(1);
                                                }
                                                //Xử lý đoạn còn lại

                                                sl = 0;
                                                foreach (DataRow drCS_Temp in arr_CSC_TD)
                                                {
                                                    DateTime dtNgayCKy = Convert.ToDateTime(drCS_Temp["NGAY_CKY"]);
                                                    if (dtNgayCKy >= ngay_dau && dtNgayCKy <= ngay_cuoi)
                                                    {
                                                        sl = sl + Convert.ToDecimal(drCS_Temp["SAN_LUONG"]) + Convert.ToDecimal(drCS_Temp["SLUONG_TTIEP"]) - Convert.ToDecimal(drCS_Temp["SLUONG_TRPHU"]);
                                                    }
                                                }
                                                if (sl != 0)
                                                {
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Them du lieu vao bang SL_1
                                                sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'"));
                                                if (sl != 0)
                                                {
                                                    //Neu <> 0 moi day vao SL_1
                                                    id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'"));
                                                    ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'TD' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }
                                                }
                                            }
                                        }

                                        //VC
                                        rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'");
                                        sl = 0;
                                        if (rows.Length != 0)
                                        {
                                            //Them du lieu vao bang SL_1
                                            sl = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")) + Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")) - Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'"));
                                            if (sl != 0)
                                            {
                                                //Neu <> 0 moi day vao SL_1
                                                id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'"));
                                                ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                if (rows.Length != 0)
                                                {
                                                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                    drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                    drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                    drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                    drSan_Luong["ID_CHISO"] = id_chiso;
                                                    drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                    drSan_Luong["BCS"] = rows[0]["BCS"];
                                                    drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                    drSan_Luong["SAN_LUONG"] = sl;
                                                    drSan_Luong["DTUONG_GIA"] = "";
                                                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                    drSan_Luong["KY"] = rows[0]["KY"];
                                                    drSan_Luong["THANG"] = rows[0]["THANG"];
                                                    drSan_Luong["NAM"] = rows[0]["NAM"];
                                                    drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                }
                                            }
                                            else
                                            {
                                                //CMIS-10274
                                                ////sl = 0: Kiểm tra nếu tồn tại trong HDG_QHE_DDO với loại quan hệ 32 thì vẫn đẩy vào
                                                bool isExistsCosfiBQ = false;
                                                if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") && dsCustomerData.Tables["HDG_QHE_DDO"].Rows.Count > 0)
                                                {
                                                    DataRow[] arrQheCosfiBQ = dsCustomerData.Tables["HDG_QHE_DDO"].Select("(MA_DDO_CHINH='" + strMa_DDo + "' or MA_DDO_PHU='" + strMa_DDo + "') and LOAI_QHE='32'");
                                                    if (arrQheCosfiBQ != null && arrQheCosfiBQ.Length > 0)
                                                        isExistsCosfiBQ = true;
                                                }
                                                if (isExistsCosfiBQ)
                                                {
                                                    id_chiso = Convert.ToDecimal(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'"));
                                                    ngay_dau = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    ngay_cuoi = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC' AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("ID_CHISO = " + id_chiso);
                                                    if (rows.Length != 0)
                                                    {
                                                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                                        drSan_Luong["MA_DVIQLY"] = rows[0]["MA_DVIQLY"];
                                                        drSan_Luong["MA_DDO"] = rows[0]["MA_DDO"];
                                                        drSan_Luong["MA_KHANG"] = rows[0]["MA_KHANG"];
                                                        drSan_Luong["ID_CHISO"] = id_chiso;
                                                        drSan_Luong["ID_BCS"] = rows[0]["ID_BCS"];
                                                        drSan_Luong["BCS"] = rows[0]["BCS"];
                                                        drSan_Luong["SO_CTO"] = rows[0]["SO_CTO"];
                                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                                        drSan_Luong["SAN_LUONG"] = sl;
                                                        drSan_Luong["DTUONG_GIA"] = "";
                                                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                                        drSan_Luong["KY"] = rows[0]["KY"];
                                                        drSan_Luong["THANG"] = rows[0]["THANG"];
                                                        drSan_Luong["NAM"] = rows[0]["NAM"];
                                                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                                                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                                                    }

                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                    }
                    if (strMa_DDo_Old != "")
                    {
                        //if (so_ngaydmuc == 0)
                        //{
                        IsNew = 0;
                        ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        thangDM_min = ngay_dkymin.Month;
                        namDM_min = ngay_dkymin.Year;
                        thangDM_max = ngay_ckymax.Month;
                        namDM_max = ngay_ckymax.Year;

                        if (namDM_min == namDM_max)
                        {
                            if (thangDM_min == thangDM_max)
                            {
                                //Kiem tra xem co phai diem do treo moi hay khong
                                //if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                //{
                                //    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                //    {
                                //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                //    }
                                //    else
                                //    {
                                IsNew = 1;
                                //    }
                                //}
                                //else
                                //{
                                //    IsNew = 0;
                                //}

                                if (IsNew == 1)
                                {
                                    //La khach hang phat trien moi
                                    thangDM = thangDM_min;
                                    namDM = namDM_min;
                                }
                                else
                                {
                                    //Khong la khach hang phat trien moi
                                    //Kiem tra xem co phai truong hop thao cong to hay khong
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                    {
                                        thangDM = thangDM_min;
                                        namDM = namDM_min;
                                    }
                                    else
                                    {
                                        if (thangDM_min == 1)
                                        {
                                            thangDM = 12;
                                            namDM = namDM_min - 1;
                                        }
                                        else
                                        {
                                            thangDM = thangDM_min - 1;
                                            namDM = namDM_min;
                                        }
                                    }
                                }
                            }
                            else
                                if (thangDM_min < thangDM_max)
                            {
                                namDM = namDM_min;
                                thangDM = thangDM_max - 1;
                            }
                        }
                        else
                            if (namDM_min < namDM_max)
                            if (thangDM_max <= 1)
                            {
                                namDM = namDM_min;
                                thangDM = 12;
                            }
                            else
                            {
                                namDM = namDM_max;
                                thangDM = thangDM_max - 1;
                            }

                        so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                        //}
                        //Day dong cuoi cung vao CSDL
                        drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                        drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                        drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                        drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                        drSan_Luong["ID_CHISO"] = id_chiso_ss;
                        drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                        drSan_Luong["BCS"] = drwCS["BCS"];
                        drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                        drSan_Luong["NGAY_DAU"] = ngay_dau_ss;
                        drSan_Luong["NGAY_CUOI"] = ngay_cuoi_ss;
                        drSan_Luong["SAN_LUONG"] = sl_ss;
                        drSan_Luong["DTUONG_GIA"] = "";
                        drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                        drSan_Luong["KY"] = drwCS["KY"];
                        drSan_Luong["THANG"] = drwCS["THANG"];
                        drSan_Luong["NAM"] = drwCS["NAM"];
                        drSan_Luong["CHANGE_PRICE"] = IsChangePrice.ToString();
                        dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                    }
                }
                //---                
                #endregion

                //Xoa cac dong chi so DUP di, khong dung nua
                DataView dwDUP = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwDUP.RowFilter = "LOAI_CHISO = 'DUP'";
                foreach (DataRowView drw in dwDUP)
                {
                    dsCustomerData.Tables["GCS_CHISO"].Rows.Remove(drw.Row);
                }

                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                {
                    dwDUP = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                    dwDUP.RowFilter = "LOAI_CHISO = 'DUP'";
                    foreach (DataRowView drw in dwDUP)
                    {
                        dsCustomerData.Tables["GCS_CHISO_GT"].Rows.Remove(drw.Row);
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_11: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }

        //Tinh san luong chi tiet theo toan bo cac bo chi so cua tung cong to trong diem do
        //Ap dung cho ky doi gia
        public string DetailDataCalculation_12(DataSet dsCustomerData, ref DS_CALCULATIONTABLES dsCalculation)
        {
            try
            {
                string strMa_DDo = "", strMa_DDo_Old = "";
                DataRow[] rows;
                DataRow drSan_Luong;
                Decimal sl = 0, so_ngaydmuc = 0, sl_ss = 0;
                Decimal id_chiso = 0, id_chiso_ss = 0, IsNew = 0; //Kiem tra co phai diem do treo moi hay khong
                DateTime ngay_dau, ngay_cuoi, ngay_dau_ss, ngay_cuoi_ss;
                //Tinh so ngay dinh muc
                DateTime ngay_dkymin, ngay_ckymax;
                int thangDM_min = 0, thangDM_max, namDM_min = 0, namDM_max = 0, thangDM = 0, namDM = 0;

                //Them vao rieng cho doi gia, tach san luong
                DataView dwCS;
                DataRowView drwCS = null;
                DateTime ngay_CKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_CKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                string strBCS = "", strBCS_Old = "";

                //Day du lieu vao bang SL_1
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_1") == false)
                    return "NotExistsSL_1";

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull";
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                    return "NotExistsGCS_CHISO";

                #region Cac diem do chinh ghep tong, cac diem do khong co quan he ghep tong
                //Lay du lieu tu bang GCS_CHISO vao SAN_LUONG                
                //Su dung DataView, can kiem tra toc do thuc hien voi database cua Dong Nai
                dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwCS.Sort = "MA_DVIQLY, MA_DDO, BCS, ID_CHISO";
                dwCS.RowFilter = "LOAI_CHISO <> 'DUP'";
                //Khoi tao cac bien kiem tra
                strMa_DDo = "";
                strMa_DDo_Old = "";
                IsNew = 0;
                ngay_CKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_CKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                strBCS = "";
                strBCS_Old = "";
                sl = 0;
                id_chiso = -1;
                id_chiso_ss = -1;
                ngay_dau = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                ngay_dau_ss = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cuoi_ss = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));

                foreach (DataRowView drw in dwCS)
                {
                    strMa_DDo = Convert.ToString(drw["MA_DDO"]);
                    strBCS = Convert.ToString(drw["BCS"]);
                    ngay_CKy = Convert.ToDateTime(drw["NGAY_CKY"]);
                    if (strMa_DDo == "PC05EE0937561001")
                    {
                        strMa_DDo = "PC05EE0937561001";
                    }

                    //so sanh 3 gia tri de xem da chuyen den gia tri ke tiep hay chua
                    if (strMa_DDo == strMa_DDo_Old && strBCS == strBCS_Old && ngay_CKy == ngay_CKy_Old)
                    {
                        //Chua chuyen, thuc hien tinh luy tien san luong va tim max(chiso_id)
                        sl_ss = sl_ss + Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                        id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                        ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                        ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                        if (id_chiso < id_chiso_ss)
                        {
                            id_chiso = id_chiso_ss;
                        }
                        if (ngay_dau > ngay_dau_ss)
                        {
                            ngay_dau = ngay_dau_ss;
                        }
                        if (ngay_cuoi < ngay_cuoi_ss)
                        {
                            ngay_cuoi = ngay_cuoi_ss;
                        }
                    }
                    else
                    {
                        //Gan lai cac gia tri san luong va chiso_id
                        sl_ss = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                        id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                        ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                        ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                        if (strMa_DDo_Old != "")
                        {
                            //Tinh lai so ngay dinh muc neu chua duoc tinh 
                            //if (so_ngaydmuc == 0)
                            //{
                            IsNew = 0;
                            ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            thangDM_min = ngay_dkymin.Month;
                            namDM_min = ngay_dkymin.Year;
                            thangDM_max = ngay_ckymax.Month;
                            namDM_max = ngay_ckymax.Year;

                            if (namDM_min == namDM_max)
                            {
                                if (thangDM_min == thangDM_max)
                                {
                                    //Kiem tra xem co phai diem do treo moi hay khong
                                    //if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                    //{
                                    //    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                    //    {
                                    //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                    //    }
                                    //    else
                                    //    {
                                    IsNew = 1;
                                    //    }
                                    //}
                                    //else
                                    //{
                                    //    IsNew = 0;
                                    //}

                                    if (IsNew == 1)
                                    {
                                        //La khach hang phat trien moi
                                        thangDM = thangDM_min;
                                        namDM = namDM_min;
                                    }
                                    else
                                    {
                                        //Khong la khach hang phat trien moi
                                        //Kiem tra xem co phai truong hop thao cong to hay khong
                                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                        {
                                            thangDM = thangDM_min;
                                            namDM = namDM_min;
                                        }
                                        else
                                        {
                                            if (thangDM_min == 1)
                                            {
                                                thangDM = 12;
                                                namDM = namDM_min - 1;
                                            }
                                            else
                                            {
                                                thangDM = thangDM_min - 1;
                                                namDM = namDM_min;
                                            }
                                        }
                                    }
                                }
                                else
                                    if (thangDM_min < thangDM_max)
                                {
                                    namDM = namDM_min;
                                    thangDM = thangDM_max - 1;
                                }
                            }
                            else
                                if (namDM_min < namDM_max)
                                if (thangDM_max <= 1)
                                {
                                    namDM = namDM_min;
                                    thangDM = 12;
                                }
                                else
                                {
                                    namDM = namDM_max;
                                    thangDM = thangDM_max - 1;
                                }

                            so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                            //}

                            //Day du lieu vao bang SL_1
                            drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                            drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                            drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                            drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                            drSan_Luong["ID_CHISO"] = id_chiso;
                            drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                            drSan_Luong["BCS"] = drwCS["BCS"];
                            drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                            drSan_Luong["NGAY_DAU"] = ngay_dau;
                            drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                            drSan_Luong["SAN_LUONG"] = sl;
                            drSan_Luong["DTUONG_GIA"] = "";
                            drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                            drSan_Luong["KY"] = drwCS["KY"];
                            drSan_Luong["THANG"] = drwCS["THANG"];
                            drSan_Luong["NAM"] = drwCS["NAM"];
                            dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                        }
                        else
                        {
                            if (id_chiso < id_chiso_ss)
                            {
                                id_chiso = id_chiso_ss;
                            }
                            if (ngay_dau > ngay_dau_ss)
                            {
                                ngay_dau = ngay_dau_ss;
                            }
                            if (ngay_cuoi < ngay_cuoi_ss)
                            {
                                ngay_cuoi = ngay_cuoi_ss;
                            }
                        }

                        //sl = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);
                        id_chiso = Convert.ToDecimal(drw["ID_CHISO"]);
                        ngay_dau = Convert.ToDateTime(drw["NGAY_DKY"]);
                        ngay_cuoi = Convert.ToDateTime(drw["NGAY_CKY"]);
                    }
                    //Gan gia tri moi
                    strMa_DDo_Old = strMa_DDo;
                    strBCS_Old = strBCS;
                    ngay_CKy_Old = ngay_CKy;

                    drwCS = drw;
                    sl = sl_ss;
                }

                //Tinh lai so ngay dinh muc neu chua duoc tinh 
                //if (so_ngaydmuc == 0)
                //{
                IsNew = 0;
                ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                thangDM_min = ngay_dkymin.Month;
                namDM_min = ngay_dkymin.Year;
                thangDM_max = ngay_ckymax.Month;
                namDM_max = ngay_ckymax.Year;

                if (namDM_min == namDM_max)
                {
                    if (thangDM_min == thangDM_max)
                    {
                        //Kiem tra xem co phai diem do treo moi hay khong
                        //if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                        //{
                        //    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                        //    {
                        //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                        //    }
                        //    else
                        //    {
                        IsNew = 1;
                        //    }
                        //}
                        //else
                        //{
                        //    IsNew = 0;
                        //}

                        if (IsNew == 1)
                        {
                            //La khach hang phat trien moi
                            thangDM = thangDM_min;
                            namDM = namDM_min;
                        }
                        else
                        {
                            //Khong la khach hang phat trien moi
                            //Kiem tra xem co phai truong hop thao cong to hay khong
                            if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                            {
                                thangDM = thangDM_min;
                                namDM = namDM_min;
                            }
                            else
                            {
                                if (thangDM_min == 1)
                                {
                                    thangDM = 12;
                                    namDM = namDM_min - 1;
                                }
                                else
                                {
                                    thangDM = thangDM_min - 1;
                                    namDM = namDM_min;
                                }
                            }
                        }
                    }
                    else
                        if (thangDM_min < thangDM_max)
                    {
                        namDM = namDM_min;
                        thangDM = thangDM_max - 1;
                    }
                }
                else
                    if (namDM_min < namDM_max)
                    if (thangDM_max <= 1)
                    {
                        namDM = namDM_min;
                        thangDM = 12;
                    }
                    else
                    {
                        namDM = namDM_max;
                        thangDM = thangDM_max - 1;
                    }

                so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                //}
                //Day dong cuoi cung vao CSDL
                drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                drSan_Luong["ID_CHISO"] = id_chiso;
                drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                drSan_Luong["BCS"] = drwCS["BCS"];
                drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                drSan_Luong["NGAY_DAU"] = ngay_dau;
                drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                drSan_Luong["SAN_LUONG"] = sl;
                drSan_Luong["DTUONG_GIA"] = "";
                drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                drSan_Luong["KY"] = drwCS["KY"];
                drSan_Luong["THANG"] = drwCS["THANG"];
                drSan_Luong["NAM"] = drwCS["NAM"];
                dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                #endregion

                #region Cac diem do phu ghep tong
                //Lay du lieu tu bang GCS_CHISO_GT vao SL_1
                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                {
                    //Lay du lieu tu bang GCS_CHISO vao SAN_LUONG                
                    //Su dung DataView, can kiem tra toc do thuc hien voi database cua Dong Nai
                    dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                    dwCS.Sort = "MA_DVIQLY, MA_DDO, BCS, ID_CHISO";
                    dwCS.RowFilter = "LOAI_CHISO <> 'DUP'";
                    //Khoi tao cac bien kiem tra
                    strMa_DDo = "";
                    strMa_DDo_Old = "";
                    IsNew = 0;
                    ngay_CKy = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_CKy_Old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    strBCS = "";
                    strBCS_Old = "";
                    sl = 0;
                    id_chiso = -1;
                    id_chiso_ss = -1;
                    ngay_dau = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_dau_ss = DateTime.Parse("01/01/3000", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    ngay_cuoi_ss = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));

                    foreach (DataRowView drw in dwCS)
                    {
                        strMa_DDo = Convert.ToString(drw["MA_DDO"]);
                        strBCS = Convert.ToString(drw["BCS"]);
                        ngay_CKy = Convert.ToDateTime(drw["NGAY_CKY"]);
                        //if (strMa_DDo == "PQ02000198238001")
                        //{
                        //    strMa_DDo = "PQ02000198238001";
                        //}

                        //so sanh 3 gia tri de xem da chuyen den gia tri ke tiep hay chua
                        if (strMa_DDo == strMa_DDo_Old && strBCS == strBCS_Old && ngay_CKy == ngay_CKy_Old)
                        {
                            //Chua chuyen, thuc hien tinh luy tien san luong va tim max(chiso_id)
                            sl_ss = sl_ss + Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                            id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                            ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                            ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                            if (id_chiso < id_chiso_ss)
                            {
                                id_chiso = id_chiso_ss;
                            }
                            if (ngay_dau > ngay_dau_ss)
                            {
                                ngay_dau = ngay_dau_ss;
                            }
                            if (ngay_cuoi < ngay_cuoi_ss)
                            {
                                ngay_cuoi = ngay_cuoi_ss;
                            }
                        }
                        else
                        {
                            //Gan lai cac gia tri san luong va chiso_id
                            sl_ss = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);

                            id_chiso_ss = Utility.DecimalDbnull(drw["ID_CHISO"]);
                            ngay_dau_ss = Convert.ToDateTime(drw["NGAY_DKY"]);
                            ngay_cuoi_ss = Convert.ToDateTime(drw["NGAY_CKY"]);

                            if (strMa_DDo_Old != "")
                            {
                                //Tinh lai so ngay dinh muc neu chua duoc tinh 
                                if (so_ngaydmuc == 0)
                                {
                                    IsNew = 0;
                                    ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    thangDM_min = ngay_dkymin.Month;
                                    namDM_min = ngay_dkymin.Year;
                                    thangDM_max = ngay_ckymax.Month;
                                    namDM_max = ngay_ckymax.Year;

                                    if (namDM_min == namDM_max)
                                    {
                                        if (thangDM_min == thangDM_max)
                                        {
                                            //Kiem tra xem co phai diem do treo moi hay khong
                                            //if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                            //{
                                            //    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                            //    {
                                            //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                            //    }
                                            //    else
                                            //    {
                                            IsNew = 1;
                                            //    }
                                            //}
                                            //else
                                            //{
                                            //    IsNew = 0;
                                            //}

                                            if (IsNew == 1)
                                            {
                                                //La khach hang phat trien moi
                                                thangDM = thangDM_min;
                                                namDM = namDM_min;
                                            }
                                            else
                                            {
                                                //Khong la khach hang phat trien moi
                                                //Kiem tra xem co phai truong hop thao cong to hay khong
                                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                                {
                                                    thangDM = thangDM_min;
                                                    namDM = namDM_min;
                                                }
                                                else
                                                {
                                                    if (thangDM_min == 1)
                                                    {
                                                        thangDM = 12;
                                                        namDM = namDM_min - 1;
                                                    }
                                                    else
                                                    {
                                                        thangDM = thangDM_min - 1;
                                                        namDM = namDM_min;
                                                    }
                                                }
                                            }
                                        }
                                        else
                                            if (thangDM_min < thangDM_max)
                                        {
                                            namDM = namDM_min;
                                            thangDM = thangDM_max - 1;
                                        }
                                    }
                                    else
                                        if (namDM_min < namDM_max)
                                        if (thangDM_max <= 1)
                                        {
                                            namDM = namDM_min;
                                            thangDM = 12;
                                        }
                                        else
                                        {
                                            namDM = namDM_max;
                                            thangDM = thangDM_max - 1;
                                        }

                                    so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                                }

                                //Day du lieu vao bang SL_1
                                drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                                drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                                drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                                drSan_Luong["ID_CHISO"] = id_chiso;
                                drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                                drSan_Luong["BCS"] = drwCS["BCS"];
                                drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                                drSan_Luong["NGAY_DAU"] = ngay_dau;
                                drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                drSan_Luong["SAN_LUONG"] = sl;
                                drSan_Luong["DTUONG_GIA"] = "";
                                drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                                drSan_Luong["KY"] = drwCS["KY"];
                                drSan_Luong["THANG"] = drwCS["THANG"];
                                drSan_Luong["NAM"] = drwCS["NAM"];
                                dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                            }
                            else
                            {
                                if (id_chiso < id_chiso_ss)
                                {
                                    id_chiso = id_chiso_ss;
                                }
                                if (ngay_dau > ngay_dau_ss)
                                {
                                    ngay_dau = ngay_dau_ss;
                                }
                                if (ngay_cuoi < ngay_cuoi_ss)
                                {
                                    ngay_cuoi = ngay_cuoi_ss;
                                }
                            }

                            //sl = Utility.DecimalDbnull(drw["SAN_LUONG"]) + Utility.DecimalDbnull(drw["SLUONG_TTIEP"]) - Utility.DecimalDbnull(drw["SLUONG_TRPHU"]);
                            id_chiso = Convert.ToDecimal(drw["ID_CHISO"]);
                            ngay_dau = Convert.ToDateTime(drw["NGAY_DKY"]);
                            ngay_cuoi = Convert.ToDateTime(drw["NGAY_CKY"]);
                        }
                        //Gan gia tri moi
                        strMa_DDo_Old = strMa_DDo;
                        strBCS_Old = strBCS;
                        ngay_CKy_Old = ngay_CKy;

                        drwCS = drw;
                        sl = sl_ss;
                    }

                    //Tinh lai so ngay dinh muc neu chua duoc tinh 
                    if (so_ngaydmuc == 0)
                    {
                        IsNew = 0;
                        ngay_dkymin = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        ngay_ckymax = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo_Old + "' AND BCS IN ('KT','BT','CD','TD') AND LOAI_CHISO <> 'DUP'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        thangDM_min = ngay_dkymin.Month;
                        namDM_min = ngay_dkymin.Year;
                        thangDM_max = ngay_ckymax.Month;
                        namDM_max = ngay_ckymax.Year;

                        if (namDM_min == namDM_max)
                        {
                            if (thangDM_min == thangDM_max)
                            {
                                //Kiem tra xem co phai diem do treo moi hay khong
                                //if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DUP'").Count() != 0)
                                //{
                                //    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDN'").Count() != 0)
                                //    {
                                //        IsNew = 0; //La khach hang co treo thao cong to trong ky
                                //    }
                                //    else
                                //    {
                                IsNew = 1;
                                //    }
                                //}
                                //else
                                //{
                                //    IsNew = 0;
                                //}

                                if (IsNew == 1)
                                {
                                    //La khach hang phat trien moi
                                    thangDM = thangDM_min;
                                    namDM = namDM_min;
                                }
                                else
                                {
                                    //Khong la khach hang phat trien moi
                                    //Kiem tra xem co phai truong hop thao cong to hay khong
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo_Old + "' AND LOAI_CHISO = 'DDK'").Count() == 0)
                                    {
                                        thangDM = thangDM_min;
                                        namDM = namDM_min;
                                    }
                                    else
                                    {
                                        if (thangDM_min == 1)
                                        {
                                            thangDM = 12;
                                            namDM = namDM_min - 1;
                                        }
                                        else
                                        {
                                            thangDM = thangDM_min - 1;
                                            namDM = namDM_min;
                                        }
                                    }
                                }
                            }
                            else
                                if (thangDM_min < thangDM_max)
                            {
                                namDM = namDM_min;
                                thangDM = thangDM_max - 1;
                            }
                        }
                        else
                            if (namDM_min < namDM_max)
                            if (thangDM_max <= 1)
                            {
                                namDM = namDM_min;
                                thangDM = 12;
                            }
                            else
                            {
                                namDM = namDM_max;
                                thangDM = thangDM_max - 1;
                            }

                        so_ngaydmuc = Convert.ToDecimal(DateTime.DaysInMonth(namDM, thangDM));
                    }
                    //Day dong cuoi cung vao CSDL
                    drSan_Luong = dsCalculation.Tables["SL_1"].NewRow();
                    drSan_Luong["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                    drSan_Luong["MA_DDO"] = drwCS["MA_DDO"];
                    drSan_Luong["MA_KHANG"] = drwCS["MA_KHANG"];
                    drSan_Luong["ID_CHISO"] = id_chiso;
                    drSan_Luong["ID_BCS"] = drwCS["ID_BCS"];
                    drSan_Luong["BCS"] = drwCS["BCS"];
                    drSan_Luong["SO_CTO"] = drwCS["SO_CTO"];
                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                    drSan_Luong["SAN_LUONG"] = sl;
                    drSan_Luong["DTUONG_GIA"] = "";
                    drSan_Luong["SO_NGAYDMUC"] = so_ngaydmuc;
                    drSan_Luong["KY"] = drwCS["KY"];
                    drSan_Luong["THANG"] = drwCS["THANG"];
                    drSan_Luong["NAM"] = drwCS["NAM"];
                    dsCalculation.Tables["SL_1"].Rows.Add(drSan_Luong);
                }
                #endregion

                //Xoa cac dong chi so DUP di, khong dung nua
                DataView dwDUP = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwDUP.RowFilter = "LOAI_CHISO = 'DUP'";
                foreach (DataRowView drw in dwDUP)
                {
                    dsCustomerData.Tables["GCS_CHISO"].Rows.Remove(drw.Row);
                }

                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                {
                    dwDUP = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                    dwDUP.RowFilter = "LOAI_CHISO = 'DUP'";
                    foreach (DataRowView drw in dwDUP)
                    {
                        dsCustomerData.Tables["GCS_CHISO_GT"].Rows.Remove(drw.Row);
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_12: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }

        //Tinh san luong chi tiet theo bien dong dau vao (gia khach hang, so ho, cap dien ap)
        public string DetailDataCalculation_2(DS_CALCULATIONTABLES dsCalculation, DataSet dsCustomerData, DataSet dsStaticCatalog)
        {
            try
            {
                DataRow drSan_Luong;
                string strMa_DDo = "", strBCS = "", strID_BBANAGIA = "";
                DateTime ngay_dau, ngay_cuoi, ngay_hlucgia, ngay_hluccu, ngay_hlucgiamin, ngay_hlucgia_temp;
                Decimal sl = 0, sl_ct = 0, sl_lt = 0;
                Decimal t1, t2; //, t3;
                //string strDebug = "";
                Decimal IsExists = 0, IsExists_CSC = 0, sl_CSC = 0;
                Decimal songay_CSC = 0;
                Decimal tong_slCSC = 0, tong_slCSC_All = 0;
                DataView dwSL1, dwCSoChot, dwCSoChot_GT, rowsDiemDo, rowsDiemDo_GT, rowsBBGia, rowsBBGia_GT;
                DateTime ngay_dkyCSC, ngay_ckyCSC;
                Int16 IsExistsThayDoiSoHo = 0, IsExistsSoHoParam = 0; //La bien kiem tra tinh so ho dinh muc theo ca thang hay la chi tiet cho tungf lan thay doi so ho

                DateTime ngay_hlucmax, ngay_hlucmaxSHBTN;

                //Tach san luong chi tiet theo bien ban gia trong ky
                //Day du lieu vao bang SL_2
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_1") == false)
                    return "NotExistsSL_1";
                else
                        if (dsCalculation.Tables.Contains("SL_2") == false)
                    return "NotExistsSL_2";

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull";
                else
                    if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == false)
                    return "NotExistsHDG_BBAN_APGIA";

                //Kiem tra bien G_SOHO, neu la C thi moi coi la tinh chi tiet cho cac lan thay doi so ho trong 1 thang
                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                {
                    if (dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_SOHO' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')").Length > 0)
                    {
                        IsExistsSoHoParam = 1; //Tinh chi tiet cho cac lan thay doi so ho trong thang
                    }
                    else
                    {
                        IsExistsSoHoParam = 0;
                    }
                }
                else
                {
                    IsExistsSoHoParam = 0;
                }

                dwSL1 = new DataView(dsCalculation.Tables["SL_1"]);
                dwSL1.RowFilter = "BCS IN ('BT','CD','TD','KT')";
                if (dwSL1.Count != 0)
                {
                    rowsBBGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                    if (rowsBBGia.Count != 0)
                    {
                        rowsBBGia.RowFilter = "MA_DVIQLY = '" + Convert.ToString(rowsBBGia[0]["MA_DVIQLY"]) + "'";
                    }
                    rowsBBGia.Sort = "NGAY_HLUC";

                    if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                    {
                        rowsBBGia_GT = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                        if (rowsBBGia_GT.Count != 0)
                        {
                            rowsBBGia_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(rowsBBGia_GT[0]["MA_DVIQLY"]) + "'";
                        }
                        rowsBBGia_GT.Sort = "NGAY_HLUC";
                    }
                    else
                    {
                        rowsBBGia_GT = null;
                    }

                    rowsDiemDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                    if (rowsDiemDo.Count != 0)
                    {
                        rowsDiemDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(rowsDiemDo[0]["MA_DVIQLY"]) + "'";
                    }
                    rowsDiemDo.Sort = "NGAY_HLUC";

                    if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == true)
                    {
                        rowsDiemDo_GT = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                        if (rowsDiemDo_GT.Count != 0)
                        {
                            rowsDiemDo_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(rowsDiemDo_GT[0]["MA_DVIQLY"]) + "'";
                        }
                        rowsDiemDo_GT.Sort = "NGAY_HLUC";
                    }
                    else
                    {
                        rowsDiemDo_GT = null;
                    }

                    dwCSoChot = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                    if (dwCSoChot.Count != 0)
                    {
                        dwCSoChot.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwCSoChot[0]["MA_DVIQLY"]) + "'";
                    }
                    dwCSoChot.Sort = "NGAY_CKY, NGAY_DKY, ID_CHISO";

                    if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                    {
                        dwCSoChot_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        if (dwCSoChot_GT.Count != 0)
                        {
                            dwCSoChot_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwCSoChot_GT[0]["MA_DVIQLY"]) + "'";
                        }
                        dwCSoChot_GT.Sort = "NGAY_CKY, NGAY_DKY, ID_CHISO";
                    }
                    else
                    {
                        dwCSoChot_GT = null;
                    }

                    foreach (DataRowView drSL1 in dwSL1)
                    {
                        strMa_DDo = Convert.ToString(drSL1["MA_DDO"]);
                        ngay_dau = Convert.ToDateTime(drSL1["NGAY_DAU"]);
                        ngay_cuoi = Convert.ToDateTime(drSL1["NGAY_CUOI"]);
                        sl = Convert.ToDecimal(drSL1["SAN_LUONG"]);
                        strBCS = Convert.ToString(drSL1["BCS"]);

                        if (strMa_DDo == "PQ03000298833001")
                        {
                            strMa_DDo = "PQ03000298833001";
                        }

                        #region Diem do chinh ghep tong, diem do phu ghep tong cung so, diem do khong co quan he ghep tong
                        //rowsGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                        //Xu ly ho ngheo SHBT nhom N
                        rowsBBGia.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBT' AND MA_NGIA = 'N'";

                        if (rowsBBGia.Count == 0)
                        {
                            //Khong co SHBT nhom N

                            rowsBBGia.RowFilter = "MA_DDO = '" + strMa_DDo + "' and LOAI_BCS = '" + strBCS + "'";
                            //rowsGia.Sort = "NGAY_HLUC";

                            strID_BBANAGIA = "";
                            //Tien xu ly rowsGia trong truong hop chi lay 1 so ho
                            if (IsExistsSoHoParam == 0)
                            {
                                strID_BBANAGIA = "";
                                foreach (DataRowView drGia in rowsBBGia)
                                {
                                    IsExistsThayDoiSoHo = 0;
                                    DateTime ngay_hluc_soho = Convert.ToDateTime(drGia["NGAY_HLUC"]);
                                    if (Convert.ToInt32(drGia["IS_SOHO"]) > 0)
                                    {
                                        if (ngay_hluc_soho <= ngay_cuoi && ngay_hluc_soho > ngay_dau)
                                            //Co thay doi so ho
                                            IsExistsThayDoiSoHo = 1;
                                        else
                                            //Nam ngoai khoang
                                            IsExistsThayDoiSoHo = 0;
                                    }


                                    //rowsDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                    //rowsDiemDo.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND THAO_TACDL = 'SOHO'";
                                    ////rowsDDo.Sort = "NGAY_HLUC";
                                    //foreach (DataRowView drDDo in rowsDiemDo)
                                    //{
                                    //    if (Convert.ToDateTime(drGia["NGAY_HLUC"]) == Convert.ToDateTime(drDDo["NGAY_HLUC"]))
                                    //    {
                                    //        IsExistsThayDoiSoHo = 1;
                                    //        break;
                                    //    }
                                    //}
                                    //La row thay doi so ho
                                    if (IsExistsThayDoiSoHo == 1)
                                    {
                                        strID_BBANAGIA = strID_BBANAGIA + Convert.ToString(drGia["ID_BBANAGIA"]) + ",";
                                    }
                                }
                                if (strID_BBANAGIA != "")
                                {
                                    rowsBBGia.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND LOAI_BCS = '" + strBCS + "' AND ID_BBANAGIA NOT IN (" + strID_BBANAGIA.Substring(0, strID_BBANAGIA.Length - 1) + ")";
                                }
                            }
                        }
                        else
                        {
                            //Co SHBT nhom N
                            //rowsBBGia.RowFilter = "MA_DDO = '" + strMa_DDo + "' and LOAI_BCS = '" + strBCS + "'";
                            rowsBBGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        }

                        if (rowsBBGia.Count != 0)
                        {
                            ngay_hlucgiamin = DateTime.Parse(Convert.ToDateTime(rowsBBGia[0]["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            //Tim ngay hieu luc gia max con <= ngay dau 
                            //if (IsExistsSoHoParam == 1)
                            //{                                
                            foreach (DataRowView drGia in rowsBBGia)
                            {
                                ngay_hlucgia = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_hlucgia > ngay_dau)
                                    continue;
                                else
                                    if (ngay_hlucgia == ngay_dau)
                                {
                                    ngay_hlucgiamin = ngay_hlucgia;
                                    break;
                                }
                                else
                                {
                                    if (ngay_hlucgiamin < ngay_hlucgia)
                                        ngay_hlucgiamin = ngay_hlucgia;
                                }
                            }

                            //Tinh so ngay bien ban gia co CSC
                            songay_CSC = 0;
                            tong_slCSC_All = 0;
                            ngay_hluccu = ngay_dau;
                            //if (IsExistsSoHoParam == 1)
                            //{
                            foreach (DataRowView drGia in rowsBBGia)
                            {
                                ngay_hlucgia_temp = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                if (ngay_hlucgia_temp > ngay_cuoi)
                                    continue;

                                if (ngay_hlucgia_temp < ngay_dau)
                                    continue;

                                if (ngay_hlucgia_temp.Equals(ngay_hluccu))
                                    continue;
                                ngay_hlucgia = ngay_hlucgia_temp;
                                //Kiem tra trong GCS_CHISO
                                IsExists_CSC = 0;
                                tong_slCSC = 0;

                                //dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);

                                dwCSoChot.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = '" + strBCS + "'";
                                if (dwCSoChot.Count > 0)
                                {
                                    foreach (DataRowView drvCSC in dwCSoChot)
                                    {
                                        ngay_dkyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        ngay_ckyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (ngay_dkyCSC >= ngay_hluccu && ngay_ckyCSC < ngay_hlucgia)
                                        {
                                            if (Convert.ToString(drvCSC["LOAI_CHISO"]).Trim().ToUpper() == "CSC")
                                            {
                                                IsExists_CSC = 1;
                                            }
                                            tong_slCSC = tong_slCSC + Convert.ToDecimal(drvCSC["SAN_LUONG"]) + Convert.ToDecimal(drvCSC["SLUONG_TTIEP"]) - Convert.ToDecimal(drvCSC["SLUONG_TRPHU"]);
                                        }
                                    }
                                }

                                //Co ton tai CSC
                                if (IsExists_CSC == 1)
                                {
                                    songay_CSC = songay_CSC + Convert.ToDecimal(ngay_hlucgia.Subtract(ngay_hluccu).TotalDays);
                                    tong_slCSC_All = tong_slCSC_All + tong_slCSC;
                                }

                                ngay_hluccu = ngay_hlucgia;
                            }

                            //Tinh san luong cho tung khoang
                            sl_lt = 0;
                            sl_ct = 0;
                            ngay_hluccu = ngay_dau;
                            t2 = Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays);
                            ngay_hlucgia = ngay_hlucgiamin;
                            IsExists = 0;

                            //if (IsExistsSoHoParam == 1)
                            //{
                            foreach (DataRowView drGia in rowsBBGia)
                            {
                                ngay_hlucgia_temp = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                if (ngay_hlucgia_temp > ngay_cuoi)
                                    continue;

                                if (ngay_hlucgia_temp < ngay_dau)
                                    continue;

                                if (ngay_hlucgia_temp.Equals(ngay_hluccu))
                                    continue;
                                ngay_hlucgia = ngay_hlucgia_temp;
                                //Kiem tra xem co CSC hay khong trong GCS_CHISO va GCS_CHISO_GT
                                //dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCSoChot.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = '" + strBCS + "'";
                                //dwCSC.Sort = "NGAY_CKY, NGAY_DKY, ID_CHISO";
                                sl_CSC = 0;
                                IsExists_CSC = 0;
                                if (dwCSoChot.Count > 0)
                                {
                                    foreach (DataRowView drvCSC in dwCSoChot)
                                    {
                                        ngay_dkyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        ngay_ckyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (ngay_dkyCSC >= ngay_hluccu && ngay_ckyCSC < ngay_hlucgia)
                                        {
                                            sl_CSC = sl_CSC + Convert.ToDecimal(drvCSC["SAN_LUONG"]) + Convert.ToDecimal(drvCSC["SLUONG_TTIEP"]) - Convert.ToDecimal(drvCSC["SLUONG_TRPHU"]);
                                            if (Convert.ToString(drvCSC["LOAI_CHISO"]).Trim().ToUpper() == "CSC")
                                            {
                                                IsExists_CSC = 1;
                                            }
                                        }
                                    }
                                }

                                //Neu co CSC
                                if (IsExists_CSC == 1)
                                {
                                    sl_ct = sl_CSC;
                                }
                                else
                                {
                                    t1 = Convert.ToDecimal(ngay_hlucgia.Subtract(ngay_hluccu).TotalDays);
                                    //t3 = t1 / (t2 + 1 - songay_CSC);
                                    //sl_ct = Math.Round(t3 * (sl - tong_slCSC_All), 0, MidpointRounding.AwayFromZero);
                                    sl_ct = Math.Round((sl - tong_slCSC_All) * t1 / (t2 + 1 - songay_CSC), 0, MidpointRounding.AwayFromZero);
                                }

                                if (sl_ct != 0)
                                {
                                    //Tao du lieu trong SL_2                            
                                    drSan_Luong = dsCalculation.Tables["SL_2"].NewRow();
                                    drSan_Luong["MA_DVIQLY"] = drSL1["MA_DVIQLY"];
                                    drSan_Luong["MA_DDO"] = drSL1["MA_DDO"];
                                    drSan_Luong["MA_KHANG"] = drSL1["MA_KHANG"];
                                    drSan_Luong["ID_CHISO"] = drSL1["ID_CHISO"];
                                    drSan_Luong["ID_BCS"] = drSL1["ID_BCS"];
                                    drSan_Luong["BCS"] = drSL1["BCS"];
                                    drSan_Luong["SO_CTO"] = drSL1["SO_CTO"];
                                    drSan_Luong["NGAY_DAU"] = ngay_hluccu;
                                    drSan_Luong["NGAY_CUOI"] = ngay_hlucgia.AddDays(-1.0);
                                    drSan_Luong["SAN_LUONG"] = sl_ct;
                                    drSan_Luong["DTUONG_GIA"] = drSL1["DTUONG_GIA"];
                                    if (ngay_hluccu == ngay_dau)
                                        drSan_Luong["NGAY_HLUCGIA"] = ngay_hlucgiamin;
                                    else
                                        drSan_Luong["NGAY_HLUCGIA"] = ngay_hluccu;
                                    drSan_Luong["SO_NGAYDMUC"] = drSL1["SO_NGAYDMUC"];
                                    drSan_Luong["KY"] = drSL1["KY"];
                                    drSan_Luong["THANG"] = drSL1["THANG"];
                                    drSan_Luong["NAM"] = drSL1["NAM"];
                                    dsCalculation.Tables["SL_2"].Rows.Add(drSan_Luong);
                                }

                                //Chuan bi cho vong lap ke tiep
                                ngay_hluccu = ngay_hlucgia;
                                sl_lt += sl_ct;

                                IsExists = 1;
                            }

                            //Add dong cuoi cung
                            sl_ct = sl - sl_lt;
                            if (sl_ct != 0)
                            {
                                drSan_Luong = dsCalculation.Tables["SL_2"].NewRow();
                                drSan_Luong["MA_DVIQLY"] = drSL1["MA_DVIQLY"];
                                drSan_Luong["MA_DDO"] = drSL1["MA_DDO"];
                                drSan_Luong["MA_KHANG"] = drSL1["MA_KHANG"];
                                drSan_Luong["ID_CHISO"] = drSL1["ID_CHISO"];
                                drSan_Luong["ID_BCS"] = drSL1["ID_BCS"];
                                drSan_Luong["BCS"] = drSL1["BCS"];
                                drSan_Luong["SO_CTO"] = drSL1["SO_CTO"];
                                if (IsExists == 0)
                                    drSan_Luong["NGAY_DAU"] = ngay_dau;
                                else
                                    drSan_Luong["NGAY_DAU"] = ngay_hlucgia;
                                drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                drSan_Luong["SAN_LUONG"] = sl_ct;
                                drSan_Luong["DTUONG_GIA"] = drSL1["DTUONG_GIA"];
                                if (IsExists == 0)
                                    drSan_Luong["NGAY_HLUCGIA"] = ngay_hlucgiamin;
                                else
                                    drSan_Luong["NGAY_HLUCGIA"] = ngay_hlucgia;
                                drSan_Luong["SO_NGAYDMUC"] = drSL1["SO_NGAYDMUC"];
                                drSan_Luong["KY"] = drSL1["KY"];
                                drSan_Luong["THANG"] = drSL1["THANG"];
                                drSan_Luong["NAM"] = drSL1["NAM"];
                                dsCalculation.Tables["SL_2"].Rows.Add(drSan_Luong);
                            }
                        }
                        #endregion

                        if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true && dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            #region Diem do phu ghep tong khac so

                            //Xu ly ho ngheo SHBT nhom N
                            rowsBBGia_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBT' AND MA_NGIA = 'N'";

                            if (rowsBBGia_GT.Count == 0)
                            {
                                //Khong co SHBT nhom N
                                rowsBBGia_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and LOAI_BCS = '" + strBCS + "'";
                                //rowsGia.Sort = "NGAY_HLUC";

                                //Tien xu ly rowsGia trong truong hop chi lay 1 so ho
                                if (IsExistsSoHoParam == 0)
                                {
                                    strID_BBANAGIA = "";
                                    foreach (DataRowView drGia in rowsBBGia_GT)
                                    {
                                        IsExistsThayDoiSoHo = 0;
                                        //if (drGia["IS_SOHO"].ToString().Trim() == "1") IsExistsThayDoiSoHo = 1;
                                        DateTime ngay_hluc_soho = Convert.ToDateTime(drGia["NGAY_HLUC"]);
                                        if (Convert.ToInt32(drGia["IS_SOHO"]) > 0)
                                        {
                                            if (ngay_hluc_soho <= ngay_cuoi && ngay_hluc_soho > ngay_dau)
                                                //Co thay doi so ho
                                                IsExistsThayDoiSoHo = 1;
                                            else
                                                //Nam ngoai khoang
                                                IsExistsThayDoiSoHo = 0;
                                        }
                                        //rowsDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                                        //rowsDiemDo_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND THAO_TACDL = 'SOHO'";
                                        ////rowsDDo.Sort = "NGAY_HLUC";
                                        //foreach (DataRowView drDDo in rowsDiemDo_GT)
                                        //{
                                        //    if (Convert.ToDateTime(drGia["NGAY_HLUC"]) == Convert.ToDateTime(drDDo["NGAY_HLUC"]))
                                        //    {
                                        //        IsExistsThayDoiSoHo = 1;
                                        //        break;
                                        //    }
                                        //}
                                        //La row thay doi so ho
                                        if (IsExistsThayDoiSoHo == 1)
                                        {
                                            strID_BBANAGIA = strID_BBANAGIA + Convert.ToString(drGia["ID_BBANAGIA"]) + ",";
                                        }
                                    }
                                    if (strID_BBANAGIA != "")
                                    {
                                        rowsBBGia_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND LOAI_BCS = '" + strBCS + "' AND ID_BBANAGIA NOT IN (" + strID_BBANAGIA.Substring(0, strID_BBANAGIA.Length - 1) + ")";
                                    }
                                }
                                ////////
                            }
                            else
                            {
                                rowsBBGia_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and LOAI_BCS = '" + strBCS + "'";
                            }


                            if (rowsBBGia_GT.Count != 0)
                            {
                                ngay_hlucgiamin = DateTime.Parse(Convert.ToDateTime(rowsBBGia_GT[0]["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                //Tim ngay hieu luc gia max con <= ngay dau                        
                                //if (IsExistsSoHoParam == 1)
                                //{
                                foreach (DataRowView drGia in rowsBBGia_GT)
                                {
                                    ngay_hlucgia = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_hlucgia > ngay_dau)
                                        continue;
                                    else
                                        if (ngay_hlucgia == ngay_dau)
                                    {
                                        ngay_hlucgiamin = ngay_hlucgia;
                                        break;
                                    }
                                    else
                                    {
                                        if (ngay_hlucgiamin < ngay_hlucgia)
                                            ngay_hlucgiamin = ngay_hlucgia;
                                    }
                                }

                                //Tinh so ngay bien ban gia co CSC
                                songay_CSC = 0;
                                tong_slCSC_All = 0;
                                ngay_hluccu = ngay_dau;
                                //if (IsExistsSoHoParam == 1)
                                //{
                                foreach (DataRowView drGia in rowsBBGia_GT)
                                {
                                    ngay_hlucgia = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                    if (ngay_hlucgia > ngay_cuoi)
                                        continue;

                                    if (ngay_hlucgia < ngay_dau)
                                        continue;

                                    if (ngay_hlucgia.Equals(ngay_hluccu))
                                        continue;

                                    //Kiem tra trong GCS_CHISO
                                    IsExists_CSC = 0;
                                    tong_slCSC = 0;

                                    //dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCSoChot_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = '" + strBCS + "'";
                                    //dwCSC.Sort = "NGAY_CKY, NGAY_DKY, ID_CHISO";
                                    if (dwCSoChot_GT.Count > 0)
                                    {
                                        foreach (DataRowView drvCSC in dwCSoChot_GT)
                                        {
                                            ngay_dkyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_ckyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            if (ngay_dkyCSC >= ngay_hluccu && ngay_ckyCSC < ngay_hlucgia)
                                            {
                                                if (Convert.ToString(drvCSC["LOAI_CHISO"]).Trim().ToUpper() == "CSC")
                                                {
                                                    IsExists_CSC = 1;
                                                }
                                                tong_slCSC = tong_slCSC + Convert.ToDecimal(drvCSC["SAN_LUONG"]) + Convert.ToDecimal(drvCSC["SLUONG_TTIEP"]) - Convert.ToDecimal(drvCSC["SLUONG_TRPHU"]);
                                            }
                                        }
                                    }

                                    //Co ton tai CSC
                                    if (IsExists_CSC == 1)
                                    {
                                        songay_CSC = songay_CSC + Convert.ToDecimal(ngay_hlucgia.Subtract(ngay_hluccu).TotalDays);
                                        tong_slCSC_All = tong_slCSC_All + tong_slCSC;
                                    }

                                    ngay_hluccu = ngay_hlucgia;
                                }

                                //Tinh san luong cho tung khoang
                                sl_lt = 0;
                                sl_ct = 0;
                                ngay_hluccu = ngay_dau;
                                t2 = Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays);
                                ngay_hlucgia = ngay_hlucgiamin;
                                IsExists = 0;

                                //if (IsExistsSoHoParam == 1)
                                //{
                                foreach (DataRowView drGia in rowsBBGia_GT)
                                {
                                    ngay_hlucgia = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                    if (ngay_hlucgia > ngay_cuoi)
                                        continue;

                                    if (ngay_hlucgia < ngay_dau)
                                        continue;

                                    if (ngay_hlucgia.Equals(ngay_hluccu))
                                        continue;

                                    //Kiem tra xem co CSC hay khong trong GCS_CHISO va GCS_CHISO_GT
                                    //dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCSoChot_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = '" + strBCS + "'";
                                    //dwCSC.Sort = "NGAY_CKY, NGAY_DKY, ID_CHISO";
                                    sl_CSC = 0;
                                    IsExists_CSC = 0;
                                    if (dwCSoChot_GT.Count > 0)
                                    {
                                        foreach (DataRowView drvCSC in dwCSoChot_GT)
                                        {
                                            ngay_dkyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            ngay_ckyCSC = DateTime.Parse(Convert.ToDateTime(drvCSC["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            if (ngay_dkyCSC >= ngay_hluccu && ngay_ckyCSC < ngay_hlucgia)
                                            {
                                                sl_CSC = sl_CSC + Convert.ToDecimal(drvCSC["SAN_LUONG"]) + Convert.ToDecimal(drvCSC["SLUONG_TTIEP"]) - Convert.ToDecimal(drvCSC["SLUONG_TRPHU"]);
                                                if (Convert.ToString(drvCSC["LOAI_CHISO"]).Trim().ToUpper() == "CSC")
                                                {
                                                    IsExists_CSC = 1;
                                                }
                                            }
                                        }
                                    }

                                    //Neu co CSC
                                    if (IsExists_CSC == 1)
                                    {
                                        sl_ct = sl_CSC;
                                    }
                                    else
                                    {
                                        t1 = Convert.ToDecimal(ngay_hlucgia.Subtract(ngay_hluccu).TotalDays);
                                        //t3 = t1 / (t2 + 1 - songay_CSC);
                                        //sl_ct = Math.Round(t3 * (sl - tong_slCSC_All), 0, MidpointRounding.AwayFromZero);
                                        sl_ct = Math.Round((sl - tong_slCSC_All) * t1 / (t2 + 1 - songay_CSC), 0, MidpointRounding.AwayFromZero);
                                    }

                                    if (sl_ct != 0)
                                    {
                                        //Tao du lieu trong SL_2                            
                                        drSan_Luong = dsCalculation.Tables["SL_2"].NewRow();
                                        drSan_Luong["MA_DVIQLY"] = drSL1["MA_DVIQLY"];
                                        drSan_Luong["MA_DDO"] = drSL1["MA_DDO"];
                                        drSan_Luong["MA_KHANG"] = drSL1["MA_KHANG"];
                                        drSan_Luong["ID_CHISO"] = drSL1["ID_CHISO"];
                                        drSan_Luong["ID_BCS"] = drSL1["ID_BCS"];
                                        drSan_Luong["BCS"] = drSL1["BCS"];
                                        drSan_Luong["SO_CTO"] = drSL1["SO_CTO"];
                                        drSan_Luong["NGAY_DAU"] = ngay_hluccu;
                                        drSan_Luong["NGAY_CUOI"] = ngay_hlucgia.AddDays(-1.0);
                                        drSan_Luong["SAN_LUONG"] = sl_ct;
                                        drSan_Luong["DTUONG_GIA"] = drSL1["DTUONG_GIA"];
                                        if (ngay_hluccu == ngay_dau)
                                            drSan_Luong["NGAY_HLUCGIA"] = ngay_hlucgiamin;
                                        else
                                            drSan_Luong["NGAY_HLUCGIA"] = ngay_hluccu;
                                        drSan_Luong["SO_NGAYDMUC"] = drSL1["SO_NGAYDMUC"];
                                        drSan_Luong["KY"] = drSL1["KY"];
                                        drSan_Luong["THANG"] = drSL1["THANG"];
                                        drSan_Luong["NAM"] = drSL1["NAM"];
                                        dsCalculation.Tables["SL_2"].Rows.Add(drSan_Luong);
                                    }

                                    //Chuan bi cho vong lap ke tiep
                                    ngay_hluccu = ngay_hlucgia;
                                    sl_lt += sl_ct;

                                    IsExists = 1;
                                }

                                //Add dong cuoi cung
                                sl_ct = sl - sl_lt;
                                if (sl_ct != 0)
                                {
                                    drSan_Luong = dsCalculation.Tables["SL_2"].NewRow();
                                    drSan_Luong["MA_DVIQLY"] = drSL1["MA_DVIQLY"];
                                    drSan_Luong["MA_DDO"] = drSL1["MA_DDO"];
                                    drSan_Luong["MA_KHANG"] = drSL1["MA_KHANG"];
                                    drSan_Luong["ID_CHISO"] = drSL1["ID_CHISO"];
                                    drSan_Luong["ID_BCS"] = drSL1["ID_BCS"];
                                    drSan_Luong["BCS"] = drSL1["BCS"];
                                    drSan_Luong["SO_CTO"] = drSL1["SO_CTO"];
                                    if (IsExists == 0)
                                        drSan_Luong["NGAY_DAU"] = ngay_dau;
                                    else
                                        drSan_Luong["NGAY_DAU"] = ngay_hlucgia;
                                    drSan_Luong["NGAY_CUOI"] = ngay_cuoi;
                                    drSan_Luong["SAN_LUONG"] = sl_ct;
                                    drSan_Luong["DTUONG_GIA"] = drSL1["DTUONG_GIA"];
                                    if (IsExists == 0)
                                        drSan_Luong["NGAY_HLUCGIA"] = ngay_hlucgiamin;
                                    else
                                        drSan_Luong["NGAY_HLUCGIA"] = ngay_hlucgia;
                                    drSan_Luong["SO_NGAYDMUC"] = drSL1["SO_NGAYDMUC"];
                                    drSan_Luong["KY"] = drSL1["KY"];
                                    drSan_Luong["THANG"] = drSL1["THANG"];
                                    drSan_Luong["NAM"] = drSL1["NAM"];
                                    dsCalculation.Tables["SL_2"].Rows.Add(drSan_Luong);
                                }
                            }
                            #endregion
                        }
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_2: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }

        //Tinh san luong chi tiet theo bien dong doi gia nha nuoc
        public string DetailDataCalculation_21(DS_CALCULATIONTABLES dsCalculation, DataSet dsCustomerData, DataSet dsStaticCatalog)
        {
            try
            {
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_2") == false)
                    return "NotExistsSL_2";

                if (dsStaticCatalog == null)
                    return "dsStaticCatalogIsNull";
                else
                    if (dsStaticCatalog.Tables.Contains("D_GIA_NHOMNN") == false)
                    return "NotExistsD_GIA_NHOMNN";
                else
                        if (dsStaticCatalog.Tables.Contains("D_THAMCHIEU_CAPDA") == false)
                    return "NotExistsD_THAMCHIEU_CAPDA";

                string strMa_DDo = "", strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";
                DateTime ngay_hlucgia = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_dau = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                Decimal IsChangePrice = 0, sl = 0, sl_ct = 0;
                DataRow drSL_New;

                DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                dwGia.Sort = "NGAY_HLUC";

                DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                DataView dwSL2 = new DataView(dsCalculation.Tables["SL_2"]);

                #region Diem do chinh
                foreach (DataRowView drSL2 in dwSL2)
                {
                    strMa_DDo = Convert.ToString(drSL2["MA_DDO"]);
                    ngay_dau = Convert.ToDateTime(drSL2["NGAY_DAU"]);
                    ngay_cuoi = Convert.ToDateTime(drSL2["NGAY_CUOI"]);
                    IsChangePrice = 0;
                    //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                    ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'").Length != 0)
                    {
                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length == 0)
                        {
                            ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'"));
                        }
                    }
                    else
                    {
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'").Length != 0)
                            {
                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length == 0)
                                {
                                    ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'"));
                                }
                            }
                        }
                    }

                    //Kiem tra thay doi gia nha nuoc hay khong
                    dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                    foreach (DataRowView drwGia in dwGia)
                    {
                        ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                        if (Convert.ToDateTime(drSL2["NGAY_HLUCGIA"]) == ngay_hlucgia)
                        {
                            //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                            strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                            strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                            strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                            strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                            strKhoang_DAp = "";

                            //Tim khoang tham chieu cap dien ap
                            dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                            foreach (DataRowView drCapDA in dwTChieuDA)
                            {
                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                {
                                    if (ngay_ckymax == ngay_hluc)
                                    {
                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                        //se tinh toan bo vao bac thang cua bang gia cu
                                        continue;
                                    }
                                }

                                if (ngay_cuoi >= ngay_hluc)
                                {
                                    strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                    break;
                                }
                            }

                            if (strKhoang_DAp != "")
                            {
                                dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                foreach (DataRowView drGia in dwGiaNhomNN)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                    {
                                        if (ngay_ckymax == ngay_hluc)
                                        {
                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                            //se tinh toan bo vao bac thang cua bang gia cu
                                            continue;
                                        }
                                    }

                                    if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                    {
                                        //Co doi gia
                                        IsChangePrice = 1;
                                        break;
                                    }
                                }
                            }

                            if (IsChangePrice == 1)
                            {
                                break;
                            }
                        }
                    }

                    //Bo sung 22/12/2012: Neu co chot chi so se phan 2 khoang gia cu gia moi
                    //if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length != 0)
                    //{
                    //    IsChangePrice = 1;
                    //}

                    if (IsChangePrice == 1)
                    {
                        if (strMa_DDo == "PQ02000199268001")
                        {
                            strMa_DDo = "PQ02000199268001";
                        }

                        //Tach san luong
                        sl = Convert.ToDecimal(drSL2["SAN_LUONG"]);
                        sl_ct = Math.Round(sl * Convert.ToDecimal(ngay_hluc.Subtract(ngay_dau).TotalDays) / Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1), 0, MidpointRounding.AwayFromZero);

                        drSL2["SAN_LUONG"] = sl_ct;
                        drSL2["NGAY_DAU"] = ngay_dau;
                        drSL2["NGAY_CUOI"] = ngay_hluc.AddDays(-1.0);

                        drSL_New = dsCalculation.Tables["SL_2"].NewRow();
                        drSL_New.ItemArray = drSL2.Row.ItemArray;
                        drSL_New["SAN_LUONG"] = sl - sl_ct;
                        drSL_New["NGAY_DAU"] = ngay_hluc;
                        drSL_New["NGAY_CUOI"] = ngay_cuoi;
                        dsCalculation.Tables["SL_2"].Rows.Add(drSL_New);
                    }
                }
                #endregion

                #region Diem do phu ghep tong
                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                {
                    dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                    dwGia.Sort = "NGAY_HLUC";

                    foreach (DataRowView drSL2 in dwSL2)
                    {
                        strMa_DDo = Convert.ToString(drSL2["MA_DDO"]);
                        ngay_dau = Convert.ToDateTime(drSL2["NGAY_DAU"]);
                        ngay_cuoi = Convert.ToDateTime(drSL2["NGAY_CUOI"]);
                        IsChangePrice = 0;
                        //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                        ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'").Length != 0)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length == 0)
                            {
                                ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'and LOAI_CHISO = 'DDK'"));
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'").Length != 0)
                                {
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length == 0)
                                    {
                                        ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'DDK'"));
                                    }
                                }
                            }
                        }

                        //Kiem tra thay doi gia nha nuoc hay khong
                        dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        foreach (DataRowView drwGia in dwGia)
                        {
                            ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                            if (Convert.ToDateTime(drSL2["NGAY_HLUCGIA"]) == ngay_hlucgia)
                            {
                                //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                strKhoang_DAp = "";

                                //Tim khoang tham chieu cap dien ap
                                dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                foreach (DataRowView drCapDA in dwTChieuDA)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                    {
                                        if (ngay_ckymax == ngay_hluc)
                                        {
                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                            //se tinh toan bo vao bac thang cua bang gia cu
                                            continue;
                                        }
                                    }

                                    if (ngay_cuoi >= ngay_hluc)
                                    {
                                        strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                        break;
                                    }
                                }

                                if (strKhoang_DAp != "")
                                {
                                    dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                    foreach (DataRowView drGia in dwGiaNhomNN)
                                    {
                                        ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (ngay_ckymax != DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
                                        {
                                            if (ngay_ckymax == ngay_hluc)
                                            {
                                                //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                //se tinh toan bo vao bac thang cua bang gia cu
                                                continue;
                                            }
                                        }

                                        if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                        {
                                            //Co doi gia
                                            IsChangePrice = 1;
                                            break;
                                        }
                                    }
                                }

                                if (IsChangePrice == 1)
                                {
                                    break;
                                }
                            }
                        }

                        //Bo sung 22/12/2012: Neu co chot chi so se phan 2 khoang gia cu gia moi
                        //if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' and LOAI_CHISO = 'CCS'").Length != 0)
                        //{
                        //    IsChangePrice = 1;
                        //}

                        if (IsChangePrice == 1)
                        {
                            //Tach san luong
                            sl = Convert.ToDecimal(drSL2["SAN_LUONG"]);
                            sl_ct = Math.Round(sl * Convert.ToDecimal(ngay_hluc.Subtract(ngay_dau).TotalDays) / Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1), 0, MidpointRounding.AwayFromZero);

                            drSL2["SAN_LUONG"] = sl_ct;
                            drSL2["NGAY_DAU"] = ngay_dau;
                            drSL2["NGAY_CUOI"] = ngay_hluc.AddDays(-1.0);

                            drSL_New = dsCalculation.Tables["SL_2"].NewRow();
                            drSL_New.ItemArray = drSL2.Row.ItemArray;
                            drSL_New["SAN_LUONG"] = sl - sl_ct;
                            drSL_New["NGAY_DAU"] = ngay_hluc;
                            drSL_New["NGAY_CUOI"] = ngay_cuoi;
                            dsCalculation.Tables["SL_2"].Rows.Add(drSL_New);
                        }
                    }
                }
                #endregion

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_21: " + ex.Message;
            }
        }

        //Tinh san luong chi tiet theo tung doi tuong trong bien ban gia
        public string DetailDataCalculation_3(DS_CALCULATIONTABLES dsCalculation, DataSet dsCustomerData, DataSet dsStaticCatalog)
        {
            string strMa_DDo = "";
            try
            {
                string strBCS = "";
                DateTime ngay_hlucgia, ngay_dau, ngay_cuoi, ngay_hlucgiamax, ngay_hluccsmin;
                DataView dw, dwGiaNgayHLuc, dwGiaSTT, dwGiaNgayHLuc_GT, dwGiaSTT_GT, dwBThang;
                Decimal sl = 0, sl_ct = 0, sl_lt = 0;
                Decimal so_ngaydmuc = 0, t1 = 0, tong_slKWH = 0;
                string loai_dmuc = "", dinh_muc = "";
                DataRow drSan_Luong;
                DataRow[] rowsGiaC;
                Decimal ExistsC = 0;
                Int64 MaxID_BBANAGIA = 0;
                Int16 IsExistsSoHoParam = 0; //La bien kiem tra tinh so ho dinh muc theo ca thang hay la chi tiet cho tungf lan thay doi so ho
                Decimal decSoHo = 0, decSoHo_N = 0; //Bo sung them tinh so ho cho ho ngheo, ho thu nhap thap

                //Tach san luong chi tiet theo tung doi tuong trong bien ban gia
                //Day du lieu vao bang SL_3
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_2") == false)
                    return "NotExistsSL_2";
                else
                        if (dsCalculation.Tables.Contains("SL_3") == false)
                    return "NotExistsSL_3";

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull";
                else
                    if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == false)
                    return "NotExistsHDG_BBAN_APGIA";

                //Kiem tra bien G_SOHO, neu la C thi moi coi la tinh chi tiet cho cac lan thay doi so ho trong 1 thang
                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                {
                    if (dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_SOHO' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')").Length > 0)
                    {
                        IsExistsSoHoParam = 1; //Tinh chi tiet cho cac lan thay doi so ho trong thang
                    }
                    else
                    {
                        IsExistsSoHoParam = 0;
                    }
                }
                else
                {
                    IsExistsSoHoParam = 0;
                }

                //Khoi tao cac dataview
                dwGiaNgayHLuc = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                if (dwGiaNgayHLuc.Count != 0)
                {
                    dwGiaNgayHLuc.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwGiaNgayHLuc[0]["MA_DVIQLY"]) + "'";
                }
                dwGiaNgayHLuc.Sort = "MA_DVIQLY, MA_DDO, NGAY_HLUC DESC, ID_BBANAGIA";

                dwGiaSTT = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                if (dwGiaSTT.Count != 0)
                {
                    dwGiaSTT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwGiaSTT[0]["MA_DVIQLY"]) + "'";
                }
                dwGiaSTT.Sort = "MA_DVIQLY, MA_DDO, LOAI_BCS, SO_THUTU, ID_BBANAGIA"; //PRIORITY dung de sua loi do phan chuyen doi du lieu gay ra

                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                {
                    dwGiaNgayHLuc_GT = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                    if (dwGiaNgayHLuc_GT.Count != 0)
                    {
                        dwGiaNgayHLuc_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwGiaNgayHLuc_GT[0]["MA_DVIQLY"]) + "'";
                    }
                    dwGiaNgayHLuc_GT.Sort = "MA_DVIQLY, MA_DDO, NGAY_HLUC DESC, ID_BBANAGIA";

                    dwGiaSTT_GT = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                    if (dwGiaSTT_GT.Count != 0)
                    {
                        dwGiaSTT_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwGiaSTT_GT[0]["MA_DVIQLY"]) + "'";
                    }
                    dwGiaSTT_GT.Sort = "MA_DVIQLY, MA_DDO, LOAI_BCS, SO_THUTU, ID_BBANAGIA"; //PRIORITY dung de sua loi do phan chuyen doi du lieu gay ra
                }
                else
                {
                    dwGiaNgayHLuc_GT = null;
                    dwGiaSTT_GT = null;
                }

                dwBThang = new DataView(dsStaticCatalog.Tables["D_BAC_THANG"]);
                dwBThang.RowFilter = "MA_NHOMNN = 'SHBT' AND MA_NGIA = 'A'";
                dwBThang.Sort = "NGAY_HLUC DESC";

                foreach (DataRow drSL2 in dsCalculation.Tables["SL_2"].Rows)
                {
                    //Dũng NT bổ sung thêm biến lưu ngày hiệu lực nhóm bậc thang A để so sánh với nhóm N
                    DateTime ngay_hluc_A = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));

                    //Khoi tao du lieu                    
                    strMa_DDo = Convert.ToString(drSL2["MA_DDO"]);
                    if (strMa_DDo == "PD11000028685002")
                    {
                        strMa_DDo = "PD11000028685002";
                    }
                    strBCS = Convert.ToString(drSL2["BCS"]);
                    ngay_hlucgia = Convert.ToDateTime(drSL2["NGAY_HLUCGIA"]);
                    sl = Convert.ToDecimal(drSL2["SAN_LUONG"]);
                    ngay_dau = Convert.ToDateTime(drSL2["NGAY_DAU"]);
                    ngay_cuoi = Convert.ToDateTime(drSL2["NGAY_CUOI"]);
                    so_ngaydmuc = Convert.ToDecimal(drSL2["SO_NGAYDMUC"]);
                    sl_lt = 0;
                    ExistsC = 0;
                    tong_slKWH = 0;

                    #region Diem do chinh ghep tong, diem do phu ghep tong cung so, diem do khong ghep tong
                    if (IsExistsSoHoParam == 0)
                    {
                        //dw = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                        dwGiaNgayHLuc.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        //dw.Sort = "MA_DVIQLY, MA_DDO, NGAY_HLUC DESC, ID_BBANAGIA";
                        if (dwGiaNgayHLuc.Count != 0)
                        {
                            //Tim so ho ung voi ngay hieu luc gia lon nhat, co nhom thuoc bac thang
                            DataRow[] arrCS = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD')");
                            if (arrCS != null && arrCS.Length > 0)
                                ngay_hluccsmin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD')"));
                            else
                                ngay_hluccsmin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD')"));
                            ngay_hlucgiamax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                            foreach (DataRowView drw in dwGiaNgayHLuc)
                            {
                                if (Convert.ToDateTime(drw["NGAY_HLUC"]) <= ngay_hluccsmin)
                                {
                                    ngay_hlucgiamax = Convert.ToDateTime(drw["NGAY_HLUC"]);
                                    break;
                                }
                            }

                            decSoHo = 0;
                            foreach (DataRowView drw in dwGiaNgayHLuc)
                            {
                                //Tim bien ban ap gia lon nhat co MA_NHOMNN la bac thang trong ky tinh hoa don
                                if (Convert.ToDateTime(drw["NGAY_HLUC"]) >= ngay_hlucgiamax)
                                {
                                    //dwGiaBT = new DataView(dsStaticCatalog.Tables["D_BAC_THANG"]);
                                    dwBThang.RowFilter = "MA_NHOMNN = '" + Convert.ToString(drw["MA_NHOMNN"]) + "' AND MA_NGIA <> 'N' AND MA_NGIA = '" + Convert.ToString(drw["MA_NGIA"]) + "'";
                                    //dwGiaBT.Sort = "NGAY_HLUC DESC";

                                    if (dwBThang.Count != 0)
                                    {
                                        decSoHo = 0;
                                        foreach (DataRowView drwGiaBT in dwBThang)
                                        {
                                            if (Convert.ToDateTime(drwGiaBT["NGAY_HLUC"]) <= ngay_cuoi)
                                            {
                                                decSoHo = Convert.ToDecimal(drw["SO_HO"]);
                                                ngay_hluc_A = Convert.ToDateTime(drw["NGAY_HLUC"]);
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                                else
                                {
                                    break;
                                }
                            }

                            //Bo sung doan tinh so ho ngheo rieng de cap nhat thong tin so ho
                            decSoHo_N = 0;
                            foreach (DataRowView drw in dwGiaNgayHLuc)
                            {
                                //Tim bien ban ap gia lon nhat co MA_NHOMNN la bac thang trong ky tinh hoa don
                                if (Convert.ToDateTime(drw["NGAY_HLUC"]) >= ngay_hlucgiamax)
                                {
                                    //dwGiaBT = new DataView(dsStaticCatalog.Tables["D_BAC_THANG"]);
                                    dwBThang.RowFilter = "MA_NHOMNN = '" + Convert.ToString(drw["MA_NHOMNN"]) + "' AND MA_NGIA = 'N' AND MA_NGIA = '" + Convert.ToString(drw["MA_NGIA"]) + "'";
                                    //dwGiaBT.Sort = "NGAY_HLUC DESC";

                                    if (dwBThang.Count != 0)
                                    {
                                        decSoHo_N = 0;
                                        foreach (DataRowView drwGiaBT in dwBThang)
                                        {
                                            if (Convert.ToDateTime(drwGiaBT["NGAY_HLUC"]) <= ngay_cuoi)
                                            {
                                                decSoHo_N = Convert.ToDecimal(drw["SO_HO"]);
                                                if (decSoHo_N != decSoHo && decSoHo != 0)//có cả nhóm N và nhóm A
                                                {
                                                    if (Convert.ToDateTime(drw["NGAY_HLUC"]) <= ngay_hluc_A)
                                                    {
                                                        //Lấy theo số hộ nhóm A
                                                        decSoHo_N = decSoHo;
                                                    }
                                                }
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                                else
                                {
                                    break;
                                }
                            }
                        }
                        else
                        {
                            decSoHo = 0;
                            decSoHo_N = 0;
                        }
                    }
                    else
                    {
                        decSoHo = 0;
                        decSoHo_N = 0;
                    }

                    //dw = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                    //dw.Sort = "MA_DVIQLY, MA_DDO, LOAI_BCS, SO_THUTU, ID_BBANAGIA"; //PRIORITY dung de sua loi do phan chuyen doi du lieu gay ra
                    if (decSoHo_N != 0)
                    {
                        dwGiaSTT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                    }
                    else
                    {
                        dwGiaSTT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND LOAI_BCS = '" + strBCS + "'";
                    }

                    if (dwGiaSTT.Count > 0)
                    {
                        //Xu ly rieng cho LOAI_DINHMUC = KWH 
                        foreach (DataRowView drGia in dwGiaSTT)
                        {
                            if (Convert.ToDateTime(drGia["NGAY_HLUC"]) == ngay_hlucgia && Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper() == "KWH")
                            {
                                loai_dmuc = Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper();
                                dinh_muc = Convert.ToString(drGia["DINH_MUC"]).Trim().ToUpper();

                                t1 = Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1);
                                //t2 = Convert.ToDecimal(t1 / so_ngaydmuc);
                                //sl_ct = Math.Round(t2 * Convert.ToDecimal(dinh_muc), 0, MidpointRounding.AwayFromZero);
                                sl_ct = Math.Round(Convert.ToDecimal(dinh_muc) * t1 / so_ngaydmuc, 0, MidpointRounding.AwayFromZero);
                                //So sanh voi tong san luong chung
                                if (sl_ct > sl - sl_lt)
                                {
                                    sl_ct = sl - sl_lt;
                                    //sl = 0;
                                }

                                tong_slKWH = tong_slKWH + sl_ct;
                                sl_lt += sl_ct;

                                if (sl_ct != 0)
                                {
                                    drSan_Luong = dsCalculation.Tables["SL_3"].NewRow();
                                    drSan_Luong["MA_DVIQLY"] = drSL2["MA_DVIQLY"];
                                    drSan_Luong["MA_DDO"] = drSL2["MA_DDO"];
                                    drSan_Luong["MA_KHANG"] = drSL2["MA_KHANG"];
                                    drSan_Luong["ID_CHISO"] = drSL2["ID_CHISO"];
                                    drSan_Luong["ID_BCS"] = drSL2["ID_BCS"];
                                    drSan_Luong["BCS"] = drSL2["BCS"];
                                    drSan_Luong["SO_CTO"] = drSL2["SO_CTO"];
                                    drSan_Luong["NGAY_DAU"] = drSL2["NGAY_DAU"];
                                    drSan_Luong["NGAY_CUOI"] = drSL2["NGAY_CUOI"];
                                    drSan_Luong["SAN_LUONG"] = sl_ct;
                                    drSan_Luong["DTUONG_GIA"] = drSL2["DTUONG_GIA"];
                                    drSan_Luong["NGAY_HLUCGIA"] = drSL2["NGAY_HLUCGIA"];
                                    drSan_Luong["SO_NGAYDMUC"] = drSL2["SO_NGAYDMUC"];
                                    drSan_Luong["KY"] = drSL2["KY"];
                                    drSan_Luong["THANG"] = drSL2["THANG"];
                                    drSan_Luong["NAM"] = drSL2["NAM"];

                                    drSan_Luong["SO_THUTU"] = drGia["SO_THUTU"];
                                    if (loai_dmuc == "" && dinh_muc == "")
                                    {
                                        drSan_Luong["DINH_MUC"] = "100";
                                        drSan_Luong["LOAI_DMUC"] = "%";
                                    }
                                    else
                                    {
                                        if (dinh_muc == "")
                                            drSan_Luong["DINH_MUC"] = "";
                                        else
                                            drSan_Luong["DINH_MUC"] = drGia["DINH_MUC"];
                                        if (loai_dmuc == "")
                                            drSan_Luong["LOAI_DMUC"] = "";
                                        else
                                            drSan_Luong["LOAI_DMUC"] = drGia["LOAI_DMUC"];
                                    }
                                    drSan_Luong["TGIAN_BDIEN"] = drGia["TGIAN_BDIEN"];
                                    drSan_Luong["MA_NHOMNN"] = drGia["MA_NHOMNN"];
                                    drSan_Luong["MA_NGIA"] = drGia["MA_NGIA"];
                                    drSan_Luong["MA_NN"] = drGia["MA_NN"];
                                    if (IsExistsSoHoParam == 1)
                                    {
                                        drSan_Luong["SO_HO"] = drGia["SO_HO"];
                                    }
                                    else
                                    {
                                        if (Convert.ToString(drGia["MA_NGIA"]) == "N")
                                        {
                                            drSan_Luong["SO_HO"] = decSoHo_N;
                                        }
                                        else
                                        {
                                            drSan_Luong["SO_HO"] = decSoHo;
                                        }
                                    }
                                    drSan_Luong["MA_CAPDAP"] = drGia["MA_CAPDAP"];
                                    drSan_Luong["ID_BBANAGIA"] = drGia["ID_BBANAGIA"];

                                    dsCalculation.Tables["SL_3"].Rows.Add(drSan_Luong);
                                }

                            }
                        }

                        //Xu ly cho cac truong hop khong phai KWH
                        foreach (DataRowView drGia in dwGiaSTT)
                        {
                            if (Convert.ToDateTime(drGia["NGAY_HLUC"]) == ngay_hlucgia && Convert.ToString(drGia["LOAI_BCS"]) == strBCS)
                            {
                                //Luu lai Max ID_BBANAGIA de lam tron do sai so
                                MaxID_BBANAGIA = Convert.ToInt64(drGia["ID_BBANAGIA"]);

                                if (Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper() != "KWH")
                                {
                                    //Kiem tra loai dinh muc
                                    loai_dmuc = Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper();
                                    dinh_muc = Convert.ToString(drGia["DINH_MUC"]).Trim().ToUpper();
                                    switch (loai_dmuc)
                                    {
                                        case "":
                                            {
                                                if (dinh_muc == "")
                                                    //la 100% san luong
                                                    sl_ct = sl - tong_slKWH;
                                                else
                                                    if (dinh_muc == "C")
                                                {
                                                    ExistsC = Convert.ToDecimal(drGia["ID_BBANAGIA"]);
                                                    sl_ct = 0;
                                                }
                                                else
                                                    sl_ct = 0;
                                            }
                                            break;
                                        case "%":
                                            {
                                                sl_ct = Math.Round(Convert.ToDecimal((sl - tong_slKWH) * Convert.ToDecimal(dinh_muc) / 100), 0, MidpointRounding.AwayFromZero);
                                            }
                                            break;
                                            //case "KWH":
                                            //    {
                                            //        t1 = Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1);
                                            //        t2 = Convert.ToDecimal(t1 / so_ngaydmuc);
                                            //        sl_ct = Math.Round(t2 * Convert.ToDecimal(dinh_muc), 0);
                                            //    }
                                            //    break;
                                    }

                                    if (loai_dmuc == "" && dinh_muc == "C")
                                        continue;
                                    else
                                    {
                                        if (sl_ct > sl - sl_lt)
                                        {
                                            sl_ct = sl - sl_lt;
                                        }

                                        sl_lt += sl_ct;
                                        if (sl_ct != 0)
                                        {
                                            drSan_Luong = dsCalculation.Tables["SL_3"].NewRow();
                                            drSan_Luong["MA_DVIQLY"] = drSL2["MA_DVIQLY"];
                                            drSan_Luong["MA_DDO"] = drSL2["MA_DDO"];
                                            drSan_Luong["MA_KHANG"] = drSL2["MA_KHANG"];
                                            drSan_Luong["ID_CHISO"] = drSL2["ID_CHISO"];
                                            drSan_Luong["ID_BCS"] = drSL2["ID_BCS"];
                                            drSan_Luong["BCS"] = drSL2["BCS"];
                                            drSan_Luong["SO_CTO"] = drSL2["SO_CTO"];
                                            drSan_Luong["NGAY_DAU"] = drSL2["NGAY_DAU"];
                                            drSan_Luong["NGAY_CUOI"] = drSL2["NGAY_CUOI"];
                                            drSan_Luong["SAN_LUONG"] = sl_ct;
                                            drSan_Luong["DTUONG_GIA"] = drSL2["DTUONG_GIA"];
                                            drSan_Luong["NGAY_HLUCGIA"] = drSL2["NGAY_HLUCGIA"];
                                            drSan_Luong["SO_NGAYDMUC"] = drSL2["SO_NGAYDMUC"];
                                            drSan_Luong["KY"] = drSL2["KY"];
                                            drSan_Luong["THANG"] = drSL2["THANG"];
                                            drSan_Luong["NAM"] = drSL2["NAM"];

                                            drSan_Luong["SO_THUTU"] = drGia["SO_THUTU"];
                                            if (loai_dmuc == "" && dinh_muc == "")
                                            {
                                                drSan_Luong["DINH_MUC"] = "100";
                                                drSan_Luong["LOAI_DMUC"] = "%";
                                            }
                                            else
                                            {
                                                if (dinh_muc == "")
                                                    drSan_Luong["DINH_MUC"] = "";
                                                else
                                                    drSan_Luong["DINH_MUC"] = drGia["DINH_MUC"];
                                                if (loai_dmuc == "")
                                                    drSan_Luong["LOAI_DMUC"] = "";
                                                else
                                                    drSan_Luong["LOAI_DMUC"] = drGia["LOAI_DMUC"];
                                            }
                                            drSan_Luong["TGIAN_BDIEN"] = drGia["TGIAN_BDIEN"];
                                            drSan_Luong["MA_NHOMNN"] = drGia["MA_NHOMNN"];
                                            drSan_Luong["MA_NGIA"] = drGia["MA_NGIA"];
                                            drSan_Luong["MA_NN"] = drGia["MA_NN"];
                                            //drSan_Luong["SO_HO"] = drGia["SO_HO"];
                                            if (IsExistsSoHoParam == 1)
                                            {
                                                drSan_Luong["SO_HO"] = drGia["SO_HO"];
                                            }
                                            else
                                            {
                                                if (Convert.ToString(drGia["MA_NGIA"]) == "N")
                                                {
                                                    drSan_Luong["SO_HO"] = decSoHo_N;
                                                }
                                                else
                                                {
                                                    drSan_Luong["SO_HO"] = decSoHo;
                                                }
                                            }
                                            drSan_Luong["MA_CAPDAP"] = drGia["MA_CAPDAP"];
                                            drSan_Luong["ID_BBANAGIA"] = drGia["ID_BBANAGIA"];

                                            dsCalculation.Tables["SL_3"].Rows.Add(drSan_Luong);
                                        }
                                    }
                                }
                            }
                        }

                        //Them thanh phan gia C (neu co)
                        if (ExistsC != 0)
                        {
                            if (sl > sl_lt)
                            {
                                //Chi them neu con san luong
                                drSan_Luong = dsCalculation.Tables["SL_3"].NewRow();
                                drSan_Luong["MA_DVIQLY"] = drSL2["MA_DVIQLY"];
                                drSan_Luong["MA_DDO"] = drSL2["MA_DDO"];
                                drSan_Luong["MA_KHANG"] = drSL2["MA_KHANG"];
                                drSan_Luong["ID_CHISO"] = drSL2["ID_CHISO"];
                                drSan_Luong["ID_BCS"] = drSL2["ID_BCS"];
                                drSan_Luong["BCS"] = drSL2["BCS"];
                                drSan_Luong["SO_CTO"] = drSL2["SO_CTO"];
                                drSan_Luong["NGAY_DAU"] = drSL2["NGAY_DAU"];
                                drSan_Luong["NGAY_CUOI"] = drSL2["NGAY_CUOI"];
                                drSan_Luong["SAN_LUONG"] = sl - sl_lt;
                                drSan_Luong["DTUONG_GIA"] = drSL2["DTUONG_GIA"];
                                drSan_Luong["NGAY_HLUCGIA"] = drSL2["NGAY_HLUCGIA"];
                                drSan_Luong["SO_NGAYDMUC"] = drSL2["SO_NGAYDMUC"];
                                drSan_Luong["KY"] = drSL2["KY"];
                                drSan_Luong["THANG"] = drSL2["THANG"];
                                drSan_Luong["NAM"] = drSL2["NAM"];

                                rowsGiaC = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_BCS = '" + strBCS + "' AND ID_BBANAGIA = " + ExistsC);

                                drSan_Luong["SO_THUTU"] = rowsGiaC[0]["SO_THUTU"];
                                drSan_Luong["DINH_MUC"] = rowsGiaC[0]["DINH_MUC"];
                                if (Convert.ToString(rowsGiaC[0]["LOAI_DMUC"]).Trim().ToUpper() == "")
                                    drSan_Luong["LOAI_DMUC"] = "";
                                else
                                    drSan_Luong["LOAI_DMUC"] = rowsGiaC[0]["LOAI_DMUC"];
                                drSan_Luong["TGIAN_BDIEN"] = rowsGiaC[0]["TGIAN_BDIEN"];
                                drSan_Luong["MA_NHOMNN"] = rowsGiaC[0]["MA_NHOMNN"];
                                drSan_Luong["MA_NGIA"] = rowsGiaC[0]["MA_NGIA"];
                                drSan_Luong["MA_NN"] = rowsGiaC[0]["MA_NN"];
                                //drSan_Luong["SO_HO"] = rowsGiaC[0]["SO_HO"];
                                if (IsExistsSoHoParam == 1)
                                {
                                    drSan_Luong["SO_HO"] = rowsGiaC[0]["SO_HO"];
                                }
                                else
                                {
                                    if (Convert.ToString(rowsGiaC[0]["MA_NGIA"]) == "N")
                                    {
                                        drSan_Luong["SO_HO"] = decSoHo_N;
                                    }
                                    else
                                    {
                                        drSan_Luong["SO_HO"] = decSoHo;
                                    }
                                }
                                drSan_Luong["MA_CAPDAP"] = rowsGiaC[0]["MA_CAPDAP"];
                                drSan_Luong["ID_BBANAGIA"] = rowsGiaC[0]["ID_BBANAGIA"];

                                dsCalculation.Tables["SL_3"].Rows.Add(drSan_Luong);
                            }
                        }
                        else
                        {
                            //Khong ton tai thanh phan C. Thuc hien lam tron cho chi tiet cuoi cung MaxID_BBANAGIA
                            foreach (DataRow drSL3 in dsCalculation.Tables["SL_3"].Rows)
                            {
                                if (Convert.ToString(drSL3["MA_DDO"]) == strMa_DDo && Convert.ToString(drSL3["BCS"]) == strBCS && Convert.ToDateTime(drSL3["NGAY_DAU"]) == ngay_dau && Convert.ToDateTime(drSL3["NGAY_CUOI"]) == ngay_cuoi && Convert.ToInt64(drSL3["ID_BBANAGIA"]) == MaxID_BBANAGIA)
                                {
                                    ////Hieu chinh lai sai so
                                    drSL3["SAN_LUONG"] = Convert.ToDecimal(drSL3["SAN_LUONG"]) - (sl_lt - sl);
                                    break;
                                }
                            }
                        }
                    }
                    //if (strMa_DDo == "PD21007700660001")
                    //    strDebug += ExistsC + " - " + sl.ToString() + " - " + sl_lt.ToString();
                    #endregion

                    if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true && dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                    {
                        #region Diem do phu ghep tong khac so

                        if (IsExistsSoHoParam == 0)
                        {
                            //dw = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                            dwGiaNgayHLuc_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                            //dw.Sort = "MA_DVIQLY, MA_DDO, NGAY_HLUC DESC, ID_BBANAGIA";
                            if (dwGiaNgayHLuc_GT.Count != 0)
                            {
                                //Tim so ho ung voi ngay hieu luc gia lon nhat, co nhom thuoc bac thang
                                //Tim so ho ung voi ngay hieu luc gia lon nhat, co nhom thuoc bac thang
                                ngay_hluccsmin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('KT','BT','CD','TD')"));
                                ngay_hlucgiamax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                                foreach (DataRowView drw in dwGiaNgayHLuc_GT)
                                {
                                    if (Convert.ToDateTime(drw["NGAY_HLUC"]) <= ngay_hluccsmin)
                                    {
                                        ngay_hlucgiamax = Convert.ToDateTime(drw["NGAY_HLUC"]);
                                        break;
                                    }
                                }

                                //ngay_hlucgiamax = Convert.ToDateTime(dw[0]["NGAY_HLUC"]);
                                decSoHo = 0;
                                foreach (DataRowView drw in dwGiaNgayHLuc_GT)
                                {
                                    //Tim bien ban ap gia lon nhat co MA_NHOMNN la bac thang trong ky tinh hoa don
                                    if (Convert.ToDateTime(drw["NGAY_HLUC"]) >= ngay_hlucgiamax)
                                    {
                                        //dwGiaBT = new DataView(dsStaticCatalog.Tables["D_BAC_THANG"]);
                                        dwBThang.RowFilter = "MA_NHOMNN = '" + Convert.ToString(drw["MA_NHOMNN"]) + "' AND MA_NGIA <> 'N' AND MA_NGIA = '" + Convert.ToString(drw["MA_NGIA"]) + "'";
                                        //dwGiaBT.Sort = "NGAY_HLUC DESC";

                                        if (dwBThang.Count != 0)
                                        {
                                            decSoHo = 0;
                                            foreach (DataRowView drwGiaBT in dwBThang)
                                            {
                                                if (Convert.ToDateTime(drwGiaBT["NGAY_HLUC"]) <= ngay_cuoi)
                                                {
                                                    decSoHo = Convert.ToDecimal(drw["SO_HO"]);
                                                    ngay_hluc_A = Convert.ToDateTime(drw["NGAY_HLUC"]);
                                                    break;
                                                }
                                            }
                                            break;
                                        }
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }

                                //Bo sung them phan tinh rieng cho so ho ngheo
                                decSoHo_N = 0;
                                foreach (DataRowView drw in dwGiaNgayHLuc_GT)
                                {
                                    //Tim bien ban ap gia lon nhat co MA_NHOMNN la bac thang trong ky tinh hoa don
                                    if (Convert.ToDateTime(drw["NGAY_HLUC"]) >= ngay_hlucgiamax)
                                    {
                                        //dwGiaBT = new DataView(dsStaticCatalog.Tables["D_BAC_THANG"]);
                                        dwBThang.RowFilter = "MA_NHOMNN = '" + Convert.ToString(drw["MA_NHOMNN"]) + "' AND MA_NGIA = 'N' AND MA_NGIA = '" + Convert.ToString(drw["MA_NGIA"]) + "'";
                                        //dwGiaBT.Sort = "NGAY_HLUC DESC";

                                        if (dwBThang.Count != 0)
                                        {
                                            decSoHo_N = 0;
                                            foreach (DataRowView drwGiaBT in dwBThang)
                                            {
                                                if (Convert.ToDateTime(drwGiaBT["NGAY_HLUC"]) <= ngay_cuoi)
                                                {
                                                    decSoHo_N = Convert.ToDecimal(drw["SO_HO"]);
                                                    if (decSoHo_N != decSoHo && decSoHo != 0)//có cả nhóm N và nhóm A
                                                    {
                                                        if (Convert.ToDateTime(drw["NGAY_HLUC"]) <= ngay_hluc_A)
                                                        {
                                                            //Lấy theo số hộ nhóm A
                                                            decSoHo_N = decSoHo;
                                                        }
                                                    }
                                                    break;
                                                }
                                            }
                                            break;
                                        }
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }
                            }
                            else
                            {
                                decSoHo = 0;
                                decSoHo_N = 0;
                            }
                        }
                        else
                        {
                            decSoHo = 0;
                            decSoHo_N = 0;
                        }

                        //dw = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                        //dw.Sort = "MA_DVIQLY, MA_DDO, LOAI_BCS, SO_THUTU, ID_BBANAGIA";
                        dwGiaSTT_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND LOAI_BCS = '" + strBCS + "'";

                        if (dwGiaSTT_GT.Count > 0)
                        {
                            //Xu ly rieng cho LOAI_DINHMUC = KWH 
                            foreach (DataRowView drGia in dwGiaSTT_GT)
                            {
                                if (Convert.ToDateTime(drGia["NGAY_HLUC"]) == ngay_hlucgia && Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper() == "KWH")
                                {
                                    loai_dmuc = Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper();
                                    dinh_muc = Convert.ToString(drGia["DINH_MUC"]).Trim().ToUpper();

                                    t1 = Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1);
                                    //t2 = Convert.ToDecimal(t1 / so_ngaydmuc);
                                    //sl_ct = Math.Round(t2 * Convert.ToDecimal(dinh_muc), 0, MidpointRounding.AwayFromZero);
                                    sl_ct = Math.Round(Convert.ToDecimal(dinh_muc) * t1 / so_ngaydmuc, 0, MidpointRounding.AwayFromZero);
                                    if (sl_ct > sl - sl_lt)
                                    {
                                        sl_ct = sl - sl_lt;
                                        //sl = 0;
                                    }

                                    tong_slKWH = tong_slKWH + sl_ct;
                                    sl_lt += sl_ct;

                                    if (sl_ct != 0)
                                    {
                                        drSan_Luong = dsCalculation.Tables["SL_3"].NewRow();
                                        drSan_Luong["MA_DVIQLY"] = drSL2["MA_DVIQLY"];
                                        drSan_Luong["MA_DDO"] = drSL2["MA_DDO"];
                                        drSan_Luong["MA_KHANG"] = drSL2["MA_KHANG"];
                                        drSan_Luong["ID_CHISO"] = drSL2["ID_CHISO"];
                                        drSan_Luong["ID_BCS"] = drSL2["ID_BCS"];
                                        drSan_Luong["BCS"] = drSL2["BCS"];
                                        drSan_Luong["SO_CTO"] = drSL2["SO_CTO"];
                                        drSan_Luong["NGAY_DAU"] = drSL2["NGAY_DAU"];
                                        drSan_Luong["NGAY_CUOI"] = drSL2["NGAY_CUOI"];
                                        drSan_Luong["SAN_LUONG"] = sl_ct;
                                        drSan_Luong["DTUONG_GIA"] = drSL2["DTUONG_GIA"];
                                        drSan_Luong["NGAY_HLUCGIA"] = drSL2["NGAY_HLUCGIA"];
                                        drSan_Luong["SO_NGAYDMUC"] = drSL2["SO_NGAYDMUC"];
                                        drSan_Luong["KY"] = drSL2["KY"];
                                        drSan_Luong["THANG"] = drSL2["THANG"];
                                        drSan_Luong["NAM"] = drSL2["NAM"];

                                        drSan_Luong["SO_THUTU"] = drGia["SO_THUTU"];
                                        if (loai_dmuc == "" && dinh_muc == "")
                                        {
                                            drSan_Luong["DINH_MUC"] = "100";
                                            drSan_Luong["LOAI_DMUC"] = "%";
                                        }
                                        else
                                        {
                                            if (dinh_muc == "")
                                                drSan_Luong["DINH_MUC"] = " ";
                                            else
                                                drSan_Luong["DINH_MUC"] = drGia["DINH_MUC"];
                                            if (loai_dmuc == "")
                                                drSan_Luong["LOAI_DMUC"] = " ";
                                            else
                                                drSan_Luong["LOAI_DMUC"] = drGia["LOAI_DMUC"];
                                        }
                                        drSan_Luong["TGIAN_BDIEN"] = drGia["TGIAN_BDIEN"];
                                        drSan_Luong["MA_NHOMNN"] = drGia["MA_NHOMNN"];
                                        drSan_Luong["MA_NGIA"] = drGia["MA_NGIA"];
                                        drSan_Luong["MA_NN"] = drGia["MA_NN"];
                                        if (IsExistsSoHoParam == 1)
                                        {
                                            drSan_Luong["SO_HO"] = drGia["SO_HO"];
                                        }
                                        else
                                        {
                                            if (Convert.ToString(drGia["MA_NGIA"]) == "N")
                                            {
                                                drSan_Luong["SO_HO"] = decSoHo_N;
                                            }
                                            else
                                            {
                                                drSan_Luong["SO_HO"] = decSoHo;
                                            }
                                        }
                                        drSan_Luong["MA_CAPDAP"] = drGia["MA_CAPDAP"];
                                        drSan_Luong["ID_BBANAGIA"] = drGia["ID_BBANAGIA"];

                                        dsCalculation.Tables["SL_3"].Rows.Add(drSan_Luong);
                                    }
                                }
                            }

                            //Xu ly cho cac truong hop khong phai KWH
                            foreach (DataRowView drGia in dwGiaSTT_GT)
                            {
                                if (Convert.ToDateTime(drGia["NGAY_HLUC"]) == ngay_hlucgia && Convert.ToString(drGia["LOAI_BCS"]) == strBCS)
                                {
                                    //Luu lai Max ID_BBANAGIA de lam tron do sai so
                                    MaxID_BBANAGIA = Convert.ToInt64(drGia["ID_BBANAGIA"]);

                                    if (Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper() != "KWH")
                                    {
                                        //Kiem tra loai dinh muc
                                        loai_dmuc = Convert.ToString(drGia["LOAI_DMUC"]).Trim().ToUpper();
                                        dinh_muc = Convert.ToString(drGia["DINH_MUC"]).Trim().ToUpper();
                                        switch (loai_dmuc)
                                        {
                                            case "":
                                                {
                                                    if (dinh_muc == "")
                                                        //la 100% san luong
                                                        sl_ct = sl - tong_slKWH;
                                                    else
                                                        if (dinh_muc == "C")
                                                    {
                                                        ExistsC = Convert.ToDecimal(drGia["ID_BBANAGIA"]);
                                                        sl_ct = 0;
                                                    }
                                                    else
                                                        sl_ct = 0;
                                                }
                                                break;
                                            case "%":
                                                {
                                                    sl_ct = Math.Round(Convert.ToDecimal((sl - tong_slKWH) * Convert.ToDecimal(dinh_muc) / 100), 0, MidpointRounding.AwayFromZero);
                                                }
                                                break;
                                                //case "KWH":
                                                //    {
                                                //        t1 = Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1);
                                                //        t2 = Convert.ToDecimal(t1 / so_ngaydmuc);
                                                //        sl_ct = Math.Round(t2 * Convert.ToDecimal(dinh_muc), 0);
                                                //    }
                                                //    break;
                                        }

                                        if (loai_dmuc == "" && dinh_muc == "C")
                                            continue;
                                        else
                                        {
                                            if (sl_ct > sl - sl_lt)
                                            {
                                                sl_ct = sl - sl_lt;
                                            }

                                            sl_lt += sl_ct;

                                            if (sl_ct != 0)
                                            {
                                                drSan_Luong = dsCalculation.Tables["SL_3"].NewRow();
                                                drSan_Luong["MA_DVIQLY"] = drSL2["MA_DVIQLY"];
                                                drSan_Luong["MA_DDO"] = drSL2["MA_DDO"];
                                                drSan_Luong["MA_KHANG"] = drSL2["MA_KHANG"];
                                                drSan_Luong["ID_CHISO"] = drSL2["ID_CHISO"];
                                                drSan_Luong["ID_BCS"] = drSL2["ID_BCS"];
                                                drSan_Luong["BCS"] = drSL2["BCS"];
                                                drSan_Luong["SO_CTO"] = drSL2["SO_CTO"];
                                                drSan_Luong["NGAY_DAU"] = drSL2["NGAY_DAU"];
                                                drSan_Luong["NGAY_CUOI"] = drSL2["NGAY_CUOI"];
                                                drSan_Luong["SAN_LUONG"] = sl_ct;
                                                drSan_Luong["DTUONG_GIA"] = drSL2["DTUONG_GIA"];
                                                drSan_Luong["NGAY_HLUCGIA"] = drSL2["NGAY_HLUCGIA"];
                                                drSan_Luong["SO_NGAYDMUC"] = drSL2["SO_NGAYDMUC"];
                                                drSan_Luong["KY"] = drSL2["KY"];
                                                drSan_Luong["THANG"] = drSL2["THANG"];
                                                drSan_Luong["NAM"] = drSL2["NAM"];

                                                drSan_Luong["SO_THUTU"] = drGia["SO_THUTU"];
                                                if (loai_dmuc == "" && dinh_muc == "")
                                                {
                                                    drSan_Luong["DINH_MUC"] = "100";
                                                    drSan_Luong["LOAI_DMUC"] = "%";
                                                }
                                                else
                                                {
                                                    if (dinh_muc == "")
                                                        drSan_Luong["DINH_MUC"] = " ";
                                                    else
                                                        drSan_Luong["DINH_MUC"] = drGia["DINH_MUC"];
                                                    if (loai_dmuc == "")
                                                        drSan_Luong["LOAI_DMUC"] = " ";
                                                    else
                                                        drSan_Luong["LOAI_DMUC"] = drGia["LOAI_DMUC"];
                                                }
                                                drSan_Luong["TGIAN_BDIEN"] = drGia["TGIAN_BDIEN"];
                                                drSan_Luong["MA_NHOMNN"] = drGia["MA_NHOMNN"];
                                                drSan_Luong["MA_NGIA"] = drGia["MA_NGIA"];
                                                drSan_Luong["MA_NN"] = drGia["MA_NN"];
                                                //drSan_Luong["SO_HO"] = drGia["SO_HO"];
                                                if (IsExistsSoHoParam == 1)
                                                {
                                                    drSan_Luong["SO_HO"] = drGia["SO_HO"];
                                                }
                                                else
                                                {
                                                    if (Convert.ToString(drGia["MA_NGIA"]) == "N")
                                                    {
                                                        drSan_Luong["SO_HO"] = decSoHo_N;
                                                    }
                                                    else
                                                    {
                                                        drSan_Luong["SO_HO"] = decSoHo;
                                                    }
                                                }
                                                drSan_Luong["MA_CAPDAP"] = drGia["MA_CAPDAP"];
                                                drSan_Luong["ID_BBANAGIA"] = drGia["ID_BBANAGIA"];

                                                dsCalculation.Tables["SL_3"].Rows.Add(drSan_Luong);
                                            }
                                        }
                                    }
                                }
                            }

                            //Them thanh phan gia C (neu co)
                            if (ExistsC != 0)
                            {
                                if (sl > sl_lt)
                                {
                                    //Chi them neu con san luong
                                    drSan_Luong = dsCalculation.Tables["SL_3"].NewRow();
                                    drSan_Luong["MA_DVIQLY"] = drSL2["MA_DVIQLY"];
                                    drSan_Luong["MA_DDO"] = drSL2["MA_DDO"];
                                    drSan_Luong["MA_KHANG"] = drSL2["MA_KHANG"];
                                    drSan_Luong["ID_CHISO"] = drSL2["ID_CHISO"];
                                    drSan_Luong["ID_BCS"] = drSL2["ID_BCS"];
                                    drSan_Luong["BCS"] = drSL2["BCS"];
                                    drSan_Luong["SO_CTO"] = drSL2["SO_CTO"];
                                    drSan_Luong["NGAY_DAU"] = drSL2["NGAY_DAU"];
                                    drSan_Luong["NGAY_CUOI"] = drSL2["NGAY_CUOI"];
                                    drSan_Luong["SAN_LUONG"] = sl - sl_lt;
                                    drSan_Luong["DTUONG_GIA"] = drSL2["DTUONG_GIA"];
                                    drSan_Luong["NGAY_HLUCGIA"] = drSL2["NGAY_HLUCGIA"];
                                    drSan_Luong["SO_NGAYDMUC"] = drSL2["SO_NGAYDMUC"];
                                    drSan_Luong["KY"] = drSL2["KY"];
                                    drSan_Luong["THANG"] = drSL2["THANG"];
                                    drSan_Luong["NAM"] = drSL2["NAM"];

                                    rowsGiaC = dsCustomerData.Tables["HDG_BBAN_APGIA_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_BCS = '" + strBCS + "' AND ID_BBANAGIA = " + ExistsC);

                                    drSan_Luong["SO_THUTU"] = rowsGiaC[0]["SO_THUTU"];
                                    drSan_Luong["DINH_MUC"] = rowsGiaC[0]["DINH_MUC"];
                                    if (Convert.ToString(rowsGiaC[0]["LOAI_DMUC"]).Trim().ToUpper() == "")
                                        drSan_Luong["LOAI_DMUC"] = " ";
                                    else
                                        drSan_Luong["LOAI_DMUC"] = rowsGiaC[0]["LOAI_DMUC"];
                                    drSan_Luong["TGIAN_BDIEN"] = rowsGiaC[0]["TGIAN_BDIEN"];
                                    drSan_Luong["MA_NHOMNN"] = rowsGiaC[0]["MA_NHOMNN"];
                                    drSan_Luong["MA_NGIA"] = rowsGiaC[0]["MA_NGIA"];
                                    drSan_Luong["MA_NN"] = rowsGiaC[0]["MA_NN"];
                                    //drSan_Luong["SO_HO"] = rowsGiaC[0]["SO_HO"];
                                    if (IsExistsSoHoParam == 1)
                                    {
                                        drSan_Luong["SO_HO"] = rowsGiaC[0]["SO_HO"];
                                    }
                                    else
                                    {
                                        if (Convert.ToString(rowsGiaC[0]["MA_NGIA"]) == "N")
                                        {
                                            drSan_Luong["SO_HO"] = decSoHo_N;
                                        }
                                        else
                                        {
                                            drSan_Luong["SO_HO"] = decSoHo;
                                        }
                                    }
                                    drSan_Luong["MA_CAPDAP"] = rowsGiaC[0]["MA_CAPDAP"];
                                    drSan_Luong["ID_BBANAGIA"] = rowsGiaC[0]["ID_BBANAGIA"];

                                    dsCalculation.Tables["SL_3"].Rows.Add(drSan_Luong);
                                }
                            }
                            else
                            {
                                //Khong ton tai thanh phan C. Thuc hien lam tron cho chi tiet cuoi cung MaxID_BBANAGIA
                                foreach (DataRow drSL3 in dsCalculation.Tables["SL_3"].Rows)
                                {
                                    if (Convert.ToString(drSL3["MA_DDO"]) == strMa_DDo && Convert.ToString(drSL3["BCS"]) == strBCS && Convert.ToDateTime(drSL3["NGAY_DAU"]) == ngay_dau && Convert.ToDateTime(drSL3["NGAY_CUOI"]) == ngay_cuoi && Convert.ToInt64(drSL3["ID_BBANAGIA"]) == MaxID_BBANAGIA)
                                    {
                                        ////Hieu chinh lai sai so
                                        drSL3["SAN_LUONG"] = Convert.ToDecimal(drSL3["SAN_LUONG"]) - (sl_lt - sl);
                                        break;
                                    }
                                }
                            }
                            //if (strMa_DDo == "PD21007700660001")
                            //    strDebug += ExistsC + " - " + sl.ToString() + " - " + sl_lt.ToString();                        
                        }
                        #endregion
                    }

                }

                //Xoa cac dong co SAN_LUONG = 0
                dw = new DataView(dsCalculation.Tables["SL_3"]);
                foreach (DataRowView drw in dw)
                {
                    if (Convert.ToDecimal(drw["SAN_LUONG"]) == 0)
                    {
                        drw.Row.Delete();
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_3: " + strMa_DDo + " - " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }

        //Gom san luong cua cac doi tuong Ban buon - xu ly rieng
        public string DetailDataCalculation_4(DS_CALCULATIONTABLES dsCalculation, DataSet dsCustomerData, DataSet dsStaticCatalog, string strMa_DViQLy, string strMa_SoGCS, short ky, short thang, short nam)
        {
            try
            {
                DataView dwSL3, dwSLBBuon, dwSLBBuon_GT, dwGCS, dwGCS_GT;
                string strMa_DDoBB = "|", strMa_DDo = "", strMa_NhomNNBB = "";
                Decimal slBB = 0, slBB_1 = 0, slTP = 0, slBN_BT = 0, slBN_CD = 0, slBN_TD = 0, slTNT50 = 0, sohoTNT50 = 0, slMDK = 0, sl_TruocChot = 0, sl_SauChot = 0;
                Decimal slTP_T = 0, slBN_BT_T = 0, slBN_CD_T = 0, slBN_TD_T = 0, slTNT50_T = 0, slTP_S = 0, slBN_BT_S = 0, slBN_CD_S = 0, slBN_TD_S = 0, slTNT50_S = 0;
                DataRow drTP, drBN_BT, drBN_CD, drBN_TD, drTNT50, drCCS_New;
                //DataRow[] drBB;
                Int16 IsExists_SLTPBB = 0;
                DateTime ngay_dky, ngay_cky, ngay_ccs;

                //Gom san luong cua cac doi tuong Ban buon - xu ly rieng
                //Cap nhat du lieu vao bang SL_3
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_3") == false)
                    return "NotExistsSL_3";
                if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                    return "NotExistsGCS_CHISO";
                dwGCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN')";
                dwSL3.Sort = "MA_DVIQLY, MA_DDO, MA_NHOMNN, MA_NGIA, NGAY_DAU, NGAY_CUOI";
                if (dwSL3.Count == 0)
                    return ""; //Khong ton tai thanh phan ban buon       

                //Co ton tai thanh phan ban buon
                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") == true)
                {
                    dwSLBBuon = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                    if (dwSLBBuon.Count != 0)
                    {
                        dwSLBBuon.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwSLBBuon[0]["MA_DVIQLY"]) + "'";
                    }
                }
                else
                {
                    dwSLBBuon = null;
                }

                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                {
                    dwSLBBuon_GT = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                    if (dwSLBBuon_GT.Count != 0)
                    {
                        dwSLBBuon_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwSLBBuon_GT[0]["MA_DVIQLY"]) + "'";
                    }
                }
                else
                {
                    dwSLBBuon_GT = null;
                }

                ngay_dky = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cky = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_ccs = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));

                foreach (DataRowView drSL3 in dwSL3)
                {
                    strMa_DDo = Convert.ToString(drSL3["MA_DDO"]);
                    strMa_NhomNNBB = Convert.ToString(drSL3["MA_NHOMNN"]);

                    if (strMa_DDo == "PD01000009837001")
                    {
                        strMa_DDo = "PD01000009837001";
                    }

                    if (strMa_DDoBB.Contains("|" + strMa_DDo + "|") == false)
                    {
                        //Dũng NT bổ sung gán mặc định ID_CHISO của dòng BT DDK cho tất cả chi tiết hóa đơn - CMIS-8178
                        dwGCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('BT','KT')";

                        if (dwGCS != null && dwGCS.Count > 0)
                        {
                            dwGCS.Sort = "ID_CHISO DESC";
                            if (drSL3["BCS"].ToString() != "VC")
                                drSL3["ID_CHISO"] = dwGCS[0]["ID_CHISO"];
                        }
                        else
                        {
                            //Không có trong GCS_CHISO, kiểm tra có GCS_CHISO_GT không
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('BT','KT')";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    dwGCS_GT.Sort = "ID_CHISO DESC";
                                    if (drSL3["BCS"].ToString() != "VC")
                                        drSL3["ID_CHISO"] = dwGCS_GT[0]["ID_CHISO"];
                                }
                                // Không có ko thực hiện gì
                            }
                            // Không có ko thực hiện gì
                        }
                        //Chua thuc hien xu ly
                        //Tim min ngay dau ky va max ngay cuoi ky
                        ngay_dky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MIN(NGAY_DAU)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN')"));
                        ngay_cky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MAX(NGAY_CUOI)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN')"));
                        //Khởi tạo lại giá trị trước khi tính
                        slTP_T = 0;
                        slTP_S = 0;
                        slBN_BT_T = 0;
                        slBN_BT_S = 0;
                        slBN_CD_T = 0;
                        slBN_CD_S = 0;
                        slBN_TD_T = 0;
                        slBN_TD_S = 0;
                        slTNT50_T = 0;
                        slTNT50_S = 0;


                        #region Kiem tra su ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                        IsExists_SLTPBB = 0;
                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") == true)
                        {
                            //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                            dwSLBBuon.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                            if (dwSLBBuon.Count > 0)
                            {
                                IsExists_SLTPBB = 1;
                            }
                            else
                            {
                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                                {
                                    //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                    dwSLBBuon_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                    if (dwSLBBuon_GT.Count > 0)
                                    {
                                        IsExists_SLTPBB = 2;
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                            {
                                //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                dwSLBBuon_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                if (dwSLBBuon_GT.Count > 0)
                                {
                                    IsExists_SLTPBB = 2;
                                }
                            }
                        }
                        #endregion


                        if (IsExists_SLTPBB != 0)
                        {
                            #region Co ton tai du lieu trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                            //drSL3["NGAY_DAU"] = ngay_dky;
                            //drSL3["NGAY_CUOI"] = ngay_cky;
                            //Ton tai trong bang GCS_SLMDK_SHBB hoac GCS_SLMDK_SHBB_GT
                            drTP = dsCalculation.Tables["SL_3"].NewRow();
                            drBN_BT = dsCalculation.Tables["SL_3"].NewRow();
                            drBN_CD = dsCalculation.Tables["SL_3"].NewRow();
                            drBN_TD = dsCalculation.Tables["SL_3"].NewRow();
                            drTNT50 = dsCalculation.Tables["SL_3"].NewRow();

                            if (strMa_NhomNNBB != "SHBM" && strMa_NhomNNBB != "SHBN")
                            {
                                #region Xu ly voi SHBB, SHBC, SHBD, SHBH, SHBP, SHBL
                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                {
                                    //Bi phat, ton tai nhom D, gan toan bo san luong cua diem do theo nhom D
                                    drSL3["NGAY_DAU"] = ngay_dky;
                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS IN ('KT','BT','CD','TD')"));
                                    drSL3.Row["SAN_LUONG"] = slBB;
                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                        drSL3.Row["BCS"] = "KT";
                                    else
                                        drSL3.Row["BCS"] = "BT";
                                    drSL3.Row["MA_NGIA"] = "D";
                                }
                                else
                                {
                                    //Khong ton tai nhom D, tinh theo san luong thuong pham
                                    if (IsExists_SLTPBB == 1)
                                    {
                                        slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                        slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                        slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                        slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                    }
                                    else
                                    {
                                        slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                        slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                        slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                        slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                    }
                                    #region Tính riêng sản lượng chốt
                                    //Xu ly cho nhom A, cong tong san luong
                                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong, neu co thi tinh theo chi so chot

                                    Decimal IsChangePrice = 0;
                                    //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                                    DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                                    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                    {
                                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                                        {
                                            ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                        }
                                    }
                                    else
                                    {
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                            {
                                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                                                {
                                                    ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                                }
                                            }
                                        }
                                    }
                                    //Kiem tra thay doi gia nha nuoc hay khong
                                    DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                                    dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                    dwGia.Sort = "NGAY_HLUC";
                                    string strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";

                                    DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                                    dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                                    dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                                    DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                                    dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                                    dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                                    DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                                    DateTime ngay_cuoi = ngay_cky;
                                    DateTime ngay_dau = ngay_dky;

                                    foreach (DataRowView drwGia in dwGia)
                                    {
                                        //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                                        if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                                        {
                                            //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                            strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                            strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                            strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                            strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                            strKhoang_DAp = "";

                                            //Tim khoang tham chieu cap dien ap
                                            dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                            foreach (DataRowView drCapDA in dwTChieuDA)
                                            {
                                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                if (ngay_ckymax == ngay_hluc)
                                                {
                                                    //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                    //se tinh toan bo vao bac thang cua bang gia cu
                                                    continue;
                                                }
                                                if (ngay_cuoi >= ngay_hluc)
                                                {
                                                    strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                                    break;
                                                }
                                            }

                                            if (strKhoang_DAp != "")
                                            {
                                                dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                                foreach (DataRowView drGia in dwGiaNhomNN)
                                                {
                                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    if (ngay_ckymax == ngay_hluc)
                                                    {
                                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                        //se tinh toan bo vao bac thang cua bang gia cu
                                                        continue;
                                                    }
                                                    if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                                    {
                                                        //Co doi gia
                                                        IsChangePrice = 1;
                                                        break;
                                                    }
                                                }
                                            }

                                            if (IsChangePrice == 1)
                                            {
                                                break;
                                            }
                                        }
                                    }

                                    //22/12/2012: Kiem tra them voi diem do phu ghep tong
                                    if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                    {
                                        if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                        {
                                            dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                                            dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                            dwGia.Sort = "NGAY_HLUC";

                                            foreach (DataRowView drwGia in dwGia)
                                            {
                                                //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                                                if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                                                {
                                                    //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                                    strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                                    strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                                    strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                                    strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                                    strKhoang_DAp = "";

                                                    //Tim khoang tham chieu cap dien ap
                                                    dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                                    foreach (DataRowView drCapDA in dwTChieuDA)
                                                    {
                                                        ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                        if (ngay_ckymax == ngay_hluc)
                                                        {
                                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                            //se tinh toan bo vao bac thang cua bang gia cu
                                                            continue;
                                                        }
                                                        if (ngay_cuoi >= ngay_hluc)
                                                        {
                                                            strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                                            break;
                                                        }
                                                    }

                                                    if (strKhoang_DAp != "")
                                                    {
                                                        dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                                        foreach (DataRowView drGia in dwGiaNhomNN)
                                                        {
                                                            ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                            if (ngay_ckymax == ngay_hluc)
                                                            {
                                                                //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                                //se tinh toan bo vao bac thang cua bang gia cu
                                                                continue;
                                                            }
                                                            if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                                            {
                                                                //Co doi gia
                                                                IsChangePrice = 1;
                                                                break;
                                                            }
                                                        }
                                                    }

                                                    if (IsChangePrice == 1)
                                                    {
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    if (strMa_DDo == "PD01000009864002")
                                    {
                                        strMa_DDo = "PD01000009864002";
                                    }

                                    if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Co chot chi so trong GCS_CHISO

                                        slBB = 0;
                                        slBB_1 = 0;

                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));

                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                        if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                        {
                                            slTNT50 = (slBB_1 + slBB) - (slTP + slBN_BT + slBN_CD + slBN_TD);
                                        }

                                        slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50;

                                        if (slTP > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                //Dũng NT bổ sung kiểm tra có sản lượng MDK chốt không
                                                //if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                //{
                                                //    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                //    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                //    if (dvMDK.Count > 0)
                                                //    {
                                                //        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //    else
                                                //    {
                                                //        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //}
                                                //else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                //{
                                                //    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                //    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                //    if (dvMDK.Count > 0)
                                                //    {
                                                //        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //    else
                                                //    {
                                                //        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //}

                                                //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP - slTP_T;

                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                slTP_S = slTP - slTP_T;

                                            }
                                        }
                                        if (slBN_BT > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slBN_BT_T = Math.Round(slBN_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBN_BT_S = slBN_BT - slBN_BT_T;
                                            }
                                            else
                                            {
                                                slBN_BT_T = Math.Round(slBN_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slBN_BT_S = slBN_BT - slBN_BT_T;
                                            }
                                        }
                                        if (slBN_CD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slBN_CD_T = Math.Round(slBN_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBN_CD_S = slBN_CD - slBN_CD_T;
                                            }
                                            else
                                            {
                                                slBN_CD_T = Math.Round(slBN_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slBN_CD_S = slBN_CD - slBN_CD_T;
                                            }
                                        }
                                        if (slBN_TD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slBN_TD_T = Math.Round(slBN_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBN_TD_S = slBN_TD - slBN_TD_T;
                                            }
                                            else
                                            {
                                                slBN_TD_T = Math.Round(slBN_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slBN_TD_S = slBN_TD - slBN_TD_T;
                                            }
                                        }
                                        if (slTNT50 > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTNT50_S = slTNT50 - slTNT50_T;
                                            }
                                            else
                                            {
                                                slTNT50_T = Math.Round(slTNT50 * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slTNT50_S = slTNT50 - slTNT50_T;
                                            }
                                        }
                                        //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                        if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                        {
                                            slTNT50_T = slBB - (slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T);
                                            slTNT50_S = slBB_1 - (slTP_S + slBN_BT_S + slBN_CD_S + slBN_TD_S);
                                        }

                                        sl_TruocChot = slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slTNT50_T;
                                        sl_SauChot = slMDK - sl_TruocChot;

                                        if (slBB > 0)
                                        {
                                            if (slBB >= sl_TruocChot)
                                            {
                                                //Truoc doi gia nha nuoc
                                                drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;
                                                if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                {
                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                    {
                                                        drSL3.Row["SO_HO"] = 0;
                                                    }
                                                    else
                                                    {
                                                        drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            if (slBB_1 >= sl_SauChot)
                                            {
                                                //Sau doi gia nha nuoc
                                                drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                //if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                //{
                                                //    if (Convert.ToDecimal(drCCS_New["SO_HO"]) < sohoTNT50)
                                                //    {
                                                //        drCCS_New["SO_HO"] = 0;
                                                //    }
                                                //    else
                                                //    {
                                                //        drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) - sohoTNT50;
                                                //    }
                                                //}
                                                dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                    }

                                    else
                                    {
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (strMa_DDo == "PD01000009864002")
                                            {
                                                strMa_DDo = "PD01000009864002";
                                            }

                                            if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                            {
                                                //Co chot chi so trong GCS_CHISO_GT
                                                slBB = 0;
                                                slBB_1 = 0;
                                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));

                                                foreach (DataRowView dwrCCS in dwSL3)
                                                {
                                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                                    {
                                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                        {
                                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50 = (slBB_1 + slBB) - (slTP + slBN_BT + slBN_CD + slBN_TD);
                                                }

                                                slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50;

                                                if (slTP > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        //if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        //{
                                                        //    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                        //    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                        //    if (dvMDK.Count > 0)
                                                        //    {
                                                        //        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //        //slTP_S = slTP - slTP_T;
                                                        //    }
                                                        //    else
                                                        //    {
                                                        //        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        //        //slTP_S = slTP - slTP_T;
                                                        //    }
                                                        //}
                                                        //else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        //{
                                                        //    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                        //    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                        //    if (dvMDK.Count > 0)
                                                        //    {
                                                        //        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //        //slTP_S = slTP - slTP_T;
                                                        //    }
                                                        //    else
                                                        //    {
                                                        //        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        //        //slTP_S = slTP - slTP_T;
                                                        //    }
                                                        //}

                                                        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                if (slBN_BT > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slBN_BT_T = Math.Round(slBN_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_BT_S = slBN_BT - slBN_BT_T;
                                                    }
                                                    else
                                                    {
                                                        slBN_BT_T = Math.Round(slBN_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_BT_S = slBN_BT - slBN_BT_T;
                                                    }
                                                }
                                                if (slBN_CD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slBN_CD_T = Math.Round(slBN_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_CD_S = slBN_CD - slBN_CD_T;
                                                    }
                                                    else
                                                    {
                                                        slBN_CD_T = Math.Round(slBN_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_CD_S = slBN_CD - slBN_CD_T;
                                                    }
                                                }
                                                if (slBN_TD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slBN_TD_T = Math.Round(slBN_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_TD_S = slBN_TD - slBN_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slBN_TD_T = Math.Round(slBN_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_TD_S = slBN_TD - slBN_TD_T;
                                                    }
                                                }
                                                if (slTNT50 > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;
                                                    }
                                                    else
                                                    {
                                                        slTNT50_T = Math.Round(slTNT50 * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;
                                                    }
                                                }

                                                //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50_T = slBB - (slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T);
                                                    slTNT50_S = slBB_1 - (slTP_S + slBN_BT_S + slBN_CD_S + slBN_TD_S);
                                                }

                                                sl_TruocChot = slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slTNT50_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB >= sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                        {
                                                            if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                            {
                                                                drSL3.Row["SO_HO"] = 0;
                                                            }
                                                            else
                                                            {
                                                                drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 >= sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                        //if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                        //{
                                                        //    if (Convert.ToDecimal(drCCS_New["SO_HO"]) < sohoTNT50)
                                                        //    {
                                                        //        drCCS_New["SO_HO"] = 0;
                                                        //    }
                                                        //    else
                                                        //    {
                                                        //        drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) - sohoTNT50;
                                                        //    }
                                                        //}
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);

                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Khong chot chi so
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                                //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                if (Convert.ToDecimal(drSL3["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50 = slBB - (slTP + slBN_BT + slBN_CD + slBN_TD);
                                                }

                                                slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50;
                                                drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                drSL3["SAN_LUONG"] = slBB - slMDK;
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3.Row["MA_NGIA"] = "A";
                                            }
                                        }
                                        else
                                        {
                                            //Khong chot chi so
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                            //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                            if (Convert.ToDecimal(drSL3["SO_HO"]) <= sohoTNT50)
                                            {
                                                slTNT50 = slBB - (slTP + slBN_BT + slBN_CD + slBN_TD);
                                            }

                                            slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50;
                                            drSL3["SAN_LUONG"] = slBB - slMDK;
                                            drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3.Row["MA_NGIA"] = "A";
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                    }
                                    #endregion

                                    if (ky + thang * 10 + nam * 12 * 10 < 1 + 3 * 10 + 2010 * 12 * 10)
                                    {
                                        //San luong ban buon muc dich khac
                                        if (slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "K";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    drTP_New["MA_NGIA"] = "K";
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "K";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        //San luong bom nuoc
                                        if (slBN_BT > 0)
                                        {
                                            if (slBN_BT_T > 0 || slBN_BT_S > 0)
                                            {
                                                if (slBN_BT_T > 0)
                                                {
                                                    drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT["SAN_LUONG"] = slBN_BT_T;
                                                    drBN_BT["MA_NGIA"] = "A";
                                                    drBN_BT["MA_NHOMNN"] = "SXD1";
                                                    drBN_BT["BCS"] = "BT";
                                                    drBN_BT["MA_NN"] = "1100";
                                                    drBN_BT["NGAY_DAU"] = ngay_dky;
                                                    drBN_BT["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_BT_S > 0)
                                                {
                                                    DataRow drBN_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT_New["SAN_LUONG"] = slBN_BT_S;
                                                    drBN_BT_New["MA_NGIA"] = "A";
                                                    drBN_BT_New["MA_NHOMNN"] = "SXD1";
                                                    drBN_BT_New["BCS"] = "BT";
                                                    drBN_BT_New["MA_NN"] = "1100";
                                                    drBN_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                drBN_BT["SAN_LUONG"] = slBN_BT;
                                                drBN_BT["MA_NGIA"] = "A";
                                                drBN_BT["MA_NHOMNN"] = "SXD1";
                                                drBN_BT["BCS"] = "BT";
                                                drBN_BT["MA_NN"] = "1100";
                                                drBN_BT["NGAY_DAU"] = ngay_dky;
                                                drBN_BT["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slBN_CD > 0)
                                        {
                                            if (slBN_CD_T > 0 || slBN_CD_S > 0)
                                            {
                                                if (slBN_CD_T > 0)
                                                {
                                                    drBN_CD.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_CD["MA_NGIA"] = "A";
                                                    drBN_CD["MA_NHOMNN"] = "SXD1";
                                                    drBN_CD["BCS"] = "CD";
                                                    drBN_CD["MA_NN"] = "1100";
                                                    drBN_CD["SAN_LUONG"] = slBN_CD_T;
                                                    drBN_CD["NGAY_DAU"] = ngay_dky;
                                                    drBN_CD["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_CD_S > 0)
                                                {
                                                    DataRow drBN_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_CD_New["MA_NGIA"] = "A";
                                                    drBN_CD_New["MA_NHOMNN"] = "SXD1";
                                                    drBN_CD_New["BCS"] = "CD";
                                                    drBN_CD_New["MA_NN"] = "1100";
                                                    drBN_CD_New["SAN_LUONG"] = slBN_CD_S;
                                                    drBN_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_CD_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_CD_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_CD.ItemArray = drSL3.Row.ItemArray;
                                                drBN_CD["SAN_LUONG"] = slBN_CD;
                                                drBN_CD["MA_NGIA"] = "A";
                                                drBN_CD["MA_NHOMNN"] = "SXD1";
                                                drBN_CD["BCS"] = "CD";
                                                drBN_CD["MA_NN"] = "1100";
                                                drBN_CD["NGAY_DAU"] = ngay_dky;
                                                drBN_CD["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slBN_TD > 0)
                                        {
                                            if (slBN_TD_T > 0 || slBN_TD_S > 0)
                                            {
                                                if (slBN_TD_T > 0)
                                                {
                                                    drBN_TD.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_TD["MA_NGIA"] = "A";
                                                    drBN_TD["MA_NHOMNN"] = "SXD1";
                                                    drBN_TD["BCS"] = "TD";
                                                    drBN_TD["MA_NN"] = "1100";
                                                    drBN_TD["SAN_LUONG"] = slBN_TD_T;
                                                    drBN_TD["NGAY_DAU"] = ngay_dky;
                                                    drBN_TD["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_TD_S > 0)
                                                {
                                                    DataRow drBN_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_TD_New["MA_NGIA"] = "A";
                                                    drBN_TD_New["MA_NHOMNN"] = "SXD1";
                                                    drBN_TD_New["BCS"] = "TD";
                                                    drBN_TD_New["MA_NN"] = "1100";
                                                    drBN_TD_New["SAN_LUONG"] = slBN_TD_S;
                                                    drBN_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_TD_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_TD_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_TD.ItemArray = drSL3.Row.ItemArray;
                                                drBN_TD["SAN_LUONG"] = slBN_TD;
                                                drBN_TD["MA_NGIA"] = "A";
                                                drBN_TD["MA_NHOMNN"] = "SXD1";
                                                drBN_TD["BCS"] = "TD";
                                                drBN_TD["MA_NN"] = "1100";
                                                drBN_TD["NGAY_DAU"] = ngay_dky;
                                                drBN_TD["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //Sau ky 1 thang 3 nam 2010
                                        //San luong ban buon muc dich khac
                                        if (slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "K";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    drTP_New["MA_NGIA"] = "K";
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "K";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        //San luong bom nuoc
                                        if (slBN_BT + slBN_CD + slBN_TD > 0)
                                        {
                                            if (slBN_BT_T > 0 || slBN_CD_T > 0 || slBN_TD_T > 0 || slBN_BT_S > 0 || slBN_CD_S > 0 || slBN_TD_S > 0)
                                            {
                                                if (slBN_BT_T > 0 || slBN_CD_T > 0 || slBN_TD_T > 0)
                                                {
                                                    drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT["SAN_LUONG"] = slBN_BT_T + slBN_CD_T + slBN_TD_T;
                                                    drBN_BT["MA_NGIA"] = "L";
                                                    drBN_BT["MA_NHOMNN"] = "SHBB";
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drBN_BT["BCS"] = "KT";
                                                    else
                                                        drBN_BT["BCS"] = "BT";
                                                    drBN_BT["MA_NN"] = "1100";
                                                    drBN_BT["NGAY_DAU"] = ngay_dky;
                                                    drBN_BT["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_BT_S > 0 || slBN_CD_S > 0 || slBN_TD_S > 0)
                                                {
                                                    DataRow drBN_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT_New["SAN_LUONG"] = slBN_BT_S + slBN_CD_S + slBN_TD_S;
                                                    drBN_BT_New["MA_NGIA"] = "L";
                                                    drBN_BT_New["MA_NHOMNN"] = "SHBB";
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drBN_BT_New["BCS"] = "KT";
                                                    else
                                                        drBN_BT_New["BCS"] = "BT";
                                                    drBN_BT_New["MA_NN"] = "1100";
                                                    drBN_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                drBN_BT["SAN_LUONG"] = slBN_BT + slBN_CD + slBN_TD;
                                                drBN_BT["MA_NGIA"] = "L";
                                                drBN_BT["MA_NHOMNN"] = "SHBB";
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                    drBN_BT["BCS"] = "KT";
                                                else
                                                    drBN_BT["BCS"] = "BT";
                                                drBN_BT["MA_NN"] = "1100";
                                                drBN_BT["NGAY_DAU"] = ngay_dky;
                                                drBN_BT["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        //San luong ban buon ho ngheo
                                        if (slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                    }

                                }
                                #endregion
                            }
                            else
                            {
                                #region Xu ly voi SHBM, SHBN
                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                {
                                    //Bi phat, ton tai nhom F, gan toan bo san luong cua diem do theo nhom F
                                    drSL3["NGAY_DAU"] = ngay_dky;
                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                    drSL3.Row["SAN_LUONG"] = slBB;
                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND BCS = 'KT'").Length != 0)
                                        drSL3.Row["BCS"] = "KT";
                                    else
                                        drSL3.Row["BCS"] = "BT";
                                    drSL3.Row["MA_NGIA"] = "F";
                                }
                                else
                                {
                                    //Khong ton tai nhom D, tinh theo san luong thuong pham
                                    //slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND BCS IN ('KT','BT','CD','TD')"));
                                    if (IsExists_SLTPBB == 1)
                                    {
                                        slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slMDK = slTP + slTNT50;
                                    }
                                    else
                                    {
                                        slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slMDK = slTP + slTNT50;
                                    }

                                    Decimal IsChangePrice = 0;
                                    //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                                    DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                                    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                    {
                                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                                        {
                                            ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                        }
                                    }
                                    else
                                    {
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                            {
                                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                                                {
                                                    ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                                }
                                            }
                                        }
                                    }
                                    //Kiem tra thay doi gia nha nuoc hay khong
                                    DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                                    dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                    dwGia.Sort = "NGAY_HLUC";
                                    string strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";

                                    DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                                    dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                                    dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                                    DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                                    dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                                    dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                                    DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                                    DateTime ngay_cuoi = ngay_cky;
                                    DateTime ngay_dau = ngay_dky;

                                    foreach (DataRowView drwGia in dwGia)
                                    {
                                        //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                                        if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                                        {
                                            //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                            strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                            strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                            strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                            strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                            strKhoang_DAp = "";

                                            //Tim khoang tham chieu cap dien ap
                                            dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                            foreach (DataRowView drCapDA in dwTChieuDA)
                                            {
                                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                if (ngay_ckymax == ngay_hluc)
                                                {
                                                    //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                    //se tinh toan bo vao bac thang cua bang gia cu
                                                    continue;
                                                }
                                                if (ngay_cuoi >= ngay_hluc)
                                                {
                                                    strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                                    break;
                                                }
                                            }

                                            if (strKhoang_DAp != "")
                                            {
                                                dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                                foreach (DataRowView drGia in dwGiaNhomNN)
                                                {
                                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    if (ngay_ckymax == ngay_hluc)
                                                    {
                                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                        //se tinh toan bo vao bac thang cua bang gia cu
                                                        continue;
                                                    }
                                                    if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                                    {
                                                        //Co doi gia
                                                        IsChangePrice = 1;
                                                        break;
                                                    }
                                                }
                                            }

                                            if (IsChangePrice == 1)
                                            {
                                                break;
                                            }
                                        }
                                    }

                                    if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Co chot chi so trong GCS_CHISO
                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                        slBB = 0;
                                        slBB_1 = 0;
                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        slMDK = slTP + slTNT50;
                                        if (slTP > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                //if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                //{
                                                //    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                //    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                //    if (dvMDK.Count > 0)
                                                //    {
                                                //        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //    else
                                                //    {
                                                //        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //}
                                                //else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                //{
                                                //    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                //    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                //    if (dvMDK.Count > 0)
                                                //    {
                                                //        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //    else
                                                //    {
                                                //        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                //        //slTP_S = slTP - slTP_T;
                                                //    }
                                                //}

                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP - slTP_T;
                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                slTP_S = slTP - slTP_T;
                                            }
                                        }
                                        if (slTNT50 > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTNT50_S = slTNT50 - slTNT50_T;
                                            }
                                            else
                                            {
                                                slTNT50_T = Math.Round(slTNT50 * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slTNT50_S = slTNT50 - slTNT50_T;
                                            }
                                        }
                                        sl_TruocChot = slTP_T + slTNT50_T;
                                        sl_SauChot = slMDK - sl_TruocChot;


                                        if (slBB > 0)
                                        {
                                            if (slBB > sl_TruocChot)
                                            {
                                                //Truoc doi gia nha nuoc
                                                drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;
                                                if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                {
                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                    {
                                                        drSL3.Row["SO_HO"] = 0;
                                                    }
                                                    else
                                                    {
                                                        drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            if (slBB_1 > sl_SauChot)
                                            {
                                                //Sau doi gia nha nuoc
                                                drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                //if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                //{
                                                //    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                //    {
                                                //        drCCS_New["SO_HO"] = 0;
                                                //    }
                                                //    else
                                                //    {
                                                //        drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) - sohoTNT50;
                                                //    }
                                                //}
                                                dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //22/12/2012
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                            {
                                                //Co chot chi so trong GCS_CHISO_GT
                                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                                slBB = 0;
                                                slBB_1 = 0;
                                                foreach (DataRowView dwrCCS in dwSL3)
                                                {
                                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                                    {
                                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                        {
                                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                slMDK = slTP + slTNT50;
                                                if (slTP > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;

                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;


                                                    }

                                                    //if (slBB + slBB_1 == 0)
                                                    //{
                                                    //    slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    //    slTP_S = slTP - slTP_T;
                                                    //}
                                                    //else
                                                    //{
                                                    //    slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                    //    slTP_S = slTP - slTP_T;
                                                    //}
                                                }
                                                if (slTNT50 > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;
                                                    }
                                                    else
                                                    {
                                                        slTNT50_T = Math.Round(slTNT50 * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;
                                                    }
                                                }
                                                sl_TruocChot = slTP_T + slTNT50_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB > sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                        {
                                                            if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                            {
                                                                drSL3.Row["SO_HO"] = 0;
                                                            }
                                                            else
                                                            {
                                                                drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 > sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                        //if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                        //{
                                                        //    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                        //    {
                                                        //        drCCS_New["SO_HO"] = 0;
                                                        //    }
                                                        //    else
                                                        //    {
                                                        //        drCCS_New["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                        //    }
                                                        //}
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);

                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_4", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //Khong chot chi so
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                //                                            
                                                drSL3["SAN_LUONG"] = slBB - slMDK;
                                                //
                                                drSL3.Row["MA_NGIA"] = "A";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        else
                                        {
                                            //Khong chot chi so
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS = 'KT'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            //                                            
                                            drSL3["SAN_LUONG"] = slBB - slMDK;
                                            //
                                            drSL3.Row["MA_NGIA"] = "A";
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                    }
                                    //

                                    if (ky + thang * 10 + nam * 12 * 10 < 1 + 3 * 10 + 2010 * 12 * 10)
                                    {
                                        //San luong ban buon muc dich khac
                                        if (slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "A";
                                                    drTP["MA_NHOMNN"] = "SHBN";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    drTP_New["MA_NGIA"] = "A";
                                                    drTP_New["MA_NHOMNN"] = "SHBN";
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "A";
                                                drTP["MA_NHOMNN"] = "SHBN";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //Sau ky 1 thang 3 nam 2010                                       
                                        //San luong ban buon muc dich khac
                                        if (slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "A";
                                                    drTP["MA_NHOMNN"] = "SHBN";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    drTP_New["MA_NGIA"] = "A";
                                                    drTP_New["MA_NHOMNN"] = "SHBN";
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "A";
                                                drTP["MA_NHOMNN"] = "SHBN";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat drTP, drBN_BT, drBN_CD, drBN_TD vao dsCalculation.Tables["SL_3"]
                            if (drTP != null)
                            {
                                if (Convert.ToString(drTP["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP);
                                }
                            }
                            if (drBN_BT != null)
                            {
                                if (Convert.ToString(drBN_BT["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_BT);
                                }
                            }
                            if (drBN_CD != null)
                            {
                                if (Convert.ToString(drBN_CD["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_CD);
                                }
                            }
                            if (drBN_TD != null)
                            {
                                if (Convert.ToString(drBN_TD["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_TD);
                                }
                            }
                            if (drTNT50 != null)
                            {
                                if (Convert.ToString(drTNT50["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50);
                                }
                            }
                            #endregion
                        }
                        else
                        {
                            #region Khong ton tai du lieu trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                            //Khong ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, xu ly cho nhom A, cong tong san luong
                            //Kiem tra xem co chot chi so doi gia nha nuoc hay khong, neu co thi tinh theo chi so chot
                            if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                            {
                                //Co chot chi so trong GCS_CHISO
                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                slBB = 0;
                                slBB_1 = 0;
                                foreach (DataRowView dwrCCS in dwSL3)
                                {
                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                    {
                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                        {
                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                            {
                                                if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                {
                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                }
                                            }
                                            else
                                            {
                                                if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                {
                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                }
                                            }
                                        }
                                    }
                                }
                                if (slBB > 0)
                                {
                                    //Truoc doi gia nha nuoc
                                    drSL3.Row["SAN_LUONG"] = slBB;
                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                        drSL3.Row["BCS"] = "KT";
                                    else
                                        drSL3.Row["BCS"] = "BT";
                                    drSL3["NGAY_DAU"] = ngay_dky;
                                    drSL3["NGAY_CUOI"] = ngay_ccs;
                                }
                                if (slBB_1 > 0)
                                {
                                    //Sau doi gia nha nuoc
                                    drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                    drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                    drCCS_New["SAN_LUONG"] = slBB_1;
                                    drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                    drCCS_New["NGAY_CUOI"] = ngay_cky;
                                    dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                }
                            }

                            else
                            {
                                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                {
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Co chot chi so trong GCS_CHISO_GT
                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                        slBB = 0;
                                        slBB_1 = 0;
                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        if (slBB > 0)
                                        {
                                            //Truoc doi gia nha nuoc
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            drSL3["NGAY_CUOI"] = ngay_ccs;
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            //Sau doi gia nha nuoc
                                            drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                            drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                            drCCS_New["SAN_LUONG"] = slBB_1;
                                            drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                            drCCS_New["NGAY_CUOI"] = ngay_cky;
                                            dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                        }
                                    }
                                    else
                                    {
                                        //Khong chot chi so
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'A'"));
                                        if (slBB > 0)
                                        {
                                            //Co san luong ban buon
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                    }
                                }
                                else
                                {
                                    //if (strMa_DDo == "PD07000000658001")
                                    //{
                                    //    strMa_DDo = "PD07000000658001";
                                    //}

                                    //Khong chot chi so
                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'A'"));
                                    if (slBB > 0)
                                    {
                                        //Co san luong ban buon nhom A
                                        drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        drSL3["NGAY_CUOI"] = ngay_cky;
                                    }
                                    else
                                    {
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'N'"));
                                        if (slBB > 0)
                                        {
                                            //Co san luong ban buon nhom N
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'N'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                    }
                                }
                            }
                            #endregion
                        }

                        strMa_DDoBB = strMa_DDoBB + strMa_DDo + "|";
                    }
                    else
                    {
                        //Da thuc hien xu ly xong
                        if (IsExists_SLTPBB != 0)
                        {
                            //Co ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, remove het cac row con lai
                            dsCalculation.Tables["SL_3"].Rows.Remove(drSL3.Row);
                            continue;
                        }
                        else
                        {
                            //Co ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, remove cac row ung voi nhom gia A
                            if (Convert.ToString(drSL3["MA_NGIA"]) == "A" || Convert.ToString(drSL3["MA_NGIA"]) == "N")//Nhóm N: Hộ nghèo
                            {
                                if (Convert.ToString(drSL3["MA_NHOMNN"]) != "SHBN")
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Remove(drSL3.Row);
                                    continue;
                                }
                            }
                        }
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_4: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }

        //Tach san luong ban buon trong ky doi gia
        //public string DetailDataCalculation_41(DS_CALCULATIONTABLES dsCalculation, DataSet dsStaticCatalog)
        //{
        //    try
        //    {
        //        DataView dwSL3, dwGia_NhomNN;
        //        DataTable dtSL3_Tmp = new DataTable();
        //        DataRow drSL3;
        //        //Gom san luong cua cac doi tuong Ban buon - xu ly rieng
        //        //Cap nhat du lieu vao bang SL_3
        //        if (dsCalculation == null)
        //            return "dsCalculationIsNull";
        //        else
        //            if (dsCalculation.Tables.Contains("SL_3") == false)
        //                return "NotExistsSL_3";
        //        //Kiem tra xem co ban buon hay khong, neu khong co thi thoat luon
        //        dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
        //        dwSL3.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN')";
        //        if (dwSL3.Count == 0)
        //            return ""; //Khong ton tai thanh phan ban buon                

        //        dtSL3_Tmp = dsCalculation.Tables["SL_3"].Copy();
        //        dsCalculation.Tables["SL_3"].Rows.Clear();

        //        #region Xu ly cho ban buon
        //        dwSL3 = new DataView(dtSL3_Tmp);
        //        dwSL3.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN')";
        //        dwSL3.Sort = "MA_NHOMNN";

        //        dwGia_NhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
        //        dwGia_NhomNN.Sort = "NGAY_ADUNG";

        //        string strMa_NhomNN = "";
        //        DateTime ngay_dau, ngay_cuoi, ngay_hluc, ngay_hluc_old, ngay_hlucmax;
        //        Decimal sl = 0, sl_lt = 0, sl_tong = 0;

        //        foreach (DataRowView drwSL3 in dwSL3)
        //        {
        //            if (strMa_NhomNN != Convert.ToString(drwSL3["MA_NHOMNN"]))
        //            {
        //                strMa_NhomNN = Convert.ToString(drwSL3["MA_NHOMNN"]);
        //                dwGia_NhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "'";                                                      
        //            }

        //            if (Convert.ToString(drwSL3["MA_DDO"]) == "PQ02000198400001")
        //            {
        //                drwSL3["MA_DDO"] = "PQ02000198400001";
        //            }

        //            if (dwGia_NhomNN.Count != 0)
        //            {
        //                ngay_dau = Convert.ToDateTime(drwSL3["NGAY_DAU"]);
        //                ngay_cuoi = Convert.ToDateTime(drwSL3["NGAY_CUOI"]);
        //                ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
        //                ngay_hluc_old = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
        //                ngay_hlucmax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
        //                sl_lt = 0;
        //                sl_tong = Convert.ToDecimal(drwSL3["SAN_LUONG"]);

        //                //Tim ngay hieu luc lon nhat con nho hon ngay_dau ky
        //                foreach (DataRowView drwGia_NhomNN in dwGia_NhomNN)
        //                {
        //                    ngay_hluc = Convert.ToDateTime(drwGia_NhomNN["NGAY_ADUNG"]);
        //                    if (ngay_hluc > ngay_dau)
        //                        break;
        //                    else
        //                    {
        //                        if (ngay_hlucmax < ngay_hluc)
        //                        {
        //                            ngay_hlucmax = ngay_hluc;
        //                        }
        //                    }
        //                }

        //                //Tach san luong
        //                foreach (DataRowView drwGia_NhomNN in dwGia_NhomNN)
        //                {
        //                    ngay_hluc = Convert.ToDateTime(drwGia_NhomNN["NGAY_ADUNG"]);
        //                    if (ngay_hluc >= ngay_hlucmax && ngay_hluc <= ngay_cuoi)
        //                    {
        //                        if (ngay_hluc_old == DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
        //                        {
        //                            ngay_hluc_old = ngay_hluc;
        //                        }
        //                        else
        //                        {
        //                            if (ngay_hluc != ngay_hluc_old)
        //                            {
        //                                if (ngay_hluc_old < ngay_dau)
        //                                {
        //                                    //Tinh tu ngay_dau den ngay_hluc
        //                                    sl = Math.Round(sl_tong * Convert.ToDecimal(ngay_hluc.Subtract(ngay_dau).TotalDays) / Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1), 0, MidpointRounding.AwayFromZero);

        //                                    //Day du lieu vao 
        //                                    drSL3 = dsCalculation.Tables["SL_3"].NewRow();
        //                                    drSL3.ItemArray = drwSL3.Row.ItemArray;
        //                                    drSL3["SAN_LUONG"] = sl;
        //                                    drSL3["NGAY_DAU"] = ngay_dau;
        //                                    drSL3["NGAY_CUOI"] = ngay_hluc.AddDays(-1.0);
        //                                    dsCalculation.Tables["SL_3"].Rows.Add(drSL3);
        //                                }
        //                                else
        //                                {
        //                                    //Tinh tu ngay_hluc_old den ngay_hluc - 1
        //                                    sl = Math.Round(sl_tong * Convert.ToDecimal(ngay_hluc.Subtract(ngay_hluc_old).TotalDays) / Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1), 0, MidpointRounding.AwayFromZero);

        //                                    //Day du lieu vao 
        //                                    drSL3 = dsCalculation.Tables["SL_3"].NewRow();
        //                                    drSL3.ItemArray = drwSL3.Row.ItemArray;
        //                                    drSL3["SAN_LUONG"] = sl;
        //                                    drSL3["NGAY_DAU"] = ngay_hluc_old;
        //                                    drSL3["NGAY_CUOI"] = ngay_hluc.AddDays(-1.0);
        //                                    dsCalculation.Tables["SL_3"].Rows.Add(drSL3);
        //                                }

        //                                sl_lt = sl_lt + sl;
        //                                ngay_hluc_old = ngay_hluc;
        //                            }
        //                        }
        //                    }
        //                }

        //                sl = sl_tong - sl_lt;
        //                //Xu ly row cuoi cung, tu ngay_hluc_old den ngay_cuoi
        //                if (ngay_hluc_old == DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN")))
        //                {
        //                    //ngay_hluc_old chua duoc gan lan nao
        //                    drSL3 = dsCalculation.Tables["SL_3"].NewRow();
        //                    drSL3.ItemArray = drwSL3.Row.ItemArray;
        //                    drSL3["SAN_LUONG"] = sl;
        //                    drSL3["NGAY_DAU"] = ngay_dau;
        //                    drSL3["NGAY_CUOI"] = ngay_cuoi;
        //                    dsCalculation.Tables["SL_3"].Rows.Add(drSL3);
        //                }
        //                else
        //                {
        //                    //if (ngay_hluc != ngay_hluc_old)
        //                    //{
        //                        //ngay_hluc_old da duoc gan it nhat 1 lan
        //                        if (ngay_hluc_old < ngay_dau)
        //                        {
        //                            drSL3 = dsCalculation.Tables["SL_3"].NewRow();
        //                            drSL3.ItemArray = drwSL3.Row.ItemArray;
        //                            drSL3["SAN_LUONG"] = sl;
        //                            drSL3["NGAY_DAU"] = ngay_dau;
        //                            drSL3["NGAY_CUOI"] = ngay_cuoi;
        //                            dsCalculation.Tables["SL_3"].Rows.Add(drSL3);
        //                        }
        //                        else
        //                        {
        //                            drSL3 = dsCalculation.Tables["SL_3"].NewRow();
        //                            drSL3.ItemArray = drwSL3.Row.ItemArray;
        //                            drSL3["SAN_LUONG"] = sl;
        //                            drSL3["NGAY_DAU"] = ngay_hluc_old;
        //                            drSL3["NGAY_CUOI"] = ngay_cuoi;
        //                            dsCalculation.Tables["SL_3"].Rows.Add(drSL3);
        //                        }
        //                    //}
        //                }
        //            }
        //        }
        //        #endregion

        //        #region Xu ly cho cac thanh phan khac
        //        dwSL3.RowFilter = "MA_NHOMNN NOT IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN')";
        //        foreach (DataRowView drwSL3 in dwSL3)
        //        {
        //            drSL3 = dsCalculation.Tables["SL_3"].NewRow();
        //            drSL3.ItemArray = drwSL3.Row.ItemArray;
        //            dsCalculation.Tables["SL_3"].Rows.Add(drSL3);
        //        }
        //        #endregion

        //        return "";
        //    }
        //    catch (Exception ex)
        //    {
        //        return "DetailDataCalculation_41: " + ex.Message;
        //    }
        //}

        /*
        //Tach san luong ban buon trong ky doi gia, co chot chi so hoac noi suy neu khong chot chi so
         */
        public string DetailDataCalculation_41(DS_CALCULATIONTABLES dsCalculation, DataSet dsStaticCatalog, DataSet dsCustomerData)
        {
            try
            {
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_3") == false)
                    return "NotExistsSL_3";

                if (dsStaticCatalog == null)
                    return "dsStaticCatalogIsNull";
                else
                    if (dsStaticCatalog.Tables.Contains("D_GIA_NHOMNN") == false)
                    return "NotExistsD_GIA_NHOMNN";
                else
                        if (dsStaticCatalog.Tables.Contains("D_THAMCHIEU_CAPDA") == false)
                    return "NotExistsD_THAMCHIEU_CAPDA";

                string strMa_DDo = "", strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";
                DateTime ngay_hlucgia = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_dau = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                Decimal IsChangePrice = 0, sl = 0, sl_ct = 0;
                DataRow drSL_New;

                DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                DataView dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                dwSL3.Sort = "MA_DVIQLY, MA_DDO, MA_NHOMNN, MA_NGIA, NGAY_DAU, NGAY_CUOI";

                #region Diem do chinh
                DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                dwGia.Sort = "NGAY_HLUC";

                foreach (DataRowView drwSL3 in dwSL3)
                {
                    strMa_DDo = Convert.ToString(drwSL3["MA_DDO"]);
                    ngay_dau = Convert.ToDateTime(drwSL3["NGAY_DAU"]);
                    ngay_cuoi = Convert.ToDateTime(drwSL3["NGAY_CUOI"]);
                    IsChangePrice = 0;
                    //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                    ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                    if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                    {
                        ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                    }
                    else
                    {
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                            {
                                ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            }
                        }
                    }
                    //Kiem tra thay doi gia nha nuoc hay khong
                    dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                    foreach (DataRowView drwGia in dwGia)
                    {
                        ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                        if (Convert.ToDateTime(drwSL3["NGAY_HLUCGIA"]) == ngay_hlucgia)
                        {
                            //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                            strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                            strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                            strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                            strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                            strKhoang_DAp = "";

                            //Tim khoang tham chieu cap dien ap
                            dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                            foreach (DataRowView drCapDA in dwTChieuDA)
                            {
                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_ckymax == ngay_hluc)
                                {
                                    //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                    //se tinh toan bo vao bac thang cua bang gia cu
                                    continue;
                                }
                                if (ngay_cuoi >= ngay_hluc)
                                {
                                    strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                    break;
                                }
                            }

                            if (strKhoang_DAp != "")
                            {
                                dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                foreach (DataRowView drGia in dwGiaNhomNN)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_ckymax == ngay_hluc)
                                    {
                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                        //se tinh toan bo vao bac thang cua bang gia cu
                                        //continue;
                                        IsChangePrice = 0;
                                        break;
                                    }
                                    if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                    {
                                        //Co doi gia
                                        IsChangePrice = 1;
                                        break;
                                    }
                                }
                            }

                            if (IsChangePrice == 1)
                            {
                                break;
                            }
                        }
                    }

                    if (IsChangePrice == 1)
                    {
                        //Co doi gia nha nuoc, thuc hien tach san luong                                                
                        sl = Convert.ToDecimal(drwSL3["SAN_LUONG"]);
                        sl_ct = Math.Round(sl * Convert.ToDecimal(ngay_hluc.Subtract(ngay_dau).TotalDays) / Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1), 0, MidpointRounding.AwayFromZero);

                        drwSL3["SAN_LUONG"] = sl_ct;
                        drwSL3["NGAY_DAU"] = ngay_dau;
                        drwSL3["NGAY_CUOI"] = ngay_hluc.AddDays(-1.0);

                        drSL_New = dsCalculation.Tables["SL_3"].NewRow();
                        drSL_New.ItemArray = drwSL3.Row.ItemArray;
                        drSL_New["SAN_LUONG"] = sl - sl_ct;
                        drSL_New["NGAY_DAU"] = ngay_hluc;
                        drSL_New["NGAY_CUOI"] = ngay_cuoi;
                        dsCalculation.Tables["SL_3"].Rows.Add(drSL_New);
                    }
                }
                #endregion

                #region Diem do phu ghep tong
                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                {
                    dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                    dwGia.Sort = "NGAY_HLUC";

                    foreach (DataRowView drwSL3 in dwSL3)
                    {
                        strMa_DDo = Convert.ToString(drwSL3["MA_DDO"]);
                        ngay_dau = Convert.ToDateTime(drwSL3["NGAY_DAU"]);
                        ngay_cuoi = Convert.ToDateTime(drwSL3["NGAY_CUOI"]);
                        IsChangePrice = 0;
                        strKhoang_DAp = "";

                        //Kiem tra thay doi gia nha nuoc hay khong
                        dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        foreach (DataRowView drwGia in dwGia)
                        {
                            ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                            if (Convert.ToDateTime(drwSL3["NGAY_HLUCGIA"]) == ngay_hlucgia)
                            {
                                //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);

                                //Tim khoang tham chieu cap dien ap
                                dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                foreach (DataRowView drCapDA in dwTChieuDA)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_cuoi >= ngay_hluc)
                                    {
                                        strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                        break;
                                    }
                                }

                                if (strKhoang_DAp != "")
                                {
                                    dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                    foreach (DataRowView drGia in dwGiaNhomNN)
                                    {
                                        ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (ngay_ckymax == ngay_hluc)
                                        {
                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                            //se tinh toan bo vao bac thang cua bang gia cu
                                            //continue;
                                            IsChangePrice = 0;
                                            break;
                                        }
                                        if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                        {
                                            //Co doi gia
                                            IsChangePrice = 1;
                                            break;
                                        }
                                    }
                                }

                                if (IsChangePrice == 1)
                                {
                                    break;
                                }
                            }
                        }

                        if (IsChangePrice == 1)
                        {
                            //Co doi gia nha nuoc, thuc hien tach san luong                                                
                            sl = Convert.ToDecimal(drwSL3["SAN_LUONG"]);
                            sl_ct = Math.Round(sl * Convert.ToDecimal(ngay_hluc.Subtract(ngay_dau).TotalDays) / Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dau).TotalDays + 1), 0, MidpointRounding.AwayFromZero);

                            drwSL3["SAN_LUONG"] = sl_ct;
                            drwSL3["NGAY_DAU"] = ngay_dau;
                            drwSL3["NGAY_CUOI"] = ngay_hluc.AddDays(-1.0);

                            drSL_New = dsCalculation.Tables["SL_3"].NewRow();
                            drSL_New.ItemArray = drwSL3.Row.ItemArray;
                            drSL_New["SAN_LUONG"] = sl - sl_ct;
                            drSL_New["NGAY_DAU"] = ngay_hluc;
                            drSL_New["NGAY_CUOI"] = ngay_cuoi;
                            dsCalculation.Tables["SL_3"].Rows.Add(drSL_New);
                        }
                    }
                }
                #endregion

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_41: " + ex.Message;
            }
        }

        //Xu ly rieng cho ban buon SHBB nhom L trong thang 3/2011
        public string DetailDataCalculation_42(DS_CALCULATIONTABLES dsCalculation)
        {
            try
            {
                string strMa_DDo = "";
                DateTime ngay_dau, ngay_cuoi, ngay20110301;
                DataView dwSL3_A = new DataView(dsCalculation.Tables["SL_3"]);
                DataView dwSL3_K = new DataView(dsCalculation.Tables["SL_3"]);
                DataView dwSL3_L = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3_L.RowFilter = "MA_NHOMNN = 'SHBB' AND MA_NGIA = 'L' AND BCS IN ('KT','BT') AND MA_NN = '1100'";
                dwSL3_L.Sort = "MA_DDO, NGAY_CUOI, NGAY_DAU";

                if (dwSL3_L.Count == 0)
                {
                    return "";
                }

                strMa_DDo = "";
                ngay_dau = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cuoi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay20110301 = DateTime.Parse("01/03/2011", new System.Globalization.CultureInfo("vi-VN"));

                foreach (DataRowView drwSL3_L in dwSL3_L)
                {
                    strMa_DDo = Convert.ToString(drwSL3_L["MA_DDO"]);
                    ngay_dau = Convert.ToDateTime(drwSL3_L["NGAY_DAU"]);
                    ngay_cuoi = Convert.ToDateTime(drwSL3_L["NGAY_CUOI"]);
                    if (ngay_cuoi < ngay20110301)
                    {
                        continue;
                    }
                    else
                    {
                        if (ngay_dau < ngay20110301)
                        {
                            continue;
                        }
                        else
                        {
                            //Xu ly bat dau tu 01/03/2011
                            dwSL3_K.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS IN ('BT','KT') AND MA_NGIA = 'K'";
                            if (dwSL3_K.Count == 0)
                            {
                                //Khong co muc dich khac, tao ra 1 nhom MDK
                                dwSL3_A.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS IN ('BT','KT') AND MA_NGIA IN ('A','D')";
                                if (dwSL3_A.Count != 0)
                                {
                                    drwSL3_L["MA_NGIA"] = "K";
                                    drwSL3_L["MA_NHOMNN"] = dwSL3_A[0]["MA_NHOMNN"];
                                    //drwSL3_L["BCS"] = "KT";
                                    drwSL3_L["MA_NN"] = dwSL3_A[0]["MA_NN"];
                                }
                                else
                                {
                                    drwSL3_L["MA_NGIA"] = "K";
                                    drwSL3_L["MA_NHOMNN"] = "SHBB";
                                    //drwSL3_L["BCS"] = "KT";
                                    drwSL3_L["MA_NN"] = "1100";
                                }
                            }
                            else
                            {
                                //Co muc dich khac
                                foreach (DataRowView drwSL3_K in dwSL3_K)
                                {
                                    if (ngay_dau == Convert.ToDateTime(drwSL3_K["NGAY_DAU"]) && ngay_cuoi == Convert.ToDateTime(drwSL3_K["NGAY_CUOI"]))
                                    {
                                        drwSL3_K["SAN_LUONG"] = Convert.ToDecimal(drwSL3_K["SAN_LUONG"]) + Convert.ToDecimal(drwSL3_L["SAN_LUONG"]);
                                        drwSL3_L.Row.Delete();
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_42: " + ex.Message;
            }
        }

        private void WriteLog(string strMa_DViQLy, string strMa_SoGCS, string strAssemblyName, string strNamespace, string strMethodName, string strDetail)
        {
            DataRow drLog;
            LOGDATA dsLog = new LOGDATA();
            cls_LogManagement log;

            drLog = dsLog.Tables["S_LOG"].NewRow();
            drLog["SUBDIVISIONID"] = strMa_DViQLy;
            drLog["LOGID"] = 1;
            drLog["BOOKID"] = strMa_SoGCS;
            drLog["ASSEMBLYNAME"] = strAssemblyName;
            drLog["NAMESPACE"] = strNamespace;
            drLog["METHODNAME"] = strMethodName;
            drLog["TIME"] = System.DateTime.Now;
            drLog["DETAIL"] = strDetail;
            dsLog.Tables["S_LOG"].Rows.Add(drLog);
            dsLog.Tables["S_LOG"].AcceptChanges();

            log = new cls_LogManagement(dsLog);
            log.InsertList();
            dsLog.Tables["S_LOG"].Rows.Clear();
        }

        //Xu ly rieng cho SHBT, neu san luong bac thang nho hon 50 / 1 ho (ho ngheo) va 100 / 1 ho (ho thong thuong), trong ky doi gia
        public string DetailDataCalculation_43(DS_CALCULATIONTABLES dsCalculation, DataSet dsStaticCatalog, DataSet dsCustomerData)
        {
            try
            {
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_3") == false)
                    return "NotExistsSL_3";

                if (dsStaticCatalog == null)
                    return "dsStaticCatalogIsNull";
                else
                    if (dsStaticCatalog.Tables.Contains("D_GIA_NHOMNN") == false)
                    return "NotExistsD_GIA_NHOMNN";
                else
                        if (dsStaticCatalog.Tables.Contains("D_THAMCHIEU_CAPDA") == false)
                    return "NotExistsD_THAMCHIEU_CAPDA";

                string strMa_DDo = "", strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";
                int IsChecked = 0; //1: da check, nam trong cac doi tuong SHBT can xu ly; 2: da check, khong nam trong cac doi tuong SHBT can xu ly
                DateTime ngay_dkymin = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                Decimal IsChangePrice = 0, sl = 0, sl_dmuc = 0;

                DataView dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3.RowFilter = "MA_NHOMNN IN ('SHBT') AND MA_NGIA IN ('A','N')";
                dwSL3.Sort = "MA_DVIQLY, MA_DDO, MA_NHOMNN, MA_NGIA, NGAY_DAU, NGAY_CUOI";

                DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                DataView dwBThang = new DataView(dsStaticCatalog.Tables["D_BAC_THANG"]);
                dwBThang.RowFilter = "MA_NHOMNN = 'SHBT' AND MA_NGIA = 'A'";
                dwBThang.Sort = "NGAY_HLUC DESC";

                foreach (DataRowView drwSL3 in dwSL3)
                {
                    if (strMa_DDo != Convert.ToString(drwSL3["MA_DDO"]) || strMa_NhomNN != Convert.ToString(drwSL3["MA_NHOMNN"]) || strMa_NGia != Convert.ToString(drwSL3["MA_NGIA"]))
                    {
                        strMa_DDo = Convert.ToString(drwSL3["MA_DDO"]);
                        strMa_NhomNN = Convert.ToString(drwSL3["MA_NHOMNN"]);
                        strMa_NGia = Convert.ToString(drwSL3["MA_NGIA"]);
                        strMa_CapDA = Convert.ToString(drwSL3["MA_CAPDAP"]);
                        strTGian_BDien = Convert.ToString(drwSL3["TGIAN_BDIEN"]);
                        strKhoang_DAp = "";
                        IsChangePrice = 0;
                        IsChecked = 0;
                        ngay_dkymin = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        sl = 0;
                        sl_dmuc = 0;

                        //Kiem tra co doi gia nha nuoc hay khong, ap dung trong toan bo chi so cua diem do
                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO IN ('DDK','DDN','CSC','CCS')").Length != 0)
                        {
                            ngay_dkymin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO IN ('DDK','DDN','CSC','CCS')"));
                            ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO IN ('DDK','DDN','CSC','CCS')"));
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO IN ('DDK','DDN','CSC','CCS')").Length != 0)
                                {
                                    ngay_dkymin = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO IN ('DDK','DDN','CSC','CCS')"));
                                    ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO IN ('DDK','DDN','CSC','CCS')"));
                                }
                            }
                        }

                        //Tim khoang tham chieu cap dien ap
                        dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                        foreach (DataRowView drCapDA in dwTChieuDA)
                        {
                            ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (ngay_ckymax >= ngay_hluc)
                            {
                                strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                break;
                            }
                        }

                        //Kiem tra trong D_GIA_NHOMNN
                        if (strKhoang_DAp != "")
                        {
                            dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                            foreach (DataRowView drGia in dwGiaNhomNN)
                            {
                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_ckymax >= ngay_hluc && ngay_dkymin < ngay_hluc)
                                {
                                    //Co doi gia
                                    IsChangePrice = 1;
                                    break;
                                }
                            }
                        }

                        if (IsChangePrice == 1)
                        {
                            //Co doi gia nha nuoc
                            //Kiem tra va so sanh tong san luong tieu thu so voi san luong dinh muc theo bac thang
                            sl = 0;
                            foreach (DataRowView drwSL3_1 in dwSL3)
                            {
                                if (strMa_DDo == Convert.ToString(drwSL3_1["MA_DDO"]) || strMa_NhomNN == Convert.ToString(drwSL3_1["MA_NHOMNN"]) || strMa_NGia == Convert.ToString(drwSL3_1["MA_NGIA"]))
                                {
                                    sl += CMISLibrary.Utility.DecimalDbnull(drwSL3_1["SAN_LUONG"]);
                                }
                            }
                            dwBThang.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_NGIA = '" + strMa_NGia + "'";
                            dwBThang.Sort = "NGAY_HLUC DESC, BTHANG_ID";
                            foreach (DataRowView drwBThang in dwBThang)
                            {
                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drwBThang["NGAY_HLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (ngay_ckymax >= ngay_hluc && ngay_dkymin < ngay_hluc)
                                {
                                    sl_dmuc = CMISLibrary.Utility.DecimalDbnull(drwBThang["DINH_MUC"]);
                                    break;
                                }
                            }
                            //sl_dmuc = Math.Round(sl_dmuc * (ngay_ckymax.Subtract(ngay_dkymin).TotalDays + 1) / Convert.ToDecimal(drwSL3["SO_NGAYDMUC"]), 0, MidpointRounding.AwayFromZero);

                            if (sl <= sl_dmuc)
                            {

                                IsChecked = 1;
                            }
                            else
                            {
                                IsChecked = 2;
                            }
                        }
                        else
                        {
                            //Khong doi gia nha nuoc
                            IsChecked = 2;
                        }
                    }
                    else
                    {
                        if (IsChecked == 1)
                        {
                            //Xoa cac dong con lai
                            dsCalculation.Tables["SL_3"].Rows.Remove(drwSL3.Row);
                        }
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_43: " + ex.Message;
            }
        }

        public string DetailDataCalculation_40(DS_CALCULATIONTABLES dsCalculation, DataSet dsCustomerData, DataSet dsStaticCatalog, DataSet dsInvoiceData, string strMa_DViQLy, string strMa_SoGCS, short ky, short thang, short nam)
        {
            try
            {
                DataView dwSL3, dwSLBBuon, dwSLBBuon_GT, dwGCS, dwGCS_GT, dwCosfi, dwSL3_Temp, dwDDo, dwDDoGT;
                DataTable dtSL3_Update;
                string strMa_DDoBB = "|", strMa_DDo = "", strMa_NhomNNBB = "";
                //Bổ sung loạt biến dùng cho nội suy sản lượng SHTM MDK ngày 16/03/2015
                //Mới xử lý cho tháng đổi giá, chưa xử lý cho tháng đổi CSPK
                Decimal slBB_KT = 0, slBB_BT = 0, slBB_CD = 0, slBB_TD = 0, slKT_BT = 0, slKT_CD = 0, slKT_TD = 0, slBB_KT_1 = 0, slBB_BT_1 = 0, slBB_CD_1 = 0, slBB_TD_1 = 0, slKT_BT_1 = 0, slKT_CD_1 = 0, slKT_TD_1 = 0;
                Decimal slBB = 0, slBB_1 = 0, slTP = 0, slBN_BT = 0, slBN_CD = 0, slBN_TD = 0, slTNT50 = 0, sohoTNT50 = 0, slMDK = 0, slMDK_CSPK = 0, slMDK_T = 0, slMDK_S = 0, sl_TruocChot = 0, sl_SauChot = 0, slB3_T = 0, slB3_S = 0;
                Decimal slTP_T = 0, slBN_BT_T = 0, slBN_CD_T = 0, slBN_TD_T = 0, slTNT50_T = 0, slTP_S = 0, slBN_BT_S = 0, slBN_CD_S = 0, slBN_TD_S = 0, slTNT50_S = 0;
                Decimal slMDK_BT = 0, slMDK_CD = 0, slMDK_TD = 0, slMDK_BT_T = 0, slMDK_CD_T = 0, slMDK_TD_T = 0, slMDK_BT_S = 0, slMDK_CD_S = 0, slMDK_TD_S = 0, tonthat_cu, tonthat_moi, ttb3_cu, ttb3_moi, soho_b3;
                Decimal slMDK_BT_CSPK = 0, slMDK_CD_CSPK = 0, slMDK_TD_CSPK = 0;
                DataRow drTP, drBN_BT, drBN_CD, drBN_TD, drTNT50, drCCS_New, drMDK_BT, drMDK_CD, drMDK_TD;
                //DataRow[] drBB;
                //IsBBtoTM: Biến kiểm tra có đổi loại từ bán buôn thông thường sang SHTM không
                //IsBMtoTM: Biến kiểm tra có đổi loại từ SHBM sang SHTM không: 1: có; 0: đổi loại bán buôn thông thường
                Int16 IsExists_SLTPBB = 0, IsBBtoTM = 0, IsBMtoTM = 0, isExistsCSPK = 0, isPhat = 0, isCPK = 0, isCCSDGia = 0;
                DateTime ngay_dky, ngay_cky, ngay_ccs, ngay_hhluc, dtDoiHSPhatCosfi;
                //Biến tên bảng lưu sản lượng thương phẩm 
                string strTableName = "";
                //Bổ sung biến lưu sản lượng CSPK, sử dụng cho kỳ có đổi CSPK
                decimal slBB_CSPK = 0, sl_MDK_BT_CSPK = 0, sl_MDK_CD_CSPK = 0, sl_MDK_TD_CSPK = 0;
                //Gom san luong cua cac doi tuong Ban buon - xu ly rieng
                //Cap nhat du lieu vao bang SL_3
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_3") == false)
                    return "NotExistsSL_3";
                if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                    return "NotExistsGCS_CHISO";
                if (dsCustomerData.Tables.Contains("HDG_DIEM_DO") == false)
                    return "NotExistsHDG_DIEM_DO";
                if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                    return "NotExistsD_COSFI";
                dwCosfi = new DataView(dsStaticCatalog.Tables["D_COSFI"]);
                dwCosfi.Sort = "NGAY_ADUNG DESC";
                dwDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                dwDDo.Sort = "NGAY_HLUC DESC, LAN_CAPNHAT DESC";
                if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == true)
                {
                    dwDDoGT = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                    dwDDoGT.Sort = "NGAY_HLUC DESC, LAN_CAPNHAT DESC";
                }
                dwGCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                dwSL3.Sort = "MA_DVIQLY, MA_DDO, NGAY_DAU, NGAY_CUOI, MA_NHOMNN, MA_NGIA";
                dwSL3_Temp = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3_Temp.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                //dwSL3_Temp.Sort = "MA_DVIQLY, MA_DDO, NGAY_DAU, NGAY_CUOI, MA_NHOMNN, MA_NGIA";
                dtSL3_Update = dwSL3_Temp.Table.Clone();
                if (dwSL3.Count == 0)
                    return ""; //Khong ton tai thanh phan ban buon       

                //Co ton tai thanh phan ban buon
                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") == true)
                {
                    dwSLBBuon = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                    if (dwSLBBuon.Count != 0)
                    {
                        dwSLBBuon.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwSLBBuon[0]["MA_DVIQLY"]) + "'";
                    }
                }
                else
                {
                    dwSLBBuon = null;
                }

                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                {
                    dwSLBBuon_GT = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                    if (dwSLBBuon_GT.Count != 0)
                    {
                        dwSLBBuon_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwSLBBuon_GT[0]["MA_DVIQLY"]) + "'";
                    }
                }
                else
                {
                    dwSLBBuon_GT = null;
                }

                ngay_dky = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cky = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_ccs = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                dtDoiHSPhatCosfi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                foreach (DataRowView drSL3 in dwSL3)
                {
                    if (drSL3.Row.RowState == DataRowState.Deleted || drSL3.Row.RowState == DataRowState.Detached) continue;
                    strMa_DDo = Convert.ToString(drSL3["MA_DDO"]);
                    strMa_NhomNNBB = Convert.ToString(drSL3["MA_NHOMNN"]);
                    //TOAN1415
                    if (strMa_DDo == "PD29007359624001")
                    {
                        strMa_DDo = "PD29007359624001";
                    }
                    if (strMa_DDo == "PD01000011154001")
                    {
                        strMa_DDo = "PD01000011154001";
                    }

                    if (strMa_DDoBB.Contains("|" + strMa_DDo + "|") == false)
                    {
                        //Chua thuc hien xu ly
                        //Tim min ngay dau ky va max ngay cuoi ky
                        ngay_dky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MIN(NGAY_DAU)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')"));
                        ngay_cky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MAX(NGAY_CUOI)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')"));
                        //Khởi tạo lại giá trị trước khi tính
                        ngay_ccs = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        dtDoiHSPhatCosfi = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        sohoTNT50 = 0;
                        slTP = 0;
                        slTP_T = 0;
                        slTP_S = 0;
                        slBN_BT_T = 0;
                        slBN_BT_S = 0;
                        slBN_CD_T = 0;
                        slBN_CD_S = 0;
                        slBN_TD_T = 0;
                        slBN_TD_S = 0;
                        slTNT50 = 0;
                        slTNT50_T = 0;
                        slTNT50_S = 0;
                        slMDK_BT = 0;
                        slMDK_BT_T = 0;
                        slMDK_BT_S = 0;
                        slMDK_CD = 0;
                        slMDK_CD_T = 0;
                        slMDK_CD_S = 0;
                        slMDK_TD = 0;
                        slMDK_TD_T = 0;
                        slMDK_TD_S = 0;
                        tonthat_cu = 1;
                        tonthat_moi = 1;
                        ttb3_cu = 1;
                        ttb3_moi = 1;
                        soho_b3 = 0;
                        slB3_T = 0;
                        slB3_S = 0;
                        IsBMtoTM = 0;
                        IsBBtoTM = 0;
                        isCCSDGia = 0;

                        isExistsCSPK = 0;
                        isPhat = 0;
                        isCPK = 0;
                        slBB_CSPK = 0;
                        slBB_1 = 0;
                        slBB = 0;
                        sl_MDK_BT_CSPK = 0;
                        sl_MDK_CD_CSPK = 0;
                        sl_MDK_TD_CSPK = 0;
                        slBB_KT = 0;
                        slBB_BT = 0;
                        slBB_CD = 0;
                        slBB_TD = 0;
                        slKT_BT = 0;
                        slKT_CD = 0;
                        slKT_TD = 0;
                        slBB_KT_1 = 0;
                        slBB_BT_1 = 0;
                        slBB_CD_1 = 0;
                        slBB_TD_1 = 0;
                        slKT_BT_1 = 0;
                        slKT_CD_1 = 0;
                        slKT_TD_1 = 0;
                        strTableName = "";
                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN <> '" + strMa_NhomNNBB + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')").Length > 0)
                        {
                            DateTime ngay_chuyendoi = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MIN(NGAY_DAU)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <> '" + strMa_NhomNNBB + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')"));
                            if (ngay_chuyendoi > ngay_dky)
                            {
                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN <> '" + strMa_NhomNNBB + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')")[0]["MA_NHOMNN"].ToString().Trim() == "SHTM")
                                //Có đổi từ bán buôn thông thường sang SHTM
                                {
                                    if (strMa_NhomNNBB == "SHBM")
                                        IsBMtoTM = 1;
                                    else
                                        IsBBtoTM = 1;
                                    //Cập nhật lại số hộ theo số hộ lớn nhất
                                    drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                }
                                else
                                {
                                    if (strMa_NhomNNBB == "SHBM")
                                        IsBMtoTM = 2;
                                    else
                                        IsBBtoTM = 2;

                                }
                            }
                        }
                        //Kiểm ta có đổi giá nhà nước luôn từ đây
                        #region Kiểm tra có đổi giá nhà nước không

                        Decimal IsChangePrice = 0;
                        //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                        DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                            {
                                ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                {
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                                    {
                                        ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                    }
                                }
                            }
                        }
                        //Kiem tra thay doi gia nha nuoc hay khong
                        DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                        dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        dwGia.Sort = "NGAY_HLUC";
                        string strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";

                        DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                        dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                        dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                        DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                        dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                        dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                        DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        DateTime ngay_cuoi = ngay_cky;
                        DateTime ngay_dau = ngay_dky;

                        foreach (DataRowView drwGia in dwGia)
                        {
                            //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                            if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                            {
                                //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                strKhoang_DAp = "";

                                //Tim khoang tham chieu cap dien ap
                                dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                foreach (DataRowView drCapDA in dwTChieuDA)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_ckymax == ngay_hluc)
                                    {
                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                        //se tinh toan bo vao bac thang cua bang gia cu
                                        continue;

                                    }
                                    if (ngay_cuoi >= ngay_hluc)
                                    {
                                        strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                        break;
                                    }
                                }

                                if (strKhoang_DAp != "")
                                {
                                    dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                    foreach (DataRowView drGia in dwGiaNhomNN)
                                    {
                                        ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (ngay_ckymax == ngay_hluc)
                                        {
                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                            //se tinh toan bo vao bac thang cua bang gia cu
                                            //continue;
                                            IsChangePrice = 0;
                                            break;
                                        }
                                        if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                        {
                                            //Co doi gia
                                            IsChangePrice = 1;
                                            ngay_ccs = ngay_hluc.AddDays(-1.0);
                                            break;
                                        }
                                        else if (drGia["NGAY_HETHLUC"].ToString().Trim().Length > 0)
                                        {
                                            ngay_hhluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HETHLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            if (ngay_cuoi >= ngay_hhluc && ngay_dau <= ngay_hhluc)
                                            {
                                                //Nhóm giá bị hết hiệu lực giữa kỳ -> Co doi gia
                                                IsChangePrice = 1;
                                                ngay_ccs = ngay_hhluc;
                                                break;
                                            }

                                        }
                                    }
                                }

                                if (IsChangePrice == 1)
                                {
                                    break;
                                }
                            }
                        }

                        //22/12/2012: Kiem tra them voi diem do phu ghep tong
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                            {
                                dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                                dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                dwGia.Sort = "NGAY_HLUC";

                                foreach (DataRowView drwGia in dwGia)
                                {
                                    //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                                    if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                                    {
                                        //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                        strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                        strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                        strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                        strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                        strKhoang_DAp = "";

                                        //Tim khoang tham chieu cap dien ap
                                        dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                        foreach (DataRowView drCapDA in dwTChieuDA)
                                        {
                                            ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            if (ngay_ckymax == ngay_hluc)
                                            {
                                                //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                //se tinh toan bo vao bac thang cua bang gia cu
                                                continue;
                                            }
                                            if (ngay_cuoi >= ngay_hluc)
                                            {
                                                strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                                break;
                                            }
                                        }

                                        if (strKhoang_DAp != "")
                                        {
                                            dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                            foreach (DataRowView drGia in dwGiaNhomNN)
                                            {
                                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                if (ngay_ckymax == ngay_hluc)
                                                {
                                                    //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                    //se tinh toan bo vao bac thang cua bang gia cu
                                                    //continue;
                                                    IsChangePrice = 0;
                                                    break;
                                                }
                                                if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                                {
                                                    //Co doi gia
                                                    IsChangePrice = 1;
                                                    ngay_ccs = ngay_hluc.AddDays(-1.0);
                                                    break;
                                                }
                                                else if (drGia["NGAY_HETHLUC"].ToString().Trim().Length > 0)
                                                {
                                                    ngay_hhluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HETHLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    if (ngay_cuoi >= ngay_hhluc && ngay_dau <= ngay_hhluc)
                                                    {
                                                        //Nhóm giá bị hết hiệu lực giữa kỳ -> Co doi gia
                                                        IsChangePrice = 1;
                                                        ngay_ccs = ngay_hhluc;
                                                        break;
                                                    }

                                                }
                                            }
                                        }

                                        if (IsChangePrice == 1)
                                        {
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        #endregion
                        #region Kiểm tra có nhập chỉ số chốt đổi giá không
                        dwGCS.RowFilter = "MA_DDO='" + strMa_DDo + "' and LOAI_CS_GOC='CCS'";
                        if (dwGCS != null && dwGCS.Count > 0)
                        {
                            isCCSDGia = 1;
                            dwGCS.RowFilter = "1=1";
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT"))
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO='" + strMa_DDo + "' and LOAI_CS_GOC='CCS'";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    isCCSDGia = 1;

                                }
                                else
                                {
                                    isCCSDGia = 0;
                                }

                            }
                            else
                            {
                                isCCSDGia = 0;
                            }
                        }
                        #endregion

                        #region Kiem tra su ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                        IsExists_SLTPBB = 0;
                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") == true)
                        {
                            //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                            dwSLBBuon.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                            if (dwSLBBuon.Count > 0)
                            {
                                IsExists_SLTPBB = 1;
                                strTableName = "GCS_SLMDK_SHBB";
                            }
                            else
                            {
                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                                {
                                    //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                    dwSLBBuon_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                    if (dwSLBBuon_GT.Count > 0)
                                    {
                                        IsExists_SLTPBB = 2;
                                        strTableName = "GCS_SLMDK_SHBB_GT";
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                            {
                                //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                dwSLBBuon_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                if (dwSLBBuon_GT.Count > 0)
                                {
                                    IsExists_SLTPBB = 2;
                                    strTableName = "GCS_SLMDK_SHBB_GT";
                                }
                            }
                        }
                        #endregion
                        #region Kiểm tra có đổi CSPK không
                        foreach (DataRowView drvCSPK in dwCosfi)
                        {
                            DateTime dtTemp = Convert.ToDateTime(drvCSPK["NGAY_ADUNG"]);
                            if (ngay_dky < dtTemp && ngay_cky >= dtTemp)
                            {

                                //Có đổi hệ số phạt cosfi
                                isExistsCSPK = 1;
                                //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                break;
                            }
                        }
                        #endregion
                        #region Kiểm tra có nhập chỉ số chốt CSPK không
                        dwGCS.RowFilter = "MA_DDO='" + strMa_DDo + "' and LOAI_CS_GOC='CPK'";
                        if (dwGCS != null && dwGCS.Count > 0)
                        {
                            isCPK = 1;
                            dwGCS.RowFilter = "1=1";
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT"))
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO='" + strMa_DDo + "' and LOAI_CS_GOC='CPK'";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    isCPK = 1;

                                }
                                else
                                {
                                    isCPK = 0;
                                }

                            }
                            else
                            {
                                isCPK = 0;
                            }
                        }
                        #endregion
                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM') AND MA_NGIA = 'K'").Length != 0)
                        {
                            //Có MDK, kiểm tra có nhóm A không
                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM') AND MA_NGIA = 'A'").Length <= 0)
                            {
                                //Không có nhóm A, coi như 100% MDK hết, không để ý đến GCS_SLMDK_SHBB nữa
                                //Không cần để ý đến SHBB nhóm N do sau ngày 1/06/2014 không còn nhóm nghèo nữa

                                strMa_NGia = "K";
                                isPhat = 1;
                            }
                            else
                            {
                                //Nếu có nhóm A, để sang phần sau tính tiếp
                                isPhat = 0;
                            }
                        }
                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <> 'SHTM' AND MA_NGIA in('D','E')").Length != 0)
                        {
                            //Có phạt
                            strMa_NGia = "E";
                            isPhat = 1;
                        }
                        if (isPhat == 1)
                        {
                            #region Nhóm phạt và 100% MDK

                            //Xử lý riêng cho nhóm giá phạt, 100% MDK
                            dwSL3_Temp.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                            dwSL3_Temp.Sort = "BCS DESC, ID_CHISO DESC";
                            int iCount = dwSL3_Temp.Count - 1;
                            if (dwSL3_Temp != null && dwSL3_Temp.Count > 0)
                            {
                                if (isExistsCSPK == 1 && isCPK == 1)
                                {
                                    //Có đổi CSPK nhà nước và có nhập chỉ số chốt
                                    if (IsChangePrice == 1)
                                    {
                                        //Xử lý ghép thành 3 khoảng
                                        while (iCount >= 0)
                                        {
                                            DataRowView drv = dwSL3_Temp[iCount];
                                            if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                            {
                                                #region Ban buon phat-BT/KT-CSPK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                                #region Ban buon phat-BT/KT-DOIGIA

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                                #region Ban buon phat-BT/KT-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }
                                            else
                                            {
                                                #region Ban buon phat-CD/TD-CSPK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                                #region Ban buon phat-CD/TD-DOIGIA

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                                #region Ban buon phat-CD/TD-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }
                                            drv.Delete();
                                            iCount--;
                                        }
                                    }
                                    else
                                    {
                                        //Xử lý ghép thành 2 khoảng: CSPK và DDK (Không có đổi giá NN)
                                        while (iCount >= 0)
                                        {
                                            DataRowView drv = dwSL3_Temp[iCount];
                                            if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                            {
                                                #region Ban buon phat-BT/KT-CSPK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                                #region Ban buon phat-BT/KT-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion

                                            }
                                            else
                                            {
                                                #region Ban buon phat-CD/TD-CSPK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                                #region Ban buon phat-CD/TD-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion

                                            }
                                            drv.Delete();
                                            iCount--;
                                        }
                                    }

                                }
                                else
                                {
                                    //Không đổi CSPK
                                    if (IsChangePrice == 1)
                                    {
                                        //Đổi giá, tách thành 2 khoảng
                                        while (iCount >= 0)
                                        {
                                            DataRowView drv = dwSL3_Temp[iCount];

                                            if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                            {
                                                #region Ban buon phat-BT/KT-DOIGIA

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion

                                                #region Ban buon phat-BT/KT-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }
                                            else
                                            {
                                                #region Ban buon phat-CD/TD-CSPK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion

                                                #region Ban buon phat-CD/TD-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }
                                            drv.Delete();
                                            iCount--;
                                        }
                                    }
                                    else
                                    {
                                        //Không đổi gì cả, để gọn thành 1 khoảng
                                        while (iCount >= 0)
                                        {
                                            DataRowView drv = dwSL3_Temp[iCount];

                                            if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                            {
                                                #region Ban buon phat-BT/KT-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }
                                            else
                                            {
                                                #region Ban buon phat-CD/TD-DDK

                                                if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                {
                                                    //Khoảng CSPK
                                                    if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                    {
                                                        dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                        dtSL3_Update.ImportRow(drv.Row);
                                                        dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                        dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                        dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                        dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                        dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                    }
                                                    else
                                                    {
                                                        int isExistsTemp = 0;
                                                        foreach (DataRow dr in dtSL3_Update.Rows)
                                                        {
                                                            if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                            {
                                                                //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                //Thay đổi BCS
                                                                if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                {
                                                                    //Cập nhật ID_CHISO của dòng sau
                                                                    dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                    if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                    {
                                                                        //Cập nhật BCS của dòng sau
                                                                        dr["BCS"] = drv["BCS"];
                                                                        dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                    }
                                                                }
                                                                isExistsTemp = 1;
                                                                break;
                                                            }
                                                        }
                                                        //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                        if (isExistsTemp == 0)
                                                        {
                                                            drv.Row["MA_NGIA"] = strMa_NGia;
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                        }
                                                    }
                                                }

                                                #endregion
                                            }
                                            drv.Delete();
                                            iCount--;
                                        }
                                    }
                                }
                            }
                            //Đẩy lại vào SL3.
                            dtSL3_Update.AcceptChanges();
                            if (dtSL3_Update != null && dtSL3_Update.Rows.Count > 0)
                                foreach (DataRow drvInsert in dtSL3_Update.Rows)
                                {
                                    if (Convert.ToDecimal(drvInsert["SAN_LUONG"]) < 0)
                                        return "Điểm đo " + drvInsert["MA_DDO"].ToString().Trim() + " từ " + Convert.ToDateTime(drvInsert["NGAY_DAU"]).ToString("dd/MM/yyyy") + " đến " + Convert.ToDateTime(drvInsert["NGAY_CUOI"]).ToString("dd/MM/yyyy") + " có sản lượng CTT < sản lượng MDK";
                                    if (Convert.ToDecimal(drvInsert["SAN_LUONG"]) > 0)
                                        dsCalculation.Tables["SL_3"].ImportRow(drvInsert);
                                }
                            dtSL3_Update.Clear();

                            #endregion
                        }
                        else
                        {
                            #region Kiểu mới- nhóm A + % khác
                            if (IsExists_SLTPBB != 0)
                            {
                                #region Tồn tại dữ liệu trong GCS_SLMDK_SHBB / GCS_SLMDK_SHBB_GT
                                //Coi như trong SL3 giờ toàn nhóm A hết
                                dwSL3_Temp.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                                dwSL3_Temp.Sort = "BCS DESC, ID_CHISO DESC";
                                int iCount = dwSL3_Temp.Count - 1;
                                if (dwSL3_Temp != null && dwSL3_Temp.Count > 0)
                                {
                                    if (isExistsCSPK == 1 && isCPK == 1)
                                    {
                                        //Có đổi CSPK nhà nước và có nhập chỉ số chốt
                                        //Chưa xử lý trường hợp có đổi CSPK + có cả SL bậc 3 (15/01/2019)
                                        if (IsChangePrice == 1)
                                        {
                                            //Xử lý ghép thành 3 khoảng
                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                {
                                                    #region Ban buon phat-BT/KT-CSPK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                            slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                    #region Ban buon phat-BT/KT-DOIGIA

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                    #region Ban buon phat-BT/KT-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Ban buon phat-CD/TD-CSPK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                    #region Ban buon phat-CD/TD-DOIGIA

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                    #region Ban buon phat-CD/TD-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }
                                            //Chuẩn hóa xong theo nhóm giá, chuẩn hóa tiếp cho SL-MDK
                                            DataView dvMDK = new DataView(dsCustomerData.Tables[strTableName]);
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            if (strMa_NhomNNBB != "SHTM")
                                            {
                                                #region Bán buôn khác SHTM

                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK is not null"));
                                                else
                                                    slMDK_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                else
                                                    slMDK_T = -1;
                                                //Nội suy sản lượng CSPK mục đích khác
                                                if (isCCSDGia == 1)
                                                {
                                                    //Có nhập chỉ số chốt đổi giá, nội suy theo sản lượng
                                                    //Có nhập chốt MDK
                                                    if (slMDK_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CSPK = Math.Round(slMDK_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_T = slMDK_T - slMDK_CSPK;
                                                        slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_T = Math.Round(slMDK_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;
                                                    }
                                                }
                                                else
                                                {
                                                    //Không nhập chỉ số chốt đổi giá, nội suy theo ngày, riêng CSPK nội suy theo sản lượng
                                                    if (slMDK_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_CSPK = Math.Round(slMDK_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CSPK = Math.Round(slMDK_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_T = slMDK_T - slMDK_CSPK;
                                                        slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_T = Math.Round((slMDK_S - slMDK_CSPK) * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_cky.Subtract(dtDoiHSPhatCosfi).TotalDays), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;
                                                    }
                                                }
                                                //Nhân tỷ lệ tổn thất
                                                slMDK_CSPK = Math.Round(slMDK_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_T = Math.Round(slMDK_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_S = Math.Round(slMDK_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];
                                                    if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) - slMDK_CSPK;
                                                            DataRow drMDK_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_CSPK["SAN_LUONG"] = slMDK_CSPK;
                                                            drMDK_CSPK["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_CSPK);
                                                        }
                                                        else
                                                            dr.Delete();
                                                    }
                                                    else if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CCS
                                                            dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) - slMDK_T;
                                                            DataRow drMDK_CCS = dtSL3_Update.NewRow();
                                                            drMDK_CCS.ItemArray = dr.ItemArray;
                                                            drMDK_CCS["SAN_LUONG"] = slMDK_T;
                                                            drMDK_CCS["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_CCS);
                                                        }
                                                        else
                                                            dr.Delete();
                                                    }
                                                    else
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //DDK
                                                            dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) - slMDK_S;
                                                            DataRow drMDK_DDK = dtSL3_Update.NewRow();
                                                            drMDK_DDK.ItemArray = dr.ItemArray;
                                                            drMDK_DDK["SAN_LUONG"] = slMDK_S;
                                                            drMDK_DDK["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_DDK);
                                                        }
                                                        else
                                                            dr.Delete();
                                                    }

                                                    iRowSL3_Upd--;
                                                }
                                                //Finish

                                                #endregion
                                            }
                                            else
                                            {
                                                #region SHTM

                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_BT_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT is not null"));
                                                else
                                                    slMDK_BT_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_CD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD is not null"));
                                                else
                                                    slMDK_CD_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_TD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD is not null"));
                                                else
                                                    slMDK_TD_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                else
                                                    slMDK_BT_T = -1;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                else
                                                    slMDK_CD_T = -1;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));
                                                else
                                                    slMDK_TD_T = -1;
                                                //Nội suy sản lượng CSPK mục đích khác
                                                if (isCCSDGia == 1)
                                                {
                                                    //Có nhập chỉ số chốt đổi giá, nội suy theo sản lượng
                                                    //Có nhập chốt MDK
                                                    if (slMDK_BT_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_BT_CSPK = Math.Round(slMDK_BT_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = slMDK_BT_T - slMDK_BT_CSPK;
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_BT_CSPK = Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    if (slMDK_CD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CD_CSPK = Math.Round(slMDK_CD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = slMDK_CD_T - slMDK_CD_CSPK;
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CD_CSPK = Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    if (slMDK_TD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = Math.Round(slMDK_TD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = slMDK_TD_T - slMDK_TD_CSPK;
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                }
                                                else
                                                {
                                                    //Không nhập chỉ số chốt đổi giá, nội suy theo sản lượng chốt
                                                    if (slMDK_BT_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_BT_CSPK = Math.Round(slMDK_BT_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_CSPK = Math.Round(slMDK_BT_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = slMDK_BT_T - slMDK_BT_CSPK;
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_BT_CSPK = Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = Math.Round((slMDK_BT_S - slMDK_BT_CSPK) * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_cky.Subtract(dtDoiHSPhatCosfi).TotalDays), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    if (slMDK_CD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_CD_CSPK = Math.Round(slMDK_CD_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_CSPK = Math.Round(slMDK_CD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = slMDK_CD_T - slMDK_CD_CSPK;
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CD_CSPK = Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round((slMDK_CD_S - slMDK_CD_CSPK) * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_cky.Subtract(dtDoiHSPhatCosfi).TotalDays), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    if (slMDK_TD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = Math.Round(slMDK_TD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = slMDK_TD_T - slMDK_TD_CSPK;
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round((slMDK_TD_S - slMDK_TD_CSPK) * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_cky.Subtract(dtDoiHSPhatCosfi).TotalDays), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                }
                                                //Nhân tỷ lệ tổn thất

                                                slMDK_BT_CSPK = Math.Round(slMDK_BT_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_T = Math.Round(slMDK_BT_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_CD_CSPK = Math.Round(slMDK_CD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_T = Math.Round(slMDK_CD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_TD_CSPK = Math.Round(slMDK_TD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_T = Math.Round(slMDK_TD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                DataRow drMDK_BT_CSPK = null;
                                                DataRow drMDK_CD_CSPK = null;
                                                DataRow drMDK_TD_CSPK = null;
                                                DataRow drMDK_BT_T = null;
                                                DataRow drMDK_CD_T = null;
                                                DataRow drMDK_TD_T = null;
                                                DataRow drMDK_BT_S = null;
                                                DataRow drMDK_CD_S = null;
                                                DataRow drMDK_TD_S = null;

                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];
                                                    if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = slBB_CSPK - slMDK_BT_CSPK - slMDK_CD_CSPK - slMDK_TD_CSPK;
                                                            drMDK_BT_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_BT_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_BT_CSPK["SAN_LUONG"] = slMDK_BT_CSPK;
                                                            drMDK_BT_CSPK["MA_NGIA"] = "K";
                                                            drMDK_BT_CSPK["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_CSPK);
                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_CD_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_CD_CSPK["MA_NGIA"] = "K";
                                                            drMDK_CD_CSPK["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_CSPK["SAN_LUONG"] = slMDK_CD_CSPK;
                                                            dr.Delete();
                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_TD_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_TD_CSPK["MA_NGIA"] = "K";
                                                            drMDK_TD_CSPK["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_CSPK["SAN_LUONG"] = slMDK_TD_CSPK;
                                                            dr.Delete();
                                                        }
                                                        //if(dtSL3_Update.Select("MA_DDO='"+strMa_DDo+"' and BCS in ('CD','TD')"))
                                                    }
                                                    else if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //CCS
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = slBB_1 - slMDK_BT_T - slMDK_CD_T - slMDK_TD_T;
                                                            drMDK_BT_T = dtSL3_Update.NewRow();
                                                            drMDK_BT_T.ItemArray = dr.ItemArray;
                                                            drMDK_BT_T["SAN_LUONG"] = slMDK_BT_T;
                                                            drMDK_BT_T["MA_NGIA"] = "K";
                                                            drMDK_BT_T["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_T);

                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_T = dtSL3_Update.NewRow();
                                                            drMDK_CD_T.ItemArray = dr.ItemArray;
                                                            drMDK_CD_T["MA_NGIA"] = "K";
                                                            drMDK_CD_T["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_T["SAN_LUONG"] = slMDK_CD_T;
                                                            dr.Delete();

                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_T = dtSL3_Update.NewRow();
                                                            drMDK_TD_T.ItemArray = dr.ItemArray;
                                                            drMDK_TD_T["MA_NGIA"] = "K";
                                                            drMDK_TD_T["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_T["SAN_LUONG"] = slMDK_TD_T;
                                                            dr.Delete();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //DDK
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = slBB - slMDK_BT_S - slMDK_CD_S - slMDK_TD_S;
                                                            drMDK_BT_S = dtSL3_Update.NewRow();
                                                            drMDK_BT_S.ItemArray = dr.ItemArray;
                                                            drMDK_BT_S["SAN_LUONG"] = slMDK_BT_S;
                                                            drMDK_BT_S["MA_NGIA"] = "K";
                                                            drMDK_BT_S["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_S);

                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_S = dtSL3_Update.NewRow();
                                                            drMDK_CD_S.ItemArray = dr.ItemArray;
                                                            drMDK_CD_S["MA_NGIA"] = "K";
                                                            drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                            dr.Delete();

                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_S = dtSL3_Update.NewRow();
                                                            drMDK_TD_S.ItemArray = dr.ItemArray;
                                                            drMDK_TD_S["MA_NGIA"] = "K";
                                                            drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                            dr.Delete();
                                                        }
                                                    }

                                                    iRowSL3_Upd--;
                                                }
                                                //Kiểm tra các datarow mới
                                                if (slMDK_CD_CSPK > 0)
                                                {
                                                    if (drMDK_CD_CSPK == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_CSPK = dtSL3_Update.NewRow();
                                                        drMDK_CD_CSPK.ItemArray = drMDK_BT_CSPK.ItemArray;
                                                        drMDK_CD_CSPK["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_CSPK["SAN_LUONG"] = slMDK_CD_CSPK;
                                                        drMDK_CD_CSPK["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_CSPK);
                                                }
                                                if (slMDK_CD_T > 0)
                                                {
                                                    if (drMDK_CD_T == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_T = dtSL3_Update.NewRow();
                                                        drMDK_CD_T.ItemArray = drMDK_BT_T.ItemArray;
                                                        drMDK_CD_T["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_T["SAN_LUONG"] = slMDK_CD_T;
                                                        drMDK_CD_T["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_T);
                                                }
                                                if (slMDK_CD_S > 0)
                                                {
                                                    if (drMDK_CD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_S = dtSL3_Update.NewRow();
                                                        drMDK_CD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                        drMDK_CD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_S);
                                                }
                                                if (slMDK_TD_CSPK > 0)
                                                {
                                                    if (drMDK_TD_CSPK == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_CSPK = dtSL3_Update.NewRow();
                                                        drMDK_TD_CSPK.ItemArray = drMDK_BT_CSPK.ItemArray;
                                                        drMDK_TD_CSPK["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_CSPK["SAN_LUONG"] = slMDK_TD_CSPK;
                                                        drMDK_TD_CSPK["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_CSPK);
                                                }
                                                if (slMDK_TD_T > 0)
                                                {
                                                    if (drMDK_TD_T == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_T = dtSL3_Update.NewRow();
                                                        drMDK_TD_T.ItemArray = drMDK_BT_T.ItemArray;
                                                        drMDK_TD_T["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_T["SAN_LUONG"] = slMDK_TD_T;
                                                        drMDK_TD_T["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_T);
                                                }
                                                if (slMDK_TD_S > 0)
                                                {
                                                    if (drMDK_TD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_S = dtSL3_Update.NewRow();
                                                        drMDK_TD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                        drMDK_TD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_S);
                                                }
                                                //Finish
                                                #endregion
                                            }
                                        }
                                        else
                                        {
                                            //Không đổi giá nhà nước, xử lý ghép thành 2 khoảng
                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                {
                                                    #region Ban buon phat-BT/KT-CSPK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                            slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion

                                                    #region Ban buon phat-BT/KT-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Ban buon phat-CD/TD-CSPK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_CSPK += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion

                                                    #region Ban buon phat-CD/TD-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }
                                            //Chuẩn hóa xong theo nhóm giá, chuẩn hóa tiếp cho SL-MDK
                                            DataView dvMDK = new DataView(dsCustomerData.Tables[strTableName]);
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            if (strMa_NhomNNBB != "SHTM")
                                            {
                                                #region Bán buôn khác SHTM

                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK is not null"));
                                                else
                                                    slMDK_S = 0;
                                                //Không quan tâm đến SL_MDK_CCS


                                                //Chưa có tỷ lệ tổn thất
                                                slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_T = 0;//Math.Round(slMDK_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;


                                                //Nhân tỷ lệ tổn thất
                                                slMDK_CSPK = Math.Round(slMDK_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_T = Math.Round(slMDK_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_S = Math.Round(slMDK_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];
                                                    if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) - slMDK_CSPK;
                                                            DataRow drMDK_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_CSPK["SAN_LUONG"] = slMDK_CSPK;
                                                            drMDK_CSPK["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_CSPK);
                                                        }
                                                        else
                                                            dr.Delete();
                                                    }
                                                    else
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //DDK
                                                            dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) - slMDK_S;
                                                            DataRow drMDK_DDK = dtSL3_Update.NewRow();
                                                            drMDK_DDK.ItemArray = dr.ItemArray;
                                                            drMDK_DDK["SAN_LUONG"] = slMDK_S;
                                                            drMDK_DDK["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_DDK);
                                                        }
                                                        else
                                                            dr.Delete();
                                                    }

                                                    iRowSL3_Upd--;
                                                }
                                                //Finish

                                                #endregion
                                            }
                                            else
                                            {
                                                #region SHTM

                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_BT_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT is not null"));
                                                else
                                                    slMDK_BT_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_CD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD is not null"));
                                                else
                                                    slMDK_CD_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_TD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD is not null"));
                                                else
                                                    slMDK_TD_S = 0;

                                                slMDK_BT_T = -1;

                                                slMDK_CD_T = -1;

                                                slMDK_TD_T = -1;
                                                //Nội suy sản lượng CSPK mục đích khác


                                                //Chưa có tỷ lệ tổn thất
                                                slMDK_BT_CSPK = Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_T = 0;//Math.Round(slMDK_BT_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;



                                                //Chưa có tỷ lệ tổn thất
                                                slMDK_CD_CSPK = Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_T = 0;// Math.Round(slMDK_CD_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;

                                                //Chưa có tỷ lệ tổn thất
                                                //slMDK_TD_CSPK = Math.Round(slMDK_TD_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_CSPK = Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                slMDK_TD_T = 0;// Math.Round(slMDK_TD_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;


                                                //Nhân tỷ lệ tổn thất

                                                slMDK_BT_CSPK = Math.Round(slMDK_BT_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_T = Math.Round(slMDK_BT_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_CD_CSPK = Math.Round(slMDK_CD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_T = Math.Round(slMDK_CD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_TD_CSPK = Math.Round(slMDK_TD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_T = Math.Round(slMDK_TD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                DataRow drMDK_BT_CSPK = null;
                                                DataRow drMDK_CD_CSPK = null;
                                                DataRow drMDK_TD_CSPK = null;
                                                DataRow drMDK_BT_T = null;
                                                DataRow drMDK_CD_T = null;
                                                DataRow drMDK_TD_T = null;
                                                DataRow drMDK_BT_S = null;
                                                DataRow drMDK_CD_S = null;
                                                DataRow drMDK_TD_S = null;

                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];
                                                    if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = slBB_CSPK - slMDK_BT_CSPK - slMDK_CD_CSPK - slMDK_TD_CSPK;
                                                            drMDK_BT_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_BT_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_BT_CSPK["SAN_LUONG"] = slMDK_BT_CSPK;
                                                            drMDK_BT_CSPK["MA_NGIA"] = "K";
                                                            drMDK_BT_CSPK["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_CSPK);
                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_CD_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_CD_CSPK["MA_NGIA"] = "K";
                                                            drMDK_CD_CSPK["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_CSPK["SAN_LUONG"] = slMDK_CD_CSPK;
                                                            dr.Delete();
                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_CSPK = dtSL3_Update.NewRow();
                                                            drMDK_TD_CSPK.ItemArray = dr.ItemArray;
                                                            drMDK_TD_CSPK["MA_NGIA"] = "K";
                                                            drMDK_TD_CSPK["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_CSPK["SAN_LUONG"] = slMDK_TD_CSPK;
                                                            dr.Delete();
                                                        }
                                                        //if(dtSL3_Update.Select("MA_DDO='"+strMa_DDo+"' and BCS in ('CD','TD')"))
                                                    }
                                                    else
                                                    {
                                                        //DDK
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = slBB - slMDK_BT_S - slMDK_CD_S - slMDK_TD_S;
                                                            drMDK_BT_S = dtSL3_Update.NewRow();
                                                            drMDK_BT_S.ItemArray = dr.ItemArray;
                                                            drMDK_BT_S["SAN_LUONG"] = slMDK_BT_S;
                                                            drMDK_BT_S["MA_NGIA"] = "K";
                                                            drMDK_BT_S["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_S);

                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_S = dtSL3_Update.NewRow();
                                                            drMDK_CD_S.ItemArray = dr.ItemArray;
                                                            drMDK_CD_S["MA_NGIA"] = "K";
                                                            drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                            dr.Delete();

                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_S = dtSL3_Update.NewRow();
                                                            drMDK_TD_S.ItemArray = dr.ItemArray;
                                                            drMDK_TD_S["MA_NGIA"] = "K";
                                                            drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                            dr.Delete();
                                                        }
                                                    }

                                                    iRowSL3_Upd--;
                                                }
                                                //Kiểm tra các datarow mới
                                                if (slMDK_CD_CSPK > 0)
                                                {
                                                    if (drMDK_CD_CSPK == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_CSPK = dtSL3_Update.NewRow();
                                                        drMDK_CD_CSPK.ItemArray = drMDK_BT_CSPK.ItemArray;
                                                        drMDK_CD_CSPK["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_CSPK["SAN_LUONG"] = slMDK_CD_CSPK;
                                                        drMDK_CD_CSPK["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_CSPK);
                                                }
                                                if (slMDK_CD_S > 0)
                                                {
                                                    if (drMDK_CD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_S = dtSL3_Update.NewRow();
                                                        drMDK_CD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                        drMDK_CD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_S);
                                                }
                                                if (slMDK_TD_CSPK > 0)
                                                {
                                                    if (drMDK_TD_CSPK == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_CSPK = dtSL3_Update.NewRow();
                                                        drMDK_TD_CSPK.ItemArray = drMDK_BT_CSPK.ItemArray;
                                                        drMDK_TD_CSPK["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_CSPK["SAN_LUONG"] = slMDK_TD_CSPK;
                                                        drMDK_TD_CSPK["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_CSPK);
                                                }

                                                if (slMDK_TD_S > 0)
                                                {
                                                    if (drMDK_TD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_S = dtSL3_Update.NewRow();
                                                        drMDK_TD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                        drMDK_TD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_S);
                                                }
                                                //Finish
                                                #endregion
                                            }
                                        }
                                    }
                                    else
                                    {
                                        #region Không đổi CSPK/chốt CSPK
                                        slBB_CSPK = 0;
                                        //Có đổi CSPK nhà nước và có nhập chỉ số chốt
                                        if (IsChangePrice == 1)
                                        {
                                            //Xử lý ghép thành 2 khoảng
                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                {

                                                    #region Ban buon phat-BT/KT-DOIGIA

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);

                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                drv.Row["NGAY_DAU"] = ngay_dky;
                                                                drv.Row["NGAY_CUOI"] = ngay_ccs;
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                        if (drv["BCS"].ToString().Trim() == "KT")
                                                            slBB_KT_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        else
                                                            slBB_BT_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                    }

                                                    #endregion
                                                    #region Ban buon phat-BT/KT-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                drv.Row["NGAY_DAU"] = ngay_ccs.AddDays(1); ;
                                                                drv.Row["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                        if (drv["BCS"].ToString().Trim() == "KT")
                                                            slBB_KT += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        else
                                                            slBB_BT += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                    }

                                                    #endregion
                                                }
                                                else
                                                {

                                                    #region Ban buon phat-CD/TD-DOIGIA

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                drv.Row["NGAY_DAU"] = ngay_dky;
                                                                drv.Row["NGAY_CUOI"] = ngay_ccs;
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                        if (drv["BCS"].ToString().Trim() == "CD")
                                                            slBB_CD_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        else
                                                            slBB_TD_1 += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                    }

                                                    #endregion
                                                    #region Ban buon phat-CD/TD-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                drv.Row["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                                drv.Row["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                        if (drv["BCS"].ToString().Trim() == "CD")
                                                            slBB_CD += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        else
                                                            slBB_TD += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                    }

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }
                                            //Chuẩn hóa xong theo nhóm giá, chuẩn hóa tiếp cho SL-MDK
                                            DataView dvMDK = new DataView(dsCustomerData.Tables[strTableName]);
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            if (strMa_NhomNNBB != "SHTM")
                                            {
                                                #region Bán buôn khác SHTM
                                                //Dang lam
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK is not null"));
                                                else
                                                    slMDK_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                else
                                                    slMDK_T = -1;
                                                //Nội suy sản lượng CSPK mục đích khác
                                                if (isCCSDGia == 1)
                                                {
                                                    //Có nhập chỉ số chốt đổi giá, nội suy theo sản lượng
                                                    //Có nhập chốt MDK
                                                    if (slMDK_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CSPK = 0;// Math.Round(slMDK_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_T = slMDK_T - slMDK_CSPK;
                                                        slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CSPK = 0;// Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_T = Math.Round(slMDK_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;
                                                    }
                                                }
                                                else
                                                {

                                                    //Chưa có tỷ lệ tổn thất
                                                    //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CSPK = 0;//Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_T = Math.Round(slMDK_S * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;

                                                }
                                                //Nhân tỷ lệ tổn thất
                                                slMDK_CSPK = Math.Round(slMDK_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_T = Math.Round(slMDK_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_S = Math.Round(slMDK_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                #region Bổ sung tính thành phần giá SHBB bậc 3 - 15/01/2019
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and SLUONG_B3 is not null";
                                                if (dvMDK.Count > 0)
                                                {
                                                    soho_b3 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + "and SLUONG_B3 is not null AND LOAI_BCS IN ('BT','KT')")[0]["SO_HO_B3"]);
                                                    ttb3_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + "and SLUONG_B3 is not null AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_B3_CCS"]);
                                                    ttb3_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + "and SLUONG_B3 is not null AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_B3"]);
                                                    slB3_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(SLUONG_B3)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and SLUONG_B3 is not null"));
                                                    dvMDK.RowFilter = "";
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and SLUONG_B3_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                        slB3_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(SLUONG_B3_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and SLUONG_B3_CCS is not null"));
                                                    else
                                                        slB3_T = -1;
                                                    if (isCCSDGia == 1)
                                                    {
                                                        //Có nhập chỉ số chốt đổi giá, nội suy theo sản lượng
                                                        //Có nhập chốt MDK
                                                        if (slB3_T != -1)
                                                        {
                                                            //Chưa có tỷ lệ tổn thất
                                                            slB3_S = slB3_S - slB3_T;
                                                        }
                                                        else
                                                        {
                                                            //Chưa có tỷ lệ tổn thất

                                                            slB3_T = Math.Round(slB3_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                            slB3_S = slB3_S - slB3_T;
                                                        }
                                                    }
                                                    else
                                                    {

                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CSPK = 0;//Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slB3_T = Math.Round(slB3_S * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slB3_S = slB3_S - slB3_T;

                                                    }
                                                }

                                                else
                                                {
                                                    soho_b3 = 0;
                                                    ttb3_cu = 1;
                                                    ttb3_moi = 1;
                                                    slB3_S = 0;
                                                }
                                                //Chưa có tỷ lệ tổn thất

                                                //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                //slB3_T = 0;//Math.Round(slMDK_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                //slB3_S = slB3_S - slB3_T;


                                                //Nhân tỷ lệ tổn thất
                                                //slMDK_CSPK = Math.Round(slMDK_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slB3_T = Math.Round(slB3_T * ttb3_cu, 0, MidpointRounding.AwayFromZero);
                                                slB3_S = Math.Round(slB3_S * ttb3_moi, 0, MidpointRounding.AwayFromZero);

                                                #endregion
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];

                                                    if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CCS
                                                            dr["SAN_LUONG"] = slBB_1 - slMDK_T;
                                                            DataRow drMDK_CCS = dtSL3_Update.NewRow();
                                                            drMDK_CCS.ItemArray = dr.ItemArray;
                                                            drMDK_CCS["SAN_LUONG"] = slMDK_T;
                                                            drMDK_CCS["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_CCS);
                                                            if (slB3_T > 0)
                                                            {
                                                                //Kiểm tra số hộ b3 = số hộ thường thì thay thế nhóm A = nhóm D luôn
                                                                if (Convert.ToDecimal(dr["SO_HO"]) <= soho_b3)
                                                                {
                                                                    dr["MA_NGIA"] = "D";
                                                                }
                                                                else
                                                                {
                                                                    //Cập nhật số hộ
                                                                    dr["SO_HO"] = Convert.ToDecimal(dr["SO_HO"]) - soho_b3;
                                                                    dr["SAN_LUONG"] = slBB_1 - slMDK_T - slB3_T;
                                                                    DataRow drB3 = dtSL3_Update.NewRow();
                                                                    drB3.ItemArray = dr.ItemArray;
                                                                    drB3["SAN_LUONG"] = slB3_T;
                                                                    drB3["MA_NGIA"] = "D";
                                                                    dtSL3_Update.Rows.Add(drB3);
                                                                }

                                                            }
                                                        }
                                                        else
                                                        {
                                                            dr.Delete();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //DDK
                                                            dr["SAN_LUONG"] = slBB - slMDK_S;
                                                            DataRow drMDK_DDK = dtSL3_Update.NewRow();
                                                            drMDK_DDK.ItemArray = dr.ItemArray;
                                                            drMDK_DDK["SAN_LUONG"] = slMDK_S;
                                                            drMDK_DDK["MA_NGIA"] = "K";
                                                            dtSL3_Update.Rows.Add(drMDK_DDK);
                                                            if (slB3_S > 0)
                                                            {
                                                                //Kiểm tra số hộ b3 = số hộ thường thì thay thế nhóm A = nhóm D luôn
                                                                if (Convert.ToDecimal(dr["SO_HO"]) <= soho_b3)
                                                                {
                                                                    dr["MA_NGIA"] = "D";
                                                                }
                                                                else
                                                                {
                                                                    //Cập nhật số hộ
                                                                    dr["SO_HO"] = Convert.ToDecimal(dr["SO_HO"]) - soho_b3;
                                                                    dr["SAN_LUONG"] = slBB - slMDK_S - slB3_S;
                                                                    DataRow drB3 = dtSL3_Update.NewRow();
                                                                    drB3.ItemArray = dr.ItemArray;
                                                                    drB3["SAN_LUONG"] = slB3_S;
                                                                    drB3["MA_NGIA"] = "D";
                                                                    dtSL3_Update.Rows.Add(drB3);
                                                                }

                                                            }
                                                        }
                                                        else
                                                        {
                                                            dr.Delete();
                                                        }
                                                    }

                                                    iRowSL3_Upd--;
                                                }
                                                //Finish

                                                #endregion
                                            }
                                            else
                                            {
                                                #region SHTM

                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_BT_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT is not null"));
                                                else
                                                    slMDK_BT_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_CD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD is not null"));
                                                else
                                                    slMDK_CD_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_TD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD is not null"));
                                                else
                                                    slMDK_TD_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                else
                                                    slMDK_BT_T = -1;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                else
                                                    slMDK_CD_T = -1;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));
                                                else
                                                    slMDK_TD_T = -1;
                                                //Nội suy sản lượng CSPK mục đích khác
                                                if (isCCSDGia == 1)
                                                {
                                                    //Có nhập chỉ số chốt đổi giá, nội suy theo sản lượng
                                                    //Tách các sản lượng KT trước và sau đổi giá
                                                    if ((slBB_BT + slBB_CD + slBB_TD + slBB_BT_1 + slBB_CD_1 + slBB_TD_1) != 0)
                                                    {
                                                        if (slBB_KT != 0)
                                                        {
                                                            slKT_BT = Math.Round((slBB_BT + slBB_BT_1) * slBB_KT / (slBB_BT + slBB_CD + slBB_TD + slBB_BT_1 + slBB_CD_1 + slBB_TD_1), 0, MidpointRounding.AwayFromZero);
                                                            slKT_CD = Math.Round((slBB_CD + slBB_CD_1) * slBB_KT / (slBB_BT + slBB_CD + slBB_TD + slBB_BT_1 + slBB_CD_1 + slBB_TD_1), 0, MidpointRounding.AwayFromZero);
                                                            slKT_TD = slBB_KT - (slKT_BT + slKT_CD);
                                                        }
                                                        if (slBB_KT_1 != 0)
                                                        {
                                                            slKT_BT_1 = Math.Round((slBB_BT + slBB_BT_1) * slBB_KT_1 / (slBB_BT + slBB_CD + slBB_TD + slBB_BT_1 + slBB_CD_1 + slBB_TD_1), 0, MidpointRounding.AwayFromZero);
                                                            slKT_CD_1 = Math.Round((slBB_CD + slBB_CD_1) * slBB_KT_1 / (slBB_BT + slBB_CD + slBB_TD + slBB_BT_1 + slBB_CD_1 + slBB_TD_1), 0, MidpointRounding.AwayFromZero);
                                                            slKT_TD_1 = slBB_KT_1 - (slKT_BT_1 + slKT_CD_1);
                                                        }
                                                    }
                                                    //Có nhập chốt MDK
                                                    if (slMDK_BT_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_BT_CSPK = 0;//Math.Round(slMDK_BT_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = slMDK_BT_T - slMDK_BT_CSPK;
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    else
                                                    {

                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_BT_CSPK = 0;//Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        if ((slBB_BT_1 + slKT_BT_1 + slBB_BT + slKT_BT) != 0)
                                                            slMDK_BT_T = Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_BT_1 + slKT_BT_1) / Convert.ToDecimal(slBB_BT_1 + slKT_BT_1 + slBB_BT + slKT_BT), 0, MidpointRounding.AwayFromZero);
                                                        else
                                                            slMDK_BT_T = Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    if (slMDK_CD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CD_CSPK = 0;//Math.Round(slMDK_CD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = slMDK_CD_T - slMDK_CD_CSPK;
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CD_CSPK = 0;//Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                        if ((slBB_CD_1 + slKT_CD_1 + slBB_CD + slKT_CD) != 0)
                                                            slMDK_CD_T = Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CD_1 + slKT_CD_1) / Convert.ToDecimal(slBB_CD_1 + slKT_CD_1 + slBB_CD + slKT_CD), 0, MidpointRounding.AwayFromZero);
                                                        else
                                                            slMDK_CD_T = Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    if (slMDK_TD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = 0;//Math.Round(slMDK_TD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = slMDK_TD_T - slMDK_TD_CSPK;
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = 0;//Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        if ((slBB_TD_1 + slKT_TD_1 + slBB_TD + slKT_TD) != 0)
                                                            slMDK_TD_T = Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_TD_1 + slKT_TD_1) / Convert.ToDecimal(slBB_TD_1 + slKT_TD_1 + slBB_TD + slKT_TD), 0, MidpointRounding.AwayFromZero);
                                                        else
                                                            slMDK_TD_T = Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_1) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                }
                                                else
                                                {

                                                    //Không nhập chỉ số chốt đổi giá, nội suy theo ngày chốt
                                                    if (slMDK_BT_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_BT_CSPK = Math.Round(slMDK_BT_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_CSPK = 0;//Math.Round(slMDK_BT_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = slMDK_BT_T - slMDK_BT_CSPK;
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_BT_CSPK = 0;//Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_T = Math.Round(slMDK_BT_S * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;
                                                    }
                                                    if (slMDK_CD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        //slMDK_CD_CSPK = Math.Round(slMDK_CD_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_CSPK = 0;//Math.Round(slMDK_CD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = slMDK_CD_T - slMDK_CD_CSPK;
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_CD_CSPK = 0;//Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD_S * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;
                                                    }
                                                    if (slMDK_TD_T != -1)
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = 0;//Math.Round(slMDK_TD_T * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = slMDK_TD_T - slMDK_TD_CSPK;
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                    else
                                                    {
                                                        //Chưa có tỷ lệ tổn thất
                                                        slMDK_TD_CSPK = 0;//Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD_S * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;
                                                    }
                                                }
                                                //Nhân tỷ lệ tổn thất

                                                slMDK_BT_CSPK = Math.Round(slMDK_BT_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_T = Math.Round(slMDK_BT_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_CD_CSPK = Math.Round(slMDK_CD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_T = Math.Round(slMDK_CD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_TD_CSPK = Math.Round(slMDK_TD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_T = Math.Round(slMDK_TD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)

                                                DataRow drMDK_BT_T = null;
                                                DataRow drMDK_CD_T = null;
                                                DataRow drMDK_TD_T = null;
                                                DataRow drMDK_BT_S = null;
                                                DataRow drMDK_CD_S = null;
                                                DataRow drMDK_TD_S = null;

                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];
                                                    if (Convert.ToDateTime(dr["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //CCS
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {

                                                            dr["SAN_LUONG"] = slBB_1 - slMDK_BT_T - slMDK_CD_T - slMDK_TD_T;
                                                            drMDK_BT_T = dtSL3_Update.NewRow();
                                                            drMDK_BT_T.ItemArray = dr.ItemArray;
                                                            drMDK_BT_T["SAN_LUONG"] = slMDK_BT_T;
                                                            drMDK_BT_T["MA_NGIA"] = "K";
                                                            drMDK_BT_T["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_T);

                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_T = dtSL3_Update.NewRow();
                                                            drMDK_CD_T.ItemArray = dr.ItemArray;
                                                            drMDK_CD_T["MA_NGIA"] = "K";
                                                            drMDK_CD_T["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_T["SAN_LUONG"] = slMDK_CD_T;
                                                            dr.Delete();

                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_T = dtSL3_Update.NewRow();
                                                            drMDK_TD_T.ItemArray = dr.ItemArray;
                                                            drMDK_TD_T["MA_NGIA"] = "K";
                                                            drMDK_TD_T["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_T["SAN_LUONG"] = slMDK_TD_T;
                                                            dr.Delete();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //DDK
                                                        if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                        {
                                                            //CSPK
                                                            dr["SAN_LUONG"] = slBB - slMDK_BT_S - slMDK_CD_S - slMDK_TD_S;
                                                            drMDK_BT_S = dtSL3_Update.NewRow();
                                                            drMDK_BT_S.ItemArray = dr.ItemArray;
                                                            drMDK_BT_S["SAN_LUONG"] = slMDK_BT_S;
                                                            drMDK_BT_S["MA_NGIA"] = "K";
                                                            drMDK_BT_S["TGIAN_BDIEN"] = "BT";
                                                            dtSL3_Update.Rows.Add(drMDK_BT_S);

                                                        }
                                                        else if (dr["BCS"].ToString().Trim() == "CD")
                                                        {
                                                            drMDK_CD_S = dtSL3_Update.NewRow();
                                                            drMDK_CD_S.ItemArray = dr.ItemArray;
                                                            drMDK_CD_S["MA_NGIA"] = "K";
                                                            drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                            drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                            dr.Delete();

                                                        }
                                                        else
                                                        {
                                                            drMDK_TD_S = dtSL3_Update.NewRow();
                                                            drMDK_TD_S.ItemArray = dr.ItemArray;
                                                            drMDK_TD_S["MA_NGIA"] = "K";
                                                            drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                            drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                            dr.Delete();
                                                        }
                                                    }

                                                    iRowSL3_Upd--;
                                                }
                                                //Kiểm tra các datarow mới

                                                if (slMDK_CD_T > 0)
                                                {
                                                    if (drMDK_CD_T == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_T = dtSL3_Update.NewRow();
                                                        drMDK_CD_T.ItemArray = drMDK_BT_T.ItemArray;
                                                        drMDK_CD_T["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_T["SAN_LUONG"] = slMDK_CD_T;
                                                        drMDK_CD_T["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_T);
                                                }
                                                if (slMDK_CD_S > 0)
                                                {
                                                    if (drMDK_CD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_S = dtSL3_Update.NewRow();
                                                        drMDK_CD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                        drMDK_CD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_S);
                                                }

                                                if (slMDK_TD_T > 0)
                                                {
                                                    if (drMDK_TD_T == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_T = dtSL3_Update.NewRow();
                                                        drMDK_TD_T.ItemArray = drMDK_BT_T.ItemArray;
                                                        drMDK_TD_T["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_T["SAN_LUONG"] = slMDK_TD_T;
                                                        drMDK_TD_T["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_T);
                                                }
                                                if (slMDK_TD_S > 0)
                                                {
                                                    if (drMDK_TD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_S = dtSL3_Update.NewRow();
                                                        drMDK_TD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                        drMDK_TD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_S);
                                                }
                                                //Finish
                                                #endregion
                                            }

                                        }
                                        else
                                        {

                                            //Không đổi giá nhà nước, xử lý ghép thành 2 khoảng
                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                {
                                                    #region Ban buon phat-BT/KT-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if ((dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                drv.Row["NGAY_DAU"] = ngay_dky;
                                                                drv.Row["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Ban buon phat-CD/TD-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = strMa_NGia;
                                                            slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                drv.Row["NGAY_DAU"] = ngay_dky;
                                                                drv.Row["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                slBB += Convert.ToDecimal(drv["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }
                                            //Chuẩn hóa xong theo nhóm giá, chuẩn hóa tiếp cho SL-MDK
                                            DataView dvMDK = new DataView(dsCustomerData.Tables[strTableName]);
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            if (strMa_NhomNNBB != "SHTM")
                                            {
                                                #region Bán buôn khác SHTM
                                                //Đang làm 15/01/2019
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK is not null"));
                                                else
                                                    slMDK_S = 0;
                                                //Không quan tâm đến SL_MDK_CCS


                                                //Chưa có tỷ lệ tổn thất
                                                slMDK_CSPK = 0;// Math.Round(slMDK_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_T = 0;//Math.Round(slMDK_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_S = slMDK_S - slMDK_T - slMDK_CSPK;


                                                //Nhân tỷ lệ tổn thất
                                                slMDK_CSPK = Math.Round(slMDK_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_T = Math.Round(slMDK_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_S = Math.Round(slMDK_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                #region Bổ sung tính thành phần giá SHBB bậc 3 - 15/01/2019
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and SLUONG_B3 is not null";
                                                if (dvMDK.Count > 0)
                                                {
                                                    soho_b3 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + "and SLUONG_B3 is not null AND LOAI_BCS IN ('BT','KT')")[0]["SO_HO_B3"]);
                                                    ttb3_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + "and SLUONG_B3 is not null AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_B3_CCS"]);
                                                    ttb3_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + "and SLUONG_B3 is not null AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_B3"]);
                                                    slB3_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(SLUONG_B3)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and SLUONG_B3 is not null"));
                                                }

                                                else
                                                {
                                                    soho_b3 = 0;
                                                    ttb3_cu = 1;
                                                    ttb3_moi = 1;
                                                    slB3_S = 0;
                                                }
                                                //Chưa có tỷ lệ tổn thất

                                                //slMDK_CSPK = Math.Round(slMDK_S * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slB3_T = 0;//Math.Round(slMDK_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slB3_S = slB3_S - slB3_T;


                                                //Nhân tỷ lệ tổn thất
                                                //slMDK_CSPK = Math.Round(slMDK_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slB3_T = Math.Round(slB3_T * ttb3_cu, 0, MidpointRounding.AwayFromZero);
                                                slB3_S = Math.Round(slB3_S * ttb3_moi, 0, MidpointRounding.AwayFromZero);

                                                #endregion
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];
                                                    if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                    {
                                                        //DDK

                                                        dr["SAN_LUONG"] = slBB - slMDK_S;
                                                        DataRow drMDK_DDK = dtSL3_Update.NewRow();
                                                        drMDK_DDK.ItemArray = dr.ItemArray;
                                                        drMDK_DDK["SAN_LUONG"] = slMDK_S;
                                                        drMDK_DDK["MA_NGIA"] = "K";
                                                        dtSL3_Update.Rows.Add(drMDK_DDK);
                                                        if (slB3_S > 0)
                                                        {
                                                            //Kiểm tra số hộ b3 = số hộ thường thì thay thế nhóm A = nhóm D luôn
                                                            if (Convert.ToDecimal(dr["SO_HO"]) <= soho_b3)
                                                            {
                                                                dr["MA_NGIA"] = "D";
                                                            }
                                                            else
                                                            {
                                                                //Cập nhật số hộ
                                                                dr["SO_HO"] = Convert.ToDecimal(dr["SO_HO"]) - soho_b3;
                                                                dr["SAN_LUONG"] = slBB - slMDK_S - slB3_S;
                                                                DataRow drB3 = dtSL3_Update.NewRow();
                                                                drB3.ItemArray = dr.ItemArray;
                                                                drB3["SAN_LUONG"] = slB3_S;
                                                                drB3["MA_NGIA"] = "D";
                                                                dtSL3_Update.Rows.Add(drB3);
                                                            }

                                                        }
                                                    }
                                                    else
                                                        dr.Delete();

                                                    iRowSL3_Upd--;
                                                }
                                                //Finish

                                                #endregion
                                            }
                                            else
                                            {
                                                #region SHTM

                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_BT_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT is not null"));
                                                else
                                                    slMDK_BT_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_CD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD is not null"));
                                                else
                                                    slMDK_CD_S = 0;
                                                dvMDK.RowFilter = "";
                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD is not null";
                                                if (dvMDK.Count > 0)
                                                    slMDK_TD_S = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables[strTableName].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD is not null"));
                                                else
                                                    slMDK_TD_S = 0;

                                                slMDK_BT_T = -1;

                                                slMDK_CD_T = -1;

                                                slMDK_TD_T = -1;
                                                //Nội suy sản lượng CSPK mục đích khác


                                                //Chưa có tỷ lệ tổn thất
                                                slMDK_BT_CSPK = 0;// Math.Round(slMDK_BT_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_T = 0;//Math.Round(slMDK_BT_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = slMDK_BT_S - slMDK_BT_T - slMDK_BT_CSPK;



                                                //Chưa có tỷ lệ tổn thất
                                                slMDK_CD_CSPK = 0;// Math.Round(slMDK_CD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_T = 0;// Math.Round(slMDK_CD_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = slMDK_CD_S - slMDK_CD_T - slMDK_CD_CSPK;

                                                //Chưa có tỷ lệ tổn thất
                                                //slMDK_TD_CSPK = Math.Round(slMDK_TD_T * Convert.ToDecimal(dtDoiHSPhatCosfi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_CSPK = 0;// Math.Round(slMDK_TD_S * Convert.ToDecimal(slBB_CSPK) / Convert.ToDecimal(slBB_CSPK + slBB_1 + slBB), 0, MidpointRounding.AwayFromZero);

                                                slMDK_TD_T = 0;// Math.Round(slMDK_TD_S * Convert.ToDecimal(ngay_ccs.Subtract(dtDoiHSPhatCosfi).TotalDays) / Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = slMDK_TD_S - slMDK_TD_T - slMDK_TD_CSPK;


                                                //Nhân tỷ lệ tổn thất

                                                slMDK_BT_CSPK = Math.Round(slMDK_BT_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_T = Math.Round(slMDK_BT_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_CD_CSPK = Math.Round(slMDK_CD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_T = Math.Round(slMDK_CD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                slMDK_TD_CSPK = Math.Round(slMDK_TD_CSPK * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_T = Math.Round(slMDK_TD_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                //Điền vào bảng DTSL3_Update tương ứng theo từng dòng
                                                int iRowSL3_Upd = dtSL3_Update.Rows.Count - 1;
                                                //foreach (DataRow dr in dtSL3_Update.Rows)
                                                DataRow drMDK_BT_CSPK = null;
                                                DataRow drMDK_CD_CSPK = null;
                                                DataRow drMDK_TD_CSPK = null;

                                                DataRow drMDK_BT_S = null;
                                                DataRow drMDK_CD_S = null;
                                                DataRow drMDK_TD_S = null;

                                                while (iRowSL3_Upd >= 0)
                                                {
                                                    DataRow dr = dtSL3_Update.Rows[iRowSL3_Upd];

                                                    //DDK
                                                    if (dr["BCS"].ToString().Trim() == "BT" || dr["BCS"].ToString().Trim() == "KT")
                                                    {
                                                        //CSPK
                                                        dr["SAN_LUONG"] = slBB - slMDK_BT_S - slMDK_CD_S - slMDK_TD_S;
                                                        drMDK_BT_S = dtSL3_Update.NewRow();
                                                        drMDK_BT_S.ItemArray = dr.ItemArray;
                                                        drMDK_BT_S["SAN_LUONG"] = slMDK_BT_S;
                                                        drMDK_BT_S["MA_NGIA"] = "K";
                                                        drMDK_BT_S["TGIAN_BDIEN"] = "BT";
                                                        dtSL3_Update.Rows.Add(drMDK_BT_S);

                                                    }
                                                    else if (dr["BCS"].ToString().Trim() == "CD")
                                                    {
                                                        drMDK_CD_S = dtSL3_Update.NewRow();
                                                        drMDK_CD_S.ItemArray = dr.ItemArray;
                                                        drMDK_CD_S["MA_NGIA"] = "K";
                                                        drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                        dr.Delete();

                                                    }
                                                    else
                                                    {
                                                        drMDK_TD_S = dtSL3_Update.NewRow();
                                                        drMDK_TD_S.ItemArray = dr.ItemArray;
                                                        drMDK_TD_S["MA_NGIA"] = "K";
                                                        drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                        dr.Delete();
                                                    }


                                                    iRowSL3_Upd--;
                                                }
                                                //Kiểm tra các datarow mới

                                                if (slMDK_CD_S > 0)
                                                {
                                                    if (drMDK_CD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_CD_S = dtSL3_Update.NewRow();
                                                        drMDK_CD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_CD_S["TGIAN_BDIEN"] = "CD";
                                                        drMDK_CD_S["SAN_LUONG"] = slMDK_CD_S;
                                                        drMDK_CD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_CD_S);
                                                }


                                                if (slMDK_TD_S > 0)
                                                {
                                                    if (drMDK_TD_S == null)
                                                    {
                                                        //Trong công tơ tổng không có CD, lấy từ BT
                                                        drMDK_TD_S = dtSL3_Update.NewRow();
                                                        drMDK_TD_S.ItemArray = drMDK_BT_S.ItemArray;
                                                        drMDK_TD_S["TGIAN_BDIEN"] = "TD";
                                                        drMDK_TD_S["SAN_LUONG"] = slMDK_TD_S;
                                                        drMDK_TD_S["MA_NGIA"] = "K";
                                                    }
                                                    dtSL3_Update.Rows.Add(drMDK_TD_S);
                                                }
                                                //Finish
                                                #endregion
                                            }
                                        }
                                        #endregion
                                    }
                                }
                                //Đẩy lại vào SL3.
                                dtSL3_Update.AcceptChanges();
                                if (dtSL3_Update != null && dtSL3_Update.Rows.Count > 0)
                                    foreach (DataRow drvInsert in dtSL3_Update.Rows)
                                    {
                                        if (Convert.ToDecimal(drvInsert["SAN_LUONG"]) < 0)
                                            return "Điểm đo " + drvInsert["MA_DDO"].ToString().Trim() + " từ " + Convert.ToDateTime(drvInsert["NGAY_DAU"]).ToString("dd/MM/yyyy") + " đến " + Convert.ToDateTime(drvInsert["NGAY_CUOI"]).ToString("dd/MM/yyyy") + " có sản lượng CTT < sản lượng MDK";

                                        if (Convert.ToDecimal(drvInsert["SAN_LUONG"]) > 0)
                                            dsCalculation.Tables["SL_3"].ImportRow(drvInsert);
                                    }
                                dtSL3_Update.Clear();
                                #endregion
                            }
                            else
                            {
                                #region Khong ton tai du lieu trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                                //Xử lý theo biên bản giá
                                dwSL3_Temp.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                                dwSL3_Temp.Sort = "BCS DESC, ID_CHISO DESC";
                                int iCount = dwSL3_Temp.Count - 1;
                                if (dwSL3_Temp != null && dwSL3_Temp.Count > 0)
                                {
                                    if (isExistsCSPK == 1 && isCPK == 1)
                                    {
                                        //Có đổi CSPK nhà nước và có nhập chỉ số chốt
                                        if (IsChangePrice == 1)
                                        {
                                            //Xử lý ghép thành 3 khoảng
                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["MA_NGIA"].ToString().Trim() == "K")
                                                {
                                                    #region Xử lý riêng nhóm K, tách thành từng BCS: BT/KT, CD, TD

                                                    strMa_NGia = "K";
                                                    if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                    {
                                                        #region Ban buon phat-BT/KT-CSPK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                        #region Ban buon phat-BT/KT-DOIGIA

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                        #region Ban buon phat-BT/KT-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    else
                                                    {
                                                        #region Ban buon phat-CD/TD-CSPK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                        #region Ban buon phat-CD/TD-DOIGIA

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                        #region Ban buon phat-CD/TD-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Xử lý với nhóm A, gom hết vào một BCS, tùy theo cto 3 giá hay 1 giá
                                                    strMa_NGia = "A";
                                                    #region Ban buon -A-CSPK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }

                                                    }


                                                    #endregion
                                                    #region Ban buon -A-DOIGIA

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }
                                                    }

                                                    #endregion
                                                    #region Ban buon -A-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }
                                                    }

                                                    #endregion

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }

                                        }
                                        else
                                        {
                                            //Không đổi giá nhà nước, ghép thành 2 khoảng

                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["MA_NGIA"].ToString().Trim() == "K")
                                                {
                                                    #region Xử lý riêng nhóm K, tách thành từng BCS: BT/KT, CD, TD


                                                    if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                    {
                                                        #region Ban buon phat-BT/KT-CSPK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion

                                                        #region Ban buon phat-BT/KT-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    else
                                                    {
                                                        #region Ban buon phat-CD/TD-CSPK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion

                                                        #region Ban buon phat-CD/TD-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Xử lý với nhóm A, gom hết vào một BCS, tùy theo cto 3 giá hay 1 giá

                                                    #region Ban buon -A-CSPK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = dtDoiHSPhatCosfi;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }

                                                    }


                                                    #endregion

                                                    #region Ban buon -A-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > dtDoiHSPhatCosfi && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = dtDoiHSPhatCosfi.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }
                                                    }

                                                    #endregion

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }

                                        }
                                    }
                                    else
                                    {
                                        //Không đổi CSPK hoặc không chốt CSPK

                                        if (IsChangePrice == 1)
                                        {
                                            //Xử lý ghép thành 2 khoảng
                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["MA_NGIA"].ToString().Trim() == "K")
                                                {
                                                    #region Xử lý riêng nhóm K, tách thành từng BCS: BT/KT, CD, TD


                                                    if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                    {
                                                        #region Ban buon phat-BT/KT-CSPK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion

                                                        #region Ban buon phat-BT/KT-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    else
                                                    {
                                                        #region Ban buon phat-CD/TD-CSPK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion

                                                        #region Ban buon phat-CD/TD-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Xử lý với nhóm A, gom hết vào một BCS, tùy theo cto 3 giá hay 1 giá

                                                    #region Ban buon -A-DOIGIA

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_ccs)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_ccs;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }

                                                    }


                                                    #endregion

                                                    #region Ban buon -A-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) > ngay_ccs && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }
                                                    }

                                                    #endregion

                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }

                                        }
                                        else
                                        {
                                            //Không đổi giá nhà nước, không đổi CSPK hoặc nhập chốt CSPK

                                            while (iCount >= 0)
                                            {
                                                DataRowView drv = dwSL3_Temp[iCount];
                                                if (drv["MA_NGIA"].ToString().Trim() == "K")
                                                {
                                                    #region Xử lý riêng nhóm K, tách thành từng BCS: BT/KT, CD, TD


                                                    if (drv["BCS"].ToString().Trim() == "KT" || drv["BCS"].ToString().Trim() == "BT")
                                                    {
                                                        #region Ban buon phat-BT/KT-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion


                                                    }
                                                    else
                                                    {
                                                        #region Ban buon phat-CD/TD-DDK

                                                        if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                        {
                                                            //Khoảng CSPK
                                                            if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                            {
                                                                dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                                dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                                dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                                dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                                dtSL3_Update.Rows[0]["MA_NGIA"] = "K";
                                                            }
                                                            else
                                                            {
                                                                int isExistsTemp = 0;
                                                                foreach (DataRow dr in dtSL3_Update.Rows)
                                                                {
                                                                    if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && dr["BCS"].ToString().Trim() == drv["BCS"].ToString().Trim() && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                    {
                                                                        //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                        dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                        //Thay đổi BCS
                                                                        if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                        {
                                                                            //Cập nhật ID_CHISO của dòng sau
                                                                            dr["ID_CHISO"] = drv["ID_CHISO"];
                                                                            if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                            {
                                                                                //Cập nhật BCS của dòng sau
                                                                                dr["BCS"] = drv["BCS"];
                                                                                dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                            }
                                                                        }
                                                                        isExistsTemp = 1;
                                                                        break;
                                                                    }
                                                                }
                                                                //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                                if (isExistsTemp == 0)
                                                                {
                                                                    drv.Row["MA_NGIA"] = "K";
                                                                    dtSL3_Update.ImportRow(drv.Row);
                                                                }
                                                            }
                                                        }

                                                        #endregion


                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    #region Xử lý với nhóm A, gom hết vào một BCS, tùy theo cto 3 giá hay 1 giá

                                                    #region Ban buon -A-DDK

                                                    if (Convert.ToDateTime(drv["NGAY_CUOI"]) >= ngay_dky && Convert.ToDateTime(drv["NGAY_CUOI"]) <= ngay_cky)
                                                    {
                                                        //Khoảng CSPK
                                                        if (dtSL3_Update == null || dtSL3_Update.Rows.Count == 0)
                                                        {
                                                            dtSL3_Update = dwSL3_Temp.Table.Clone();
                                                            dtSL3_Update.ImportRow(drv.Row);
                                                            dtSL3_Update.Rows[0]["BCS"] = drv["BCS"];
                                                            dtSL3_Update.Rows[0]["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                            dtSL3_Update.Rows[0]["NGAY_DAU"] = ngay_dky;
                                                            dtSL3_Update.Rows[0]["NGAY_CUOI"] = ngay_cky;
                                                            dtSL3_Update.Rows[0]["MA_NGIA"] = "A";
                                                        }
                                                        else
                                                        {
                                                            int isExistsTemp = 0;
                                                            foreach (DataRow dr in dtSL3_Update.Rows)
                                                            {
                                                                if (dr["MA_NGIA"].ToString().Trim() == drv["MA_NGIA"].ToString().Trim() && (dr["BCS"].ToString().Trim() == "CD" || dr["BCS"].ToString().Trim() == "TD" || dr["BCS"].ToString().Trim() == "KT" || dr["BCS"].ToString().Trim() == "BT") && Convert.ToDateTime(drv["NGAY_CUOI"]) >= Convert.ToDateTime(dr["NGAY_DAU"]) && Convert.ToDateTime(drv["NGAY_CUOI"]) <= Convert.ToDateTime(dr["NGAY_CUOI"]))
                                                                {
                                                                    //Tồn tại dòng có cùng BCS, cùng khoảng ngày, gom sản lượng
                                                                    dr["SAN_LUONG"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(drv["SAN_LUONG"]);
                                                                    //Thay đổi BCS
                                                                    if (Convert.ToInt64(dr["ID_CHISO"]) < Convert.ToInt64(drv["ID_CHISO"]))
                                                                    {
                                                                        //Cập nhật ID_CHISO của dòng sau
                                                                        dr["ID_CHISO"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["ID_CHISO"] : drv["ID_CHISO"];
                                                                        if (dr["BCS"].ToString().Trim() != drv["BCS"].ToString().Trim())
                                                                        {
                                                                            //Cập nhật BCS của dòng sau
                                                                            dr["BCS"] = drv["BCS"].ToString().Trim() == "CD" || drv["BCS"].ToString().Trim() == "TD" ? dr["BCS"] : drv["BCS"];
                                                                            dr["TGIAN_BDIEN"] = drv["TGIAN_BDIEN"];
                                                                        }
                                                                    }
                                                                    isExistsTemp = 1;
                                                                    break;
                                                                }
                                                            }
                                                            //Cuối vòng lặp mà chưa có dòng nào thỏa mãn, đẩy mới vào dtSL3_Temp
                                                            if (isExistsTemp == 0)
                                                            {
                                                                drv.Row["MA_NGIA"] = "A";
                                                                dtSL3_Update.ImportRow(drv.Row);
                                                            }
                                                        }

                                                    }


                                                    #endregion


                                                    #endregion
                                                }
                                                drv.Delete();
                                                iCount--;
                                            }

                                        }
                                    }
                                }
                                //Đẩy lại vào SL3.
                                dtSL3_Update.AcceptChanges();
                                if (dtSL3_Update != null && dtSL3_Update.Rows.Count > 0)
                                    foreach (DataRow drvInsert in dtSL3_Update.Rows)
                                    {
                                        if (Convert.ToDecimal(drvInsert["SAN_LUONG"]) < 0)
                                            return "Điểm đo " + drvInsert["MA_DDO"].ToString().Trim() + " từ " + Convert.ToDateTime(drvInsert["NGAY_DAU"]).ToString("dd/MM/yyyy") + " đến " + Convert.ToDateTime(drvInsert["NGAY_CUOI"]).ToString("dd/MM/yyyy") + " có sản lượng CTT < sản lượng MDK";

                                        if (Convert.ToDecimal(drvInsert["SAN_LUONG"]) > 0)
                                            dsCalculation.Tables["SL_3"].ImportRow(drvInsert);
                                    }
                                dtSL3_Update.Clear();
                                #endregion
                            }
                            #endregion

                        }

                        strMa_DDoBB = strMa_DDoBB + strMa_DDo + "|";
                    }
                    else
                    {
                        if (isPhat == 1)
                        {
                            //Không phải làm gì nữa
                        }
                        else
                        {
                            //Da thuc hien xu ly xong
                            //if (IsExists_SLTPBB != 0)
                            //{
                            //    //Co ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, remove het cac row con lai
                            //    dsCalculation.Tables["SL_3"].Rows.Remove(drSL3.Row);
                            //    continue;
                            //}
                            //else
                            //{
                            //    //Khong ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, remove cac row ung voi nhom gia A, giá phạt
                            //    if (Convert.ToString(drSL3["MA_NGIA"]) == "A" || Convert.ToString(drSL3["MA_NGIA"]) == "N" || Convert.ToString(drSL3["MA_NGIA"]) == "D" || Convert.ToString(drSL3["MA_NGIA"]) == "E" || Convert.ToString(drSL3["MA_NGIA"]) == "F" || (Convert.ToString(drSL3["MA_NGIA"]) == "K" && Convert.ToString(drSL3["MA_NHOMNN"]) == "SHTM"))
                            //    //Nhóm N: Hộ nghèo\
                            //    //Nhóm E: giá khác, chỉ xảy ra khi có đổi biên bản giá bán buôn kỳ đổi giá nhà nước
                            //    {
                            //        if (Convert.ToString(drSL3["MA_NHOMNN"]) != "SHBN")
                            //        {
                            //            dsCalculation.Tables["SL_3"].Rows.Remove(drSL3.Row);
                            //            continue;
                            //        }
                            //    }
                            //}
                        }
                    }

                    dsCalculation.Tables["SL_3"].AcceptChanges();
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_40: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }
        public string DetailDataCalculation_40_0106(DS_CALCULATIONTABLES dsCalculation, DataSet dsCustomerData, DataSet dsStaticCatalog, DataSet dsInvoiceData, string strMa_DViQLy, string strMa_SoGCS, short ky, short thang, short nam)
        {
            try
            {
                DataView dwSL3, dwSLBBuon, dwSLBBuon_GT, dwGCS, dwGCS_GT;
                string strMa_DDoBB = "|", strMa_DDo = "", strMa_NhomNNBB = "";
                Decimal slBB = 0, slBB_1 = 0, slTP = 0, slBN_BT = 0, slBN_CD = 0, slBN_TD = 0, slTNT50 = 0, sohoTNT50 = 0, slMDK = 0, sl_TruocChot = 0, sl_SauChot = 0;
                Decimal slTP_T = 0, slBN_BT_T = 0, slBN_CD_T = 0, slBN_TD_T = 0, slTNT50_T = 0, slTP_S = 0, slBN_BT_S = 0, slBN_CD_S = 0, slBN_TD_S = 0, slTNT50_S = 0;
                Decimal slMDK_BT = 0, slMDK_CD = 0, slMDK_TD = 0, slMDK_BT_T = 0, slMDK_CD_T = 0, slMDK_TD_T = 0, slMDK_BT_S = 0, slMDK_CD_S = 0, slMDK_TD_S = 0, tonthat_cu, tonthat_moi;
                DataRow drTP, drBN_BT, drBN_CD, drBN_TD, drTNT50, drCCS_New, drMDK_BT, drMDK_CD, drMDK_TD;
                //DataRow[] drBB;
                //IsBBtoTM: Biến kiểm tra có đổi loại từ bán buôn thông thường sang SHTM không
                //IsBMtoTM: Biến kiểm tra có đổi loại từ SHBM sang SHTM không: 1: có; 0: đổi loại bán buôn thông thường
                Int16 IsExists_SLTPBB = 0, IsBBtoTM = 0, IsBMtoTM = 0;
                DateTime ngay_dky, ngay_cky, ngay_ccs, ngay_hhluc;

                //Gom san luong cua cac doi tuong Ban buon - xu ly rieng
                //Cap nhat du lieu vao bang SL_3
                if (dsCalculation == null)
                    return "dsCalculationIsNull";
                else
                    if (dsCalculation.Tables.Contains("SL_3") == false)
                    return "NotExistsSL_3";
                if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                    return "NotExistsGCS_CHISO";
                dwGCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwSL3 = new DataView(dsCalculation.Tables["SL_3"]);
                dwSL3.RowFilter = "MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')";
                dwSL3.Sort = "MA_DVIQLY, MA_DDO, NGAY_DAU, NGAY_CUOI, MA_NHOMNN, MA_NGIA";
                if (dwSL3.Count == 0)
                    return ""; //Khong ton tai thanh phan ban buon       

                //Co ton tai thanh phan ban buon
                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") == true)
                {
                    dwSLBBuon = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                    if (dwSLBBuon.Count != 0)
                    {
                        dwSLBBuon.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwSLBBuon[0]["MA_DVIQLY"]) + "'";
                    }
                }
                else
                {
                    dwSLBBuon = null;
                }

                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                {
                    dwSLBBuon_GT = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                    if (dwSLBBuon_GT.Count != 0)
                    {
                        dwSLBBuon_GT.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwSLBBuon_GT[0]["MA_DVIQLY"]) + "'";
                    }
                }
                else
                {
                    dwSLBBuon_GT = null;
                }

                ngay_dky = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_cky = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                ngay_ccs = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));

                foreach (DataRowView drSL3 in dwSL3)
                {
                    if (drSL3.Row.RowState == DataRowState.Deleted || drSL3.Row.RowState == DataRowState.Detached) continue;
                    strMa_DDo = Convert.ToString(drSL3["MA_DDO"]);
                    strMa_NhomNNBB = Convert.ToString(drSL3["MA_NHOMNN"]);
                    //TOAN1415
                    if (strMa_DDo == "PD01000010248001")
                    {
                        strMa_DDo = "PD01000010248001";
                    }

                    if (strMa_DDoBB.Contains("|" + strMa_DDo + "|") == false)
                    {
                        //Dũng NT bổ sung gán mặc định ID_CHISO của dòng BT DDK cho tất cả chi tiết hóa đơn - CMIS-8178
                        #region Tìm dòng chỉ số tương ứng theo BCS để lấy ID_CHISO gán vào HDN_HDONCTIET

                        DataRowView drvCCS = null, drvDDK = null, drv_BT_DDK = null, drv_CD_DDK = null, drv_TD_DDK = null;
                        dwGCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('BT','KT')";

                        if (dwGCS != null && dwGCS.Count > 0)
                        {

                            dwGCS.Sort = "ID_CHISO DESC";
                            drvDDK = dwGCS[0];
                            drv_BT_DDK = dwGCS[0];
                            if (drSL3["BCS"].ToString() != "VC")
                                drSL3["ID_CHISO"] = dwGCS[0]["ID_CHISO"];
                        }
                        else
                        {
                            //Không có trong GCS_CHISO, kiểm tra có GCS_CHISO_GT không
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('BT','KT')";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    dwGCS_GT.Sort = "ID_CHISO DESC";
                                    drvDDK = dwGCS_GT[0];
                                    drv_BT_DDK = dwGCS_GT[0];
                                    if (drSL3["BCS"].ToString() != "VC")
                                        drSL3["ID_CHISO"] = dwGCS_GT[0]["ID_CHISO"];
                                }
                                // Không có ko thực hiện gì
                            }
                            // Không có ko thực hiện gì
                        }
                        dwGCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('CD')";

                        if (dwGCS != null && dwGCS.Count > 0)
                        {
                            dwGCS.Sort = "ID_CHISO DESC";
                            drv_CD_DDK = dwGCS[0];
                        }
                        else
                        {
                            //Không có trong GCS_CHISO, kiểm tra có GCS_CHISO_GT không
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('CD')";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    dwGCS_GT.Sort = "ID_CHISO DESC";
                                    drv_CD_DDK = dwGCS_GT[0];
                                }
                                // Không có ko thực hiện gì
                            }
                            // Không có ko thực hiện gì
                        }
                        dwGCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('TD')";

                        if (dwGCS != null && dwGCS.Count > 0)
                        {
                            dwGCS.Sort = "ID_CHISO DESC";
                            drv_TD_DDK = dwGCS[0];
                        }
                        else
                        {
                            //Không có trong GCS_CHISO, kiểm tra có GCS_CHISO_GT không
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('CD')";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    dwGCS_GT.Sort = "ID_CHISO DESC";
                                    drv_TD_DDK = dwGCS_GT[0];
                                }
                                // Không có ko thực hiện gì
                            }
                            // Không có ko thực hiện gì
                        }
                        //Bổ sung lấy dòng CCS BT hoặc KT để gán cho dòng chi tiết trước đổi giá

                        dwGCS.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('BT','KT') and LOAI_CHISO ='CCS'";

                        if (dwGCS != null && dwGCS.Count > 0)
                        {
                            dwGCS.Sort = "ID_CHISO DESC";
                            drvCCS = dwGCS[0];
                        }
                        else
                        {
                            //Không có trong GCS_CHISO, kiểm tra có GCS_CHISO_GT không
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                dwGCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwGCS_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "' and BCS in ('BT','KT') and LOAI_CHISO ='CCS'";
                                if (dwGCS_GT != null && dwGCS_GT.Count > 0)
                                {
                                    dwGCS_GT.Sort = "ID_CHISO DESC";
                                    drvCCS = dwGCS_GT[0];
                                }
                                // Không có ko thực hiện gì
                            }
                            // Không có ko thực hiện gì
                        }

                        #endregion
                        //Chua thuc hien xu ly
                        //Tim min ngay dau ky va max ngay cuoi ky
                        ngay_dky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MIN(NGAY_DAU)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')"));
                        ngay_cky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MAX(NGAY_CUOI)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')"));
                        //Khởi tạo lại giá trị trước khi tính
                        ngay_ccs = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        sohoTNT50 = 0;
                        slTP = 0;
                        slTP_T = 0;
                        slTP_S = 0;
                        slBN_BT_T = 0;
                        slBN_BT_S = 0;
                        slBN_CD_T = 0;
                        slBN_CD_S = 0;
                        slBN_TD_T = 0;
                        slBN_TD_S = 0;
                        slTNT50 = 0;
                        slTNT50_T = 0;
                        slTNT50_S = 0;
                        slMDK_BT = 0;
                        slMDK_BT_T = 0;
                        slMDK_BT_S = 0;
                        slMDK_CD = 0;
                        slMDK_CD_T = 0;
                        slMDK_CD_S = 0;
                        slMDK_TD = 0;
                        slMDK_TD_T = 0;
                        slMDK_TD_S = 0;
                        tonthat_cu = 1;
                        tonthat_moi = 1;
                        IsBMtoTM = 0;
                        IsBBtoTM = 0;
                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN <> '" + strMa_NhomNNBB + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')").Length > 0)
                        {
                            DateTime ngay_chuyendoi = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MIN(NGAY_DAU)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <> '" + strMa_NhomNNBB + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')"));
                            if (ngay_chuyendoi > ngay_dky)
                            {
                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN <> '" + strMa_NhomNNBB + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')")[0]["MA_NHOMNN"].ToString().Trim() == "SHTM")
                                //Có đổi từ bán buôn thông thường sang SHTM
                                {
                                    if (strMa_NhomNNBB == "SHBM")
                                        IsBMtoTM = 1;
                                    else
                                        IsBBtoTM = 1;
                                    //Cập nhật lại số hộ theo số hộ lớn nhất
                                    drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                }
                                else
                                {
                                    if (strMa_NhomNNBB == "SHBM")
                                        IsBMtoTM = 2;
                                    else
                                        IsBBtoTM = 2;

                                }
                            }
                        }
                        //Kiểm ta có đổi giá nhà nước luôn từ đây
                        #region Kiểm tra có đổi giá nhà nước không

                        Decimal IsChangePrice = 0;
                        //Kiem tra va xu ly rieng cho cac so ghi chi so ngay 01, trung ngay doi gia
                        DateTime ngay_ckymax = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                            {
                                ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                                {
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length == 0)
                                    {
                                        ngay_ckymax = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                    }
                                }
                            }
                        }
                        //Kiem tra thay doi gia nha nuoc hay khong
                        DataView dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA"]);
                        dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                        dwGia.Sort = "NGAY_HLUC";
                        string strMa_NhomNN = "", strMa_CapDA = "", strTGian_BDien = "", strMa_NGia = "", strKhoang_DAp = "";

                        DataView dwTChieuDA = new DataView(dsStaticCatalog.Tables["D_THAMCHIEU_CAPDA"]);
                        dwTChieuDA.RowFilter = "MA_NHOMNN = 'SHBT'";
                        dwTChieuDA.Sort = "NGAY_ADUNG DESC";

                        DataView dwGiaNhomNN = new DataView(dsStaticCatalog.Tables["D_GIA_NHOMNN"]);
                        dwGiaNhomNN.RowFilter = "MA_NHOMNN = 'SHBT'";
                        dwGiaNhomNN.Sort = "NGAY_ADUNG DESC";

                        DateTime ngay_hluc = DateTime.Parse("01/01/1900", new System.Globalization.CultureInfo("vi-VN"));
                        DateTime ngay_cuoi = ngay_cky;
                        DateTime ngay_dau = ngay_dky;

                        foreach (DataRowView drwGia in dwGia)
                        {
                            //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                            if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                            {
                                //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                strKhoang_DAp = "";

                                //Tim khoang tham chieu cap dien ap
                                dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                foreach (DataRowView drCapDA in dwTChieuDA)
                                {
                                    ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (ngay_ckymax == ngay_hluc)
                                    {
                                        //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                        //se tinh toan bo vao bac thang cua bang gia cu
                                        continue;

                                    }
                                    if (ngay_cuoi >= ngay_hluc)
                                    {
                                        strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                        break;
                                    }
                                }

                                if (strKhoang_DAp != "")
                                {
                                    dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                    foreach (DataRowView drGia in dwGiaNhomNN)
                                    {
                                        ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (ngay_ckymax == ngay_hluc)
                                        {
                                            //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                            //se tinh toan bo vao bac thang cua bang gia cu
                                            //continue;
                                            IsChangePrice = 0;
                                            break;
                                        }
                                        if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                        {
                                            //Co doi gia
                                            IsChangePrice = 1;
                                            ngay_ccs = ngay_hluc.AddDays(-1.0);
                                            break;
                                        }
                                        else if (drGia["NGAY_HETHLUC"].ToString().Trim().Length > 0)
                                        {
                                            ngay_hhluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HETHLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            if (ngay_cuoi >= ngay_hhluc && ngay_dau <= ngay_hhluc)
                                            {
                                                //Nhóm giá bị hết hiệu lực giữa kỳ -> Co doi gia
                                                IsChangePrice = 1;
                                                ngay_ccs = ngay_hhluc;
                                                break;
                                            }

                                        }
                                    }
                                }

                                if (IsChangePrice == 1)
                                {
                                    break;
                                }
                            }
                        }

                        //22/12/2012: Kiem tra them voi diem do phu ghep tong
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "'").Length != 0)
                            {
                                dwGia = new DataView(dsCustomerData.Tables["HDG_BBAN_APGIA_GT"]);
                                dwGia.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                dwGia.Sort = "NGAY_HLUC";

                                foreach (DataRowView drwGia in dwGia)
                                {
                                    //ngay_hlucgia = Convert.ToDateTime(drwGia["NGAY_HLUC"]);
                                    if (Convert.ToDateTime(drSL3["NGAY_HLUCGIA"]) == Convert.ToDateTime(drwGia["NGAY_HLUC"]))
                                    {
                                        //Kiem tra xem co doi gia nha nuoc trong khoang ngay_dau, ngay_cuoi hay khong
                                        strMa_NhomNN = Convert.ToString(drwGia["MA_NHOMNN"]);
                                        strMa_CapDA = Convert.ToString(drwGia["MA_CAPDAP"]);
                                        strTGian_BDien = Convert.ToString(drwGia["TGIAN_BDIEN"]);
                                        strMa_NGia = Convert.ToString(drwGia["MA_NGIA"]);
                                        strKhoang_DAp = "";

                                        //Tim khoang tham chieu cap dien ap
                                        dwTChieuDA.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND MA_CAPDA = '" + strMa_CapDA + "'";
                                        foreach (DataRowView drCapDA in dwTChieuDA)
                                        {
                                            ngay_hluc = DateTime.Parse(Convert.ToDateTime(drCapDA["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                            if (ngay_ckymax == ngay_hluc)
                                            {
                                                //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                //se tinh toan bo vao bac thang cua bang gia cu
                                                continue;
                                            }
                                            if (ngay_cuoi >= ngay_hluc)
                                            {
                                                strKhoang_DAp = Convert.ToString(drCapDA["KHOANG_DA"]);
                                                break;
                                            }
                                        }

                                        if (strKhoang_DAp != "")
                                        {
                                            dwGiaNhomNN.RowFilter = "MA_NHOMNN = '" + strMa_NhomNN + "' AND KHOANG_DA = '" + strKhoang_DAp + "' AND THOIGIAN_BDIEN = '" + strTGian_BDien + "' AND MA_NGIA = '" + strMa_NGia + "'";

                                            foreach (DataRowView drGia in dwGiaNhomNN)
                                            {
                                                ngay_hluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_ADUNG"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                if (ngay_ckymax == ngay_hluc)
                                                {
                                                    //Xu ly rieng cho cac diem do co so ghi ngay trung voi ngay doi gia,
                                                    //se tinh toan bo vao bac thang cua bang gia cu
                                                    //continue;
                                                    IsChangePrice = 0;
                                                    break;
                                                }
                                                if (ngay_cuoi >= ngay_hluc && ngay_dau < ngay_hluc)
                                                {
                                                    //Co doi gia
                                                    IsChangePrice = 1;
                                                    ngay_ccs = ngay_hluc.AddDays(-1.0);
                                                    break;
                                                }
                                                else if (drGia["NGAY_HETHLUC"].ToString().Trim().Length > 0)
                                                {
                                                    ngay_hhluc = DateTime.Parse(Convert.ToDateTime(drGia["NGAY_HETHLUC"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                    if (ngay_cuoi >= ngay_hhluc && ngay_dau <= ngay_hhluc)
                                                    {
                                                        //Nhóm giá bị hết hiệu lực giữa kỳ -> Co doi gia
                                                        IsChangePrice = 1;
                                                        ngay_ccs = ngay_hhluc;
                                                        break;
                                                    }

                                                }
                                            }
                                        }

                                        if (IsChangePrice == 1)
                                        {
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        #endregion
                        #region Kiem tra su ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                        IsExists_SLTPBB = 0;
                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") == true)
                        {
                            //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                            dwSLBBuon.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                            if (dwSLBBuon.Count > 0)
                            {
                                IsExists_SLTPBB = 1;
                            }
                            else
                            {
                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                                {
                                    //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                    dwSLBBuon_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                    if (dwSLBBuon_GT.Count > 0)
                                    {
                                        IsExists_SLTPBB = 2;
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") == true)
                            {
                                //dwSLBB = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                dwSLBBuon_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                if (dwSLBBuon_GT.Count > 0)
                                {
                                    IsExists_SLTPBB = 2;
                                }
                            }
                        }
                        #endregion


                        if (IsExists_SLTPBB != 0)
                        {
                            #region Co ton tai du lieu trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT
                            //drSL3["NGAY_DAU"] = ngay_dky;
                            //drSL3["NGAY_CUOI"] = ngay_cky;
                            //Ton tai trong bang GCS_SLMDK_SHBB hoac GCS_SLMDK_SHBB_GT
                            drTP = dsCalculation.Tables["SL_3"].NewRow();
                            drBN_BT = dsCalculation.Tables["SL_3"].NewRow();
                            drBN_CD = dsCalculation.Tables["SL_3"].NewRow();
                            drBN_TD = dsCalculation.Tables["SL_3"].NewRow();
                            drTNT50 = dsCalculation.Tables["SL_3"].NewRow();
                            drMDK_BT = dsCalculation.Tables["SL_3"].NewRow();
                            drMDK_CD = dsCalculation.Tables["SL_3"].NewRow();
                            drMDK_TD = dsCalculation.Tables["SL_3"].NewRow();
                            if (strMa_NhomNNBB != "SHBM" && strMa_NhomNNBB != "SHBN" && strMa_NhomNNBB != "SHTM")
                            {
                                #region Xu ly voi SHBB, SHBC, SHBD, SHBH, SHBP, SHBL
                                //Tính lại ngày đầu kỳ, cuối kỳ cho trường hợp SHBM chuyển sang SHBB,C,D,H,L
                                //ngay_dky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MIN(NGAY_DAU)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL')"));
                                //ngay_cky = Convert.ToDateTime(dsCalculation.Tables["SL_3"].Compute("MAX(NGAY_CUOI)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL')"));



                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                {
                                    //Bi phat, ton tai nhom D, gan toan bo san luong cua diem do theo nhom D
                                    //lấy ra bản ghi áp giá phạt trong SL_3
                                    if (IsChangePrice == 1)
                                    {
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        //drSL3["NGAY_CUOI"] = ngay_cky;
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='" + strMa_NhomNNBB + "' AND BCS IN ('KT','BT','CD','TD')"));
                                        //drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3.Row["MA_NGIA"] = "D";


                                        if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                        {
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (IsBBtoTM == 1 && dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND BCS IN ('KT','BT','CD','TD')").Length > 0)
                                            {
                                                //Đổi từ SHBB,C,D,H,L sang SHBM, bóc tách theo BCS
                                                DateTime ngaydky_phat_new = ngay_ccs;// DateTime.Parse(Convert.ToDateTime(drSL3["NGAY_CUOI"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                #region SHTM-KT
                                                decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='KT'"));
                                                if (slBB_KT_1 > 0)
                                                {
                                                    DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_KT_New["SAN_LUONG"] = slBB_KT_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_KT_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_KT_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_KT_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_KT_New["MA_NGIA"] = "K";
                                                        drPhat_KT_New["BCS"] = "KT";
                                                        drPhat_KT_New["TGIAN_BDIEN"] = "BT";
                                                        drPhat_KT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_KT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);
                                                    }

                                                }
                                                #endregion
                                                #region SHTM-BT

                                                decimal slBB_BT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='BT'"));
                                                if (slBB_BT_1 > 0)
                                                {
                                                    DataRow drPhat_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_BT_New["SAN_LUONG"] = slBB_BT_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_BT_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_BT_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_BT_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_BT_New["MA_NGIA"] = "K";
                                                        drPhat_BT_New["BCS"] = "BT";
                                                        drPhat_BT_New["TGIAN_BDIEN"] = "BT";
                                                        drPhat_BT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_BT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_BT_New);
                                                    }

                                                }

                                                #endregion
                                                #region SHTM-CD

                                                decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                                if (slBB_CD_1 > 0)
                                                {
                                                    DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_CD_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_CD_New["MA_NGIA"] = "K";
                                                        drPhat_CD_New["BCS"] = "CD";
                                                        drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                        drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);
                                                    }

                                                }

                                                #endregion
                                                #region SHTM-TD

                                                decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                                if (slBB_TD_1 > 0)
                                                {
                                                    DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_TD_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_TD_New["MA_NGIA"] = "K";
                                                        drPhat_TD_New["BCS"] = "TD";
                                                        drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                        drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);
                                                    }

                                                }

                                                #endregion
                                            }
                                            else
                                            {
                                                //Có đổi nhóm giá khác, chỉ xảy ra trong kỳ đổi giá
                                                slBB_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND BCS IN ('KT','BT','CD','TD')"));

                                                DataRow drPhat_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_New["SAN_LUONG"] = slBB_1;
                                                DateTime ngaydky_phat_new = ngay_ccs;//DateTime.Parse(Convert.ToDateTime(drSL3["NGAY_CUOI"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                if (ngaydky_phat_new < ngay_cky)
                                                {
                                                    drPhat_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                    drPhat_New["NGAY_CUOI"] = ngay_cky;
                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                    if (IsBBtoTM == 2)
                                                    {
                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                        if (drTemp != null && drTemp.Length > 0)
                                                        {
                                                            drPhat_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                            drPhat_New["MA_NGIA"] = "E";
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                        drPhat_New["MA_NGIA"] = "E";
                                                    }

                                                    dsCalculation.Tables["SL_3"].Rows.Add(drPhat_New);
                                                }
                                            }
                                            drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                            drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                        }
                                        else
                                        {
                                            slBB = 0;
                                            slBB_1 = 0;
                                            //Không đổi giá nhóm khác
                                            //Tách riêng khoảng sản lượng CTT trước và sau khi đổi giá
                                            foreach (DataRowView dwrCCS in dwSL3)
                                            {
                                                if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                                {
                                                    if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                    {
                                                        if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                        {
                                                            //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                            if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                            {
                                                                slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                            if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                            {
                                                                slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            drSL3["NGAY_CUOI"] = ngay_ccs;
                                            DataRow drPhat_New = dsCalculation.Tables["SL_3"].NewRow();
                                            drPhat_New.ItemArray = drSL3.Row.ItemArray;
                                            drPhat_New["SAN_LUONG"] = slBB_1;
                                            drPhat_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                            drPhat_New["NGAY_CUOI"] = ngay_cky;
                                            drPhat_New["MA_NGIA"] = "E";
                                            dsCalculation.Tables["SL_3"].Rows.Add(drPhat_New);
                                        }
                                    }
                                    else
                                    {
                                        //Bi phat, ton tai nhom D, gan toan bo san luong cua diem do theo nhom D
                                        //Sổ ghi trùng ngày đổi giá, tính toàn bộ nhóm F SHBM
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        //drSL3["NGAY_CUOI"] = ngay_cky;
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                        drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3.Row["MA_NGIA"] = "D";
                                        //Gán lại cho toàn bộ khoảng ngày
                                        drSL3["NGAY_CUOI"] = ngay_cky;
                                    }

                                }
                                else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'E'").Length != 0)
                                {
                                    //Bi phat sau 01/06/2014, ton tai nhom E, gan toan bo san luong cua diem do theo nhom E
                                    drSL3["NGAY_DAU"] = ngay_dky;
                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS IN ('KT','BT','CD','TD')"));
                                    drSL3.Row["SAN_LUONG"] = slBB;
                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                        drSL3.Row["BCS"] = "KT";
                                    else
                                        drSL3.Row["BCS"] = "BT";
                                    drSL3.Row["MA_NGIA"] = "E";
                                }
                                else
                                {
                                    //Khong ton tai nhom D, tinh theo san luong thuong pham
                                    if (IsBBtoTM == 1)
                                    {
                                        //SHBB,C,D,H,L sang SHTM
                                        if (IsExists_SLTPBB == 1)
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                            slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                            slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                        else
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                            slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                            slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                    }
                                    else if (IsBBtoTM == 2 || IsBBtoTM == 0)
                                    {
                                        //SHBH->SHBC;SHBL->SHBD: hiện nay chưa chắc chắn có trường hợp này.
                                        if (IsExists_SLTPBB == 1)
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);

                                            slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = 0;
                                            slMDK_CD = 0;
                                            slMDK_TD = 0;
                                            slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                            slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                            slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                        else
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);

                                            slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = 0;
                                            slMDK_CD = 0;
                                            slMDK_TD = 0;
                                            slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                            slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                            slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                    }
                                    #region Tính riêng sản lượng chốt
                                    //Xu ly cho nhom A, cong tong san luong

                                    if (strMa_DDo == "PD01000009864002")
                                    {
                                        strMa_DDo = "PD01000009864002";
                                    }

                                    if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Co chot chi so trong GCS_CHISO

                                        slBB = 0;
                                        slBB_1 = 0;

                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));

                                        //Tách riêng khoảng sản lượng CTT trước và sau khi đổi giá
                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                        if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                        {
                                            slTNT50 = (slBB_1 + slBB) - (slTP + slBN_BT + slBN_CD + slBN_TD + slMDK_TD + slMDK_CD + slMDK_BT);
                                        }
                                        //Chưa tính tổn thất
                                        slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50 + slMDK_TD + slMDK_CD + slMDK_BT;

                                        //tách sản lượng mdk
                                        if (slTP > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP - slTP_T;

                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                slTP_S = slTP - slTP_T;

                                            }
                                        }

                                        //Bổ sung tách sản lượng MDK_BT,CD,TD
                                        if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_T = 0;
                                                        slMDK_CD_T = 0;
                                                        slMDK_TD_T = 0;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_T = 0;
                                                        slMDK_CD_T = 0;
                                                        slMDK_TD_T = 0;
                                                    }
                                                }
                                                //slTP_S = slTP - slTP_T;
                                            }
                                        }
                                        //Tính lại sản lượng tp theo tỉ lệ tổn thất
                                        //Tính lại sản lượng tp theo tỉ lệ tổn thất
                                        slTP_T = Math.Round(slTP_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                        slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                        if (slBN_BT > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slBN_BT_T = Math.Round(slBN_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBN_BT_S = slBN_BT - slBN_BT_T;
                                            }
                                            else
                                            {
                                                slBN_BT_T = Math.Round(slBN_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slBN_BT_S = slBN_BT - slBN_BT_T;
                                            }
                                        }
                                        if (slBN_CD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slBN_CD_T = Math.Round(slBN_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBN_CD_S = slBN_CD - slBN_CD_T;
                                            }
                                            else
                                            {
                                                slBN_CD_T = Math.Round(slBN_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slBN_CD_S = slBN_CD - slBN_CD_T;
                                            }
                                        }
                                        if (slBN_TD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slBN_TD_T = Math.Round(slBN_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBN_TD_S = slBN_TD - slBN_TD_T;
                                            }
                                            else
                                            {
                                                slBN_TD_T = Math.Round(slBN_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slBN_TD_S = slBN_TD - slBN_TD_T;
                                            }
                                        }
                                        //Tính lại sl hộ nghèo và slmdk sau khi đã có tổn thất
                                        if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                        {
                                            slTNT50 = (slBB_1 + slBB) - (slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S);
                                        }
                                        //Đã tính tổn thất
                                        slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;
                                        //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T
                                        if (slTNT50 > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTNT50_S = slTNT50 - slTNT50_T;

                                            }
                                            else
                                            {
                                                slTNT50_T = Math.Round(slTNT50 * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                slTNT50_S = slTNT50 - slTNT50_T;
                                            }
                                        }
                                        //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                        if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                        {
                                            slTNT50_T = slBB - (slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slMDK_BT_T + slMDK_CD_T + slMDK_TD_T);
                                            slTNT50_S = slBB_1 - (slTP_S + slBN_BT_S + slBN_CD_S + slBN_TD_S + slMDK_BT_S + slMDK_CD_S + slMDK_TD_S);
                                        }
                                        //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                        if (ngay_dky >= new DateTime(2014, 6, 1))
                                        {
                                            //tính lại slMDK
                                            slMDK = slMDK - slTNT50;
                                            slTNT50_T = 0;
                                            slTNT50_S = 0;
                                        }
                                        else
                                        {
                                            if (ngay_cky >= new DateTime(2014, 6, 1))
                                            {
                                                //Vắt qua đổi giá 01/06/2014, trước có hộ nghèo và sau = 0
                                                slMDK = slMDK - slTNT50_S;
                                                slTNT50_S = 0;
                                            }
                                        }
                                        sl_TruocChot = slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slTNT50_T;
                                        sl_SauChot = slMDK - sl_TruocChot;

                                        if (slBB > 0)
                                        {
                                            if (slBB >= sl_TruocChot)
                                            {
                                                //Truoc doi gia nha nuoc
                                                drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;

                                                //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                if (ngay_dky < new DateTime(2014, 6, 1))
                                                {
                                                    if (sohoTNT50 > 0)
                                                    {
                                                        //Nếu có sản lượng hộ nghèo trong GCS_SLMDK_SHBB, ưu tiên tính theo GCS_SLMDK_SHBB
                                                        //Gán nhóm bán buôn về A
                                                        drSL3["MA_NGIA"] = "A";
                                                        if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                        {
                                                            drSL3.Row["SO_HO"] = 0;
                                                        }
                                                        else
                                                        {
                                                            drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                        }
                                                    }

                                                }

                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            if (slBB_1 >= sl_SauChot)
                                            {
                                                //Sau doi gia nha nuoc
                                                drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                if (ngay_dky < new DateTime(2014, 6, 1) && ngay_cky > new DateTime(2014, 6, 1))
                                                {
                                                    //trước đã trừ số hộ nghèo, sau phải cộng lại
                                                    drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) + sohoTNT50;

                                                }
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                                {
                                                    DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                    if (drTemp != null && drTemp.Length > 0)
                                                    {
                                                        drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                    }
                                                }
                                                dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        //Chuẩn hóa lại ID_CHISO
                                        drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                        drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                    }

                                    else
                                    {
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (strMa_DDo == "PD01000009864002")
                                            {
                                                strMa_DDo = "PD01000009864002";
                                            }

                                            if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                            {
                                                //Co chot chi so trong GCS_CHISO_GT
                                                slBB = 0;
                                                slBB_1 = 0;
                                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));

                                                foreach (DataRowView dwrCCS in dwSL3)
                                                {
                                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                                    {
                                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                        {
                                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50 = (slBB_1 + slBB) - (slTP + slBN_BT + slBN_CD + slBN_TD + slMDK_TD + slMDK_CD + slMDK_BT);
                                                }
                                                //Chưa tính tổn thất
                                                slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50 + slMDK_TD + slMDK_CD + slMDK_BT;

                                                if (slTP > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;
                                                    }
                                                }

                                                //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                        //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                        slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                            }
                                                            else
                                                            {
                                                                slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_T = 0;
                                                                slMDK_CD_T = 0;
                                                                slMDK_TD_T = 0;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                            }
                                                            else
                                                            {

                                                                slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_T = 0;
                                                                slMDK_CD_T = 0;
                                                                slMDK_TD_T = 0;
                                                            }
                                                        }
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                //Tính lại sản lượng tp theo tỉ lệ tổn thất

                                                slTP_T = Math.Round(slTP_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                if (slBN_BT > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slBN_BT_T = Math.Round(slBN_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_BT_S = slBN_BT - slBN_BT_T;
                                                    }
                                                    else
                                                    {
                                                        slBN_BT_T = Math.Round(slBN_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_BT_S = slBN_BT - slBN_BT_T;
                                                    }
                                                }
                                                if (slBN_CD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slBN_CD_T = Math.Round(slBN_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_CD_S = slBN_CD - slBN_CD_T;
                                                    }
                                                    else
                                                    {
                                                        slBN_CD_T = Math.Round(slBN_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_CD_S = slBN_CD - slBN_CD_T;
                                                    }
                                                }
                                                if (slBN_TD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slBN_TD_T = Math.Round(slBN_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_TD_S = slBN_TD - slBN_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slBN_TD_T = Math.Round(slBN_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_TD_S = slBN_TD - slBN_TD_T;
                                                    }
                                                }
                                                //Tính lại sl hộ nghèo và slmdk sau khi đã có tổn thất
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50 = (slBB_1 + slBB) - (slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S);
                                                }
                                                //Đã tính tổn thất
                                                slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;
                                                //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T

                                                if (slTNT50 > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;
                                                    }
                                                    else
                                                    {
                                                        slTNT50_T = Math.Round(slTNT50 * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;
                                                    }
                                                }

                                                //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50_T = slBB - (slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slMDK_BT_T + slMDK_CD_T + slMDK_TD_T);
                                                    slTNT50_S = slBB_1 - (slTP_S + slBN_BT_S + slBN_CD_S + slBN_TD_S + slMDK_BT_S + slMDK_CD_S + slMDK_TD_S);
                                                }
                                                //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                if (ngay_dky >= new DateTime(2014, 6, 1))
                                                {
                                                    //tính lại slMDK
                                                    slMDK = slMDK - slTNT50;
                                                    slTNT50_T = 0;
                                                    slTNT50_S = 0;
                                                }
                                                else
                                                {
                                                    if (ngay_cky >= new DateTime(2014, 6, 1))
                                                    {
                                                        //Vắt qua đổi giá 01/06/2014, trước có hộ nghèo và sau = 0
                                                        slMDK = slMDK - slTNT50_S;
                                                        slTNT50_S = 0;
                                                    }
                                                }
                                                sl_TruocChot = slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slTNT50_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB >= sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;

                                                        //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                        if (ngay_dky < new DateTime(2014, 6, 1))
                                                        {
                                                            if (sohoTNT50 > 0)
                                                            {
                                                                //Nếu có sản lượng hộ nghèo trong GCS_SLMDK_SHBB, ưu tiên tính theo GCS_SLMDK_SHBB
                                                                //Gán nhóm bán buôn về A
                                                                drSL3["MA_NGIA"] = "A";
                                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                                {
                                                                    drSL3.Row["SO_HO"] = 0;
                                                                }
                                                                else
                                                                {
                                                                    drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                                }
                                                            }
                                                        }

                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 >= sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                        if (ngay_dky < new DateTime(2014, 6, 1) && ngay_cky > new DateTime(2014, 6, 1))
                                                        {
                                                            //trước đã trừ số hộ nghèo, sau phải cộng lại
                                                            drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) + sohoTNT50;
                                                        }
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                                        {
                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }

                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);

                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                                drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                            }
                                            else
                                            {
                                                //Khong chot chi so
                                                if (IsChangePrice == 1)
                                                {
                                                    //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                                    decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slBB_1 = slBB - slbbTemp;
                                                    slBB = slbbTemp;
                                                    #region Đang làm
                                                    //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                    {
                                                        slTNT50 = (slBB_1 + slBB) - (slTP + slBN_BT + slBN_CD + slBN_TD + slMDK_TD + slMDK_CD + slMDK_BT);
                                                    }
                                                    //Chưa tính tổn thất
                                                    slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50 + slMDK_TD + slMDK_CD + slMDK_BT;

                                                    //tách sản lượng mdk
                                                    if (slTP > 0)
                                                    {
                                                        //Do không chốt CCS nên luôn nội suy theo ngày
                                                        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTP_S = slTP - slTP_T;
                                                    }

                                                    //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                    if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                    {
                                                        //Luôn nội suy theo ngày
                                                        slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;

                                                    }
                                                    //Tính lại sản lượng tp theo tỉ lệ tổn thất


                                                    slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slTP_T = Math.Round((slTP > 0 ? slTP_T : (slMDK_BT_T + slMDK_CD_T + slMDK_TD_T)) * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                    slTP_S = slTP > 0 ? slTP_S : 0;
                                                    slMDK_BT_T = 0;
                                                    slMDK_CD_T = 0;
                                                    slMDK_TD_T = 0;
                                                    slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                    if (slBN_BT > 0)
                                                    {

                                                        slBN_BT_T = Math.Round(slBN_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_BT_S = slBN_BT - slBN_BT_T;

                                                    }
                                                    if (slBN_CD > 0)
                                                    {

                                                        slBN_CD_T = Math.Round(slBN_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_CD_S = slBN_CD - slBN_CD_T;

                                                    }
                                                    if (slBN_TD > 0)
                                                    {

                                                        slBN_TD_T = Math.Round(slBN_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slBN_TD_S = slBN_TD - slBN_TD_T;

                                                    }
                                                    //Tính lại sl hộ nghèo và slmdk sau khi đã có tổn thất
                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                    {
                                                        slTNT50 = (slBB_1 + slBB) - (slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S);
                                                    }
                                                    //Đã tính tổn thất
                                                    slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;
                                                    //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T
                                                    if (slTNT50 > 0)
                                                    {

                                                        slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTNT50_S = slTNT50 - slTNT50_T;


                                                    }
                                                    //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                    {
                                                        slTNT50_T = slBB - (slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T);
                                                        slTNT50_S = slBB_1 - (slTP_S + slBN_BT_S + slBN_CD_S + slBN_TD_S + slMDK_BT_S + slMDK_CD_S + slMDK_TD_S);
                                                    }
                                                    //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                    if (ngay_dky >= new DateTime(2014, 6, 1))
                                                    {
                                                        //tính lại slMDK
                                                        slMDK = slMDK - slTNT50;
                                                        slTNT50_T = 0;
                                                        slTNT50_S = 0;
                                                    }
                                                    else
                                                    {
                                                        if (ngay_cky >= new DateTime(2014, 6, 1))
                                                        {
                                                            //Vắt qua đổi giá 01/06/2014, trước có hộ nghèo và sau = 0
                                                            slMDK = slMDK - slTNT50_S;
                                                            slTNT50_S = 0;
                                                        }
                                                    }
                                                    sl_TruocChot = slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slTNT50_T;
                                                    sl_SauChot = slMDK - sl_TruocChot;

                                                    if (slBB > 0)
                                                    {
                                                        if (slBB >= sl_TruocChot)
                                                        {
                                                            //Truoc doi gia nha nuoc
                                                            drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            drSL3["NGAY_DAU"] = ngay_dky;
                                                            drSL3["NGAY_CUOI"] = ngay_ccs;

                                                            //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                            if (ngay_dky < new DateTime(2014, 6, 1))
                                                            {

                                                                if (sohoTNT50 > 0)
                                                                {
                                                                    //Nếu có sản lượng hộ nghèo trong GCS_SLMDK_SHBB, ưu tiên tính theo GCS_SLMDK_SHBB
                                                                    //Gán nhóm bán buôn về A
                                                                    drSL3["MA_NGIA"] = "A";
                                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                                    {
                                                                        drSL3.Row["SO_HO"] = 0;
                                                                    }
                                                                    else
                                                                    {
                                                                        drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                                    }
                                                                }

                                                            }


                                                        }
                                                        else
                                                        {
                                                            //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                            drSL3.Row["SAN_LUONG"] = 0;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                        }
                                                    }
                                                    if (slBB_1 > 0)
                                                    {
                                                        if (slBB_1 >= sl_SauChot)
                                                        {
                                                            //Sau doi gia nha nuoc
                                                            drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                            drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                            drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                            if (ngay_dky < new DateTime(2014, 6, 1) && ngay_cky > new DateTime(2014, 6, 1))
                                                            {
                                                                //trước đã trừ số hộ nghèo, sau phải cộng lại
                                                                drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) + sohoTNT50;

                                                            }
                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                                            {
                                                                DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                                if (drTemp != null && drTemp.Length > 0)
                                                                {
                                                                    drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                    drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                                }

                                                            }
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                        }
                                                        else
                                                        {
                                                            //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                            drSL3.Row["SAN_LUONG"] = 0;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                        }
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    //Không có đổi giá nhà nước, để như cũ
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));
                                                    //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                    //tính lại sản lượng tp theo tỷ lệ tổn thất
                                                    slTP = slTP > 0 ? Math.Round(slTP * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_BT = slMDK_BT > 0 ? Math.Round(slMDK_BT * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_CD = slMDK_CD > 0 ? Math.Round(slMDK_CD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_TD = slMDK_TD > 0 ? Math.Round(slMDK_TD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    //if (Convert.ToDecimal(drSL3["SO_HO"]) <= sohoTNT50)
                                                    //{
                                                    //    slTNT50 = slBB - (slTP + slBN_BT + slBN_CD + slBN_TD + slMDK_BT + slMDK_CD + slMDK_TD);
                                                    //}
                                                    //Sau đợt đổi giá 01/06/2014 không còn hộ nghèo nữa
                                                    slTNT50 = 0;
                                                    slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50 + slMDK_BT + slMDK_CD + slMDK_TD;
                                                    //drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                    drSL3["SAN_LUONG"] = slBB - slMDK;
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                                    if (drvDDK != null)
                                                        drSL3["BCS"] = drvDDK["BCS"];
                                                    else
                                                    {
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                    }
                                                    drSL3.Row["MA_NGIA"] = "A";
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Khong chot chi so
                                            if (IsChangePrice == 1)
                                            {
                                                //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                                decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBB_1 = slBB - slbbTemp;
                                                slBB = slbbTemp;
                                                #region Đang làm
                                                //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50 = (slBB_1 + slBB) - (slTP + slBN_BT + slBN_CD + slBN_TD + slMDK_TD + slMDK_CD + slMDK_BT);
                                                }
                                                //Chưa tính tổn thất
                                                slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50 + slMDK_TD + slMDK_CD + slMDK_BT;

                                                //tách sản lượng mdk
                                                if (slTP > 0)
                                                {
                                                    //Do không chốt CCS nên luôn nội suy theo ngày
                                                    slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slTP_S = slTP - slTP_T;
                                                }

                                                //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                {
                                                    //Luôn nội suy theo ngày
                                                    slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                    slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                    slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_TD_S = slMDK_TD - slMDK_TD_T;

                                                }
                                                //Tính lại sản lượng tp theo tỉ lệ tổn thất

                                                slTP_T = Math.Round((slTP > 0 ? slTP_T : (slMDK_BT_T + slMDK_CD_T + slMDK_TD_T)) * tonthat_cu, MidpointRounding.AwayFromZero);
                                                slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP > 0 ? slTP_S : 0;


                                                slMDK_BT_T = 0;
                                                slMDK_CD_T = 0;
                                                slMDK_TD_T = 0;
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                if (slBN_BT > 0)
                                                {

                                                    slBN_BT_T = Math.Round(slBN_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slBN_BT_S = slBN_BT - slBN_BT_T;

                                                }
                                                if (slBN_CD > 0)
                                                {

                                                    slBN_CD_T = Math.Round(slBN_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slBN_CD_S = slBN_CD - slBN_CD_T;

                                                }
                                                if (slBN_TD > 0)
                                                {

                                                    slBN_TD_T = Math.Round(slBN_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slBN_TD_S = slBN_TD - slBN_TD_T;

                                                }
                                                //Tính lại sl hộ nghèo và slmdk sau khi đã có tổn thất
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50 = (slBB_1 + slBB) - (slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S);
                                                }
                                                //Đã tính tổn thất
                                                slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;
                                                //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T
                                                if (slTNT50 > 0)
                                                {

                                                    slTNT50_T = Math.Round(slTNT50 * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slTNT50_S = slTNT50 - slTNT50_T;


                                                }
                                                //Xu ly rieng cho truong hop so ho ngheo = so ho cong to tong
                                                if (Convert.ToDecimal(drSL3.Row["SO_HO"]) <= sohoTNT50)
                                                {
                                                    slTNT50_T = slBB - (slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T);
                                                    slTNT50_S = slBB_1 - (slTP_S + slBN_BT_S + slBN_CD_S + slBN_TD_S + slMDK_BT_S + slMDK_CD_S + slMDK_TD_S);
                                                }
                                                //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                if (ngay_dky >= new DateTime(2014, 6, 1))
                                                {
                                                    //tính lại slMDK
                                                    slMDK = slMDK - slTNT50;
                                                    slTNT50_T = 0;
                                                    slTNT50_S = 0;
                                                }
                                                else
                                                {
                                                    if (ngay_cky >= new DateTime(2014, 6, 1))
                                                    {
                                                        //Vắt qua đổi giá 01/06/2014, trước có hộ nghèo và sau = 0
                                                        slMDK = slMDK - slTNT50_S;
                                                        slTNT50_S = 0;
                                                    }
                                                }
                                                sl_TruocChot = slTP_T + slBN_BT_T + slBN_CD_T + slBN_TD_T + slTNT50_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB >= sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (ky + thang * 10 + nam * 12 * 10 >= 1 + 3 * 10 + 2010 * 12 * 10)
                                                        {
                                                            //Sau 01/06/2014, sản lượng hộ nghèo trước và sau đổi giá = 0, gán hết vào bán buôn
                                                            if (ngay_dky < new DateTime(2014, 6, 1))
                                                            {

                                                                if (sohoTNT50 > 0)
                                                                {
                                                                    //Nếu có sản lượng hộ nghèo trong GCS_SLMDK_SHBB, ưu tiên tính theo GCS_SLMDK_SHBB
                                                                    //Gán nhóm bán buôn về A
                                                                    drSL3["MA_NGIA"] = "A";
                                                                    if (Convert.ToDecimal(drSL3.Row["SO_HO"]) < sohoTNT50)
                                                                    {
                                                                        drSL3.Row["SO_HO"] = 0;
                                                                    }
                                                                    else
                                                                    {
                                                                        drSL3.Row["SO_HO"] = Convert.ToDecimal(drSL3.Row["SO_HO"]) - sohoTNT50;
                                                                    }
                                                                }

                                                            }

                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 >= sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                        if (ngay_dky < new DateTime(2014, 6, 1) && ngay_cky > new DateTime(2014, 6, 1))
                                                        {
                                                            //trước đã trừ số hộ nghèo, sau phải cộng lại
                                                            drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) + sohoTNT50;

                                                        }
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                                        {
                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }

                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                #endregion
                                            }
                                            else
                                            {
                                                //Không có đổi giá nhà nước, để như cũ
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));
                                                //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                //tính lại sản lượng tp theo tỷ lệ tổn thất
                                                slTP = slTP > 0 ? Math.Round(slTP * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_BT = slMDK_BT > 0 ? Math.Round(slMDK_BT * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_CD = slMDK_CD > 0 ? Math.Round(slMDK_CD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_TD = slMDK_TD > 0 ? Math.Round(slMDK_TD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                //if (Convert.ToDecimal(drSL3["SO_HO"]) <= sohoTNT50)
                                                //{
                                                //    slTNT50 = slBB - (slTP + slBN_BT + slBN_CD + slBN_TD + slMDK_BT + slMDK_CD + slMDK_TD);
                                                //}
                                                //Sau đợt đổi giá 01/06/2014 không còn hộ nghèo nữa
                                                slTNT50 = 0;
                                                slMDK = slTP + slBN_BT + slBN_CD + slBN_TD + slTNT50 + slMDK_BT + slMDK_CD + slMDK_TD;
                                                //drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                drSL3["SAN_LUONG"] = slBB - slMDK;
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                                if (drvDDK != null)
                                                    drSL3["BCS"] = drvDDK["BCS"];
                                                else
                                                {
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                }
                                                drSL3.Row["MA_NGIA"] = "A";
                                            }
                                        }
                                    }
                                    #endregion

                                    if (ky + thang * 10 + nam * 12 * 10 < 1 + 3 * 10 + 2010 * 12 * 10)
                                    {
                                        #region Tạo bản ghi các nhóm MDK, bơm, nghèo trước 01/03/2010
                                        //San luong ban buon muc dich khac
                                        if (slTP_T + slTP_S > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "K";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    drTP_New["MA_NGIA"] = "K";
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "K";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        //San luong bom nuoc
                                        if (slBN_BT > 0)
                                        {
                                            if (slBN_BT_T > 0 || slBN_BT_S > 0)
                                            {
                                                if (slBN_BT_T > 0)
                                                {
                                                    drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT["SAN_LUONG"] = slBN_BT_T;
                                                    drBN_BT["MA_NGIA"] = "A";
                                                    drBN_BT["MA_NHOMNN"] = "SXD1";
                                                    drBN_BT["BCS"] = "BT";
                                                    drBN_BT["MA_NN"] = "1100";
                                                    drBN_BT["NGAY_DAU"] = ngay_dky;
                                                    drBN_BT["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_BT_S > 0)
                                                {
                                                    DataRow drBN_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT_New["SAN_LUONG"] = slBN_BT_S;
                                                    drBN_BT_New["MA_NGIA"] = "A";
                                                    drBN_BT_New["MA_NHOMNN"] = "SXD1";
                                                    drBN_BT_New["BCS"] = "BT";
                                                    drBN_BT_New["MA_NN"] = "1100";
                                                    drBN_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                drBN_BT["SAN_LUONG"] = slBN_BT;
                                                drBN_BT["MA_NGIA"] = "A";
                                                drBN_BT["MA_NHOMNN"] = "SXD1";
                                                drBN_BT["BCS"] = "BT";
                                                drBN_BT["MA_NN"] = "1100";
                                                drBN_BT["NGAY_DAU"] = ngay_dky;
                                                drBN_BT["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slBN_CD > 0)
                                        {
                                            if (slBN_CD_T > 0 || slBN_CD_S > 0)
                                            {
                                                if (slBN_CD_T > 0)
                                                {
                                                    drBN_CD.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_CD["MA_NGIA"] = "A";
                                                    drBN_CD["MA_NHOMNN"] = "SXD1";
                                                    drBN_CD["BCS"] = "CD";
                                                    drBN_CD["MA_NN"] = "1100";
                                                    drBN_CD["SAN_LUONG"] = slBN_CD_T;
                                                    drBN_CD["NGAY_DAU"] = ngay_dky;
                                                    drBN_CD["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_CD_S > 0)
                                                {
                                                    DataRow drBN_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_CD_New["MA_NGIA"] = "A";
                                                    drBN_CD_New["MA_NHOMNN"] = "SXD1";
                                                    drBN_CD_New["BCS"] = "CD";
                                                    drBN_CD_New["MA_NN"] = "1100";
                                                    drBN_CD_New["SAN_LUONG"] = slBN_CD_S;
                                                    drBN_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_CD_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_CD_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_CD.ItemArray = drSL3.Row.ItemArray;
                                                drBN_CD["SAN_LUONG"] = slBN_CD;
                                                drBN_CD["MA_NGIA"] = "A";
                                                drBN_CD["MA_NHOMNN"] = "SXD1";
                                                drBN_CD["BCS"] = "CD";
                                                drBN_CD["MA_NN"] = "1100";
                                                drBN_CD["NGAY_DAU"] = ngay_dky;
                                                drBN_CD["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slBN_TD > 0)
                                        {
                                            if (slBN_TD_T > 0 || slBN_TD_S > 0)
                                            {
                                                if (slBN_TD_T > 0)
                                                {
                                                    drBN_TD.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_TD["MA_NGIA"] = "A";
                                                    drBN_TD["MA_NHOMNN"] = "SXD1";
                                                    drBN_TD["BCS"] = "TD";
                                                    drBN_TD["MA_NN"] = "1100";
                                                    drBN_TD["SAN_LUONG"] = slBN_TD_T;
                                                    drBN_TD["NGAY_DAU"] = ngay_dky;
                                                    drBN_TD["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_TD_S > 0)
                                                {
                                                    DataRow drBN_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_TD_New["MA_NGIA"] = "A";
                                                    drBN_TD_New["MA_NHOMNN"] = "SXD1";
                                                    drBN_TD_New["BCS"] = "TD";
                                                    drBN_TD_New["MA_NN"] = "1100";
                                                    drBN_TD_New["SAN_LUONG"] = slBN_TD_S;
                                                    drBN_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_TD_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_TD_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_TD.ItemArray = drSL3.Row.ItemArray;
                                                drBN_TD["SAN_LUONG"] = slBN_TD;
                                                drBN_TD["MA_NGIA"] = "A";
                                                drBN_TD["MA_NHOMNN"] = "SXD1";
                                                drBN_TD["BCS"] = "TD";
                                                drBN_TD["MA_NN"] = "1100";
                                                drBN_TD["NGAY_DAU"] = ngay_dky;
                                                drBN_TD["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Sau ky 1 thang 3 nam 2010
                                        //San luong ban buon muc dich khac
                                        //Kiểm soát trường hợp đã nhập sản lượng MDK thương phẩm thì bỏ qua MDK trong áp giá
                                        if (slTP_T + slTP_S > 0 || slTP > 0 || slMDK_BT_T + slMDK_BT_S > 0 || slMDK_CD_T + slMDK_CD_S > 0 || slMDK_TD_T + slMDK_TD_S > 0 || slMDK_BT > 0 || slMDK_CD > 0 || slMDK_TD > 0)
                                        {
                                            //Có sản lượng MDK trong GCS_SLMDK_SHBB
                                            //Duyệt bảng SL_3 loại bỏ các bản ghi áp giá MDK
                                            DataView dvXoaMDK = new DataView(dsCalculation.Tables["SL_3"]);
                                            dvXoaMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM') and MA_NGIA='K'";
                                            if (dvXoaMDK.Count > 0)
                                            {
                                                foreach (DataRowView drvTemp in dvXoaMDK)
                                                {
                                                    dsCalculation.Tables["SL_3"].Rows.Remove(drvTemp.Row);
                                                }
                                            }
                                            if (ngay_dky > new DateTime(2014, 6, 1))
                                            {
                                                dvXoaMDK.RowFilter = "";
                                                dvXoaMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN = 'SHBN'";
                                                if (dvXoaMDK.Count > 0)
                                                {
                                                    foreach (DataRowView drvTemp in dvXoaMDK)
                                                    {
                                                        dsCalculation.Tables["SL_3"].Rows.Remove(drvTemp.Row);
                                                    }
                                                }
                                            }

                                        }
                                        if (slTP_T + slTP_S > 0 || slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "K";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                    drTP["ID_CHISO"] = drvCCS == null ? drTP["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    drTP_New["MA_NGIA"] = "K";
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    drTP_New["ID_CHISO"] = drvDDK == null ? drTP_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "K";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                                drTP["ID_CHISO"] = drvDDK == null ? drTP["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        //San luong bom nuoc
                                        if (slBN_BT + slBN_CD + slBN_TD > 0)
                                        {
                                            if (slBN_BT_T > 0 || slBN_CD_T > 0 || slBN_TD_T > 0 || slBN_BT_S > 0 || slBN_CD_S > 0 || slBN_TD_S > 0)
                                            {
                                                if (slBN_BT_T > 0 || slBN_CD_T > 0 || slBN_TD_T > 0)
                                                {
                                                    drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT["SAN_LUONG"] = slBN_BT_T + slBN_CD_T + slBN_TD_T;
                                                    drBN_BT["MA_NGIA"] = "L";
                                                    drBN_BT["MA_NHOMNN"] = "SHBB";
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drBN_BT["BCS"] = "KT";
                                                    else
                                                        drBN_BT["BCS"] = "BT";
                                                    drBN_BT["MA_NN"] = "1100";
                                                    drBN_BT["NGAY_DAU"] = ngay_dky;
                                                    drBN_BT["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slBN_BT_S > 0 || slBN_CD_S > 0 || slBN_TD_S > 0)
                                                {
                                                    DataRow drBN_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drBN_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drBN_BT_New["SAN_LUONG"] = slBN_BT_S + slBN_CD_S + slBN_TD_S;
                                                    drBN_BT_New["MA_NGIA"] = "L";
                                                    drBN_BT_New["MA_NHOMNN"] = "SHBB";
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drBN_BT_New["BCS"] = "KT";
                                                    else
                                                        drBN_BT_New["BCS"] = "BT";
                                                    drBN_BT_New["MA_NN"] = "1100";
                                                    drBN_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drBN_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drBN_BT.ItemArray = drSL3.Row.ItemArray;
                                                drBN_BT["SAN_LUONG"] = slBN_BT + slBN_CD + slBN_TD;
                                                drBN_BT["MA_NGIA"] = "L";
                                                drBN_BT["MA_NHOMNN"] = "SHBB";
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                    drBN_BT["BCS"] = "KT";
                                                else
                                                    drBN_BT["BCS"] = "BT";
                                                drBN_BT["MA_NN"] = "1100";
                                                drBN_BT["NGAY_DAU"] = ngay_dky;
                                                drBN_BT["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        //San luong ban buon ho ngheo
                                        if (slTNT50_T + slTNT50_S > 0 || slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                    drTNT50["ID_CHISO"] = drvCCS == null ? drTNT50["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    drTNT50_New["ID_CHISO"] = drvDDK == null ? drTNT50_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                                drTNT50["ID_CHISO"] = drvDDK == null ? drTNT50["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slMDK_BT > 0)
                                        {
                                            if (slMDK_BT_T > 0 || slMDK_BT_S > 0)
                                            {
                                                if (slMDK_BT_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_BT["SAN_LUONG"] = slMDK_BT_T;
                                                    drMDK_BT["MA_NGIA"] = "K";
                                                    drMDK_BT["BCS"] = drvCCS == null ? drvDDK == null ? "BT" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_BT["TGIAN_BDIEN"] = "BT";
                                                    drMDK_BT["MA_NHOMNN"] = "SHTM";
                                                    drMDK_BT["NGAY_DAU"] = ngay_dky;
                                                    drMDK_BT["NGAY_CUOI"] = ngay_ccs;
                                                    drMDK_BT["ID_CHISO"] = drvCCS == null ? drMDK_BT["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slMDK_BT_S > 0)
                                                {
                                                    DataRow drMDK_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_BT_New["SAN_LUONG"] = slMDK_BT_S;
                                                    drMDK_BT_New["MA_NGIA"] = "K";
                                                    drMDK_BT_New["BCS"] = drvDDK == null ? drMDK_BT_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_BT_New["TGIAN_BDIEN"] = "BT";
                                                    drMDK_BT_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    drMDK_BT_New["ID_CHISO"] = drvDDK == null ? drMDK_BT_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_BT.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_BT["SAN_LUONG"] = slMDK_BT;
                                                drMDK_BT["MA_NGIA"] = "K";
                                                drMDK_BT["BCS"] = drvDDK == null ? drMDK_BT["BCS"] : drvDDK["BCS"];
                                                drMDK_BT["TGIAN_BDIEN"] = "BT";
                                                drMDK_BT["MA_NHOMNN"] = "SHTM";
                                                drMDK_BT["NGAY_DAU"] = ngay_dky;
                                                drMDK_BT["NGAY_CUOI"] = ngay_cky;
                                                drMDK_BT["ID_CHISO"] = drvDDK == null ? drMDK_BT["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slMDK_CD > 0)
                                        {
                                            if (slMDK_CD_T > 0 || slMDK_CD_S > 0)
                                            {
                                                if (slMDK_CD_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_CD.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_CD["SAN_LUONG"] = slMDK_CD_T;
                                                    drMDK_CD["MA_NGIA"] = "K";
                                                    drMDK_CD["BCS"] = drvCCS == null ? drvDDK == null ? "CD" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_CD["TGIAN_BDIEN"] = "CD";
                                                    drMDK_CD["MA_NHOMNN"] = "SHTM";
                                                    drMDK_CD["NGAY_DAU"] = ngay_dky;
                                                    drMDK_CD["NGAY_CUOI"] = ngay_ccs;
                                                    drMDK_CD["ID_CHISO"] = drvCCS == null ? drMDK_CD["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slMDK_CD_S > 0)
                                                {
                                                    DataRow drMDK_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_CD_New["SAN_LUONG"] = slMDK_CD_S;
                                                    drMDK_CD_New["MA_NGIA"] = "K";
                                                    drMDK_CD_New["BCS"] = drvDDK == null ? drMDK_CD_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_CD_New["TGIAN_BDIEN"] = "CD";
                                                    drMDK_CD_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_CD_New["NGAY_CUOI"] = ngay_cky;
                                                    drMDK_CD_New["ID_CHISO"] = drvDDK == null ? drMDK_CD_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_CD_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_CD.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_CD["SAN_LUONG"] = slMDK_CD;
                                                drMDK_CD["MA_NGIA"] = "K";
                                                drMDK_CD["BCS"] = drvDDK == null ? drMDK_CD["BCS"] : drvDDK["BCS"];
                                                drMDK_CD["TGIAN_BDIEN"] = "CD";
                                                drMDK_CD["MA_NHOMNN"] = "SHTM";
                                                drMDK_CD["NGAY_DAU"] = ngay_dky;
                                                drMDK_CD["NGAY_CUOI"] = ngay_cky;
                                                drMDK_CD["ID_CHISO"] = drvDDK == null ? drMDK_CD["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slMDK_TD > 0)
                                        {
                                            if (slMDK_TD_T > 0 || slMDK_TD_S > 0)
                                            {
                                                if (slMDK_TD_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_TD.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_TD["SAN_LUONG"] = slMDK_TD_T;
                                                    drMDK_TD["MA_NGIA"] = "K";
                                                    drMDK_TD["BCS"] = drvCCS == null ? drvDDK == null ? "TD" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_TD["TGIAN_BDIEN"] = "TD";
                                                    drMDK_TD["MA_NHOMNN"] = "SHTM";
                                                    drMDK_TD["NGAY_DAU"] = ngay_dky;
                                                    drMDK_TD["NGAY_CUOI"] = ngay_ccs;
                                                    drMDK_TD["ID_CHISO"] = drvCCS == null ? drMDK_TD["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slMDK_TD_S > 0)
                                                {
                                                    DataRow drMDK_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_TD_New["SAN_LUONG"] = slMDK_TD_S;
                                                    drMDK_TD_New["MA_NGIA"] = "K";
                                                    drMDK_TD_New["BCS"] = drvDDK == null ? drMDK_TD_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_TD_New["TGIAN_BDIEN"] = "TD";
                                                    drMDK_TD_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_TD_New["NGAY_CUOI"] = ngay_cky;
                                                    drMDK_TD_New["ID_CHISO"] = drvDDK == null ? drMDK_TD_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_TD_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_TD.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_TD["SAN_LUONG"] = slMDK_TD;
                                                drMDK_TD["MA_NGIA"] = "K";
                                                drMDK_TD["BCS"] = drvDDK == null ? drMDK_TD["BCS"] : drvDDK["BCS"];
                                                drMDK_TD["TGIAN_BDIEN"] = "TD";
                                                drMDK_TD["MA_NHOMNN"] = "SHTM";
                                                drMDK_TD["NGAY_DAU"] = ngay_dky;
                                                drMDK_TD["NGAY_CUOI"] = ngay_cky;
                                                drMDK_TD["ID_CHISO"] = drvDDK == null ? drMDK_TD["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                    }

                                }
                                #endregion
                            }
                            else if (strMa_NhomNNBB != "SHTM")
                            {
                                #region Xu ly voi SHBM, SHBN

                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                {
                                    if (IsChangePrice == 1)
                                    {
                                        //Bi phat, ton tai nhom F, gan toan bo san luong cua diem do theo nhom F
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        //drSL3["NGAY_CUOI"] = ngay_cky;
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBM' AND BCS IN ('KT','BT','CD','TD')"));
                                        drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND BCS = 'KT'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3.Row["MA_NGIA"] = "F";
                                        if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                        {
                                            if (IsBMtoTM == 1 && dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND BCS IN ('KT','BT','CD','TD')").Length > 0)
                                            {

                                                //Đổi từ SHBB,C,D,H,L sang SHBM, bóc tách theo BCS
                                                DateTime ngaydky_phat_new = ngay_ccs;//DateTime.Parse(Convert.ToDateTime(drSL3["NGAY_CUOI"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                #region SHTM-KT
                                                decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='KT'"));
                                                if (slBB_KT_1 > 0)
                                                {
                                                    DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_KT_New["SAN_LUONG"] = slBB_KT_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_KT_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_KT_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_KT_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_KT_New["MA_NGIA"] = "K";
                                                        drPhat_KT_New["BCS"] = "KT";
                                                        drPhat_KT_New["TGIAN_BDIEN"] = "BT";
                                                        drPhat_KT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_KT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);
                                                    }

                                                }
                                                #endregion
                                                #region SHTM-BT

                                                decimal slBB_BT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='BT'"));
                                                if (slBB_BT_1 > 0)
                                                {
                                                    DataRow drPhat_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_BT_New["SAN_LUONG"] = slBB_BT_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_BT_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_BT_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_BT_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_BT_New["MA_NGIA"] = "K";
                                                        drPhat_BT_New["BCS"] = "BT";
                                                        drPhat_BT_New["TGIAN_BDIEN"] = "BT";
                                                        drPhat_BT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_BT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_BT_New);
                                                    }

                                                }

                                                #endregion
                                                #region SHTM-CD

                                                decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                                if (slBB_CD_1 > 0)
                                                {
                                                    DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_CD_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_CD_New["MA_NGIA"] = "K";
                                                        drPhat_CD_New["BCS"] = "CD";
                                                        drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                        drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);
                                                    }

                                                }

                                                #endregion
                                                #region SHTM-TD

                                                decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                                if (slBB_TD_1 > 0)
                                                {
                                                    DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;
                                                    if (ngaydky_phat_new < ngay_cky)
                                                    {
                                                        drPhat_TD_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                        drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_TD_New["MA_NGIA"] = "K";
                                                        drPhat_TD_New["BCS"] = "TD";
                                                        drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                        drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);
                                                    }

                                                }

                                                #endregion
                                            }
                                            else
                                            {
                                                //Có đổi nhóm giá bán buôn khác, chỉ bị trong kỳ đổi giá
                                                slBB_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND BCS IN ('KT','BT','CD','TD')"));

                                                DataRow drPhat_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_New["SAN_LUONG"] = slBB_1;
                                                DateTime ngaydky_phat_new = ngay_ccs;//DateTime.Parse(Convert.ToDateTime(drSL3["NGAY_CUOI"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                                if (ngaydky_phat_new < ngay_cky)
                                                {
                                                    drPhat_New["NGAY_DAU"] = ngaydky_phat_new.AddDays(1.0);
                                                    drPhat_New["NGAY_CUOI"] = ngay_cky;
                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                    if (IsBMtoTM == 2)
                                                    {
                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                        if (drTemp != null && drTemp.Length > 0)
                                                        {
                                                            drPhat_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                            drPhat_New["MA_NGIA"] = "E";

                                                        }

                                                    }
                                                    else
                                                    {
                                                        //Cập nhật lại mã nhóm giá sau đổi giá phạt 

                                                        drPhat_New["MA_NGIA"] = "E";

                                                    }
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drPhat_New);
                                                }
                                            }
                                            drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                            drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                        }
                                        else
                                        {
                                            //Gán lại cho toàn bộ khoảng ngày
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                    }
                                    else
                                    {
                                        //Bi phat, ton tai nhom F, gan toan bo san luong cua diem do theo nhom F
                                        //Sổ ghi trùng ngày đổi giá, tính toàn bộ nhóm F SHBM
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        //drSL3["NGAY_CUOI"] = ngay_cky;
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                        drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND BCS = 'KT'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3.Row["MA_NGIA"] = "F";
                                        //Gán lại cho toàn bộ khoảng ngày
                                        drSL3["NGAY_CUOI"] = ngay_cky;
                                    }
                                }
                                //do sau 01/06/2014 không còn SHBM và SHBN nữa, nên không cần kiểm tra nhóm E với 2 biên bản này
                                //else if nhóm E
                                else
                                {
                                    //Khong ton tai nhom D, tinh theo san luong thuong pham
                                    //slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND BCS IN ('KT','BT','CD','TD')"));
                                    if (IsBMtoTM == 1)
                                    {
                                        if (IsExists_SLTPBB == 1)
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            //slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            //sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                        else
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                            slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slMDK_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            //slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            //sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));

                                        }
                                    }
                                    else if (IsBMtoTM == 2 || IsBMtoTM == 0)
                                    {
                                        if (IsExists_SLTPBB == 1)
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);

                                            slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = 0;
                                            slMDK_CD = 0;
                                            slMDK_TD = 0;
                                            slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                            slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                            //slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            //sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                        else
                                        {
                                            tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                            tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);

                                            slTP = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            slMDK_BT = 0;
                                            slMDK_CD = 0;
                                            slMDK_TD = 0;
                                            slBN_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                            slBN_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('CD')"));
                                            slBN_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_BNUOC)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')")) + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(BNUOC_TT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('TD')"));
                                            //slTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SLUONG_HNGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                            //sohoTNT50 = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(SHO_NGHEO)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        }
                                    }


                                    if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Co chot chi so trong GCS_CHISO
                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                        slBB = 0;
                                        slBB_1 = 0;
                                        //Tách riêng khoảng sản lượng CTT trước và sau khi đổi giá
                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        //Chưa tính tổn thất
                                        slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;

                                        if (slTP > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP - slTP_T;
                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        //Nội suy sản lượng
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                slTP_S = slTP - slTP_T;
                                            }
                                        }

                                        //Bổ sung tách sản lượng MDK_BT,CD,TD
                                        if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_T = 0;
                                                        slMDK_CD_T = 0;
                                                        slMDK_TD_T = 0;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_T = 0;
                                                        slMDK_CD_T = 0;
                                                        slMDK_TD_T = 0;
                                                    }
                                                }
                                                //slTP_S = slTP - slTP_T;
                                            }
                                        }
                                        //Tính lại sản lượng tp theo tỉ lệ tổn thất
                                        slTP_T = Math.Round(slTP_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                        slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                        //Đã tính tổn thất
                                        slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;

                                        sl_TruocChot = slTP_T;
                                        sl_SauChot = slMDK - sl_TruocChot;


                                        if (slBB > 0)
                                        {
                                            if (slBB > sl_TruocChot)
                                            {
                                                //Truoc doi gia nha nuoc
                                                drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;
                                                if (strMa_NhomNNBB == "SHBM")
                                                {
                                                    //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                    drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                }
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            if (slBB_1 > sl_SauChot)
                                            {
                                                //Sau doi gia nha nuoc
                                                drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                //if (ngay_dky < new DateTime(2014, 6, 1) && ngay_cky > new DateTime(2014, 6, 1))
                                                //{
                                                //    //trước đã trừ số hộ nghèo, sau phải cộng lại
                                                //    drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) + sohoTNT50;

                                                //}
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                                {
                                                    DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                    if (drTemp != null && drTemp.Length > 0)
                                                    {
                                                        drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                    }
                                                }
                                                dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                        drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                    }
                                    else
                                    {
                                        //22/12/2012
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                            {
                                                //Co chot chi so trong GCS_CHISO_GT
                                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                                slBB = 0;
                                                slBB_1 = 0;
                                                foreach (DataRowView dwrCCS in dwSL3)
                                                {
                                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                                    {
                                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                        {
                                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;
                                                if (slTP > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;

                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;


                                                    }
                                                }

                                                //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                        //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                        slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                            }
                                                            else
                                                            {
                                                                slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_T = 0;
                                                                slMDK_CD_T = 0;
                                                                slMDK_TD_T = 0;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                            }
                                                            else
                                                            {

                                                                slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_T = 0;
                                                                slMDK_CD_T = 0;
                                                                slMDK_TD_T = 0;
                                                            }
                                                        }
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                //Tính lại sản lượng tp theo tỉ lệ tổn thất

                                                slTP_T = Math.Round(slTP_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                                //Đã tính tổn thất
                                                slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;

                                                sl_TruocChot = slTP_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB > sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (strMa_NhomNNBB == "SHBM")
                                                        {
                                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 > sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                                        {
                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }
                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);

                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                                drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                            }
                                            else
                                            {
                                                #region GCS_CHISO_GT không chốt chỉ số
                                                //Khong chot chi so
                                                if (IsChangePrice == 1)
                                                {
                                                    #region Có đổi giá không chốt chỉ số
                                                    //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                                    decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slBB_1 = slBB - slbbTemp;
                                                    slBB = slbbTemp;


                                                    //Chưa tính tổn thất
                                                    slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;

                                                    //tách sản lượng mdk
                                                    if (slTP > 0)
                                                    {
                                                        //Do không chốt CCS nên luôn nội suy theo ngày
                                                        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTP_S = slTP - slTP_T;
                                                    }

                                                    //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                    if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                    {
                                                        //Luôn nội suy theo ngày
                                                        slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;

                                                    }
                                                    //Tính lại sản lượng tp theo tỉ lệ tổn thất


                                                    slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                    slTP_T = Math.Round((slTP > 0 ? slTP_T : (slMDK_BT_T + slMDK_CD_T + slMDK_TD_T)) * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                    slTP_S = slTP > 0 ? slTP_S : 0;
                                                    slMDK_BT_T = 0;
                                                    slMDK_CD_T = 0;
                                                    slMDK_TD_T = 0;
                                                    slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                                    //Đã tính tổn thất
                                                    slMDK = slTP_T + slTP_S + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S;
                                                    //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T

                                                    sl_TruocChot = slTP_T;
                                                    sl_SauChot = slMDK - sl_TruocChot;

                                                    if (slBB > 0)
                                                    {
                                                        if (slBB >= sl_TruocChot)
                                                        {
                                                            //Truoc doi gia nha nuoc
                                                            drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            drSL3["NGAY_DAU"] = ngay_dky;
                                                            drSL3["NGAY_CUOI"] = ngay_ccs;
                                                            if (strMa_NhomNNBB == "SHBM")
                                                            {
                                                                //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                                drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                            drSL3.Row["SAN_LUONG"] = 0;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                        }
                                                    }
                                                    if (slBB_1 > 0)
                                                    {
                                                        if (slBB_1 >= sl_SauChot)
                                                        {
                                                            //Sau doi gia nha nuoc
                                                            drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                            drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                            drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                                            {
                                                                DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                                if (drTemp != null && drTemp.Length > 0)
                                                                {
                                                                    drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                    drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                                }
                                                            }
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                        }
                                                        else
                                                        {
                                                            //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                            drSL3.Row["SAN_LUONG"] = 0;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                        }
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    //Không có đổi giá nhà nước, để như cũ, sẽ ko nhảy vào đây do nhóm này hết HL
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));
                                                    //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                    //tính lại sản lượng tp theo tỷ lệ tổn thất
                                                    slTP = slTP > 0 ? Math.Round(slTP * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_BT = slMDK_BT > 0 ? Math.Round(slMDK_BT * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_CD = slMDK_CD > 0 ? Math.Round(slMDK_CD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_TD = slMDK_TD > 0 ? Math.Round(slMDK_TD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;


                                                    //Sau đợt đổi giá 01/06/2014 không còn hộ nghèo nữa
                                                    slTNT50 = 0;
                                                    slMDK = slTP + slMDK_BT + slMDK_CD + slMDK_TD;
                                                    //drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                    drSL3["SAN_LUONG"] = slBB - slMDK;
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                                    if (drvDDK != null)
                                                        drSL3["BCS"] = drvDDK["BCS"];
                                                    else
                                                    {
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                    }
                                                    drSL3.Row["MA_NGIA"] = "A";
                                                }
                                                #endregion

                                            }
                                        }
                                        else
                                        {
                                            #region GCS_CHISO không chốt chỉ số
                                            //Khong chot chi so
                                            if (IsChangePrice == 1)
                                            {
                                                #region Có đổi giá không chốt chỉ số
                                                //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                                decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBB_1 = slBB - slbbTemp;
                                                slBB = slbbTemp;


                                                //Chưa tính tổn thất
                                                slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;

                                                //tách sản lượng mdk
                                                if (slTP > 0)
                                                {
                                                    //Do không chốt CCS nên luôn nội suy theo ngày
                                                    slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slTP_S = slTP - slTP_T;
                                                }

                                                //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                {
                                                    //Luôn nội suy theo ngày
                                                    slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                    slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                    slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_TD_S = slMDK_TD - slMDK_TD_T;

                                                }

                                                //Tính lại sản lượng tp theo tỉ lệ tổn thất

                                                slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slTP_T = Math.Round((slTP > 0 ? slTP_T : (slMDK_BT_T + slMDK_CD_T + slMDK_TD_T)) * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP > 0 ? slTP_S : 0;
                                                slMDK_BT_T = 0;
                                                slMDK_CD_T = 0;
                                                slMDK_TD_T = 0;
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                                //Đã tính tổn thất
                                                slMDK = slTP_T + slTP_S + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S;
                                                //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T

                                                sl_TruocChot = slTP_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB >= sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (strMa_NhomNNBB == "SHBM")
                                                        {
                                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 >= sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                                        {
                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }
                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                #endregion
                                            }
                                            else
                                            {
                                                //Không có đổi giá nhà nước, để như cũ, sẽ ko nhảy vào đây do nhóm này hết HL
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));
                                                //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                //tính lại sản lượng tp theo tỷ lệ tổn thất

                                                slTP = slTP > 0 ? Math.Round(slTP * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_BT = slMDK_BT > 0 ? Math.Round(slMDK_BT * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_CD = slMDK_CD > 0 ? Math.Round(slMDK_CD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_TD = slMDK_TD > 0 ? Math.Round(slMDK_TD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;

                                                //Sau đợt đổi giá 01/06/2014 không còn hộ nghèo nữa
                                                slTNT50 = 0;
                                                slMDK = slTP + slMDK_BT + slMDK_CD + slMDK_TD;
                                                //drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                drSL3["SAN_LUONG"] = slBB - slMDK;
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                                if (drvDDK != null)
                                                    drSL3["BCS"] = drvDDK["BCS"];
                                                else
                                                {
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                }
                                                drSL3.Row["MA_NGIA"] = "A";
                                            }
                                            #endregion
                                        }
                                    }
                                    //

                                    if (ky + thang * 10 + nam * 12 * 10 < 1 + 3 * 10 + 2010 * 12 * 10)
                                    {
                                        //San luong ban buon muc dich khac
                                        #region Trước 01/03/2014


                                        if (slTP_T + slTP_S > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "A";
                                                    drTP["MA_NHOMNN"] = "SHBN";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                    drTP["ID_CHISO"] = drvCCS == null ? drTP["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    if (IsBMtoTM == 1)
                                                    {
                                                        drTP_New["MA_NGIA"] = "K";
                                                        drTP_New["MA_NHOMNN"] = "SHTM";

                                                    }
                                                    else
                                                    {
                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                        drTP_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drTP_New["MA_NGIA"] = "K";
                                                    }
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "A";
                                                drTP["MA_NHOMNN"] = "SHBN";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slTNT50_T + slTNT50_S > 0 || slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                    drTNT50["ID_CHISO"] = drvCCS == null ? drTNT50["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Sau ky 1 thang 3 nam 2010                                       
                                        //San luong ban buon muc dich khac
                                        //Kiểm soát trường hợp đã nhập sản lượng MDK thương phẩm thì bỏ qua MDK trong áp giá
                                        if (slTP_T + slTP_S > 0 || slTP > 0 || slMDK_BT_T + slMDK_BT_S > 0 || slMDK_CD_T + slMDK_CD_S > 0 || slMDK_TD_T + slMDK_TD_S > 0 || slMDK_BT > 0 || slMDK_CD > 0 || slMDK_TD > 0)
                                        {
                                            //Duyệt bảng SL_3 loại bỏ các bản ghi áp giá MDK
                                            DataView dvXoaMDK = new DataView(dsCalculation.Tables["SL_3"]);
                                            dvXoaMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM') and MA_NGIA='K'";
                                            if (dvXoaMDK.Count > 0)
                                            {
                                                foreach (DataRowView drvTemp in dvXoaMDK)
                                                {
                                                    dsCalculation.Tables["SL_3"].Rows.Remove(drvTemp.Row);
                                                }
                                            }
                                            if (ngay_dky > new DateTime(2014, 6, 1))
                                            {
                                                dvXoaMDK.RowFilter = "";
                                                dvXoaMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN = 'SHBN'";
                                                if (dvXoaMDK.Count > 0)
                                                {
                                                    foreach (DataRowView drvTemp in dvXoaMDK)
                                                    {
                                                        dsCalculation.Tables["SL_3"].Rows.Remove(drvTemp.Row);
                                                    }
                                                }
                                            }
                                        }
                                        if (slTP_T + slTP_S > 0 || slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "A";
                                                    drTP["MA_NHOMNN"] = "SHBN";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                    drTP["ID_CHISO"] = drvCCS == null ? drTP["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    if (IsBMtoTM == 1)
                                                    {
                                                        drTP_New["MA_NGIA"] = "K";
                                                        drTP_New["MA_NHOMNN"] = "SHTM";

                                                    }
                                                    else
                                                    {
                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                        drTP_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drTP_New["MA_NGIA"] = "K";
                                                    }
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    drTP_New["ID_CHISO"] = drvDDK == null ? drTP_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP == 0 ? slTP_T + slTP_S : slTP;
                                                drTP["MA_NGIA"] = "A";
                                                drTP["MA_NHOMNN"] = "SHBN";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                                drTP["ID_CHISO"] = drvDDK == null ? drTP["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slTNT50_T + slTNT50_S > 0 || slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                    drTNT50["ID_CHISO"] = drvCCS == null ? drTNT50["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    drTNT50_New["ID_CHISO"] = drvDDK == null ? drTNT50_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                                drTNT50["ID_CHISO"] = drvDDK == null ? drTNT50["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slMDK_BT > 0)
                                        {
                                            if (slMDK_BT_T > 0 || slMDK_BT_S > 0)
                                            {
                                                if (slMDK_BT_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_BT["SAN_LUONG"] = slMDK_BT_T;
                                                    drMDK_BT["MA_NGIA"] = "K";
                                                    drMDK_BT["BCS"] = drvCCS == null ? drvDDK == null ? "BT" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_BT["TGIAN_BDIEN"] = "BT";
                                                    drMDK_BT["MA_NHOMNN"] = "SHTM";
                                                    drMDK_BT["NGAY_DAU"] = ngay_dky;
                                                    drMDK_BT["NGAY_CUOI"] = ngay_ccs;
                                                    drMDK_BT["ID_CHISO"] = drvCCS == null ? drMDK_BT["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slMDK_BT_S > 0)
                                                {
                                                    DataRow drMDK_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_BT_New["SAN_LUONG"] = slMDK_BT_S;
                                                    drMDK_BT_New["MA_NGIA"] = "K";
                                                    drMDK_BT_New["BCS"] = drvDDK == null ? drMDK_BT_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_BT_New["TGIAN_BDIEN"] = "BT";
                                                    drMDK_BT_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    drMDK_BT_New["ID_CHISO"] = drvDDK == null ? drMDK_BT_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_BT.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_BT["SAN_LUONG"] = slMDK_BT;
                                                drMDK_BT["MA_NGIA"] = "K";
                                                drMDK_BT["BCS"] = drvDDK == null ? drMDK_BT["BCS"] : drvDDK["BCS"];
                                                drMDK_BT["TGIAN_BDIEN"] = "BT";
                                                drMDK_BT["MA_NHOMNN"] = "SHTM";
                                                drMDK_BT["NGAY_DAU"] = ngay_dky;
                                                drMDK_BT["NGAY_CUOI"] = ngay_cky;
                                                drMDK_BT["ID_CHISO"] = drvDDK == null ? drMDK_BT["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slMDK_CD > 0)
                                        {
                                            if (slMDK_CD_T > 0 || slMDK_CD_S > 0)
                                            {
                                                if (slMDK_CD_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_CD.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_CD["SAN_LUONG"] = slMDK_CD_T;
                                                    drMDK_CD["MA_NGIA"] = "K";
                                                    drMDK_CD["BCS"] = drvCCS == null ? drvDDK == null ? "CD" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_CD["TGIAN_BDIEN"] = "CD";
                                                    drMDK_CD["MA_NHOMNN"] = "SHTM";
                                                    drMDK_CD["NGAY_DAU"] = ngay_dky;
                                                    drMDK_CD["NGAY_CUOI"] = ngay_ccs;
                                                    drMDK_CD["ID_CHISO"] = drvCCS == null ? drMDK_CD["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slMDK_CD_S > 0)
                                                {
                                                    DataRow drMDK_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_CD_New["SAN_LUONG"] = slMDK_CD_S;
                                                    drMDK_CD_New["MA_NGIA"] = "K";
                                                    drMDK_CD_New["BCS"] = drvDDK == null ? drMDK_CD_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_CD_New["TGIAN_BDIEN"] = "CD";
                                                    drMDK_CD_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_CD_New["NGAY_CUOI"] = ngay_cky;
                                                    drMDK_CD_New["ID_CHISO"] = drvDDK == null ? drMDK_CD_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_CD_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_CD.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_CD["SAN_LUONG"] = slMDK_CD;
                                                drMDK_CD["MA_NGIA"] = "K";
                                                drMDK_CD["BCS"] = drvDDK == null ? drMDK_CD["BCS"] : drvDDK["BCS"];
                                                drMDK_CD["TGIAN_BDIEN"] = "CD";
                                                drMDK_CD["MA_NHOMNN"] = "SHTM";
                                                drMDK_CD["NGAY_DAU"] = ngay_dky;
                                                drMDK_CD["NGAY_CUOI"] = ngay_cky;
                                                drMDK_CD["ID_CHISO"] = drvDDK == null ? drMDK_CD["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                        if (slMDK_TD > 0)
                                        {
                                            if (slMDK_TD_T > 0 || slMDK_TD_S > 0)
                                            {
                                                if (slMDK_TD_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_TD.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_TD["SAN_LUONG"] = slMDK_TD_T;
                                                    drMDK_TD["MA_NGIA"] = "K";
                                                    drMDK_TD["BCS"] = drvCCS == null ? drvDDK == null ? "TD" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_TD["TGIAN_BDIEN"] = "TD";
                                                    drMDK_TD["MA_NHOMNN"] = "SHTM";
                                                    drMDK_TD["NGAY_DAU"] = ngay_dky;
                                                    drMDK_TD["NGAY_CUOI"] = ngay_ccs;
                                                    drMDK_TD["ID_CHISO"] = drvCCS == null ? drMDK_TD["ID_CHISO"] : drvCCS["ID_CHISO"];
                                                }
                                                if (slMDK_TD_S > 0)
                                                {
                                                    DataRow drMDK_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_TD_New["SAN_LUONG"] = slMDK_TD_S;
                                                    drMDK_TD_New["MA_NGIA"] = "K";
                                                    drMDK_TD_New["BCS"] = drvDDK == null ? drMDK_TD_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_TD_New["TGIAN_BDIEN"] = "TD";
                                                    drMDK_TD_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_TD_New["NGAY_CUOI"] = ngay_cky;
                                                    drMDK_TD_New["ID_CHISO"] = drvDDK == null ? drMDK_TD_New["ID_CHISO"] : drvDDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_TD_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_TD.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_TD["SAN_LUONG"] = slMDK_TD;
                                                drMDK_TD["MA_NGIA"] = "K";
                                                drMDK_TD["BCS"] = drvDDK == null ? drMDK_TD["BCS"] : drvDDK["BCS"];
                                                drMDK_TD["TGIAN_BDIEN"] = "TD";
                                                drMDK_TD["MA_NHOMNN"] = "SHTM";
                                                drMDK_TD["NGAY_DAU"] = ngay_dky;
                                                drMDK_TD["NGAY_CUOI"] = ngay_cky;
                                                drMDK_TD["ID_CHISO"] = drvDDK == null ? drMDK_TD["ID_CHISO"] : drvDDK["ID_CHISO"];
                                            }
                                        }
                                    }
                                }
                                #endregion
                            }
                            else
                            {
                                #region Xu ly voi SHTM

                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHTM') AND MA_NGIA = 'K'").Length != 0)
                                {
                                    //Xử lý với nhóm phạt SHTM

                                    #region SHTM-BT

                                    //Bi phat, ton tai nhom K, gan toan bo san luong cua diem do theo nhom K
                                    drSL3["NGAY_DAU"] = ngay_dky;
                                    //drSL3["NGAY_CUOI"] = ngay_cky;
                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHTM' AND BCS IN ('BT','KT')"));
                                    drSL3.Row["SAN_LUONG"] = slBB;
                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHTM') AND BCS = 'KT'").Length != 0)
                                        drSL3.Row["BCS"] = "KT";
                                    else
                                        drSL3.Row["BCS"] = "KT";
                                    drSL3.Row["BCS"] = (drv_CD_DDK == null && drv_TD_DDK == null) ? drv_BT_DDK == null ? "KT" : drv_BT_DDK["BCS"] : "BT";
                                    drSL3.Row["MA_NGIA"] = "K";
                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                    drSL3["TGIAN_BDIEN"] = "BT";
                                    drSL3["ID_CHISO"] = drv_BT_DDK == null ? drSL3["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                    #endregion
                                    #region SHTM-CD

                                    decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                    if (slBB_CD_1 > 0)
                                    {
                                        DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                        drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                        drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                        drPhat_CD_New["NGAY_DAU"] = ngay_dky;
                                        drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                        drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                        drPhat_CD_New["MA_NGIA"] = "K";
                                        drPhat_CD_New["BCS"] = (drv_CD_DDK == null && drv_TD_DDK == null) ? drv_BT_DDK == null ? "KT" : drv_BT_DDK["BCS"] : "CD";
                                        drPhat_CD_New["BCS"] = drvDDK == null ? (drv_CD_DDK == null ? "CD" : drv_CD_DDK["BCS"]) : drvDDK["BCS"];
                                        drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                        drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drv_BT_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);


                                    }

                                    #endregion
                                    #region SHTM-TD

                                    decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                    if (slBB_TD_1 > 0)
                                    {
                                        DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                        drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                        drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;
                                        drPhat_TD_New["NGAY_DAU"] = ngay_dky;
                                        drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                        drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                        drPhat_TD_New["MA_NGIA"] = "K";
                                        drPhat_TD_New["BCS"] = (drv_CD_DDK == null && drv_TD_DDK == null) ? drv_BT_DDK == null ? "KT" : drv_BT_DDK["BCS"] : "TD";
                                        drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                        drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drv_BT_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];

                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                    }

                                    #endregion

                                }
                                else
                                {
                                    //Khong ton tai nhom E, tinh theo san luong thuong pham
                                    //slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND BCS IN ('KT','BT','CD','TD')"));

                                    if (IsExists_SLTPBB == 1)
                                    {
                                        tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                        tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                        slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slMDK_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                        slMDK_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                        slMDK_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));

                                    }
                                    else
                                    {
                                        tonthat_cu = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK_CU"]);
                                        tonthat_moi = 1 + CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')")[0]["TLETT_MDK"]);
                                        slTP = 0;// CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam));
                                        slMDK_BT = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                        slMDK_CD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));
                                        slMDK_TD = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " AND LOAI_BCS IN ('BT','KT')"));


                                    }



                                    if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Chưa xử lý do SHTM là nhóm mới chưa đổi giá nhà nước
                                        //Co chot chi so trong GCS_CHISO
                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                        slBB = 0;
                                        slBB_1 = 0;
                                        //Tách riêng khoảng sản lượng CTT trước và sau khi đổi giá
                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        //Chưa tính tổn thất
                                        slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;

                                        if (slTP > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP - slTP_T;
                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        //Nội suy sản lượng
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                    else
                                                    {
                                                        slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                slTP_S = slTP - slTP_T;
                                            }
                                        }

                                        //Bổ sung tách sản lượng MDK_BT,CD,TD
                                        if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                        {
                                            if (slBB + slBB_1 == 0)
                                            {
                                                //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                            }
                                            else
                                            {
                                                if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_T = 0;
                                                        slMDK_CD_T = 0;
                                                        slMDK_TD_T = 0;
                                                    }
                                                }
                                                else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                {
                                                    DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                    dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                    if (dvMDK.Count > 0)
                                                    {
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                        dvMDK.RowFilter = "";
                                                        dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                        if (dvMDK.Count > 0)
                                                            slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {

                                                        slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                        slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                        slMDK_BT_T = 0;
                                                        slMDK_CD_T = 0;
                                                        slMDK_TD_T = 0;
                                                    }
                                                }
                                                //slTP_S = slTP - slTP_T;
                                            }
                                        }
                                        //Tính lại sản lượng tp theo tỉ lệ tổn thất
                                        slTP_T = Math.Round(slTP_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                        slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                        slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                        //Đã tính tổn thất
                                        slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;

                                        sl_TruocChot = slTP_T;
                                        sl_SauChot = slMDK - sl_TruocChot;


                                        if (slBB > 0)
                                        {
                                            if (slBB > sl_TruocChot)
                                            {
                                                //Truoc doi gia nha nuoc
                                                drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;
                                                if (strMa_NhomNNBB == "SHBM")
                                                {
                                                    //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                    drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                }
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            if (slBB_1 > sl_SauChot)
                                            {
                                                //Sau doi gia nha nuoc
                                                drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                //if (ngay_dky < new DateTime(2014, 6, 1) && ngay_cky > new DateTime(2014, 6, 1))
                                                //{
                                                //    //trước đã trừ số hộ nghèo, sau phải cộng lại
                                                //    drCCS_New["SO_HO"] = Convert.ToDecimal(drCCS_New["SO_HO"]) + sohoTNT50;

                                                //}
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                                {
                                                    DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                    if (drTemp != null && drTemp.Length > 0)
                                                    {
                                                        drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                    }
                                                }
                                                dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //22/12/2012
                                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                        {
                                            if (IsChangePrice == 1 && dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                            {
                                                //Chưa xử lý do SHTM là nhóm mới chưa đổi giá nhà nước
                                                //Co chot chi so trong GCS_CHISO_GT
                                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                                slBB = 0;
                                                slBB_1 = 0;
                                                foreach (DataRowView dwrCCS in dwSL3)
                                                {
                                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                                    {
                                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                        {
                                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                                {
                                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;
                                                if (slTP > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;

                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CCS is not null";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                slTP_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CCS is not null"));
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                            else
                                                            {
                                                                slTP_T = Math.Round(slTP * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                //slTP_S = slTP - slTP_T;
                                                            }
                                                        }
                                                        slTP_S = slTP - slTP_T;


                                                    }
                                                }

                                                //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                {
                                                    if (slBB + slBB_1 == 0)
                                                    {
                                                        //Có chốt chỉ số CCS nhưng sản lượng = 0
                                                        //Neu san luong cong to tong = 0 thi tinh MDK theo ti le ngay
                                                        slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                    }
                                                    else
                                                    {
                                                        if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB") && dsCustomerData.Tables["GCS_SLMDK_SHBB"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                            }
                                                            else
                                                            {
                                                                slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_T = 0;
                                                                slMDK_CD_T = 0;
                                                                slMDK_TD_T = 0;
                                                            }
                                                        }
                                                        else if (dsCustomerData.Tables.Contains("GCS_SLMDK_SHBB_GT") && dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Rows.Count > 0)
                                                        {
                                                            DataView dvMDK = new DataView(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"]);
                                                            dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and (MDK_BT_CCS is not null or MDK_CD_CCS is not null or MDK_TD_CCS is not null)";
                                                            if (dvMDK.Count > 0)
                                                            {
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_BT_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_BT_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_BT_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_BT_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_CD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_CD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_CD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_CD_CCS is not null"));
                                                                dvMDK.RowFilter = "";
                                                                dvMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MDK_TD_CCS is not null";
                                                                if (dvMDK.Count > 0)
                                                                    slMDK_TD_T = CMISLibrary.Utility.DecimalDbnull(dsCustomerData.Tables["GCS_SLMDK_SHBB_GT"].Compute("SUM(MDK_TD_CCS)", "MA_DDO = '" + strMa_DDo + "' AND KY = " + ky + " AND THANG = " + thang + " AND NAM = " + nam + " and MDK_TD_CCS is not null"));

                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                            }
                                                            else
                                                            {

                                                                slMDK_BT_T = Math.Round(slMDK_BT * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_CD_T = Math.Round(slMDK_CD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_TD_T = Math.Round(slMDK_TD * slBB / (slBB + slBB_1), 0, MidpointRounding.AwayFromZero);
                                                                slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                                slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                                slMDK_TD_S = slMDK_TD - slMDK_TD_T;
                                                                slTP_T = slMDK_BT_T + slMDK_CD_T + slMDK_TD_T;
                                                                slMDK_BT_T = 0;
                                                                slMDK_CD_T = 0;
                                                                slMDK_TD_T = 0;
                                                            }
                                                        }
                                                        //slTP_S = slTP - slTP_T;
                                                    }
                                                }
                                                //Tính lại sản lượng tp theo tỉ lệ tổn thất

                                                slTP_T = Math.Round(slTP_T * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                                //Đã tính tổn thất
                                                slMDK = slTP_T + slTP_S + slBN_BT + slBN_CD + slBN_TD + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S + slTNT50;

                                                sl_TruocChot = slTP_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB > sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (strMa_NhomNNBB == "SHBM")
                                                        {
                                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 > sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        if (IsBMtoTM == 1 || IsBMtoTM == 2)
                                                        {
                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }
                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);

                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                #region GCS_CHISO_GT không chốt chỉ số
                                                //Khong chot chi so
                                                if (IsChangePrice == 1)
                                                {
                                                    //Chưa xử lý do SHTM là nhóm mới chưa đổi giá nhà nước
                                                    #region Có đổi giá không chốt chỉ số
                                                    //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                                    decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slBB_1 = slBB - slbbTemp;
                                                    slBB = slbbTemp;


                                                    //Chưa tính tổn thất
                                                    slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;

                                                    //tách sản lượng mdk
                                                    if (slTP > 0)
                                                    {
                                                        //Do không chốt CCS nên luôn nội suy theo ngày
                                                        slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slTP_S = slTP - slTP_T;
                                                    }

                                                    //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                    if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                    {
                                                        //Luôn nội suy theo ngày
                                                        slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                        slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                        slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                        slMDK_TD_S = slMDK_TD - slMDK_TD_T;

                                                    }
                                                    //Tính lại sản lượng tp theo tỉ lệ tổn thất


                                                    slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);

                                                    slTP_T = Math.Round((slTP > 0 ? slTP_T : (slMDK_BT_T + slMDK_CD_T + slMDK_TD_T)) * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                    slTP_S = slTP > 0 ? slTP_S : 0;
                                                    slMDK_BT_T = 0;
                                                    slMDK_CD_T = 0;
                                                    slMDK_TD_T = 0;
                                                    slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                    slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                                    //Đã tính tổn thất
                                                    slMDK = slTP_T + slTP_S + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S;
                                                    //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T

                                                    sl_TruocChot = slTP_T;
                                                    sl_SauChot = slMDK - sl_TruocChot;

                                                    if (slBB > 0)
                                                    {
                                                        if (slBB >= sl_TruocChot)
                                                        {
                                                            //Truoc doi gia nha nuoc
                                                            drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            drSL3["NGAY_DAU"] = ngay_dky;
                                                            drSL3["NGAY_CUOI"] = ngay_ccs;
                                                            if (strMa_NhomNNBB == "SHBM")
                                                            {
                                                                //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                                drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                            drSL3.Row["SAN_LUONG"] = 0;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                        }
                                                    }
                                                    if (slBB_1 > 0)
                                                    {
                                                        if (slBB_1 >= sl_SauChot)
                                                        {
                                                            //Sau doi gia nha nuoc
                                                            drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                            drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                            drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                                            {
                                                                DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                                if (drTemp != null && drTemp.Length > 0)
                                                                {
                                                                    drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                    drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                                }
                                                            }
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                        }
                                                        else
                                                        {
                                                            //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                            drSL3.Row["SAN_LUONG"] = 0;
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                                drSL3.Row["BCS"] = "KT";
                                                            else
                                                                drSL3.Row["BCS"] = "BT";
                                                            WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                        }
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    //Không có đổi giá nhà nước, 
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));
                                                    //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                    //tính lại sản lượng tp theo tỷ lệ tổn thất
                                                    slTP = 0;// slTP > 0 ? Math.Round(slTP * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_BT = slMDK_BT > 0 ? Math.Round(slMDK_BT * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_CD = slMDK_CD > 0 ? Math.Round(slMDK_CD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                    slMDK_TD = slMDK_TD > 0 ? Math.Round(slMDK_TD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;


                                                    //Sau đợt đổi giá 01/06/2014 không còn hộ nghèo nữa
                                                    slTNT50 = 0;
                                                    slMDK = slTP + slMDK_BT + slMDK_CD + slMDK_TD;
                                                    //drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                    drSL3["SAN_LUONG"] = slBB - slMDK;
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                                    if (drvDDK != null)
                                                        drSL3.Row["BCS"] = drvDDK["BCS"];
                                                    else
                                                    {
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                    }
                                                    drSL3.Row["MA_NGIA"] = "A";
                                                }
                                                #endregion

                                            }
                                        }
                                        else
                                        {
                                            #region GCS_CHISO không chốt chỉ số
                                            //Khong chot chi so
                                            if (IsChangePrice == 1)
                                            {
                                                //Chưa xử lý do SHTM là nhóm mới chưa đổi giá nhà nước
                                                #region Có đổi giá không chốt chỉ số
                                                //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                                decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                slBB_1 = slBB - slbbTemp;
                                                slBB = slbbTemp;


                                                //Chưa tính tổn thất
                                                slMDK = slTP + slMDK_TD + slMDK_CD + slMDK_BT;

                                                //tách sản lượng mdk
                                                if (slTP > 0)
                                                {
                                                    //Do không chốt CCS nên luôn nội suy theo ngày
                                                    slTP_T = Math.Round(slTP * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slTP_S = slTP - slTP_T;
                                                }

                                                //Bổ sung tách sản lượng MDK_BT,CD,TD
                                                if (slMDK_BT + slMDK_CD + slMDK_TD > 0)
                                                {
                                                    //Luôn nội suy theo ngày
                                                    slMDK_BT_T = Math.Round(slMDK_BT * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_BT_S = slMDK_BT - slMDK_BT_T;
                                                    slMDK_CD_T = Math.Round(slMDK_CD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_CD_S = slMDK_CD - slMDK_CD_T;
                                                    slMDK_TD_T = Math.Round(slMDK_TD * Convert.ToDecimal(ngay_ccs.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                                    slMDK_TD_S = slMDK_TD - slMDK_TD_T;

                                                }

                                                //Tính lại sản lượng tp theo tỉ lệ tổn thất

                                                slTP_S = Math.Round(slTP_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slTP_T = Math.Round((slTP > 0 ? slTP_T : (slMDK_BT_T + slMDK_CD_T + slMDK_TD_T)) * tonthat_cu, 0, MidpointRounding.AwayFromZero);
                                                slTP_S = slTP > 0 ? slTP_S : 0;
                                                slMDK_BT_T = 0;
                                                slMDK_CD_T = 0;
                                                slMDK_TD_T = 0;
                                                slMDK_BT_S = Math.Round(slMDK_BT_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_CD_S = Math.Round(slMDK_CD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);
                                                slMDK_TD_S = Math.Round(slMDK_TD_S * tonthat_moi, 0, MidpointRounding.AwayFromZero);


                                                //Đã tính tổn thất
                                                slMDK = slTP_T + slTP_S + slMDK_TD_S + slMDK_CD_S + slMDK_BT_S;
                                                //Lần đổi giá sau 01/06/2014 sẽ phải thay slTP_T = tổng slMDK_TD_T+slMDK_CD_T+slMDK_BT_T

                                                sl_TruocChot = slTP_T;
                                                sl_SauChot = slMDK - sl_TruocChot;

                                                if (slBB > 0)
                                                {
                                                    if (slBB >= sl_TruocChot)
                                                    {
                                                        //Truoc doi gia nha nuoc
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                                        if (strMa_NhomNNBB == "SHBM")
                                                        {
                                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                if (slBB_1 > 0)
                                                {
                                                    if (slBB_1 >= sl_SauChot)
                                                    {
                                                        //Sau doi gia nha nuoc
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        if (IsBBtoTM == 1 || IsBBtoTM == 2)
                                                        {
                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }
                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                    }
                                                    else
                                                    {
                                                        //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                        drSL3.Row["SAN_LUONG"] = 0;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                    }
                                                }
                                                #endregion
                                            }
                                            else
                                            {
                                                //Không có đổi giá nhà nước
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));
                                                //Xu ly rieng trong truong hop so ho ngheo = so ho sau cong to tong
                                                //tính lại sản lượng tp theo tỷ lệ tổn thất

                                                slTP = 0;// slTP > 0 ? Math.Round(slTP * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_BT = slMDK_BT > 0 ? Math.Round(slMDK_BT * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_CD = slMDK_CD > 0 ? Math.Round(slMDK_CD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;
                                                slMDK_TD = slMDK_TD > 0 ? Math.Round(slMDK_TD * tonthat_moi, 0, MidpointRounding.AwayFromZero) : 0;

                                                //Sau đợt đổi giá 01/06/2014 không còn hộ nghèo nữa
                                                slTNT50 = 0;
                                                slMDK = slTP + slMDK_BT + slMDK_CD + slMDK_TD;
                                                //drSL3["SO_HO"] = Convert.ToDecimal(drSL3["SO_HO"]) - sohoTNT50;
                                                drSL3["SAN_LUONG"] = slBB - slMDK;
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                                if (drvDDK != null)
                                                    drSL3.Row["BCS"] = drvDDK["BCS"];
                                                else
                                                {
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND BCS = 'KT'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                }
                                                drSL3.Row["MA_NGIA"] = "A";
                                            }
                                            #endregion
                                        }
                                    }
                                    //

                                    if (ky + thang * 10 + nam * 12 * 10 < 1 + 3 * 10 + 2010 * 12 * 10)
                                    {
                                        //San luong ban buon muc dich khac
                                        #region Trước 01/03/2014


                                        if (slTP_T + slTP_S > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "A";
                                                    drTP["MA_NHOMNN"] = "SHBN";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    if (IsBMtoTM == 1)
                                                    {
                                                        drTP_New["MA_NGIA"] = "K";
                                                        drTP_New["MA_NHOMNN"] = "SHTM";

                                                    }
                                                    else
                                                    {
                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                        drTP_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drTP_New["MA_NGIA"] = "K";
                                                    }
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP;
                                                drTP["MA_NGIA"] = "A";
                                                drTP["MA_NHOMNN"] = "SHBN";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slTNT50_T + slTNT50_S > 0 || slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Sau ky 1 thang 3 nam 2010                                       
                                        //San luong ban buon muc dich khac
                                        //Kiểm soát trường hợp đã nhập sản lượng MDK thương phẩm thì bỏ qua MDK trong áp giá
                                        if (slTP_T + slTP_S > 0 || slTP > 0 || slMDK_BT_T + slMDK_BT_S > 0 || slMDK_CD_T + slMDK_CD_S > 0 || slMDK_TD_T + slMDK_TD_S > 0 || slMDK_BT > 0 || slMDK_CD > 0 || slMDK_TD > 0)
                                        {
                                            //Duyệt bảng SL_3 loại bỏ các bản ghi áp giá MDK
                                            DataView dvXoaMDK = new DataView(dsCalculation.Tables["SL_3"]);
                                            dvXoaMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM') and MA_NGIA='K'";
                                            if (dvXoaMDK.Count > 0)
                                            {
                                                foreach (DataRowView drvTemp in dvXoaMDK)
                                                {
                                                    dsCalculation.Tables["SL_3"].Rows.Remove(drvTemp.Row);
                                                }
                                            }
                                            if (ngay_dky > new DateTime(2014, 6, 1))
                                            {
                                                dvXoaMDK.RowFilter = "";
                                                dvXoaMDK.RowFilter = "MA_DDO = '" + strMa_DDo + "' and MA_NHOMNN = 'SHBN'";
                                                if (dvXoaMDK.Count > 0)
                                                {
                                                    foreach (DataRowView drvTemp in dvXoaMDK)
                                                    {
                                                        dsCalculation.Tables["SL_3"].Rows.Remove(drvTemp.Row);
                                                    }
                                                }
                                            }
                                        }

                                        if (slTP_T + slTP_S > 0 || slTP > 0)
                                        {
                                            if (slTP_T > 0 || slTP_S > 0)
                                            {
                                                if (slTP_T > 0)
                                                {
                                                    drTP.ItemArray = drSL3.Row.ItemArray;
                                                    drTP["SAN_LUONG"] = slTP_T;
                                                    drTP["MA_NGIA"] = "A";
                                                    drTP["MA_NHOMNN"] = "SHBN";
                                                    drTP["NGAY_DAU"] = ngay_dky;
                                                    drTP["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTP_S > 0)
                                                {
                                                    DataRow drTP_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTP_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTP_New["SAN_LUONG"] = slTP_S;
                                                    if (IsBMtoTM == 1)
                                                    {
                                                        drTP_New["MA_NGIA"] = "K";
                                                        drTP_New["MA_NHOMNN"] = "SHTM";

                                                    }
                                                    else
                                                    {
                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNN + "'");
                                                        drTP_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drTP_New["MA_NGIA"] = "K";
                                                    }
                                                    drTP_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTP_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP_New);
                                                }
                                            }
                                            else
                                            {
                                                drTP.ItemArray = drSL3.Row.ItemArray;
                                                drTP["SAN_LUONG"] = slTP_T + slTP_S;
                                                drTP["MA_NGIA"] = "A";
                                                drTP["MA_NHOMNN"] = "SHBN";
                                                drTP["NGAY_DAU"] = ngay_dky;
                                                drTP["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slTNT50_T + slTNT50_S > 0 || slTNT50 > 0)
                                        {
                                            if (slTNT50_T > 0 || slTNT50_S > 0)
                                            {
                                                if (slTNT50_T > 0)
                                                {
                                                    drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50["SAN_LUONG"] = slTNT50_T;
                                                    drTNT50["MA_NGIA"] = "N";
                                                    drTNT50["SO_HO"] = sohoTNT50;
                                                    drTNT50["NGAY_DAU"] = ngay_dky;
                                                    drTNT50["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slTNT50_S > 0)
                                                {
                                                    DataRow drTNT50_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drTNT50_New.ItemArray = drSL3.Row.ItemArray;
                                                    drTNT50_New["SAN_LUONG"] = slTNT50_S;
                                                    drTNT50_New["MA_NGIA"] = "N";
                                                    drTNT50_New["SO_HO"] = sohoTNT50;
                                                    drTNT50_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drTNT50_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50_New);
                                                }
                                            }
                                            else
                                            {
                                                drTNT50.ItemArray = drSL3.Row.ItemArray;
                                                drTNT50["SAN_LUONG"] = slTNT50;
                                                drTNT50["MA_NGIA"] = "N";
                                                drTNT50["SO_HO"] = sohoTNT50;
                                                drTNT50["NGAY_DAU"] = ngay_dky;
                                                drTNT50["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slMDK_BT > 0)
                                        {
                                            if (slMDK_BT_T > 0 || slMDK_BT_S > 0)
                                            {
                                                if (slMDK_BT_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_BT.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_BT["SAN_LUONG"] = slMDK_BT_T;
                                                    drMDK_BT["MA_NGIA"] = "K";
                                                    drMDK_BT["BCS"] = drvCCS == null ? drvDDK == null ? "BT" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_BT["TGIAN_BDIEN"] = "BT";
                                                    drMDK_BT["MA_NHOMNN"] = "SHTM";
                                                    drMDK_BT["NGAY_DAU"] = ngay_dky;
                                                    drMDK_BT["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slMDK_BT_S > 0)
                                                {
                                                    DataRow drMDK_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_BT_New["SAN_LUONG"] = slMDK_BT_S;
                                                    drMDK_BT_New["MA_NGIA"] = "K";
                                                    drMDK_BT_New["BCS"] = drvDDK == null ? drMDK_BT_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_BT_New["TGIAN_BDIEN"] = "BT";
                                                    drMDK_BT_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_BT_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_BT_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_BT.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_BT["SAN_LUONG"] = slMDK_BT;
                                                drMDK_BT["MA_NGIA"] = "K";
                                                drMDK_BT["BCS"] = drvDDK == null ? drMDK_BT["BCS"] : drvDDK["BCS"];
                                                drMDK_BT["TGIAN_BDIEN"] = "BT";
                                                drMDK_BT["MA_NHOMNN"] = "SHTM";
                                                drMDK_BT["NGAY_DAU"] = ngay_dky;
                                                drMDK_BT["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slMDK_CD > 0)
                                        {
                                            if (slMDK_CD_T > 0 || slMDK_CD_S > 0)
                                            {
                                                if (slMDK_CD_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_CD.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_CD["SAN_LUONG"] = slMDK_CD_T;
                                                    drMDK_CD["MA_NGIA"] = "K";
                                                    drMDK_CD["BCS"] = drvCCS == null ? drvDDK == null ? "CD" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_CD["TGIAN_BDIEN"] = "CD";
                                                    drMDK_CD["MA_NHOMNN"] = "SHTM";
                                                    drMDK_CD["NGAY_DAU"] = ngay_dky;
                                                    drMDK_CD["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slMDK_CD_S > 0)
                                                {
                                                    DataRow drMDK_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_CD_New["SAN_LUONG"] = slMDK_CD_S;
                                                    drMDK_CD_New["MA_NGIA"] = "K";
                                                    drMDK_CD_New["BCS"] = drvDDK == null ? drMDK_CD_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_CD_New["TGIAN_BDIEN"] = "CD";
                                                    drMDK_CD_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_CD_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_CD_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_CD.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_CD["SAN_LUONG"] = slMDK_CD;
                                                drMDK_CD["MA_NGIA"] = "K";
                                                drMDK_CD["BCS"] = drvDDK == null ? drMDK_CD["BCS"] : drvDDK["BCS"];
                                                drMDK_CD["TGIAN_BDIEN"] = "CD";
                                                drMDK_CD["MA_NHOMNN"] = "SHTM";
                                                drMDK_CD["NGAY_DAU"] = ngay_dky;
                                                drMDK_CD["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                        if (slMDK_TD > 0)
                                        {
                                            if (slMDK_TD_T > 0 || slMDK_TD_S > 0)
                                            {
                                                if (slMDK_TD_T > 0 && ngay_dky > new DateTime(2014, 6, 1))
                                                {
                                                    drMDK_TD.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_TD["SAN_LUONG"] = slMDK_TD_T;
                                                    drMDK_TD["MA_NGIA"] = "K";
                                                    drMDK_TD["BCS"] = drvCCS == null ? drvDDK == null ? "TD" : drvDDK["BCS"] : drvCCS["BCS"];
                                                    drMDK_TD["TGIAN_BDIEN"] = "TD";
                                                    drMDK_TD["MA_NHOMNN"] = "SHTM";
                                                    drMDK_TD["NGAY_DAU"] = ngay_dky;
                                                    drMDK_TD["NGAY_CUOI"] = ngay_ccs;
                                                }
                                                if (slMDK_TD_S > 0)
                                                {
                                                    DataRow drMDK_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drMDK_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drMDK_TD_New["SAN_LUONG"] = slMDK_TD_S;
                                                    drMDK_TD_New["MA_NGIA"] = "K";
                                                    drMDK_TD_New["BCS"] = drvDDK == null ? drMDK_TD_New["BCS"] : drvDDK["BCS"];
                                                    drMDK_TD_New["TGIAN_BDIEN"] = "TD";
                                                    drMDK_TD_New["MA_NHOMNN"] = "SHTM";
                                                    drMDK_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1);
                                                    drMDK_TD_New["NGAY_CUOI"] = ngay_cky;
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_TD_New);
                                                }
                                            }
                                            else
                                            {
                                                drMDK_TD.ItemArray = drSL3.Row.ItemArray;
                                                drMDK_TD["SAN_LUONG"] = slMDK_TD;
                                                drMDK_TD["MA_NGIA"] = "K";
                                                drMDK_TD["BCS"] = drvDDK == null ? drMDK_TD["BCS"] : drvDDK["BCS"];
                                                drMDK_TD["TGIAN_BDIEN"] = "TD";
                                                drMDK_TD["MA_NHOMNN"] = "SHTM";
                                                drMDK_TD["NGAY_DAU"] = ngay_dky;
                                                drMDK_TD["NGAY_CUOI"] = ngay_cky;
                                            }
                                        }
                                    }
                                }
                                #endregion
                            }
                            //Cap nhat drTP, drBN_BT, drBN_CD, drBN_TD vao dsCalculation.Tables["SL_3"]

                            if (drMDK_BT != null)
                            {
                                if (Convert.ToString(drMDK_BT["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_BT);
                                }
                            }
                            if (drMDK_CD != null)
                            {
                                if (Convert.ToString(drMDK_CD["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_CD);
                                }
                            }
                            if (drMDK_TD != null)
                            {
                                if (Convert.ToString(drMDK_TD["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drMDK_TD);
                                }
                            }
                            if (drTP != null)
                            {
                                if (Convert.ToString(drTP["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drTP);
                                }
                            }
                            if (drBN_BT != null)
                            {
                                if (Convert.ToString(drBN_BT["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_BT);
                                }
                            }
                            if (drBN_CD != null)
                            {
                                if (Convert.ToString(drBN_CD["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_CD);
                                }
                            }
                            if (drBN_TD != null)
                            {
                                if (Convert.ToString(drBN_TD["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drBN_TD);
                                }
                            }
                            if (drTNT50 != null)
                            {
                                if (Convert.ToString(drTNT50["MA_DDO"]) == strMa_DDo)
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Add(drTNT50);
                                }
                            }
                            #endregion
                        }
                        else
                        {
                            #region Khong ton tai du lieu trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT


                            //Kiem tra xem co chot chi so doi gia nha nuoc hay khong, neu co thi tinh theo chi so chot


                            if (dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                            {

                                //Co chot chi so trong GCS_CHISO
                                ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                slBB = 0;
                                slBB_1 = 0;


                                foreach (DataRowView dwrCCS in dwSL3)
                                {
                                    if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                    {
                                        if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                        {
                                            if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                            {
                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                {
                                                    slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                }
                                            }
                                            else
                                            {
                                                //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                {
                                                    slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                }
                                            }
                                        }
                                    }
                                }

                                if (slBB > 0)
                                {
                                    //Truoc doi gia nha nuoc
                                    //Kiểm tra trường hợp áp giá phạt
                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                    {
                                        //Có gia phạt
                                        drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM') AND BCS = 'KT'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                        if (strMa_NhomNNBB == "SHBM")
                                        {
                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                            drSL3["MA_NGIA"] = "F";
                                        }
                                        drSL3["MA_NGIA"] = "D";
                                    }
                                    else
                                    {
                                        drSL3.Row["SAN_LUONG"] = slBB;
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                            drSL3.Row["BCS"] = "KT";
                                        else
                                            drSL3.Row["BCS"] = "BT";
                                        drSL3["NGAY_DAU"] = ngay_dky;
                                        drSL3["NGAY_CUOI"] = ngay_ccs;
                                        if (strMa_NhomNNBB == "SHBM")
                                        {
                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                        }
                                    }
                                }
                                if (slBB_1 > 0)
                                {
                                    //Sau doi gia nha nuoc
                                    if (IsBMtoTM == 1 || IsBBtoTM == 1)
                                    {

                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                        {
                                            //Bóc tách phần sau đổi giá theo 3 BCS của SHTM trường hợp áp giá phạt
                                            #region SHTM-KT

                                            decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='KT'"));
                                            if (slBB_KT_1 > 0)
                                            {
                                                DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_KT_New["SAN_LUONG"] = slBB_KT_1;
                                                drPhat_KT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drPhat_KT_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drPhat_KT_New["MA_NHOMNN"] = "SHTM";
                                                drPhat_KT_New["MA_NGIA"] = "K";
                                                drPhat_KT_New["BCS"] = "KT";
                                                drPhat_KT_New["TGIAN_BDIEN"] = "BT";
                                                drPhat_KT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_KT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);


                                            }

                                            #endregion
                                            #region SHTM-BT

                                            decimal slBB_BT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='BT'"));
                                            if (slBB_BT_1 > 0)
                                            {
                                                DataRow drPhat_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_BT_New["SAN_LUONG"] = slBB_BT_1;
                                                drPhat_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drPhat_BT_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drPhat_BT_New["MA_NHOMNN"] = "SHTM";
                                                drPhat_BT_New["MA_NGIA"] = "K";
                                                drPhat_BT_New["BCS"] = "BT";
                                                drPhat_BT_New["TGIAN_BDIEN"] = "BT";
                                                drPhat_BT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_BT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_BT_New);


                                            }

                                            #endregion
                                            #region SHTM-CD

                                            decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                            if (slBB_CD_1 > 0)
                                            {
                                                DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                                drPhat_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                drPhat_CD_New["MA_NGIA"] = "K";
                                                drPhat_CD_New["BCS"] = "CD";
                                                drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);

                                            }

                                            #endregion
                                            #region SHTM-TD

                                            decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                            if (slBB_TD_1 > 0)
                                            {
                                                DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;

                                                drPhat_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                drPhat_TD_New["MA_NGIA"] = "K";
                                                drPhat_TD_New["BCS"] = "TD";
                                                drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                            }

                                            #endregion
                                        }
                                        else
                                        {
                                            drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                            drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                            drCCS_New["SAN_LUONG"] = slBB_1;
                                            drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                            drCCS_New["NGAY_CUOI"] = ngay_cky;
                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi nhóm giá NN
                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                            if (drTemp != null && drTemp.Length > 0)
                                            {
                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                            }
                                            //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                            {
                                                drCCS_New["MA_NGIA"] = "E";
                                            }
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                            {
                                                drCCS_New["MA_NGIA"] = "E";
                                            }
                                            //và hộ nghèo
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                            {
                                                drCCS_New["MA_NGIA"] = "A";
                                            }
                                            dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                        }
                                    }
                                    else
                                    {

                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                        drCCS_New["SAN_LUONG"] = slBB_1;
                                        drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                        drCCS_New["NGAY_CUOI"] = ngay_cky;
                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi nhóm giá NN
                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                        if (drTemp != null && drTemp.Length > 0)
                                        {
                                            drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                            drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                        }
                                        //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                        {
                                            drCCS_New["MA_NGIA"] = "E";
                                        }
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                        {
                                            drCCS_New["MA_NGIA"] = "E";
                                        }
                                        //và hộ nghèo
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                        {
                                            drCCS_New["MA_NGIA"] = "A";
                                        }
                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                    }
                                }
                                drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                            }

                            else
                            {
                                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                {
                                    if (dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'").Length != 0)
                                    {
                                        //Co chot chi so trong GCS_CHISO_GT
                                        ngay_ccs = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "' AND LOAI_CHISO = 'CCS'"));
                                        slBB = 0;
                                        slBB_1 = 0;
                                        foreach (DataRowView dwrCCS in dwSL3)
                                        {
                                            if (dwrCCS["MA_NHOMNN"].ToString().Trim() != "SHBN")
                                            {
                                                if (dwrCCS["MA_DDO"].ToString().Trim() == strMa_DDo)
                                                {
                                                    if (ngay_ccs >= Convert.ToDateTime(dwrCCS["NGAY_CUOI"]))
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB = slBB + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //if (Convert.ToString(dwrCCS["MA_NGIA"]) == "A" && Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        if (Convert.ToString("|KT|BT|CD|TD|").IndexOf(Convert.ToString(dwrCCS["BCS"])) > 0)
                                                        {
                                                            slBB_1 = slBB_1 + Convert.ToDecimal(dwrCCS["SAN_LUONG"]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        if (slBB > 0)
                                        {
                                            //Truoc doi gia nha nuoc
                                            //Kiểm tra trường hợp áp giá phạt
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                            {
                                                //Có gia phạt
                                                drSL3.Row["SAN_LUONG"] = slBB;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;
                                                if (strMa_NhomNNBB == "SHBM")
                                                {
                                                    //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                    drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                    drSL3["MA_NGIA"] = "F";
                                                }
                                                drSL3["MA_NGIA"] = "D";
                                            }
                                            else
                                            {
                                                drSL3.Row["SAN_LUONG"] = slBB;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_ccs;
                                                if (strMa_NhomNNBB == "SHBM")
                                                {
                                                    //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                    drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                }
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            //Sau doi gia nha nuoc
                                            if (IsBMtoTM == 1 || IsBBtoTM == 1)
                                            {

                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                                {
                                                    //Bóc tách phần sau đổi giá theo 3 BCS của SHTM trường hợp áp giá phạt
                                                    #region SHTM-KT

                                                    decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='KT'"));
                                                    if (slBB_KT_1 > 0)
                                                    {
                                                        DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                        drPhat_KT_New["SAN_LUONG"] = slBB_KT_1;
                                                        drPhat_KT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drPhat_KT_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_KT_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_KT_New["MA_NGIA"] = "K";
                                                        drPhat_KT_New["BCS"] = "KT";
                                                        drPhat_KT_New["TGIAN_BDIEN"] = "BT";
                                                        drPhat_KT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_KT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);


                                                    }

                                                    #endregion
                                                    #region SHTM-BT

                                                    decimal slBB_BT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='BT'"));
                                                    if (slBB_BT_1 > 0)
                                                    {
                                                        DataRow drPhat_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drPhat_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                        drPhat_BT_New["SAN_LUONG"] = slBB_BT_1;
                                                        drPhat_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drPhat_BT_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_BT_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_BT_New["MA_NGIA"] = "K";
                                                        drPhat_BT_New["BCS"] = "BT";
                                                        drPhat_BT_New["TGIAN_BDIEN"] = "BT";
                                                        drPhat_BT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_BT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_BT_New);


                                                    }

                                                    #endregion
                                                    #region SHTM-CD

                                                    decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                                    if (slBB_CD_1 > 0)
                                                    {
                                                        DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                        drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                                        drPhat_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_CD_New["MA_NGIA"] = "K";
                                                        drPhat_CD_New["BCS"] = "CD";
                                                        drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                        drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);

                                                    }

                                                    #endregion
                                                    #region SHTM-TD

                                                    decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                                    if (slBB_TD_1 > 0)
                                                    {
                                                        DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                        drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;

                                                        drPhat_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                        drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                        drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                        drPhat_TD_New["MA_NGIA"] = "K";
                                                        drPhat_TD_New["BCS"] = "TD";
                                                        drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                        drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                                    }

                                                    #endregion
                                                }
                                                else
                                                {
                                                    drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                    drCCS_New["SAN_LUONG"] = slBB_1;
                                                    drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                    drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi nhóm giá NN
                                                    DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                    if (drTemp != null && drTemp.Length > 0)
                                                    {
                                                        drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                    }
                                                    //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                                    {
                                                        drCCS_New["MA_NGIA"] = "E";
                                                    }
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                                    {
                                                        drCCS_New["MA_NGIA"] = "E";
                                                    }
                                                    //và hộ nghèo
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                                    {
                                                        drCCS_New["MA_NGIA"] = "A";
                                                    }
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                }
                                            }
                                            else
                                            {
                                                drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                drCCS_New["SAN_LUONG"] = slBB_1;
                                                drCCS_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                drCCS_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN

                                                DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                if (drTemp != null && drTemp.Length > 0)
                                                {
                                                    drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                    drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                }
                                                //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                                {
                                                    drCCS_New["MA_NGIA"] = "E";
                                                }
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                                {
                                                    drCCS_New["MA_NGIA"] = "E";
                                                }
                                                //và hộ nghèo
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                                {
                                                    drCCS_New["MA_NGIA"] = "A";
                                                }
                                                dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                            }
                                        }
                                        drSL3["BCS"] = drvCCS == null ? drSL3["BCS"] : drvCCS["BCS"];
                                        drSL3["ID_CHISO"] = drvCCS == null ? drSL3["ID_CHISO"] : drvCCS["ID_CHISO"];
                                    }
                                    else
                                    {

                                        #region Không chốt chỉ số và không có trong GCS_SLMDK_SHBB
                                        //Kiểm tra xem có đổi giá không

                                        //DateTime ngay_cuoi = DateTime.Parse(Convert.ToDateTime(drSL3["NGAY_CUOI"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                        if (IsChangePrice == 1)
                                        {
                                            ngay_cuoi = ngay_ccs;
                                            //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                            decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                            slBB_1 = slBB - slbbTemp;
                                            slBB = slbbTemp;
                                            sl_TruocChot = 0;
                                            sl_SauChot = 0;
                                            if (slBB > 0)
                                            {
                                                if (slBB >= sl_TruocChot)
                                                {
                                                    //Truoc doi gia nha nuoc
                                                    //Kiểm tra trường hợp áp giá phạt
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                                    {
                                                        //Có gia phạt
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' ").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_cuoi;
                                                        if (strMa_NhomNNBB == "SHBM")
                                                        {
                                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                            drSL3["MA_NGIA"] = "F";
                                                        }
                                                        drSL3["MA_NGIA"] = "D";
                                                    }
                                                    else
                                                    {
                                                        drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_cuoi;
                                                        if (strMa_NhomNNBB == "SHBM")
                                                        {
                                                            //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                            drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                    drSL3.Row["SAN_LUONG"] = 0;
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                    WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                }
                                            }
                                            if (slBB_1 > 0)
                                            {
                                                if (slBB_1 >= sl_SauChot)
                                                {
                                                    //Sau doi gia nha nuoc
                                                    if (IsBMtoTM == 1 || IsBBtoTM == 1)
                                                    {

                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                                        {
                                                            //Bóc tách phần sau đổi giá theo 3 BCS của SHTM trường hợp áp giá phạt
                                                            #region SHTM-KT

                                                            decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='KT'"));
                                                            if (slBB_KT_1 > 0)
                                                            {
                                                                DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                                drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                                drPhat_KT_New["SAN_LUONG"] = slBB_KT_1;
                                                                drPhat_KT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                                drPhat_KT_New["NGAY_CUOI"] = ngay_cky;
                                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                                drPhat_KT_New["MA_NHOMNN"] = "SHTM";
                                                                drPhat_KT_New["MA_NGIA"] = "K";
                                                                drPhat_KT_New["BCS"] = "KT";
                                                                drPhat_KT_New["TGIAN_BDIEN"] = "BT";
                                                                drPhat_KT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_KT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);


                                                            }

                                                            #endregion
                                                            #region SHTM-BT

                                                            decimal slBB_BT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='BT'"));
                                                            if (slBB_BT_1 > 0)
                                                            {
                                                                DataRow drPhat_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                                drPhat_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                                drPhat_BT_New["SAN_LUONG"] = slBB_BT_1;
                                                                drPhat_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                                drPhat_BT_New["NGAY_CUOI"] = ngay_cky;
                                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                                drPhat_BT_New["MA_NHOMNN"] = "SHTM";
                                                                drPhat_BT_New["MA_NGIA"] = "K";
                                                                drPhat_BT_New["BCS"] = "BT";
                                                                drPhat_BT_New["TGIAN_BDIEN"] = "BT";
                                                                drPhat_BT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_BT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_BT_New);


                                                            }

                                                            #endregion
                                                            #region SHTM-CD

                                                            decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                                            if (slBB_CD_1 > 0)
                                                            {
                                                                DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                                drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                                drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                                                drPhat_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                                drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                                drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                                drPhat_CD_New["MA_NGIA"] = "K";
                                                                drPhat_CD_New["BCS"] = "CD";
                                                                drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                                drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);

                                                            }

                                                            #endregion
                                                            #region SHTM-TD

                                                            decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                                            if (slBB_TD_1 > 0)
                                                            {
                                                                DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                                drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                                drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;

                                                                drPhat_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                                drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                                drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                                drPhat_TD_New["MA_NGIA"] = "K";
                                                                drPhat_TD_New["BCS"] = "TD";
                                                                drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                                drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                                            }

                                                            #endregion
                                                        }
                                                        else
                                                        {
                                                            //Không phải phạt
                                                            drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                            drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                            drCCS_New["NGAY_DAU"] = ngay_cuoi.AddDays(1.0);
                                                            drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN

                                                            DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                            if (drTemp != null && drTemp.Length > 0)
                                                            {
                                                                drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                                drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                            }
                                                            //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                                            {
                                                                drCCS_New["MA_NGIA"] = "E";
                                                            }
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                                            {
                                                                drCCS_New["MA_NGIA"] = "E";
                                                            }
                                                            //và hộ nghèo
                                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                                            {
                                                                drCCS_New["MA_NGIA"] = "A";
                                                            }
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //Không phải chuyển sang SHTM
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_cuoi.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN

                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                        if (drTemp != null && drTemp.Length > 0)
                                                        {
                                                            drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                            drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                        }
                                                        //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                                        {
                                                            drCCS_New["MA_NGIA"] = "E";
                                                        }
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                                        {
                                                            drCCS_New["MA_NGIA"] = "E";
                                                        }
                                                        //và hộ nghèo
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                                        {
                                                            drCCS_New["MA_NGIA"] = "A";
                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                    }
                                                }
                                                else
                                                {
                                                    //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                    drSL3.Row["SAN_LUONG"] = 0;
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                    WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //Bổ sung xử lý nhóm giá phạt trong trường hợp không đổi giá nhà nước
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                            {
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                //drSL3["NGAY_CUOI"] = ngay_cky;
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                                drSL3.Row["SAN_LUONG"] = slBB;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3.Row["MA_NGIA"] = "D";
                                                //Gán lại cho toàn bộ khoảng ngày
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                            }
                                            else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                            {
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                //drSL3["NGAY_CUOI"] = ngay_cky;
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                                drSL3.Row["SAN_LUONG"] = slBB;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3.Row["MA_NGIA"] = "F";
                                                //Gán lại cho toàn bộ khoảng ngày
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                            }
                                            else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'E'").Length != 0)
                                            {
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                //drSL3["NGAY_CUOI"] = ngay_cky;
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                                drSL3.Row["SAN_LUONG"] = slBB;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3.Row["MA_NGIA"] = "E";
                                                //Gán lại cho toàn bộ khoảng ngày
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                            }
                                            else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHTM') AND MA_NGIA = 'K'").Length != 0)
                                            {
                                                //Bóc tách phần sau đổi giá theo 3 BCS của SHTM trường hợp áp giá phạt
                                                #region SHTM-KT

                                                decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS in ('KT','BT')"));
                                                if (slBB_KT_1 > 0)
                                                {
                                                    //DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    //drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                    drSL3["SAN_LUONG"] = slBB_KT_1;
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                    drSL3["MA_NHOMNN"] = "SHTM";
                                                    drSL3["MA_NGIA"] = "K";
                                                    //Chuẩn hóa lại BCS
                                                    drSL3["BCS"] = drv_BT_DDK == null ? drSL3["BCS"] : drv_BT_DDK["BCS"];
                                                    drSL3["TGIAN_BDIEN"] = "BT";
                                                    drSL3["ID_CHISO"] = drv_BT_DDK == null ? drSL3["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                    //if (drSL3["MA_NHOMNN"].ToString().Trim() == "SHTM" && drSL3["MA_NGIA"].ToString().Trim() == "K" && drSL3["TGIAN_BDIEN"].ToString().Trim() == "BT" )
                                                    //dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);


                                                }

                                                #endregion

                                                #region SHTM-CD

                                                decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                                if (slBB_CD_1 > 0)
                                                {
                                                    DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                                    drPhat_CD_New["NGAY_DAU"] = ngay_dky;
                                                    drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                    drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                    drPhat_CD_New["MA_NGIA"] = "K";
                                                    drPhat_CD_New["BCS"] = "CD";
                                                    drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                    drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);

                                                }

                                                #endregion
                                                #region SHTM-TD

                                                decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                                if (slBB_TD_1 > 0)
                                                {
                                                    DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                    drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;

                                                    drPhat_TD_New["NGAY_DAU"] = ngay_dky;
                                                    drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                    drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                    drPhat_TD_New["MA_NGIA"] = "K";
                                                    drPhat_TD_New["BCS"] = "TD";
                                                    drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                    drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                                }

                                                #endregion

                                            }
                                            else
                                            {
                                                //Để như cũ
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'A'"));
                                                if (slBB > 0)
                                                {
                                                    //Co san luong ban buon nhom A
                                                    drSL3.Row["SAN_LUONG"] = slBB;
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                                }
                                                else
                                                {
                                                    slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'N'"));
                                                    if (slBB > 0)
                                                    {
                                                        //Co san luong ban buon nhom N
                                                        drSL3.Row["SAN_LUONG"] = slBB;
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'N'").Length != 0)
                                                            drSL3.Row["BCS"] = "KT";
                                                        else
                                                            drSL3.Row["BCS"] = "BT";
                                                        drSL3["NGAY_DAU"] = ngay_dky;
                                                        drSL3["NGAY_CUOI"] = ngay_cky;
                                                    }
                                                }
                                            }
                                        }
                                        #endregion


                                    }
                                }
                                else
                                {
                                    #region Không chốt chỉ số và không có trong GCS_SLMDK_SHBB
                                    //Kiểm tra xem có đổi giá không
                                    //DateTime ngay_cuoi = DateTime.Parse(Convert.ToDateTime(drSL3["NGAY_CUOI"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                    if (IsChangePrice == 1)
                                    {
                                        //Có đổi giá nội suy theo ngày luôn không để đến 41 nữa
                                        ngay_cuoi = ngay_ccs;
                                        slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD')"));

                                        decimal slbbTemp = Math.Round(slBB * Convert.ToDecimal(ngay_cuoi.Subtract(ngay_dky).TotalDays + 1) / Convert.ToDecimal(ngay_cky.Subtract(ngay_dky).TotalDays + 1), 0, MidpointRounding.AwayFromZero);
                                        slBB_1 = slBB - slbbTemp;
                                        slBB = slbbTemp;
                                        sl_TruocChot = 0;
                                        sl_SauChot = 0;
                                        if (slBB > 0)
                                        {
                                            if (slBB >= sl_TruocChot)
                                            {
                                                //Truoc doi gia nha nuoc
                                                //Kiểm tra trường hợp áp giá phạt
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                                {
                                                    //Có gia phạt
                                                    drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cuoi;
                                                    if (strMa_NhomNNBB == "SHBM")
                                                    {
                                                        //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                        drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                        drSL3["MA_NGIA"] = "F";
                                                    }
                                                    drSL3["MA_NGIA"] = "D";
                                                }
                                                else
                                                {
                                                    drSL3.Row["SAN_LUONG"] = slBB - sl_TruocChot;
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cuoi;
                                                    if (strMa_NhomNNBB == "SHBM")
                                                    {
                                                        //Trường hợp SHBM, số hộ trước đổi giá =0, gán lại = số hộ sau đổi giá, không tính hộ nghèo
                                                        drSL3["SO_HO"] = dsCalculation.Tables["SL_3"].Compute("MAX(SO_HO)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN','SHTM')");
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                        if (slBB_1 > 0)
                                        {
                                            if (slBB_1 >= sl_SauChot)
                                            {
                                                //Sau doi gia nha nuoc
                                                if (IsBMtoTM == 1 || IsBBtoTM == 1)
                                                {

                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0 || dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                                    {
                                                        //Bóc tách phần sau đổi giá theo 3 BCS của SHTM trường hợp áp giá phạt
                                                        #region SHTM-KT

                                                        decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='KT'"));
                                                        if (slBB_KT_1 > 0)
                                                        {
                                                            DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                            drPhat_KT_New["SAN_LUONG"] = slBB_KT_1;
                                                            drPhat_KT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drPhat_KT_New["NGAY_CUOI"] = ngay_cky;
                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            drPhat_KT_New["MA_NHOMNN"] = "SHTM";
                                                            drPhat_KT_New["MA_NGIA"] = "K";
                                                            drPhat_KT_New["BCS"] = "KT";
                                                            drPhat_KT_New["TGIAN_BDIEN"] = "BT";
                                                            drPhat_KT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_KT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);


                                                        }

                                                        #endregion
                                                        #region SHTM-BT

                                                        decimal slBB_BT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='BT'"));
                                                        if (slBB_BT_1 > 0)
                                                        {
                                                            DataRow drPhat_BT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drPhat_BT_New.ItemArray = drSL3.Row.ItemArray;
                                                            drPhat_BT_New["SAN_LUONG"] = slBB_BT_1;
                                                            drPhat_BT_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drPhat_BT_New["NGAY_CUOI"] = ngay_cky;
                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            drPhat_BT_New["MA_NHOMNN"] = "SHTM";
                                                            drPhat_BT_New["MA_NGIA"] = "K";
                                                            drPhat_BT_New["BCS"] = "BT";
                                                            drPhat_BT_New["TGIAN_BDIEN"] = "BT";
                                                            drPhat_BT_New["ID_CHISO"] = drv_BT_DDK == null ? drPhat_BT_New["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drPhat_BT_New);


                                                        }

                                                        #endregion
                                                        #region SHTM-CD

                                                        decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                                        if (slBB_CD_1 > 0)
                                                        {
                                                            DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                            drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                                            drPhat_CD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                            drPhat_CD_New["MA_NGIA"] = "K";
                                                            drPhat_CD_New["BCS"] = "CD";
                                                            drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                            drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);

                                                        }

                                                        #endregion
                                                        #region SHTM-TD

                                                        decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                                        if (slBB_TD_1 > 0)
                                                        {
                                                            DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                            drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                            drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;

                                                            drPhat_TD_New["NGAY_DAU"] = ngay_ccs.AddDays(1.0);
                                                            drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                            //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                            drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                            drPhat_TD_New["MA_NGIA"] = "K";
                                                            drPhat_TD_New["BCS"] = "TD";
                                                            drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                            drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                            dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                                        }

                                                        #endregion
                                                    }
                                                    else
                                                    {
                                                        //Không phải phạt
                                                        drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                        drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                        drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                        drCCS_New["NGAY_DAU"] = ngay_cuoi.AddDays(1.0);
                                                        drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                        //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN

                                                        DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                        if (drTemp != null && drTemp.Length > 0)
                                                        {
                                                            drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                            drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                        }
                                                        //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                                        {
                                                            drCCS_New["MA_NGIA"] = "E";
                                                        }
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                                        {
                                                            drCCS_New["MA_NGIA"] = "E";
                                                        }
                                                        //và hộ nghèo
                                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                                        {
                                                            drCCS_New["MA_NGIA"] = "A";
                                                        }
                                                        dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                    }
                                                }
                                                else
                                                {
                                                    //Không phải chuyển sang SHTM
                                                    drCCS_New = dsCalculation.Tables["SL_3"].NewRow();
                                                    drCCS_New.ItemArray = drSL3.Row.ItemArray;
                                                    drCCS_New["SAN_LUONG"] = slBB_1 - sl_SauChot;
                                                    drCCS_New["NGAY_DAU"] = ngay_cuoi.AddDays(1.0);
                                                    drCCS_New["NGAY_CUOI"] = ngay_cky;

                                                    //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN

                                                    DataRow[] drTemp = dsCalculation.Tables["SL_3"].Select("MA_DDO ='" + strMa_DDo + "' and MA_NHOMNN <>'" + strMa_NhomNNBB + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM')");
                                                    if (drTemp != null && drTemp.Length > 0)
                                                    {
                                                        drCCS_New["MA_NHOMNN"] = drTemp[0]["MA_NHOMNN"];
                                                        drCCS_New["MA_NGIA"] = drTemp[0]["MA_NGIA"];
                                                    }
                                                    //Cập nhật lại mã nhóm giá sau đổi giá phạt 
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                                    {
                                                        drCCS_New["MA_NGIA"] = "E";
                                                    }
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM','SHBN') AND MA_NGIA = 'F'").Length != 0)
                                                    {
                                                        drCCS_New["MA_NGIA"] = "E";
                                                    }
                                                    //và hộ nghèo
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'N'").Length != 0)
                                                    {
                                                        drCCS_New["MA_NGIA"] = "A";
                                                    }
                                                    dsCalculation.Tables["SL_3"].Rows.Add(drCCS_New);
                                                }
                                            }
                                            else
                                            {
                                                //San luong TP + Bom nuoc khong hop ly, khong thuc hien tinh toan
                                                drSL3.Row["SAN_LUONG"] = 0;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                WriteLog(strMa_DViQLy, strMa_SoGCS, "busBillingCalculation", "busBillingCalculation.clsDetailDataCalculation", "DetailDataCalculation_40", "Tổng sản lượng nhỏ hơn sản lượng mục đích khác + sản lượng bơm nước - điểm đo: " + strMa_DDo);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //Bổ sung xử lý nhóm giá phạt trong trường hợp không đổi giá nhà nước
                                        if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'D'").Length != 0)
                                        {
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            //drSL3["NGAY_CUOI"] = ngay_cky;
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3.Row["MA_NGIA"] = "D";
                                            //Gán lại cho toàn bộ khoảng ngày
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                        else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBM') AND MA_NGIA = 'F'").Length != 0)
                                        {
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            //drSL3["NGAY_CUOI"] = ngay_cky;
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3.Row["MA_NGIA"] = "F";
                                            //Gán lại cho toàn bộ khoảng ngày
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                        else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL') AND MA_NGIA = 'E'").Length != 0)
                                        {
                                            drSL3["NGAY_DAU"] = ngay_dky;
                                            //drSL3["NGAY_CUOI"] = ngay_cky;
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS IN ('KT','BT','CD','TD')"));
                                            drSL3.Row["SAN_LUONG"] = slBB;
                                            if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN in ('SHBB','SHBC','SHBD','SHBH','SHBL','SHTM','SHBN','SHBM') AND BCS = 'KT'").Length != 0)
                                                drSL3.Row["BCS"] = "KT";
                                            else
                                                drSL3.Row["BCS"] = "BT";
                                            drSL3.Row["MA_NGIA"] = "E";
                                            //Gán lại cho toàn bộ khoảng ngày
                                            drSL3["NGAY_CUOI"] = ngay_cky;
                                        }
                                        else if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHTM') AND MA_NGIA = 'K'").Length != 0)
                                        {
                                            //Bóc tách phần sau đổi giá theo 3 BCS của SHTM trường hợp áp giá phạt
                                            #region SHTM-KT

                                            decimal slBB_KT_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS in ('KT','BT')"));
                                            if (slBB_KT_1 > 0)
                                            {
                                                //DataRow drPhat_KT_New = dsCalculation.Tables["SL_3"].NewRow();
                                                //drPhat_KT_New.ItemArray = drSL3.Row.ItemArray;
                                                drSL3["SAN_LUONG"] = slBB_KT_1;
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drSL3["MA_NHOMNN"] = "SHTM";
                                                drSL3["MA_NGIA"] = "K";
                                                //Chuẩn hóa lại BCS
                                                drSL3["BCS"] = drv_BT_DDK == null ? drSL3["BCS"] : drv_BT_DDK["BCS"];
                                                drSL3["TGIAN_BDIEN"] = "BT";
                                                drSL3["ID_CHISO"] = drv_BT_DDK == null ? drSL3["ID_CHISO"] : drv_BT_DDK["ID_CHISO"];
                                                //if (drSL3["MA_NHOMNN"].ToString().Trim() == "SHTM" && drSL3["MA_NGIA"].ToString().Trim() == "K" && drSL3["TGIAN_BDIEN"].ToString().Trim() == "BT" )
                                                //dsCalculation.Tables["SL_3"].Rows.Add(drPhat_KT_New);


                                            }

                                            #endregion
                                            #region SHTM-CD

                                            decimal slBB_CD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='CD'"));
                                            if (slBB_CD_1 > 0)
                                            {
                                                DataRow drPhat_CD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_CD_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_CD_New["SAN_LUONG"] = slBB_CD_1;

                                                drPhat_CD_New["NGAY_DAU"] = ngay_dky;
                                                drPhat_CD_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drPhat_CD_New["MA_NHOMNN"] = "SHTM";
                                                drPhat_CD_New["MA_NGIA"] = "K";
                                                drPhat_CD_New["BCS"] = "CD";
                                                drPhat_CD_New["TGIAN_BDIEN"] = "CD";
                                                drPhat_CD_New["ID_CHISO"] = drv_CD_DDK == null ? drPhat_CD_New["ID_CHISO"] : drv_CD_DDK["ID_CHISO"];
                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_CD_New);

                                            }

                                            #endregion
                                            #region SHTM-TD

                                            decimal slBB_TD_1 = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN ='SHTM' AND BCS ='TD'"));
                                            if (slBB_TD_1 > 0)
                                            {
                                                DataRow drPhat_TD_New = dsCalculation.Tables["SL_3"].NewRow();
                                                drPhat_TD_New.ItemArray = drSL3.Row.ItemArray;
                                                drPhat_TD_New["SAN_LUONG"] = slBB_TD_1;

                                                drPhat_TD_New["NGAY_DAU"] = ngay_dky;
                                                drPhat_TD_New["NGAY_CUOI"] = ngay_cky;
                                                //Cập nhật lại mã nhóm NN và mã nhóm giá sau đổi giá NN
                                                drPhat_TD_New["MA_NHOMNN"] = "SHTM";
                                                drPhat_TD_New["MA_NGIA"] = "K";
                                                drPhat_TD_New["BCS"] = "TD";
                                                drPhat_TD_New["TGIAN_BDIEN"] = "TD";
                                                drPhat_TD_New["ID_CHISO"] = drv_TD_DDK == null ? drPhat_TD_New["ID_CHISO"] : drv_TD_DDK["ID_CHISO"];
                                                dsCalculation.Tables["SL_3"].Rows.Add(drPhat_TD_New);


                                            }

                                            #endregion
                                        }
                                        else
                                        {
                                            //Để như cũ
                                            slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHTM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'A'"));
                                            if (slBB > 0)
                                            {
                                                //Co san luong ban buon nhom A
                                                drSL3.Row["SAN_LUONG"] = slBB;
                                                if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'A'").Length != 0)
                                                    drSL3.Row["BCS"] = "KT";
                                                else
                                                    drSL3.Row["BCS"] = "BT";
                                                drSL3["NGAY_DAU"] = ngay_dky;
                                                drSL3["NGAY_CUOI"] = ngay_cky;
                                            }
                                            else
                                            {
                                                slBB = CMISLibrary.Utility.DecimalDbnull(dsCalculation.Tables["SL_3"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM') AND BCS IN ('KT','BT','CD','TD') AND MA_NGIA = 'N'"));
                                                if (slBB > 0)
                                                {
                                                    //Co san luong ban buon nhom N
                                                    drSL3.Row["SAN_LUONG"] = slBB;
                                                    if (dsCalculation.Tables["SL_3"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN IN ('SHBB','SHBC','SHBD','SHBH','SHBL','SHBM','SHBN') AND BCS = 'KT' AND MA_NGIA = 'N'").Length != 0)
                                                        drSL3.Row["BCS"] = "KT";
                                                    else
                                                        drSL3.Row["BCS"] = "BT";
                                                    drSL3["NGAY_DAU"] = ngay_dky;
                                                    drSL3["NGAY_CUOI"] = ngay_cky;
                                                }
                                            }
                                        }
                                    }
                                    #endregion
                                }
                            }
                            #endregion
                        }

                        strMa_DDoBB = strMa_DDoBB + strMa_DDo + "|";
                    }
                    else
                    {
                        //Da thuc hien xu ly xong
                        if (IsExists_SLTPBB != 0)
                        {
                            //Co ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, remove het cac row con lai
                            dsCalculation.Tables["SL_3"].Rows.Remove(drSL3.Row);
                            continue;
                        }
                        else
                        {
                            //Khong ton tai trong bang GCS_SLMDK_SHBB va GCS_SLMDK_SHBB_GT, remove cac row ung voi nhom gia A, giá phạt
                            if (Convert.ToString(drSL3["MA_NGIA"]) == "A" || Convert.ToString(drSL3["MA_NGIA"]) == "N" || Convert.ToString(drSL3["MA_NGIA"]) == "D" || Convert.ToString(drSL3["MA_NGIA"]) == "E" || Convert.ToString(drSL3["MA_NGIA"]) == "F" || (Convert.ToString(drSL3["MA_NGIA"]) == "K" && Convert.ToString(drSL3["MA_NHOMNN"]) == "SHTM"))
                            //Nhóm N: Hộ nghèo\
                            //Nhóm E: giá khác, chỉ xảy ra khi có đổi biên bản giá bán buôn kỳ đổi giá nhà nước
                            {
                                if (Convert.ToString(drSL3["MA_NHOMNN"]) != "SHBN")
                                {
                                    dsCalculation.Tables["SL_3"].Rows.Remove(drSL3.Row);
                                    continue;
                                }
                            }
                        }
                    }
                    dsCalculation.Tables["SL_3"].AcceptChanges();
                }

                return "";
            }
            catch (Exception ex)
            {
                return "DetailDataCalculation_40: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //    dsCalculation.AcceptChanges();
            //}
        }

    }
}
