using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data;
using CMISLibrary;

namespace busBillingCalculation
{
    public class clsRawDataCalculation
    {
        //Tinh san luong tho cua chi so
        public string RawDataCalculation_1(DataSet dsCustomerData)
        {
            try
            {
                Decimal sl = 0;
                Decimal exp = 0;
                Decimal csc = 0;
                Decimal csm = 0;
                Decimal hsn = 0;
                //Int16 IsExists = 0, IsChanged = 0;

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                        return "NotExistsGCS_CHISO"; //khong ton tai bang GCS_CHISO
                    else
                    {
                        //if (dsCustomerData.Tables.Contains("GCS_CHISO_PHUGT") == true)
                        //{
                        //    IsExists = 1; //Ton tai bang GCS_CHISO_PHUGT
                        //}
                        //else
                        //{
                        //    IsExists = 0;
                        //}

                        //Co du lieu trong bang GCS_CHISO                            
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            ////Loai bo du lieu thua cua cac diem do phu ghep tong
                            //if (IsExists == 1)
                            //{
                            //    if (dsCustomerData.Tables["GCS_CHISO_PHUGT"].Select("MA_DVIQLY = '" + Convert.ToString(dr["MA_DVIQLY"]) + "' AND ID_CHISO = " + Convert.ToString(dr["ID_CHISO"])).Length == 0)
                            //    {
                            //        dr.Delete();
                            //        IsChanged = 1;
                            //        continue;
                            //    }
                            //}

                            //Tinh san luong
                            csc = Convert.ToDecimal(dr["CHISO_CU"]);
                            csm = Convert.ToDecimal(dr["CHISO_MOI"]);
                            hsn = Convert.ToDecimal(dr["HS_NHAN"]);
                            if (csc <= csm)
                            {
                                sl = Convert.ToDecimal(Math.Round((csm - csc) * hsn, 0, MidpointRounding.AwayFromZero));
                            }
                            else
                            {
                                if (Convert.ToString(dr["MA_TTCTO"]).Trim().ToUpper() == "Q")
                                {
                                    exp = Convert.ToDecimal(Math.Pow(10, Convert.ToString(Math.Round(csc, 0)).Trim().Length));
                                    sl = Convert.ToDecimal((exp - csc + csm) * hsn);
                                }
                                else
                                    sl = 0;
                            }
                            dr["SAN_LUONG"] = Math.Round(sl, 0, MidpointRounding.AwayFromZero);
                        }
                        //if (IsChanged == 1)
                        //{
                        //    dsCustomerData.Tables["GCS_CHISO"].AcceptChanges();
                        //}
                    }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_1: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //}
        }

        //Tinh san luong tho cua cac diem do phu ghep tong 
        public string RawDataCalculation_2(DataSet dsCustomerData)
        {
            try
            {
                Decimal sl = 0;
                Decimal exp = 0;
                Decimal csc = 0;
                Decimal csm = 0;
                Decimal hsn = 0;

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        //Co bang GCS_CHISO_GT                            
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            csc = Convert.ToDecimal(dr["CHISO_CU"]);
                            csm = Convert.ToDecimal(dr["CHISO_MOI"]);
                            hsn = Convert.ToDecimal(dr["HS_NHAN"]);
                            if (csc <= csm)
                            {
                                sl = Convert.ToDecimal(Math.Round((csm - csc) * hsn, 0, MidpointRounding.AwayFromZero));
                            }
                            else
                            {
                                if (Convert.ToString(dr["MA_TTCTO"]).Trim().ToUpper() == "Q")
                                {
                                    exp = Convert.ToDecimal(Math.Pow(10, Convert.ToString(Math.Round(csc, 0)).Trim().Length));
                                    sl = Convert.ToDecimal((exp - csc + csm) * hsn);
                                }
                                else
                                    sl = 0;
                            }
                            dr["SAN_LUONG"] = Math.Round(sl, 0, MidpointRounding.AwayFromZero);
                        }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_2: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //}
        }

        //Tinh san luong tho cua cac diem do phu tru phu 
        public string RawDataCalculation_3(DataSet dsCustomerData)
        {
            try
            {
                Decimal sl = 0;
                Decimal exp = 0;
                Decimal csc = 0;
                Decimal csm = 0;
                Decimal hsn = 0;

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                        //Co bang GCS_CHISO_TP                            
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_TP"].Rows)
                        {
                            csc = Convert.ToDecimal(dr["CHISO_CU"]);
                            csm = Convert.ToDecimal(dr["CHISO_MOI"]);
                            hsn = Convert.ToDecimal(dr["HS_NHAN"]);
                            if (csc <= csm)
                            {
                                sl = Convert.ToDecimal(Math.Round((csm - csc) * hsn, 0, MidpointRounding.AwayFromZero));
                            }
                            else
                            {
                                if (Convert.ToString(dr["MA_TTCTO"]).Trim().ToUpper() == "Q")
                                {
                                    exp = Convert.ToDecimal(Math.Pow(10, Convert.ToString(Math.Round(csc, 0)).Trim().Length));
                                    sl = Convert.ToDecimal((exp - csc + csm) * hsn);
                                }
                                else
                                    sl = 0;
                            }
                            dr["SAN_LUONG"] = Math.Round(sl, 0, MidpointRounding.AwayFromZero);
                        }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_3: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //}
        }

        //Tinh tru phu
        public string RawDataCalculation_4(DataSet dsCustomerData, DataSet dsStaticCatalog)
        {
            try
            {
                string strError = "", strResult = "";
                string strMa_DDoC = "", strMa_DDoP = "";
                decimal heso_truphu = Convert.ToDecimal(1.0);
                Int16 IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0;
                DataRow[] drDDo, drParameters;
                if (!dsCustomerData.Tables.Contains("HDG_QHE_DDO")) return "";
                DataView dwQH = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                dwQH.Sort = "MA_DVIQLY, MA_SOGCS_CHINH, MA_DDO_CHINH, TT_UUTIEN, MA_DDO_PHU";
                dwQH.RowFilter = "LOAI_QHE IN ('10','11','20','21')";
                if (dwQH.Count == 0) return "";

                //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                {
                    drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                    if (drParameters.Length > 0)
                    {
                        //Co ton tai tham so
                        IsExistsParam = 1;
                    }
                }

                //Bo sung them bang temp luu gia tri tru phu luy tien
                DataTable dt = new DataTable();
                dt.TableName = "GCS_CHISO_TP_LT";
                dt.Columns.Add("MA_DVIQLY", System.Type.GetType("System.String"));
                dt.Columns.Add("MA_DDO", System.Type.GetType("System.String"));
                dt.Columns.Add("BCS", System.Type.GetType("System.String"));
                dt.Columns.Add("TPLT", System.Type.GetType("System.Decimal"));
                if (dsCustomerData.Tables.Contains("GCS_CHISO_TP_LT")) dsCustomerData.Tables.Remove("GCS_CHISO_TP_LT");
                dsCustomerData.Tables.Add(dt);

                DataTable dtTruocCCS = new DataTable();
                dtTruocCCS.TableName = "GCS_CHISO_TP_LT_TRUOCCCS";
                dtTruocCCS.Columns.Add("MA_DVIQLY", System.Type.GetType("System.String"));
                dtTruocCCS.Columns.Add("MA_DDO", System.Type.GetType("System.String"));
                dtTruocCCS.Columns.Add("BCS", System.Type.GetType("System.String"));
                dtTruocCCS.Columns.Add("TPLT", System.Type.GetType("System.Decimal"));
                if (dsCustomerData.Tables.Contains("GCS_CHISO_TP_LT_TRUOCCCS")) dsCustomerData.Tables.Remove("GCS_CHISO_TP_LT_TRUOCCCS");
                dsCustomerData.Tables.Add(dtTruocCCS);

                DataTable dtSauCCS = new DataTable();
                dtSauCCS.TableName = "GCS_CHISO_TP_LT_SAUCCS";
                dtSauCCS.Columns.Add("MA_DVIQLY", System.Type.GetType("System.String"));
                dtSauCCS.Columns.Add("MA_DDO", System.Type.GetType("System.String"));
                dtSauCCS.Columns.Add("BCS", System.Type.GetType("System.String"));
                dtSauCCS.Columns.Add("TPLT", System.Type.GetType("System.Decimal"));
                if (dsCustomerData.Tables.Contains("GCS_CHISO_TP_LT_SAUCCS")) dsCustomerData.Tables.Remove("GCS_CHISO_TP_LT_SAUCCS");
                dsCustomerData.Tables.Add(dtSauCCS);

                //Khoi tao luon DataView va index
                DataView dwCSTP = null;
                if (dsCustomerData.Tables["GCS_CHISO_TP"] != null)
                {
                    dwCSTP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                }
                DataView dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                if (dwQH.Count != 0)
                {
                    dwCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwQH[0]["MA_DVIQLY"]) + "'";
                }
                DataRow drCS;

                foreach (DataRowView drQH in dwQH)
                {
                    //Kiem tra xem da them vao GCS_CHISO_TP_LT hay chua
                    if (dsCustomerData.Tables["GCS_CHISO_TP_LT"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "'").Length == 0)
                    {
                        //DataView dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                        //DataRow drCS;
                        dwCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "'";
                        if (dwCS.Count > 0)
                        {
                            foreach (DataRowView drwCS in dwCS)
                            {
                                if (dsCustomerData.Tables["GCS_CHISO_TP_LT"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "' AND BCS = '" + Convert.ToString(drwCS["BCS"]) + "'").Length == 0)
                                {
                                    //Chua co
                                    drCS = dsCustomerData.Tables["GCS_CHISO_TP_LT"].NewRow();
                                    drCS["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                    drCS["MA_DDO"] = drwCS["MA_DDO"];
                                    drCS["BCS"] = drwCS["BCS"];
                                    drCS["TPLT"] = 0;
                                    dsCustomerData.Tables["GCS_CHISO_TP_LT"].Rows.Add(drCS);
                                }

                                if (dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "' AND BCS = '" + Convert.ToString(drwCS["BCS"]) + "'").Length == 0)
                                {
                                    //Chua co
                                    drCS = dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].NewRow();
                                    drCS["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                    drCS["MA_DDO"] = drwCS["MA_DDO"];
                                    drCS["BCS"] = drwCS["BCS"];
                                    drCS["TPLT"] = 0;
                                    dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Rows.Add(drCS);
                                }

                                if (dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "' AND BCS = '" + Convert.ToString(drwCS["BCS"]) + "'").Length == 0)
                                {
                                    //Chua co
                                    drCS = dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].NewRow();
                                    drCS["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                    drCS["MA_DDO"] = drwCS["MA_DDO"];
                                    drCS["BCS"] = drwCS["BCS"];
                                    drCS["TPLT"] = 0;
                                    dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Rows.Add(drCS);
                                }
                            }
                        }
                        else
                        {
                            if (dsCustomerData.Tables["GCS_CHISO_TP"] != null)
                            {
                                dwCSTP.RowFilter = "MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "'";
                                if (dwCSTP.Count > 0)
                                {
                                    foreach (DataRowView drwCS in dwCSTP)
                                    {
                                        if (dsCustomerData.Tables["GCS_CHISO_TP_LT"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "' AND BCS = '" + Convert.ToString(drwCS["BCS"]) + "'").Length == 0)
                                        {
                                            //Chua co
                                            drCS = dsCustomerData.Tables["GCS_CHISO_TP_LT"].NewRow();
                                            drCS["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                            drCS["MA_DDO"] = drwCS["MA_DDO"];
                                            drCS["BCS"] = drwCS["BCS"];
                                            drCS["TPLT"] = 0;
                                            dsCustomerData.Tables["GCS_CHISO_TP_LT"].Rows.Add(drCS);
                                        }

                                        if (dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "' AND BCS = '" + Convert.ToString(drwCS["BCS"]) + "'").Length == 0)
                                        {
                                            //Chua co
                                            drCS = dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].NewRow();
                                            drCS["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                            drCS["MA_DDO"] = drwCS["MA_DDO"];
                                            drCS["BCS"] = drwCS["BCS"];
                                            drCS["TPLT"] = 0;
                                            dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Rows.Add(drCS);
                                        }

                                        if (dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Select("MA_DVIQLY = '" + Convert.ToString(drQH["MA_DVIQLY"]) + "' AND MA_DDO = '" + Convert.ToString(drQH["MA_DDO_PHU"]) + "' AND BCS = '" + Convert.ToString(drwCS["BCS"]) + "'").Length == 0)
                                        {
                                            //Chua co
                                            drCS = dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].NewRow();
                                            drCS["MA_DVIQLY"] = drwCS["MA_DVIQLY"];
                                            drCS["MA_DDO"] = drwCS["MA_DDO"];
                                            drCS["BCS"] = drwCS["BCS"];
                                            drCS["TPLT"] = 0;
                                            dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Rows.Add(drCS);
                                        }
                                    }
                                }
                            }
                        }
                    }


                    strMa_DDoC = Convert.ToString(drQH["MA_DDO_CHINH"]).Trim();
                    strMa_DDoP = Convert.ToString(drQH["MA_DDO_PHU"]).Trim();


                    IsExistsSHBB = 0;
                    IsExistsSXD1 = 0;
                    //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                    if (IsExistsParam == 1)
                    {
                        if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                        {
                            drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoC + "' AND MA_NHOMNN = 'SHBB'");
                            if (drDDo.Length > 0)
                            {
                                IsExistsSHBB = 1;
                            }
                            else
                            {
                                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                                {
                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA_GT"].Select("MA_DDO = '" + strMa_DDoC + "' AND MA_NHOMNN = 'SHBB'");
                                    if (drDDo.Length > 0)
                                    {
                                        IsExistsSHBB = 1;
                                    }
                                    else
                                    {
                                        IsExistsSHBB = 0;
                                    }
                                }
                                else
                                {
                                    IsExistsSHBB = 0;
                                }
                            }

                            drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                            if (drDDo.Length > 0)
                            {
                                IsExistsSXD1 = 1;
                            }
                            else
                            {
                                IsExistsSXD1 = 0;
                            }

                            if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                            {
                                heso_truphu = Convert.ToDecimal(1.1);
                            }
                            else
                            {
                                heso_truphu = Convert.ToDecimal(1.0);
                            }
                        }
                        else
                        {
                            heso_truphu = Convert.ToDecimal(1.0);
                        }
                    }
                    else
                    {
                        heso_truphu = Convert.ToDecimal(1.0);
                    }

                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == true)
                    {
                        //Kiem tra xem la diem do chinh quan he ghep tong hay la diem do phu quan he ghep tong
                        drDDo = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDoC + "'");
                        if (drDDo.Length > 0)
                        {
                            //Diem do chinh ghep tong
                            //Chay vong lap, thuc hien tru phu cho tung cap diem do
                            strResult = this.ParentChildDataCalculation(dsCustomerData, strMa_DDoC, strMa_DDoP, Convert.ToString(drQH["LOAI_QHE"]).Trim(), heso_truphu);
                            if (strResult != "")
                            {
                                if (strError.Length < 200)
                                {
                                    strError = strError + "|" + strResult;
                                }
                            }
                        }
                        else
                        {
                            //Diem do phu ghep tong
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                            {
                                drDDo = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDoC + "'");
                                if (drDDo.Length > 0)
                                {
                                    //Chay vong lap, thuc hien tru phu cho tung cap diem do
                                    strResult = this.ParentChildDataCalculation_GT(dsCustomerData, strMa_DDoC, strMa_DDoP, Convert.ToString(drQH["LOAI_QHE"]).Trim(), heso_truphu);
                                    if (strResult != "")
                                    {
                                        if (strError.Length < 200)
                                        {
                                            strError = strError + "|" + strResult;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        //Diem do phu ghep tong
                        if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                        {
                            drDDo = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDoC + "'");
                            if (drDDo.Length > 0)
                            {
                                //Chay vong lap, thuc hien tru phu cho tung cap diem do
                                strResult = this.ParentChildDataCalculation_GT(dsCustomerData, strMa_DDoC, strMa_DDoP, Convert.ToString(drQH["LOAI_QHE"]).Trim(), heso_truphu);
                                if (strResult != "")
                                {
                                    if (strError.Length < 200)
                                    {
                                        strError = strError + "|" + strResult;
                                    }
                                }
                            }
                        }
                    }
                }
                //Cap nhat san luong tru phu tu bang GCS_CHISO ve  bang GCS_CHISO_BQ
                #region Cat di sau nay có the dung den
                if (dsCustomerData.Tables.Contains("GCS_CHISO_BQ") && dsCustomerData.Tables["GCS_CHISO_BQ"].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_BQ"].Rows)
                    {
                        strMa_DDoC = Convert.ToString(dr["MA_DDO"]);
                        if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                        {
                            DataView dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                            dwTP.RowFilter = "MA_DDO_CHINH = '" + Convert.ToString(dr["MA_DDO"]) + "' AND LOAI_QHE IN ('10','11')";
                            if (dwTP.Count <= 0)
                            {
                                foreach (DataRow drTmp in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == Convert.ToString(drTmp["MA_DDO"]) && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDouble(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") && dsCustomerData.Tables["GCS_CHISO_GT"].Rows.Count > 0)
                                {
                                    foreach (DataRow drTmp in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == Convert.ToString(drTmp["MA_DDO"]) && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDouble(drTmp["SLUONG_TRPHU"]);
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                    }
                }
                dsCustomerData.AcceptChanges();
                #endregion
                return strError;
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_4: " + ex.Message;
            }
            //finally
            //{
            //    dsCustomerData.AcceptChanges();
            //}
        }
        //Cho cac diem do chinh trong quan he ghep tong
        private string ParentChildDataCalculation(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string loai_qhe, decimal hstp)
        {
            try
            {
                DateTime dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP;
                Int16 IsExists = 0;
                Int64 ID_BCS_C = 0, ID_BCS_P = 0;
                //string strLoai_CSC = "", strLoai_CSP = "";
                //Thuc hien tru phu
                //DataView dwCSCTP, dwCSPTP;

                if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                    return "";

                if (dsCustomerData.Tables.Contains("GCS_CHISO_TP") == false)
                    return "";

                //Kiem tra treo thao cung ngay
                DataView dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                if (dwCSC == null || dwCSC.Count == 0)
                    return "";
                dwCSC.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK')";
                dwCSC.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                DataView dwCSP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                if (dwCSP == null || dwCSP.Count == 0)
                    return "";
                dwCSP.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK')";
                dwCSP.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";





                if (dwCSC.Count == 1)
                {
                    //Diem do chinh chi co 1 bien dong chi so DDN va DDK
                    IsExists = 0;
                }
                else
                {
                    if (dwCSP.Count == 1)
                        //Diem do phu chi co 1 bien dong chi so DDN va DDK
                        IsExists = 0;
                    else
                    {
                        IsExists = 0;
                        foreach (DataRowView drCSC in dwCSC)
                        {
                            ID_BCS_C = Convert.ToInt64(drCSC["ID_BCS"]);
                            dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                            dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                            dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            IsExists = 0;
                            foreach (DataRowView drCSP in dwCSP)
                            {
                                ID_BCS_P = Convert.ToInt64(drCSP["ID_BCS"]);
                                dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                                dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                                dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                if (dNgay_CKyC == dNgay_CKyP && dNgay_DKyC == dNgay_DKyP)
                                {
                                    //Ton tai cong to phu cung treo thao voi cong to chinh
                                    IsExists = 1;
                                    break;
                                }
                            }
                            //Neu khong ton tai cong to phu cung treo thao cung cong to chinh
                            if (IsExists == 0)
                            {
                                break;
                            }
                        }
                    }
                }

                if (IsExists == 0)
                {
                    //Treo thao khong cung ngay, sum tong tru phu lai va tinh toan
                    ParentChildDataCalculation_1(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, "x", "x", loai_qhe, hstp, null, null, null, null);
                }
                else
                {
                    //Treo thao cung ngay, tru tuong ung theo tung cong to                    
                    foreach (DataRowView drCSC in dwCSC)
                    {
                        ID_BCS_C = Convert.ToInt64(drCSC["ID_BCS"]);
                        dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                        dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                        dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        foreach (DataRowView drCSP in dwCSP)
                        {
                            ID_BCS_P = Convert.ToInt64(drCSP["ID_BCS"]);
                            dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                            dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                            dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            if (dNgay_CKyC == dNgay_CKyP && dNgay_DKyC == dNgay_DKyP)
                            {
                                //Ton tai cong to phu cung treo thao voi cong to chinh

                                ParentChildDataCalculation_1(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, Convert.ToString(drCSC["MA_CTO"]), Convert.ToString(drCSP["MA_CTO"]), loai_qhe, hstp, dNgay_CKyC, dNgay_DKyC, dNgay_CKyP, dNgay_DKyP);
                                break;
                            }
                        }
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation: " + ex.Message;
            }
        }
        private string ParentChildDataCalculation_1(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, string loai_qhe, decimal hstp, DateTime? dNgayCKy_C, DateTime? dNgayDKy_C, DateTime? dNgayCKy_P, DateTime? dNgayDKy_P)
        {
            //Truyen them 4 gia tri NgayDKy_C, NgayCKy_C,NgayDKy_P, NgayCKy_P xuong. Thu xem sao?
            try
            {
                DateTime dNgay_CKyC, dNgay_DKyC, dNgay_CKyP, dNgay_DKyP;

                //if (strMa_DDoChinh == "PA25BXBX90003001" && strMa_DDoPhu == "PA25BXBX90003002")
                //{
                //    strMa_DDoChinh = "PA25BXBX90003001";
                //    strMa_DDoPhu = "PA25BXBX90003002";
                //}

                if (strMa_CToChinh == "x")
                {
                    //Toan bo khoang chi so - kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    //DataView dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                    //dwCSC.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS'";
                    //dwCSC.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //DataView dwCSP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                    //dwCSP.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS'";
                    //dwCSP.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //if (dwCSC.Count == 1 && dwCSP.Count == 1)
                    //{
                    //    //Chinh phu chot chi so doi gia
                    //    //Truoc doi gia
                    //    dNgay_CKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_CKyP = dNgay_CKyC;

                    //    dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    ParentChildDataCalculation_2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);

                    //    //Sau doi gia
                    //    dNgay_DKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).AddDays(1.0).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_DKyP = dNgay_DKyC;

                    //    dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    ParentChildDataCalculation_2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                    //else
                    //{
                    //Chinh phu khong cung chot chi so doi gia
                    dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    ParentChildDataCalculation_2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                }
                else
                {
                    //Theo tung cong to
                    //DataView dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                    //dwCSC.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS' AND MA_CTO = '" + strMa_CToChinh + "'";
                    //dwCSC.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //DataView dwCSP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                    //dwCSP.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS' AND MA_CTO = '" + strMa_CToPhu + "'";
                    //dwCSP.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //if (dwCSC.Count == 1 && dwCSP.Count == 1)
                    //{
                    //    //Chinh phu chot chi so doi gia
                    //    //Truoc doi gia
                    //    dNgay_CKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_CKyP = dNgay_CKyC;

                    //    dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //    dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //    dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    ParentChildDataCalculation_2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);

                    //    //Sau doi gia
                    //    dNgay_DKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).AddDays(1.0).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_DKyP = dNgay_DKyC;

                    //    dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //    dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //    dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    ParentChildDataCalculation_2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                    //else
                    //{

                    //Chinh phu khong cung chot chi so doi gia
                    //dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    dNgay_CKyC = dNgayCKy_C.Value;
                    dNgay_DKyC = dNgayDKy_C.Value;
                    dNgay_CKyP = dNgayCKy_P.Value;
                    dNgay_DKyP = dNgayDKy_P.Value;
                    ParentChildDataCalculation_2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_1: " + ex.Message;
            }
        }
        private string ParentChildDataCalculation_2(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, DateTime dNgay_DKyC, DateTime dNgay_CKyC, DateTime dNgay_DKyP, DateTime dNgay_CKyP, string loai_qhe, decimal hstp)
        {
            try
            {
                Decimal SLKT_P = 0, SLBT_P = 0, SLCD_P = 0, SLTD_P = 0, SLVC_P = 0;
                Decimal SLKT_P_LT = 0, SLBT_P_LT = 0, SLCD_P_LT = 0, SLTD_P_LT = 0, SLVC_P_LT = 0;
                Decimal SLKT_C = 0, SLBT_C = 0, SLCD_C = 0, SLTD_C = 0, SLVC_C = 0;
                Decimal SLKT_CAll = 0, SLBT_CAll = 0, SLCD_CAll = 0, SLTD_CAll = 0, SLVC_CAll = 0;
                Decimal SL_SS = 0, SL_TP = 0;
                DataView dwCS;
                Decimal IsExistsCCS = 0;
                if (strMa_DDoChinh == "PD27007666157001")
                {

                }
                Int64 IDMax = 0;
                if (strMa_CToChinh == "x")
                {
                    //Khong treo thao cung ngay

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va phu cung chot chi so doi gia nha nuoc
                        string strMa_DDoChinh_1 = "";
                        string strMa_DDoPhu_1 = "";
                        DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                        //Chuan bi du lieu
                        DataSet dsTmp = new DataSet();
                        DataRow drRemove;
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        #region Truoc doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        //Khong chot chi so doi gia nha nuoc
                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        //SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        //SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);

                                            //SLKT_C = 0;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}

                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                    break;
                                }
                            }
                        }

                        dsTmp.Reset();
                        #endregion

                        #region Sau doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                    break;
                                }
                            }
                        }
                        dsTmp.Reset();
                        #endregion
                    }
                    else
                    {
                        //Khong chot chi so doi gia nha nuoc
                        if (strMa_DDoChinh == "PD05000088015001" && strMa_DDoPhu == "PD05000091349001")
                        {
                            strMa_DDoChinh = "PD05000088015001";
                        }

                        dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                    //dsCustomerData.AcceptChanges();
                }
                else
                {
                    //Treo thao cung ngay                   
                    string strMa_DDoChinh_1 = "";
                    string strMa_DDoPhu_1 = "";
                    string strMa_CToChinh_1 = "";
                    string strMa_CToPhu_1 = "";
                    DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                    //Chuan bi du lieu
                    DataSet dsTmp = new DataSet();
                    DataRow drRemove;

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va diem do phu cung  chot chi so doi gia nha nuoc
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        if (dNgay_CKyC > dNgayC_CCS_1 && dNgay_DKyC <= dNgayC_CCS_1)
                        {
                            //Cong to co chot chi so doi gia nha nuoc
                            #region Truoc doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                        break;
                                    }
                                }
                            }

                            dsTmp.Reset();
                            #endregion

                            #region Sau doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            //Khong chot chi so doi gia nha nuoc
                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                        break;
                                    }
                                }
                            }
                            dsTmp.Reset();
                            #endregion
                        }
                        else
                        {

                            //Cong to khong chot chi so doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                                {
                                    dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P != 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                #endregion
                            }

                            //dsTmp.AcceptChanges();

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                        break;
                                    }
                                }
                            }
                            //dsCustomerData.AcceptChanges();

                            dsTmp.Reset();
                        }
                    }
                    else
                    {
                        //Khong cung chot chi so doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                            {
                                dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P != 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P != 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    //Loại quan hệ khác 10,11 thì tính trừ phụ hữu công khi tính cosfi 
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion
                        }

                        //dsTmp.AcceptChanges(); --

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                    break;
                                }
                            }
                        }
                        //dsCustomerData.AcceptChanges();

                        dsTmp.Reset();
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_2: " + ex.Message;
            }
        }

        private string ParentChildDataCalculation_2_Backup_moi_nhat(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, DateTime dNgay_DKyC, DateTime dNgay_CKyC, DateTime dNgay_DKyP, DateTime dNgay_CKyP, string loai_qhe, decimal hstp)
        {
            try
            {
                Decimal SLKT_P = 0, SLBT_P = 0, SLCD_P = 0, SLTD_P = 0, SLVC_P = 0;
                Decimal SLKT_P_LT = 0, SLBT_P_LT = 0, SLCD_P_LT = 0, SLTD_P_LT = 0, SLVC_P_LT = 0;
                Decimal SLKT_C = 0, SLBT_C = 0, SLCD_C = 0, SLTD_C = 0, SLVC_C = 0;
                Decimal SLKT_CAll = 0, SLBT_CAll = 0, SLCD_CAll = 0, SLTD_CAll = 0, SLVC_CAll = 0;
                Decimal SL_SS = 0, SL_TP = 0;
                DataView dwCS;
                Decimal IsExistsCCS = 0;
                if (strMa_DDoChinh == "PD01000010088001")
                {

                }
                Int64 IDMax = 0;
                if (strMa_CToChinh == "x")
                {
                    //Khong treo thao cung ngay

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va phu cung chot chi so doi gia nha nuoc
                        string strMa_DDoChinh_1 = "";
                        string strMa_DDoPhu_1 = "";
                        DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                        //Chuan bi du lieu
                        DataSet dsTmp = new DataSet();
                        DataRow drRemove;
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        #region Truoc doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        //Khong chot chi so doi gia nha nuoc
                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        //SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        //SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);

                                            //SLKT_C = 0;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}

                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    break;
                                }
                            }
                        }

                        dsTmp.Reset();
                        #endregion

                        #region Sau doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    break;
                                }
                            }
                        }
                        dsTmp.Reset();
                        #endregion
                    }
                    else
                    {
                        //Khong chot chi so doi gia nha nuoc
                        if (strMa_DDoChinh == "PD05000088015001" && strMa_DDoPhu == "PD05000091349001")
                        {
                            strMa_DDoChinh = "PD05000088015001";
                        }

                        dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                    //dsCustomerData.AcceptChanges();
                }
                else
                {
                    //Treo thao cung ngay                   
                    string strMa_DDoChinh_1 = "";
                    string strMa_DDoPhu_1 = "";
                    string strMa_CToChinh_1 = "";
                    string strMa_CToPhu_1 = "";
                    DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                    //Chuan bi du lieu
                    DataSet dsTmp = new DataSet();
                    DataRow drRemove;

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va diem do phu cung  chot chi so doi gia nha nuoc
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        if (dNgay_CKyC > dNgayC_CCS_1 && dNgay_DKyC <= dNgayC_CCS_1)
                        {
                            //Cong to co chot chi so doi gia nha nuoc
                            #region Truoc doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                            }

                            dsTmp.Reset();
                            #endregion

                            #region Sau doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            //Khong chot chi so doi gia nha nuoc
                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                            }
                            dsTmp.Reset();
                            #endregion
                        }
                        else
                        {
                            //Cong to khong chot chi so doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                                {
                                    dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P != 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                #endregion
                            }

                            //dsTmp.AcceptChanges();

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                            }
                            //dsCustomerData.AcceptChanges();
                            dsTmp.Reset();
                        }
                    }
                    else
                    {
                        //Khong cung chot chi so doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                            {
                                dsTmp.Tables["GCS_CHISO"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P != 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P != 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion
                        }

                        //dsTmp.AcceptChanges(); --

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    break;
                                }
                            }
                        }
                        //dsCustomerData.AcceptChanges();
                        dsTmp.Reset();
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_2: " + ex.Message;
            }
        }

        //Cho cac diem do phu trong quan he ghep tong
        private string ParentChildDataCalculation_GT(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string loai_qhe, decimal hstp)
        {
            try
            {
                DateTime dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP;
                Int16 IsExists = 0;
                Int64 ID_BCS_C = 0, ID_BCS_P = 0;
                //string strLoai_CSC = "", strLoai_CSP = "";
                //Thuc hien tru phu
                //DataView dwCSCTP, dwCSPTP;

                //Kiem tra treo thao cung ngay
                DataView dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                if (dwCSC == null || dwCSC.Count == 0)
                    return "";
                dwCSC.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK')";
                dwCSC.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                DataView dwCSP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                if (dwCSP == null || dwCSP.Count == 0)
                    return "";
                dwCSP.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK')";
                dwCSP.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";





                if (dwCSC.Count == 1)
                {
                    //Diem do chinh chi co 1 bien dong chi so DDN va DDK
                    IsExists = 0;
                }
                else
                {
                    if (dwCSP.Count == 1)
                        //Diem do phu chi co 1 bien dong chi so DDN va DDK
                        IsExists = 0;
                    else
                    {
                        IsExists = 0;
                        foreach (DataRowView drCSC in dwCSC)
                        {
                            ID_BCS_C = Convert.ToInt64(drCSC["ID_BCS"]);
                            dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                            dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                            dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            IsExists = 0;
                            foreach (DataRowView drCSP in dwCSP)
                            {
                                ID_BCS_P = Convert.ToInt64(drCSP["ID_BCS"]);
                                dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                                dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                                dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                                if (dNgay_CKyC == dNgay_CKyP && dNgay_DKyC == dNgay_DKyP)
                                {
                                    //Ton tai cong to phu cung treo thao voi cong to chinh
                                    IsExists = 1;
                                    break;
                                }
                            }
                            //Neu khong ton tai cong to phu cung treo thao cung cong to chinh
                            if (IsExists == 0)
                            {
                                break;
                            }
                        }
                    }
                }

                if (IsExists == 0)
                {
                    //Treo thao khong cung ngay, sum tong tru phu lai va tinh toan
                    ParentChildDataCalculation_GT1(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, "x", "x", loai_qhe, hstp, null, null, null, null);
                }
                else
                {
                    //Treo thao cung ngay, tru tuong ung theo tung cong to                    
                    foreach (DataRowView drCSC in dwCSC)
                    {
                        ID_BCS_C = Convert.ToInt64(drCSC["ID_BCS"]);
                        dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                        dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_C));
                        dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        foreach (DataRowView drCSP in dwCSP)
                        {
                            ID_BCS_P = Convert.ToInt64(drCSP["ID_BCS"]);
                            dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                            dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND ID_BCS = " + ID_BCS_P));
                            dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                            if (dNgay_CKyC == dNgay_CKyP && dNgay_DKyC == dNgay_DKyP)
                            {
                                //Ton tai cong to phu cung treo thao voi cong to chinh

                                ParentChildDataCalculation_GT1(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, Convert.ToString(drCSC["MA_CTO"]), Convert.ToString(drCSP["MA_CTO"]), loai_qhe, hstp, dNgay_CKyC, dNgay_DKyC, dNgay_CKyP, dNgay_DKyP);
                                break;
                            }
                        }
                    }
                }

                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_GT: " + ex.Message;
            }
        }
        private string ParentChildDataCalculation_GT1(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, string loai_qhe, decimal hstp, DateTime? dNgayCKy_C, DateTime? dNgayDKy_C, DateTime? dNgayCKy_P, DateTime? dNgayDKy_P)
        {
            try
            {
                DateTime dNgay_CKyC, dNgay_DKyC, dNgay_CKyP, dNgay_DKyP;

                if (strMa_CToChinh == "x")
                {
                    //Toan bo khoang chi so - kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    //DataView dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                    //dwCSC.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS'";
                    //dwCSC.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //DataView dwCSP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                    //dwCSP.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS'";
                    //dwCSP.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //if (dwCSC.Count == 1 && dwCSP.Count == 1)
                    //{                        
                    //Chinh phu chot chi so doi gia
                    //Truoc doi gia
                    //dNgay_CKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //dNgay_CKyP = dNgay_CKyC;

                    //dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //ParentChildDataCalculation_GT2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);

                    ////Sau doi gia
                    //dNgay_DKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).AddDays(1.0).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //dNgay_DKyP = dNgay_DKyC;

                    //dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //Dũng NT sửa lỗi phụ ghép tổng bị trừ phụ 2 lần
                    //cách sửa chuyển về xử lý giống điểm đo bình thường trừ phụ
                    dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    ParentChildDataCalculation_GT2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                    //else
                    //{
                    //    //Chinh phu khong cung chot chi so doi gia
                    //    dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    //    dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    ParentChildDataCalculation_GT2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                }
                else
                {
                    //Theo tung cong to
                    //DataView dwCSC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                    //dwCSC.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS' AND MA_CTO = '" + strMa_CToChinh + "'";
                    //dwCSC.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //DataView dwCSP = new DataView(dsCustomerData.Tables["GCS_CHISO_TP"]);
                    //dwCSP.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO = 'CCS' AND MA_CTO = '" + strMa_CToPhu + "'";
                    //dwCSP.Sort = "MA_DVIQLY, MA_DDO, ID_BCS, ID_CHISO";

                    //if (dwCSC.Count == 1 && dwCSP.Count == 1)
                    //{
                    //    //Chinh phu chot chi so doi gia
                    //    //Truoc doi gia
                    //    dNgay_CKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_CKyP = dNgay_CKyC;

                    //    //dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //    //dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    //dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //    //dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_DKyC = dNgayDKy_C.Value;
                    //    dNgay_DKyP = dNgayDKy_P.Value;
                    //    ParentChildDataCalculation_GT2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);

                    //    //Sau doi gia
                    //    dNgay_DKyC = DateTime.Parse(Convert.ToDateTime(dwCSC[0]["NGAY_CKY"]).AddDays(1.0).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_DKyP = dNgay_DKyC;

                    //    //dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //    //dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //    //dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //    //dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //    dNgay_CKyC = dNgayCKy_C.Value;
                    //    dNgay_CKyP = dNgayCKy_P.Value;
                    //    ParentChildDataCalculation_GT2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                    //else
                    //{
                    //Chinh phu khong cung chot chi so doi gia
                    //dNgay_DKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //dNgay_DKyC = DateTime.Parse(dNgay_DKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //dNgay_CKyC = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToChinh + "'"));
                    //dNgay_CKyC = DateTime.Parse(dNgay_CKyC.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                    //dNgay_DKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //dNgay_DKyP = DateTime.Parse(dNgay_DKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    //dNgay_CKyP = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC') AND MA_CTO = '" + strMa_CToPhu + "'"));
                    //dNgay_CKyP = DateTime.Parse(dNgay_CKyP.ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                    dNgay_DKyC = dNgayDKy_C.Value;
                    dNgay_DKyP = dNgayDKy_P.Value;
                    dNgay_CKyC = dNgayCKy_C.Value;
                    dNgay_CKyP = dNgayCKy_P.Value;
                    ParentChildDataCalculation_GT2(dsCustomerData, strMa_DDoChinh, strMa_DDoPhu, strMa_CToChinh, strMa_CToPhu, dNgay_DKyC, dNgay_CKyC, dNgay_DKyP, dNgay_CKyP, loai_qhe, hstp);
                    //}
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_GT1: " + ex.Message;
            }
        }
        #region ParentChildDataCalculation_GT2 kiểu mới
        private string ParentChildDataCalculation_GT2(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, DateTime dNgay_DKyC, DateTime dNgay_CKyC, DateTime dNgay_DKyP, DateTime dNgay_CKyP, string loai_qhe, decimal hstp)
        {
            try
            {
                Decimal SLKT_P = 0, SLBT_P = 0, SLCD_P = 0, SLTD_P = 0, SLVC_P = 0;
                Decimal SLKT_P_LT = 0, SLBT_P_LT = 0, SLCD_P_LT = 0, SLTD_P_LT = 0, SLVC_P_LT = 0;
                Decimal SLKT_C = 0, SLBT_C = 0, SLCD_C = 0, SLTD_C = 0, SLVC_C = 0;
                Decimal SLKT_CAll = 0, SLBT_CAll = 0, SLCD_CAll = 0, SLTD_CAll = 0, SLVC_CAll = 0;
                Decimal SL_SS = 0, SL_TP = 0;
                DataView dwCS;
                Decimal IsExistsCCS = 0;

                Int64 IDMax = 0;
                if (strMa_CToChinh == "x")
                {
                    //Khong treo thao cung ngay

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va phu cung chot chi so doi gia nha nuoc
                        string strMa_DDoChinh_1 = "";
                        string strMa_DDoPhu_1 = "";
                        DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                        //Chuan bi du lieu
                        DataSet dsTmp = new DataSet();
                        DataRow drRemove;
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        #region Truoc doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        //Khong chot chi so doi gia nha nuoc
                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }

                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }

                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }

                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        //SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        //SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);

                                            //SLKT_C = 0;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}

                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                    break;
                                }
                            }
                        }

                        dsTmp.Reset();
                        #endregion

                        #region Sau doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                    break;
                                }
                            }
                        }
                        dsTmp.Reset();
                        #endregion
                    }
                    else
                    {
                        //Khong chot chi so doi gia nha nuoc
                        if (strMa_DDoChinh == "PD05000088015001" && strMa_DDoPhu == "PD05000091349001")
                        {
                            strMa_DDoChinh = "PD05000088015001";
                        }

                        dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                    //dsCustomerData.AcceptChanges();
                }
                else
                {
                    //Treo thao cung ngay                   
                    string strMa_DDoChinh_1 = "";
                    string strMa_DDoPhu_1 = "";
                    string strMa_CToChinh_1 = "";
                    string strMa_CToPhu_1 = "";
                    DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                    //Chuan bi du lieu
                    DataSet dsTmp = new DataSet();
                    DataRow drRemove;

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va diem do phu cung  chot chi so doi gia nha nuoc
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        if (dNgay_CKyC > dNgayC_CCS_1 && dNgay_DKyC <= dNgayC_CCS_1)
                        {
                            //Cong to co chot chi so doi gia nha nuoc
                            #region Truoc doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                        break;
                                    }
                                }
                            }

                            dsTmp.Reset();
                            #endregion

                            #region Sau doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            //Khong chot chi so doi gia nha nuoc
                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                        break;
                                    }
                                }
                            }
                            dsTmp.Reset();
                            #endregion
                        }
                        else
                        {
                            //Cong to khong chot chi so doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P != 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                        }
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        if (loai_qhe != "10" && loai_qhe != "11")
                                                        {
                                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                        }
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            foreach (DataRowView dr in dwCS)
                                            //foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                #endregion
                            }

                            //dsTmp.AcceptChanges();

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                        break;
                                    }
                                }
                            }
                            //dsCustomerData.AcceptChanges();
                            dsTmp.Reset();
                        }
                    }
                    else
                    {
                        //Khong cung chot chi so doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                            {
                                dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P != 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLKT_P - SL_SS;
                                        }
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        if (loai_qhe != "10" && loai_qhe != "11")
                                        {
                                            dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                        }
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P != 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                    }
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    if (loai_qhe != "10" && loai_qhe != "11")
                                                    {
                                                        dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                    }
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLBT_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLCD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLTD_P - SL_SS;
                                                }
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                if (loai_qhe != "10" && loai_qhe != "11")
                                                {
                                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                                }
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SLVC_P - SL_SS;
                                            }
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            if (loai_qhe != "10" && loai_qhe != "11")
                                            {
                                                dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(dr["SLUONG_TRPHU_COSFI"]) + SL_TP;
                                            }
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion
                        }

                        //dsTmp.AcceptChanges(); --

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    dr["SLUONG_TRPHU_COSFI"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU_COSFI"]);
                                    break;
                                }
                            }
                        }
                        //dsCustomerData.AcceptChanges();
                        dsTmp.Reset();
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_2: " + ex.Message;
            }
        }

        private string ParentChildDataCalculation_GT2_backup_moi_nhat(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, DateTime dNgay_DKyC, DateTime dNgay_CKyC, DateTime dNgay_DKyP, DateTime dNgay_CKyP, string loai_qhe, decimal hstp)
        {
            try
            {
                Decimal SLKT_P = 0, SLBT_P = 0, SLCD_P = 0, SLTD_P = 0, SLVC_P = 0;
                Decimal SLKT_P_LT = 0, SLBT_P_LT = 0, SLCD_P_LT = 0, SLTD_P_LT = 0, SLVC_P_LT = 0;
                Decimal SLKT_C = 0, SLBT_C = 0, SLCD_C = 0, SLTD_C = 0, SLVC_C = 0;
                Decimal SLKT_CAll = 0, SLBT_CAll = 0, SLCD_CAll = 0, SLTD_CAll = 0, SLVC_CAll = 0;
                Decimal SL_SS = 0, SL_TP = 0;
                DataView dwCS;
                Decimal IsExistsCCS = 0;

                Int64 IDMax = 0;
                if (strMa_CToChinh == "x")
                {
                    //Khong treo thao cung ngay

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va phu cung chot chi so doi gia nha nuoc
                        string strMa_DDoChinh_1 = "";
                        string strMa_DDoPhu_1 = "";
                        DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                        //Chuan bi du lieu
                        DataSet dsTmp = new DataSet();
                        DataRow drRemove;
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        #region Truoc doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        //Khong chot chi so doi gia nha nuoc
                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        //SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        //SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);

                                            //SLKT_C = 0;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}

                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    break;
                                }
                            }
                        }

                        dsTmp.Reset();
                        #endregion

                        #region Sau doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    break;
                                }
                            }
                        }
                        dsTmp.Reset();
                        #endregion
                    }
                    else
                    {
                        //Khong chot chi so doi gia nha nuoc
                        if (strMa_DDoChinh == "PD05000088015001" && strMa_DDoPhu == "PD05000091349001")
                        {
                            strMa_DDoChinh = "PD05000088015001";
                        }

                        dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh tong san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                        SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                        SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                        SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                        SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                        SLBT_P = SLBT_P - SLBT_P_LT;
                        SLKT_P = SLKT_P - SLKT_P_LT;
                        SLCD_P = SLCD_P - SLCD_P_LT;
                        SLTD_P = SLTD_P - SLTD_P_LT;
                        SLVC_P = SLVC_P - SLVC_P_LT;

                        SLBT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P > 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";

                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                }
                            }
                            #endregion
                        }

                        //Cap nhat lai gia tri tru phu luy tien
                        DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT"]);
                        dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                        foreach (DataRowView drwCSP_LT in dwCSP_LT)
                        {
                            switch (Convert.ToString(drwCSP_LT["BCS"]))
                            {
                                case "KT":
                                    drwCSP_LT["TPLT"] = SLKT_P_LT;
                                    break;
                                case "BT":
                                    drwCSP_LT["TPLT"] = SLBT_P_LT;
                                    break;
                                case "CD":
                                    drwCSP_LT["TPLT"] = SLCD_P_LT;
                                    break;
                                case "TD":
                                    drwCSP_LT["TPLT"] = SLTD_P_LT;
                                    break;
                                case "VC":
                                    drwCSP_LT["TPLT"] = SLVC_P_LT;
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                    //dsCustomerData.AcceptChanges();
                }
                else
                {
                    //Treo thao cung ngay                   
                    string strMa_DDoChinh_1 = "";
                    string strMa_DDoPhu_1 = "";
                    string strMa_CToChinh_1 = "";
                    string strMa_CToPhu_1 = "";
                    DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgayC_CCS_1, dNgay_DKyP_1, dNgay_CKyP_1, dNgayP_CCS_1;
                    //Chuan bi du lieu
                    DataSet dsTmp = new DataSet();
                    DataRow drRemove;

                    //Kiem tra xem co chot chi so doi gia nha nuoc hay khong
                    if ((dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'").Length != 0) && (dsCustomerData.Tables["GCS_CHISO_TP"].Select("MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'").Length != 0))
                    {
                        IsExistsCCS = 1;
                    }
                    else
                    {
                        IsExistsCCS = 0;
                    }

                    if (IsExistsCCS == 1)
                    {
                        //Diem do chinh va diem do phu cung  chot chi so doi gia nha nuoc
                        dNgayC_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoChinh + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgayP_CCS_1 = DateTime.Parse(Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoPhu + "' AND LOAI_CHISO = 'CCS'")).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));

                        if (dNgay_CKyC > dNgayC_CCS_1 && dNgay_DKyC <= dNgayC_CCS_1)
                        {
                            //Cong to co chot chi so doi gia nha nuoc
                            #region Truoc doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 > dNgayC_CCS_1 || dNgay_CKyC_1 > dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 > dNgayP_CCS_1 || dNgay_CKyP_1 > dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_TRUOCCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                            }

                            dsTmp.Reset();
                            #endregion

                            #region Sau doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC_1 <= dNgayC_CCS_1 || dNgay_CKyC_1 <= dNgayC_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP_1 <= dNgayP_CCS_1 || dNgay_CKyP_1 <= dNgayP_CCS_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            //Khong chot chi so doi gia nha nuoc
                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh tong san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                            SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                            SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                            SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                            SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                            SLBT_P = SLBT_P - SLBT_P_LT;
                            SLKT_P = SLKT_P - SLKT_P_LT;
                            SLCD_P = SLCD_P - SLCD_P_LT;
                            SLTD_P = SLTD_P - SLTD_P_LT;
                            SLVC_P = SLVC_P - SLVC_P_LT;

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P > 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;
                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;
                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";

                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P > 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }

                                                //Luy tien tru phu
                                                SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_C;
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLVC_P_LT = SLVC_P_LT + SLVC_P;
                                    }
                                }
                                #endregion
                            }

                            //Cap nhat lai gia tri tru phu luy tien
                            dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT_SAUCCS"]);
                            dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                            foreach (DataRowView drwCSP_LT in dwCSP_LT)
                            {
                                switch (Convert.ToString(drwCSP_LT["BCS"]))
                                {
                                    case "KT":
                                        drwCSP_LT["TPLT"] = SLKT_P_LT;
                                        break;
                                    case "BT":
                                        drwCSP_LT["TPLT"] = SLBT_P_LT;
                                        break;
                                    case "CD":
                                        drwCSP_LT["TPLT"] = SLCD_P_LT;
                                        break;
                                    case "TD":
                                        drwCSP_LT["TPLT"] = SLTD_P_LT;
                                        break;
                                    case "VC":
                                        drwCSP_LT["TPLT"] = SLVC_P_LT;
                                        break;
                                    default:
                                        break;
                                }
                            }

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                            }
                            dsTmp.Reset();
                            #endregion
                        }
                        else
                        {
                            //Cong to khong chot chi so doi gia nha nuoc
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                            dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                            for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                                strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                                }
                            }

                            for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                            {
                                drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                                strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                                strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                                dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                                if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                                {
                                    dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                                }
                            }

                            dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                            dwCS.Sort = "ID_CHISO";

                            //Tinh san luong tru phu
                            SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                            SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            #region "KT, BT, CD, TD - KT"
                            if (SLKT_P != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLKT_C + SLBT_C <= SLKT_P)
                                {
                                    //San luong KT va BT cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                    if (SLCD_C <= SLKT_P)
                                    {
                                        //San luong CD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                        SLKT_P = SLKT_P - SLCD_C;

                                        if (SLTD_C <= SLKT_P)
                                        {
                                            //San luong TD cua chinh nho hon phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD cua chinh lon hon phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong CD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong KT va BT cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion

                            if (SLBT_P + SLCD_P + SLTD_P != 0)
                            {
                                SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                if (SLKT_C != 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C + SLCD_C + SLTD_C != 0)
                                    {
                                        //Xu ly KT + BT + CD + TD - BT + TD + CD
                                        #region "KT, BT - BT"
                                        if (SLBT_P != 0)
                                        {
                                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLBT_C <= SLBT_P)
                                            {
                                                //San luong BT, KT chinh nho hon BT phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong BT, KT chinh lon hon BT phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, CD - CD"
                                        if (SLCD_P != 0)
                                        {
                                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLCD_C <= SLCD_P)
                                            {
                                                //San luong CD, KT chinh nho hon CD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong CD, KT chinh lon hon CD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion

                                        #region "KT, TD - TD"
                                        if (SLTD_P != 0)
                                        {
                                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                            if (SLKT_C + SLTD_C <= SLTD_P)
                                            {
                                                //San luong TD, KT chinh nho hon TD phu
                                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                                {
                                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //San luong TD, KT chinh lon hon TD phu
                                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                                SL_SS = 0;
                                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                                //dwCS.Sort = "ID_CHISO";
                                                foreach (DataRowView dr in dwCS)
                                                {
                                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                    //{
                                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                    {
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                    }
                                                    else
                                                    {
                                                        SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                        SL_SS = SL_SS + SL_TP;
                                                    }
                                                    //}
                                                }
                                            }
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        //Xu ly KT - BT + CD + TD
                                        #region "KT - BT + CD + TD"
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                        {
                                            //San luong KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                            SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        }
                                        else
                                        {
                                            //San luong KT chinh lon hon BT + CD + TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }

                                        #endregion
                                    }
                                }
                                else
                                {
                                    //Xu ly BT, CD, TD - BT, CD, TD
                                    #region "BT - BT"
                                    if (SLBT_P > 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT chinh nho hon BT phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        }
                                    }
                                    #endregion

                                    #region "CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD chinh nho hon CD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                        }
                                        else
                                        {
                                            //San luong CD chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        }
                                    }
                                    #endregion

                                    #region "TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD nho hon TD phu
                                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                        }
                                        else
                                        {
                                            //San luong TD lon hon TD phu
                                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }

                                            //Luy tien tru phu
                                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                        }
                                    }
                                    #endregion
                                }
                            }

                            //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                            if (loai_qhe == "11" || loai_qhe == "21")
                            {
                                #region "VC - VC"
                                if (SLVC_P != 0)
                                {
                                    SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLVC_C <= SLVC_P)
                                    {
                                        //San luong VC chinh nho hon VC phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong VC chinh lon hon VC phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                #endregion
                            }

                            //dsTmp.AcceptChanges();

                            //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                        break;
                                    }
                                }
                            }
                            //dsCustomerData.AcceptChanges();
                            dsTmp.Reset();
                        }
                    }
                    else
                    {
                        //Khong cung chot chi so doi gia nha nuoc
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                        dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                        for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                            strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_DKyC > dNgay_CKyC_1 || dNgay_CKyC < dNgay_DKyC_1)
                            {
                                dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                            }
                        }

                        for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                        {
                            drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                            strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                            strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                            dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                            if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_DKyP > dNgay_CKyP_1 || dNgay_CKyP < dNgay_DKyP_1)
                            {
                                dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                            }
                        }

                        dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                        dwCS.Sort = "ID_CHISO";

                        //Tinh san luong tru phu
                        SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                        SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        #region "KT, BT, CD, TD - KT"
                        if (SLKT_P != 0)
                        {
                            SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLKT_C + SLBT_C <= SLKT_P)
                            {
                                //San luong KT va BT cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                                if (SLCD_C <= SLKT_P)
                                {
                                    //San luong CD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                    SLKT_P = SLKT_P - SLCD_C;

                                    if (SLTD_C <= SLKT_P)
                                    {
                                        //San luong TD cua chinh nho hon phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        //San luong TD cua chinh lon hon phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong CD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            else
                            {
                                //San luong KT va BT cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }
                            }
                        }
                        #endregion

                        if (SLBT_P + SLCD_P + SLTD_P != 0)
                        {
                            SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            if (SLKT_C != 0)
                            {
                                SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLBT_C + SLCD_C + SLTD_C != 0)
                                {
                                    //Xu ly KT + BT + CD + TD - BT + TD + CD
                                    #region "KT, BT - BT"
                                    if (SLBT_P != 0)
                                    {
                                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLBT_C <= SLBT_P)
                                        {
                                            //San luong BT, KT chinh nho hon BT phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong BT, KT chinh lon hon BT phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, CD - CD"
                                    if (SLCD_P != 0)
                                    {
                                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLCD_C <= SLCD_P)
                                        {
                                            //San luong CD, KT chinh nho hon CD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong CD, KT chinh lon hon CD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "KT, TD - TD"
                                    if (SLTD_P != 0)
                                    {
                                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                        if (SLKT_C + SLTD_C <= SLTD_P)
                                        {
                                            //San luong TD, KT chinh nho hon TD phu
                                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                            {
                                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            //San luong TD, KT chinh lon hon TD phu
                                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                            SL_SS = 0;
                                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                                            //dwCS.Sort = "ID_CHISO";
                                            foreach (DataRowView dr in dwCS)
                                            {
                                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                                //{
                                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                                {
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                                }
                                                else
                                                {
                                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                    SL_SS = SL_SS + SL_TP;
                                                }
                                                //}
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //Xu ly KT - BT + CD + TD
                                    #region "KT - BT + CD + TD"
                                    SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLKT_C <= SLBT_P + SLCD_P + SLTD_P)
                                    {
                                        //San luong KT chinh nho hon BT phu
                                        foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "KT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLCD_P_LT = SLCD_P_LT + Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                        SLTD_P_LT = SLTD_P_LT + SLKT_C - Math.Round(SLKT_C * SLBT_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero) - Math.Round(SLKT_C * SLCD_P / (SLBT_P + SLCD_P + SLTD_P), 0, MidpointRounding.AwayFromZero);
                                    }
                                    else
                                    {
                                        //San luong KT chinh lon hon BT + CD + TD phu
                                        IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P + SLCD_P + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round((SLBT_P + SLCD_P + SLTD_P) * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }

                                    #endregion
                                }
                            }
                            else
                            {
                                //Xu ly BT, CD, TD - BT, CD, TD
                                #region "BT - BT"
                                if (SLBT_P > 0)
                                {
                                    SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLBT_C <= SLBT_P)
                                    {
                                        //San luong BT chinh nho hon BT phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "BT")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_C;
                                    }
                                    else
                                    {
                                        //San luong BT, KT chinh lon hon BT phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLBT_P_LT = SLBT_P_LT + SLBT_P;
                                    }
                                }
                                #endregion

                                #region "CD - CD"
                                if (SLCD_P != 0)
                                {
                                    SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLCD_C <= SLCD_P)
                                    {
                                        //San luong CD chinh nho hon CD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "CD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_C;
                                    }
                                    else
                                    {
                                        //San luong CD chinh lon hon CD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLCD_P_LT = SLCD_P_LT + SLCD_P;
                                    }
                                }
                                #endregion

                                #region "TD - TD"
                                if (SLTD_P != 0)
                                {
                                    SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                    if (SLTD_C <= SLTD_P)
                                    {
                                        //San luong TD nho hon TD phu
                                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                        {
                                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToString(dr["BCS"]) == "TD")
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                            }
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_C;
                                    }
                                    else
                                    {
                                        //San luong TD lon hon TD phu
                                        IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                        SL_SS = 0;
                                        //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                        //dwCS.Sort = "ID_CHISO";
                                        foreach (DataRowView dr in dwCS)
                                        {
                                            //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                            //{
                                            if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                            {
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                            }
                                            else
                                            {
                                                SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll), 0, MidpointRounding.AwayFromZero);
                                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                                SL_SS = SL_SS + SL_TP;
                                            }
                                            //}
                                        }

                                        //Luy tien tru phu
                                        SLTD_P_LT = SLTD_P_LT + SLTD_P;
                                    }
                                }
                                #endregion
                            }
                        }

                        //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                        if (loai_qhe == "11" || loai_qhe == "21")
                        {
                            #region "VC - VC"
                            if (SLVC_P != 0)
                            {
                                SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                                if (SLVC_C <= SLVC_P)
                                {
                                    //San luong VC chinh nho hon VC phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong VC chinh lon hon VC phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            #endregion
                        }

                        //dsTmp.AcceptChanges(); --

                        //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                    break;
                                }
                            }
                        }
                        //dsCustomerData.AcceptChanges();
                        dsTmp.Reset();
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_2: " + ex.Message;
            }
        }

        #endregion
        #region ParentChildDataCalculation_GT2 kiểu cũ
        /*
        private string ParentChildDataCalculation_GT2(DataSet dsCustomerData, string strMa_DDoChinh, string strMa_DDoPhu, string strMa_CToChinh, string strMa_CToPhu, DateTime dNgay_DKyC, DateTime dNgay_CKyC, DateTime dNgay_DKyP, DateTime dNgay_CKyP, string loai_qhe, decimal hstp)
        {
            try
            {
                Decimal SLKT_P = 0, SLBT_P = 0, SLCD_P = 0, SLTD_P = 0, SLVC_P = 0;
                Decimal SLKT_P_LT = 0, SLBT_P_LT = 0, SLCD_P_LT = 0, SLTD_P_LT = 0, SLVC_P_LT = 0;
                Decimal SLKT_C = 0, SLBT_C = 0, SLCD_C = 0, SLTD_C = 0, SLVC_C = 0;
                Decimal SLKT_CAll = 0, SLBT_CAll = 0, SLCD_CAll = 0, SLTD_CAll = 0, SLVC_CAll = 0;
                Decimal SL_SS = 0, SL_TP = 0;
                DataView dwCS;

                Int64 IDMax = 0;
                if (strMa_CToChinh == "x")
                {
                    dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                    dwCS.Sort = "ID_CHISO";

                    //Tinh tong san luong tru phu
                    SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLVC_P = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                    SLBT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT'"));
                    SLKT_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT'"));
                    SLCD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD'"));
                    SLTD_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD'"));
                    SLVC_P_LT = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP_LT"].Compute("SUM(TPLT)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC'"));

                    SLBT_P = SLBT_P - SLBT_P_LT;
                    SLKT_P = SLKT_P - SLKT_P_LT;
                    SLCD_P = SLCD_P - SLCD_P_LT;
                    SLTD_P = SLTD_P - SLTD_P_LT;
                    SLVC_P = SLVC_P - SLVC_P_LT;

                    SLBT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLKT_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLCD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLTD_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLVC_CAll = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                    #region "KT, BT, CD, TD - KT"
                    if (SLKT_P != 0)
                    {
                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLBT_C <= SLKT_P)
                        {
                            //San luong KT va BT cua chinh nho hon phu
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }
                            SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                            //Luy tien tru phu
                            SLKT_P_LT = SLKT_P_LT + (SLKT_C + SLBT_C);

                            if (SLCD_C <= SLKT_P)
                            {
                                //San luong CD cua chinh nho hon phu
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLCD_C;

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLCD_C;

                                if (SLTD_C <= SLKT_P)
                                {
                                    //San luong TD cua chinh nho hon phu
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLTD_C;
                                }
                                else
                                {
                                    //San luong TD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }

                                    //Luy tien tru phu
                                    SLKT_P_LT = SLKT_P_LT + SLKT_P;
                                }
                            }
                            else
                            {
                                //San luong CD cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLKT_P_LT = SLKT_P_LT + SLKT_P;
                            }
                        }
                        else
                        {
                            //San luong KT va BT cua chinh lon hon phu
                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }

                            //Luy tien tru phu
                            SLKT_P_LT = SLKT_P_LT + SLKT_P;
                        }
                    }
                    #endregion

                    #region "KT, BT - BT"
                    if (SLBT_P != 0)
                    {
                        SLBT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLBT_C <= SLBT_P)
                        {
                            //San luong BT, KT chinh nho hon BT phu
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }

                            //Luy tien tru phu
                            SLBT_P_LT = SLBT_P_LT + (SLKT_C + SLBT_C);
                        }
                        else
                        {
                            //San luong BT, KT chinh lon hon BT phu
                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }

                            //Luy tien tru phu
                            SLBT_P_LT = SLBT_P_LT + SLBT_P;
                        }
                    }
                    #endregion

                    #region "KT, CD - CD"
                    if (SLCD_P != 0)
                    {
                        SLCD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLCD_C <= SLCD_P)
                        {
                            //San luong CD, KT chinh nho hon CD phu
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }

                            //Luy tien tru phu
                            SLCD_P_LT = SLCD_P_LT + (SLKT_C + SLCD_C);
                        }
                        else
                        {
                            //San luong CD, KT chinh lon hon CD phu
                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }

                            //Luy tien tru phu
                            SLCD_P_LT = SLCD_P_LT + SLCD_P;
                        }
                    }
                    #endregion

                    #region "KT, TD - TD"
                    if (SLTD_P != 0)
                    {
                        SLTD_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLTD_C <= SLTD_P)
                        {
                            //San luong TD, KT chinh nho hon TD phu
                            foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }

                            //Luy tien tru phu
                            SLTD_P_LT = SLTD_P_LT + (SLKT_C + SLTD_C);
                        }
                        else
                        {
                            //San luong TD, KT chinh lon hon TD phu
                            IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }

                            //Luy tien tru phu
                            SLTD_P_LT = SLTD_P_LT + SLTD_P;
                        }
                    }
                    #endregion

                    //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                    if (loai_qhe == "11" || loai_qhe == "21")
                    {
                        #region "VC - VC"
                        if (SLVC_P != 0)
                        {
                            SLVC_C = Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLVC_C <= SLVC_P)
                            {
                                //San luong VC chinh nho hon VC phu
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }

                                //Luy tien tru phu
                                SLVC_P_LT = SLVC_P_LT + SLVC_C;
                            }
                            else
                            {
                                //San luong VC chinh lon hon VC phu
                                IDMax = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }

                                //Luy tien tru phu
                                SLVC_P_LT = SLVC_P_LT + SLVC_P;
                            }
                        }
                        #endregion
                    }

                    //Cap nhat lai gia tri tru phu luy tien
                    DataView dwCSP_LT = new DataView(dsCustomerData.Tables["GCS_CHISO_TP_LT"]);
                    dwCSP_LT.RowFilter = "MA_DDO = '" + strMa_DDoPhu + "'";
                    foreach (DataRowView drwCSP_LT in dwCSP_LT)
                    {
                        switch (Convert.ToString(drwCSP_LT["BCS"]))
                        {
                            case "KT":
                                drwCSP_LT["TPLT"] = SLKT_P_LT;
                                break;
                            case "BT":
                                drwCSP_LT["TPLT"] = SLBT_P_LT;
                                break;
                            case "CD":
                                drwCSP_LT["TPLT"] = SLCD_P_LT;
                                break;
                            case "TD":
                                drwCSP_LT["TPLT"] = SLTD_P_LT;
                                break;
                            case "VC":
                                drwCSP_LT["TPLT"] = SLVC_P_LT;
                                break;
                            default:
                                break;
                        }
                    }

                    //dsCustomerData.AcceptChanges();
                }
                else
                {
                    string strMa_DDoChinh_1 = "";
                    string strMa_DDoPhu_1 = "";
                    string strMa_CToChinh_1 = "";
                    string strMa_CToPhu_1 = "";
                    DateTime dNgay_DKyC_1, dNgay_CKyC_1, dNgay_DKyP_1, dNgay_CKyP_1;

                    //Chuan bi du lieu
                    DataSet dsTmp = new DataSet();
                    dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_GT"].Copy());
                    dsTmp.Tables.Add(dsCustomerData.Tables["GCS_CHISO_TP"].Copy());

                    DataRow drRemove;
                    for (int i = dsTmp.Tables["GCS_CHISO_GT"].Rows.Count - 1; i >= 0; i--)
                    {
                        drRemove = dsTmp.Tables["GCS_CHISO_GT"].Rows[i];
                        strMa_DDoChinh_1 = Convert.ToString(drRemove["MA_DDO"]);
                        strMa_CToChinh_1 = Convert.ToString(drRemove["MA_CTO"]);
                        dNgay_CKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgay_DKyC_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        if (strMa_DDoChinh != strMa_DDoChinh_1 || strMa_CToChinh != strMa_CToChinh_1 || dNgay_CKyC != dNgay_CKyC_1 || dNgay_DKyC != dNgay_DKyC_1)
                        {
                            dsTmp.Tables["GCS_CHISO_GT"].Rows.RemoveAt(i);
                        }
                    }

                    for (int i = dsTmp.Tables["GCS_CHISO_TP"].Rows.Count - 1; i >= 0; i--)
                    {
                        drRemove = dsTmp.Tables["GCS_CHISO_TP"].Rows[i];
                        strMa_DDoPhu_1 = Convert.ToString(drRemove["MA_DDO"]);
                        strMa_CToPhu_1 = Convert.ToString(drRemove["MA_CTO"]);
                        dNgay_CKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_CKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        dNgay_DKyP_1 = DateTime.Parse(Convert.ToDateTime(drRemove["NGAY_DKY"]).ToString("dd/MM/yyyy", new System.Globalization.CultureInfo("vi-VN")), new System.Globalization.CultureInfo("vi-VN"));
                        if (strMa_DDoPhu != strMa_DDoPhu_1 || strMa_CToPhu != strMa_CToPhu_1 || dNgay_CKyP != dNgay_CKyP_1 || dNgay_DKyP != dNgay_DKyP_1)
                        {
                            dsTmp.Tables["GCS_CHISO_TP"].Rows.RemoveAt(i);
                        }
                    }

                    dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "'";
                    dwCS.Sort = "ID_CHISO";

                    //Tinh san luong tru phu
                    SLBT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLKT_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLCD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLTD_P = Math.Round(hstp * (Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"))), 0, MidpointRounding.AwayFromZero);
                    SLVC_P = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoPhu + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                    SLBT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLKT_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLCD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLTD_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                    SLVC_CAll = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                    #region "KT, BT, CD, TD - KT"
                    if (SLKT_P != 0)
                    {
                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLBT_C <= SLKT_P)
                        {
                            //San luong KT va BT cua chinh nho hon phu
                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }
                            SLKT_P = SLKT_P - SLKT_C - SLBT_C;

                            if (SLCD_C <= SLKT_P)
                            {
                                //San luong CD cua chinh nho hon phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                                SLKT_P = SLKT_P - SLCD_C;

                                if (SLTD_C <= SLKT_P)
                                {
                                    //San luong TD cua chinh nho hon phu
                                    foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                        }
                                    }
                                }
                                else
                                {
                                    //San luong TD cua chinh lon hon phu
                                    IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                    SL_SS = 0;
                                    //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                    dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD')";
                                    //dwCS.Sort = "ID_CHISO";
                                    foreach (DataRowView dr in dwCS)
                                    {
                                        //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD"))
                                        //{
                                        if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                        {
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                        }
                                        else
                                        {
                                            SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLTD_CAll, 0, MidpointRounding.AwayFromZero);
                                            dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                            SL_SS = SL_SS + SL_TP;
                                        }
                                        //}
                                    }
                                }
                            }
                            else
                            {
                                //San luong CD cua chinh lon hon phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLCD_CAll, 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }
                            }
                        }
                        else
                        {
                            //San luong KT va BT cua chinh lon hon phu
                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLKT_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLKT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }
                        }
                    }
                    #endregion

                    #region "KT, BT - BT"
                    if (SLBT_P != 0)
                    {
                        SLBT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'BT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLBT_C <= SLBT_P)
                        {
                            //San luong BT, KT chinh nho hon BT phu
                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "BT" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }
                        }
                        else
                        {
                            //San luong BT, KT chinh lon hon BT phu
                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','BT') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('BT','KT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "BT"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLBT_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLBT_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLBT_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }
                        }
                    }
                    #endregion

                    #region "KT, CD - CD"
                    if (SLCD_P != 0)
                    {
                        SLCD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'CD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLCD_C <= SLCD_P)
                        {
                            //San luong CD, KT chinh nho hon CD phu
                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "CD" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }
                        }
                        else
                        {
                            //San luong CD, KT chinh lon hon CD phu
                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','CD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('CD','KT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "CD"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLCD_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLCD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLCD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }
                        }
                    }
                    #endregion

                    #region "KT, TD - TD"
                    if (SLTD_P != 0)
                    {
                        SLTD_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'TD' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                        SLKT_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'KT' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                        if (SLKT_C + SLTD_C <= SLTD_P)
                        {
                            //San luong TD, KT chinh nho hon TD phu
                            foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                            {
                                if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "TD" || Convert.ToString(dr["BCS"]) == "KT"))
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                }
                            }
                        }
                        else
                        {
                            //San luong TD, KT chinh lon hon TD phu
                            IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('KT','TD') AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                            SL_SS = 0;
                            //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                            dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('TD','KT')";
                            //dwCS.Sort = "ID_CHISO";
                            foreach (DataRowView dr in dwCS)
                            {
                                //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "KT" || Convert.ToString(dr["BCS"]) == "TD"))
                                //{
                                if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                {
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLTD_P - SL_SS;
                                }
                                else
                                {
                                    SL_TP = Math.Round(SLTD_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / (SLTD_CAll + SLKT_CAll), 0, MidpointRounding.AwayFromZero);
                                    dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                    SL_SS = SL_SS + SL_TP;
                                }
                                //}
                            }
                        }
                    }
                    #endregion

                    //Chi tru phu vo cong neu loai quan he tru phu la 11 hoac 21
                    if (loai_qhe == "11" || loai_qhe == "21")
                    {
                        #region "VC - VC"
                        if (SLVC_P != 0)
                        {
                            SLVC_C = Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) + Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')")) - Utility.DecimalDbnull(dsTmp.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));

                            if (SLVC_C <= SLVC_P)
                            {
                                //San luong VC chinh nho hon VC phu
                                foreach (DataRow dr in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"]);
                                    }
                                }
                            }
                            else
                            {
                                //San luong VC chinh lon hon VC phu
                                IDMax = Convert.ToInt64(dsTmp.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDoChinh + "' AND BCS = 'VC' AND LOAI_CHISO IN ('DDN','DDK','CCS','CSC')"));
                                SL_SS = 0;
                                //dwCS = new DataView(dsTmp.Tables["GCS_CHISO_GT"]);
                                dwCS.RowFilter = "MA_DDO = '" + strMa_DDoChinh + "' AND BCS IN ('VC')";
                                //dwCS.Sort = "ID_CHISO";
                                foreach (DataRowView dr in dwCS)
                                {
                                    //if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && (Convert.ToString(dr["BCS"]) == "VC"))
                                    //{
                                    if (Convert.ToInt64(dr["ID_CHISO"]) == IDMax)
                                    {
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SLVC_P - SL_SS;
                                    }
                                    else
                                    {
                                        SL_TP = Math.Round(SLVC_P * (Convert.ToDecimal(dr["SAN_LUONG"]) + Convert.ToDecimal(dr["SLUONG_TTIEP"])) / SLVC_CAll, 0, MidpointRounding.AwayFromZero);
                                        dr["SLUONG_TRPHU"] = Convert.ToDecimal(dr["SLUONG_TRPHU"]) + SL_TP;
                                        SL_SS = SL_SS + SL_TP;
                                    }
                                    //}
                                }
                            }
                        }
                        #endregion
                    }

                    //dsTmp.AcceptChanges();

                    //Cap nhat san luong tru phu tu dsTmp ve dsCustomerData
                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                    {
                        foreach (DataRow drTmp in dsTmp.Tables["GCS_CHISO_GT"].Rows)
                        {
                            if (Convert.ToString(dr["MA_DDO"]) == strMa_DDoChinh && Convert.ToInt64(dr["ID_CHISO"]) == Convert.ToInt64(drTmp["ID_CHISO"]))
                            {
                                dr["SLUONG_TRPHU"] = Convert.ToDecimal(drTmp["SLUONG_TRPHU"]);
                                break;
                            }
                        }
                    }
                    //dsCustomerData.AcceptChanges();
                    dsTmp.Reset();
                }
                return "";
            }
            catch (Exception ex)
            {
                return "ParentChildDataCalculation_GT2: " + ex.Message;
            }
        }
        */
        #endregion
        //Tinh cosfi cua cac diem do chinh
        public string RawDataCalculation_5_Backup_moi_nhat(DataSet dsCustomerData, DataSet dsInvoiceData, DataSet dsStaticCatalog, string strTen_DNhap)
        {
            string strMa_DDo = "", strMa_DDoP = "";
            try
            {
                DataRow[] rows, drDDo, drParameters;
                DataRow drHDonCosfi;
                Double hc = 0, vc = 0, hc_tp = 0, hc_1358 = 0;
                Decimal cosfi = 0, kcosfi = 0;
                Decimal min = 0, heso_truphu;
                DataView dwTP, dwCSKT, dwCSVC, dwDDo_SoGCS, dwVTri_DDo, dwDDo;
                Int16 IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0, IsExistsTreoThao = 0, IsTinhCosfi = 0;

                if (dsStaticCatalog == null)
                    return "dsStaticCatalog"; //du lieu truyen vao bi null
                else
                    if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                        return "NotExistsD_COSFI"; //khong ton tai bang D_COSFI

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                        return "NotExistsGCS_CHISO"; //khong ton tai bang GCS_CHISO
                    else
                        if (dsCustomerData.Tables.Contains("HDG_DDO_SOGCS") == false)
                            return "NotExistsHDG_DDO_SOGCS";
                        else
                            if (dsCustomerData.Tables.Contains("HDG_VITRI_DDO") == false)
                                return "NotExistsHDG_VITRI_DDO";
                            else
                                if (dsCustomerData.Tables.Contains("HDG_DIEM_DO") == false)
                                    return "NotExistsHDG_DIEM_DO";

                if (dsInvoiceData == null)
                    return "dsInvoiceDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsInvoiceData.Tables.Contains("HDN_HDONCOSFI") == false)
                        return "NotExistsHDN_HDONCOSFI"; //khong ton tai bang HDN_HDONCOSFI

                //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                {
                    drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                    if (drParameters.Length > 0)
                    {
                        //Co ton tai tham so
                        IsExistsParam = 1;
                    }
                }

                //Khoi tao dataview
                dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwCSKT.RowFilter = "BCS = 'KT'";
                dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwCSVC.RowFilter = "BCS = 'VC'";
                dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                dwTP.RowFilter = "LOAI_QHE IN ('10','11')";

                dwDDo_SoGCS = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                if (dwDDo_SoGCS.Count != 0)
                {
                    dwDDo_SoGCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo_SoGCS[0]["MA_DVIQLY"]) + "'";
                }
                dwDDo_SoGCS.Sort = "NGAY_HLUC DESC";

                dwVTri_DDo = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                if (dwVTri_DDo.Count != 0)
                {
                    dwVTri_DDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwVTri_DDo[0]["MA_DVIQLY"]) + "'";
                }
                dwVTri_DDo.Sort = "NGAY_HLUC DESC";

                dwDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                if (dwDDo.Count != 0)
                {
                    dwDDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo[0]["MA_DVIQLY"]) + "'";
                }
                dwDDo.Sort = "NGAY_HLUC DESC";

                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                {
                    strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                    if (strMa_DDo == "PD01000010067001")
                    {
                    }
                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'");
                    if (rows.Length != 0)
                    {
                        //Co dong chi so vo cong
                        if (dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'").Length == 0)
                        {
                            hc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"));
                            vc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                            //Kiem tra xem co treo thao tu loai 1 sang 3,5,8 hoac nguoc lai
                            hc_1358 = 0;
                            //dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                            dwCSKT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT'";
                            //dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                            if (dwCSKT.Count == 0)
                            {
                                //Khong co dong KT
                                hc_1358 = 0;
                            }
                            else
                            {
                                //Co dong KT, thuc hien kiem tra xem co dong VC di kem hay khong
                                //dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCSVC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'";
                                //dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                                //foreach (DataRowView drvCSKT in dwCSKT)
                                //{
                                //    IsExistsTreoThao = 0; //Khong ton tai treo thao tu cong to co sang cong to dien tu hoac nguoc lai
                                //    foreach (DataRowView drvCSVC in dwCSVC)
                                //    {
                                //        if (Convert.ToDateTime(drvCSKT["NGAY_CKY"]) == Convert.ToDateTime(drvCSVC["NGAY_CKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) == Convert.ToDateTime(drvCSVC["NGAY_DKY"]))
                                //        {
                                //            IsExistsTreoThao = 1;
                                //            break;
                                //        }
                                //    }
                                //    //Khong ton tai VC cung ngay dau ky va ngay cuoi ky voi KT
                                //    if (IsExistsTreoThao == 0)
                                //    {
                                //        hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                //    }
                                //}
                                //Loc cac san luong KT khong dung de tinh cosfi
                                foreach (DataRowView drvCSKT in dwCSKT)
                                {
                                    IsTinhCosfi = 0; //Khong dung de tinh cosfi
                                    foreach (DataRowView drvCSVC in dwCSVC)
                                    {
                                        if (Convert.ToDateTime(drvCSKT["NGAY_DKY"]) >= Convert.ToDateTime(drvCSVC["NGAY_DKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) <= Convert.ToDateTime(drvCSVC["NGAY_CKY"]))
                                        {
                                            IsTinhCosfi = 1;
                                            break;
                                        }
                                    }
                                    //Khong ton tai VC chua ngay dau ky KT, loai bo san luong nay khoi thanh phan HC tinh cosfi
                                    if (IsTinhCosfi == 0)
                                    {
                                        //hc1358: tong cac san luong KT khong dung de tinh cosfi
                                        hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                    }
                                }
                            }
                            hc = hc - hc_1358;

                            //Hieu chinh lai san luong hc va vc doi voi cac truong hop sau
                            //Diem do co quan he tru phu 10, 11 tuc la tru phu huu cong khi tinh tien dien, khong tru phu huu cong khi tinh cosfi
                            if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                            {
                                //dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                hc_tp = 0;
                                foreach (DataRowView drTP in dwTP)
                                {
                                    strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                    //Xu ly doi voi SHBB va SXD1
                                    IsExistsSHBB = 0;
                                    IsExistsSXD1 = 0;
                                    //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                    if (IsExistsParam == 1)
                                    {
                                        if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                                        {
                                            drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                            if (drDDo.Length > 0)
                                            {
                                                IsExistsSHBB = 1;
                                            }
                                            else
                                            {
                                                IsExistsSHBB = 0;
                                            }

                                            drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                            if (drDDo.Length > 0)
                                            {
                                                IsExistsSXD1 = 1;
                                            }
                                            else
                                            {
                                                IsExistsSXD1 = 0;
                                            }

                                            if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                            {
                                                heso_truphu = Convert.ToDecimal(1.1);
                                            }
                                            else
                                            {
                                                heso_truphu = Convert.ToDecimal(1.0);
                                            }
                                        }
                                        else
                                        {
                                            heso_truphu = Convert.ToDecimal(1.0);
                                        }
                                    }
                                    else
                                    {
                                        heso_truphu = Convert.ToDecimal(1.0);
                                    }

                                    hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                }
                                hc = hc + hc_tp;
                            }

                            if (hc == 0)
                                if (vc == 0)
                                    cosfi = 1;
                                else
                                    cosfi = 0;
                            else
                            {
                                cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                            }

                            min = 1000;
                            kcosfi = 0;
                            foreach (DataRow drcosfi in dsStaticCatalog.Tables["D_COSFI"].Rows)
                            {
                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                {
                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                    {
                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                    }
                                }
                            }

                            if (hc != 0 || vc != 0)
                            {
                                //Day du lieu vao HDN_HDONCOSFI    
                                drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                drHDonCosfi["ID_HDONCOSFI"] = 0;
                                drHDonCosfi["ID_HDON"] = 0;
                                drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                drHDonCosfi["NAM"] = dr["NAM"];
                                drHDonCosfi["THANG"] = dr["THANG"];
                                drHDonCosfi["KY"] = dr["KY"];

                                //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                //dw.Sort = "NGAY_HLUC DESC";
                                //if (dw.Count == 0)
                                if (dwDDo_SoGCS.Count == 0)
                                {
                                    drHDonCosfi["MA_SOGCS"] = "";
                                    drHDonCosfi["MA_KVUC"] = "";
                                    drHDonCosfi["STT"] = "";
                                }
                                else
                                {
                                    //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                    //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                    //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                    drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                    drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                    drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                }

                                //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                //dw.Sort = "NGAY_HLUC DESC";
                                //if (dw.Count == 0)
                                if (dwVTri_DDo.Count == 0)
                                {
                                    drHDonCosfi["MA_LO"] = "";
                                    drHDonCosfi["MA_TRAM"] = "";
                                    drHDonCosfi["MA_TO"] = "";
                                }
                                else
                                {
                                    //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                    //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                    //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                    drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                    drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                    drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                }

                                drHDonCosfi["HUU_CONG"] = hc;
                                drHDonCosfi["VO_CONG"] = vc;
                                drHDonCosfi["TIEN_HUUCONG"] = 0;
                                drHDonCosfi["COSFI"] = cosfi;
                                drHDonCosfi["KCOSFI"] = kcosfi;
                                drHDonCosfi["TIEN_VOCONG"] = 0;

                                //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                //dw.Sort = "NGAY_HLUC DESC";
                                //if (dw.Count == 0)
                                if (dwDDo.Count == 0)
                                {
                                    drHDonCosfi["KIMUA_CSPK"] = 0;
                                }
                                else
                                {
                                    //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                    drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                }

                                drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                if (hc_1358 != 0)
                                {
                                    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                    drHDonCosfi["MA_CNANG"] = 1;
                                }
                                else
                                {
                                    //Mac dinh la = 0
                                    drHDonCosfi["MA_CNANG"] = 0;
                                }
                                dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                            }
                        }
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_5: " + ex.Message + " - " + strMa_DDo;
            }
            //finally
            //{
            //    dsInvoiceData.AcceptChanges();
            //    dsCustomerData.AcceptChanges();
            //}
        }

        //Tinh cosfi cua cac diem do phu ghep tong
        public string RawDataCalculation_6_Backup_moi_nhat(DataSet dsCustomerData, DataSet dsInvoiceData, DataSet dsStaticCatalog, string strTen_DNhap)
        {
            try
            {
                string strMa_DDo = "", strMa_DDoP = "";
                DataRow[] rows, drDDo, drParameters;
                DataRow drHDonCosfi;
                Double hc = 0, vc = 0, hc_tp = 0, hc_1358 = 0;
                Decimal cosfi = 0, kcosfi = 0;
                Decimal min = 0, heso_truphu;
                DataView dwTP, dwCSKT, dwCSVC, dwDDo_SoGCS, dwVTri_DDo, dwDDo;
                Int16 IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0, IsExistsTreoThao = 0, IsTinhCosfi = 0;

                if (dsStaticCatalog == null)
                    return "dsStaticCatalog"; //du lieu truyen vao bi null
                else
                    if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                        return "NotExistsD_COSFI"; //khong ton tai bang D_COSFI

                if (dsInvoiceData == null)
                    return "dsInvoiceDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsInvoiceData.Tables.Contains("HDN_HDONCOSFI") == false)
                        return "NotExistsHDN_HDONCOSFI"; //khong ton tai bang HDN_HDONCOSFI

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null                    
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                    //Co bang GCS_CHISO_GT
                    {
                        //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                        if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                        {
                            drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                            if (drParameters.Length > 0)
                            {
                                //Co ton tai tham so
                                IsExistsParam = 1;
                            }
                        }

                        //Khoi tao cac dataview
                        dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCSKT.RowFilter = "BCS = 'KT'";
                        dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                        dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCSVC.RowFilter = "BCS = 'VC'";
                        dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                        dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                        dwTP.RowFilter = "LOAI_QHE IN ('10','11')";

                        if (dsCustomerData.Tables.Contains("HDG_DDO_SOGCS_GT") == true)
                        {
                            dwDDo_SoGCS = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS_GT"]);
                            if (dwDDo_SoGCS.Count != 0)
                            {
                                dwDDo_SoGCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo_SoGCS[0]["MA_DVIQLY"]) + "'";
                            }
                            dwDDo_SoGCS.Sort = "NGAY_HLUC DESC";
                        }
                        else
                        {
                            dwDDo_SoGCS = null;
                        }

                        if (dsCustomerData.Tables.Contains("HDG_VITRI_DDO_GT") == true)
                        {
                            dwVTri_DDo = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO_GT"]);
                            if (dwVTri_DDo.Count != 0)
                            {
                                dwVTri_DDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwVTri_DDo[0]["MA_DVIQLY"]) + "'";
                            }
                            dwVTri_DDo.Sort = "NGAY_HLUC DESC";
                        }
                        else
                        {
                            dwVTri_DDo = null;
                        }

                        if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == true)
                        {
                            dwDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                            if (dwDDo.Count != 0)
                            {
                                dwDDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo[0]["MA_DVIQLY"]) + "'";
                            }
                            dwDDo.Sort = "NGAY_HLUC DESC";
                        }
                        else
                        {
                            dwDDo = null;
                        }

                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                            string strMaSoGCS = "";
                            var arrMaSoGCS = dsCustomerData.Tables["HDG_DDO_SOGCS_GT"].AsEnumerable().Where(c => c.Field<string>("MA_DDO") == strMa_DDo);
                            if (arrMaSoGCS != null && arrMaSoGCS.Count() > 0)
                                strMaSoGCS = arrMaSoGCS.First()["MA_SOGCS"].ToString();
                            else strMaSoGCS = " ";
                            rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'");
                            if (rows.Length != 0)
                            {
                                //Co dong chi so vo cong
                                if (dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'").Length == 0)
                                {
                                    hc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"));
                                    vc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                    //Kiem tra xem co treo thao tu loai 1 sang 3,5,8 hoac nguoc lai
                                    hc_1358 = 0;
                                    //dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCSKT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT'";
                                    //dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                                    if (dwCSKT.Count == 0)
                                    {
                                        //Khong co dong KT
                                        hc_1358 = 0;
                                    }
                                    else
                                    {
                                        //Co dong KT, thuc hien kiem tra xem co dong VC di kem hay khong
                                        //dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCSVC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'";
                                        //dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";
                                        //foreach (DataRowView drvCSKT in dwCSKT)
                                        //{
                                        //    IsExistsTreoThao = 0; //Khong ton tai treo thao tu cong to co sang cong to dien tu hoac nguoc lai
                                        //    foreach (DataRowView drvCSVC in dwCSVC)
                                        //    {
                                        //        if (Convert.ToDateTime(drvCSKT["NGAY_CKY"]) == Convert.ToDateTime(drvCSVC["NGAY_CKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) == Convert.ToDateTime(drvCSVC["NGAY_DKY"]))
                                        //        {
                                        //            IsExistsTreoThao = 1;
                                        //            break;
                                        //        }
                                        //    }
                                        //    //Khong ton tai VC cung ngay dau ky va ngay cuoi ky voi KT
                                        //    if (IsExistsTreoThao == 0)
                                        //    {
                                        //        hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                        //    }
                                        //}

                                        //Loc cac san luong KT khong dung de tinh cosfi
                                        foreach (DataRowView drvCSKT in dwCSKT)
                                        {
                                            IsTinhCosfi = 0; //Khong dung de tinh cosfi
                                            foreach (DataRowView drvCSVC in dwCSVC)
                                            {
                                                if (Convert.ToDateTime(drvCSKT["NGAY_DKY"]) >= Convert.ToDateTime(drvCSVC["NGAY_DKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) <= Convert.ToDateTime(drvCSVC["NGAY_CKY"]))
                                                {
                                                    IsTinhCosfi = 1;
                                                    break;
                                                }
                                            }
                                            //Khong ton tai VC chua ngay dau ky KT, loai bo san luong nay khoi thanh phan HC tinh cosfi
                                            if (IsTinhCosfi == 0)
                                            {
                                                //hc1358: tong cac san luong KT khong dung de tinh cosfi
                                                hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                            }
                                        }
                                    }
                                    hc = hc - hc_1358;

                                    //Hieu chinh lai san luong hc va vc doi voi cac truong hop sau
                                    //Diem do co quan he tru phu 10, 11 tuc la tru phu huu cong khi tinh tien dien, khong tru phu huu cong khi tinh cosfi
                                    if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                    {
                                        //dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                        dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                        hc_tp = 0;
                                        foreach (DataRowView drTP in dwTP)
                                        {
                                            strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                            //Xu ly doi voi SHBB va SXD1
                                            IsExistsSHBB = 0;
                                            IsExistsSXD1 = 0;
                                            //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                            if (IsExistsParam == 1)
                                            {
                                                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                                                {
                                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                    if (drDDo.Length > 0)
                                                    {
                                                        IsExistsSHBB = 1;
                                                    }
                                                    else
                                                    {
                                                        IsExistsSHBB = 0;
                                                    }

                                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                    if (drDDo.Length > 0)
                                                    {
                                                        IsExistsSXD1 = 1;
                                                    }
                                                    else
                                                    {
                                                        IsExistsSXD1 = 0;
                                                    }

                                                    if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                    {
                                                        heso_truphu = Convert.ToDecimal(1.1);
                                                    }
                                                    else
                                                    {
                                                        heso_truphu = Convert.ToDecimal(1.0);
                                                    }
                                                }
                                                else
                                                {
                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                }
                                            }
                                            else
                                            {
                                                heso_truphu = Convert.ToDecimal(1.0);
                                            }

                                            hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                        }
                                        hc = hc + hc_tp;
                                    }

                                    if (hc == 0)
                                        if (vc == 0)
                                            cosfi = 1;
                                        else
                                            cosfi = 0;
                                    else
                                    {
                                        cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                    }

                                    min = 1000;
                                    kcosfi = 0;
                                    foreach (DataRow drcosfi in dsStaticCatalog.Tables["D_COSFI"].Rows)
                                    {
                                        if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                        {
                                            if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                            {
                                                min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                            }
                                        }
                                    }

                                    if (hc != 0 || vc != 0)
                                    {
                                        //Day du lieu vao HDN_HDONCOSFI    
                                        drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                        drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                        drHDonCosfi["ID_HDONCOSFI"] = 0;
                                        drHDonCosfi["ID_HDON"] = 0;
                                        drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                        drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                        //drHDonCosfi["MA_SOGCS"] = strMaSoGCS;
                                        drHDonCosfi["NAM"] = dr["NAM"];
                                        drHDonCosfi["THANG"] = dr["THANG"];
                                        drHDonCosfi["KY"] = dr["KY"];

                                        if (dsCustomerData.Tables.Contains("HDG_DDO_SOGCS_GT") == true)
                                        {
                                            //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS_GT"]);
                                            dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            if (dwDDo_SoGCS.Count == 0)
                                            {
                                                drHDonCosfi["MA_SOGCS"] = "";
                                                drHDonCosfi["MA_KVUC"] = "";
                                                drHDonCosfi["STT"] = "";
                                            }
                                            else
                                            {
                                                drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                            }
                                        }
                                        else
                                        {
                                            drHDonCosfi["MA_SOGCS"] = "";
                                            drHDonCosfi["MA_KVUC"] = "";
                                            drHDonCosfi["STT"] = "";
                                        }

                                        if (dsCustomerData.Tables.Contains("HDG_VITRI_DDO_GT") == true)
                                        {
                                            //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO_GT"]);
                                            dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            if (dwVTri_DDo.Count == 0)
                                            {
                                                drHDonCosfi["MA_LO"] = "";
                                                drHDonCosfi["MA_TRAM"] = "";
                                                drHDonCosfi["MA_TO"] = "";
                                            }
                                            else
                                            {
                                                drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                            }
                                        }
                                        else
                                        {
                                            drHDonCosfi["MA_LO"] = "";
                                            drHDonCosfi["MA_TRAM"] = "";
                                            drHDonCosfi["MA_TO"] = "";
                                        }

                                        //drHDonCosfi["MA_KVUC"] = "";
                                        //drHDonCosfi["STT"] = "";
                                        //drHDonCosfi["MA_LO"] = "";
                                        //drHDonCosfi["MA_TRAM"] = "";
                                        //drHDonCosfi["MA_TO"] = "";

                                        drHDonCosfi["HUU_CONG"] = hc;
                                        drHDonCosfi["VO_CONG"] = vc;
                                        drHDonCosfi["TIEN_HUUCONG"] = 0;
                                        drHDonCosfi["COSFI"] = cosfi;
                                        drHDonCosfi["KCOSFI"] = kcosfi;
                                        drHDonCosfi["TIEN_VOCONG"] = 0;
                                        //drHDonCosfi["KIMUA_CSPK"] = 0;

                                        if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == false)
                                        {
                                            drHDonCosfi["KIMUA_CSPK"] = 0;
                                        }
                                        else
                                        {
                                            //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                                            dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            if (dwDDo.Count == 0)
                                            {
                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                            }
                                            else
                                            {
                                                drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                            }
                                        }

                                        drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                        drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                        drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                        drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                        drHDonCosfi["MA_CNANG"] = 0;
                                        dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                    }
                                }
                            }
                        }
                    }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_6: " + ex.Message;
            }
            //finally
            //{
            //    dsInvoiceData.AcceptChanges();
            //    dsCustomerData.AcceptChanges();
            //}
        }

        //Tinh cosfi binh quan
        public string RawDataCalculation_7_Backup_moi_nhat(DataSet dsCustomerData, DataSet dsInvoiceData, DataSet dsStaticCatalog, string strTen_DNhap)
        {
            try
            {
                string strMa_DDo = "", strMa_DDoTmp = "";
                DataRow[] rowsQHC, rowsQHP, rowsDDoCosFi, rowsDDoPhu, drDDo, drParameters;
                DataRow drHDonCosfi;
                Double hc = 0, vc = 0;
                Decimal cosfi = 0, kcosfi = 0;
                Decimal min = 0, heso_truphu = 0;
                Int16 IsExistsCS = 0, IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0;

                if (dsStaticCatalog == null)
                    return "dsStaticCatalog"; //du lieu truyen vao bi null
                else
                    if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                        return "NotExistsD_COSFI"; //khong ton tai bang D_COSFI

                if (dsInvoiceData == null)
                    return "dsInvoiceDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsInvoiceData.Tables.Contains("HDN_HDONCOSFI") == false)
                        return "NotExistsHDN_HDONCOSFI"; //khong ton tai bang HDN_HDONCOSFI

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                        return "NotExistsGCS_CHISO"; //khong ton tai bang GCS_CHISO
                    else
                        if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true)
                            //Co bang HDG_QHE_DDO
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_BQ") == true)
                            //Co bang GCS_CHISO_BQ
                            {
                                //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                                {
                                    drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                                    if (drParameters.Length > 0)
                                    {
                                        //Co ton tai tham so
                                        IsExistsParam = 1;
                                    }
                                }
                                #region GCS_CHISO
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) != strMa_DDo)
                                    {
                                        IsExistsCS = 0;
                                        strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                                        if (strMa_DDo == "PD01000009282001")
                                        {
                                            strMa_DDo = "PD01000009282001";
                                        }
                                        hc = 0;
                                        vc = 0;

                                        rowsQHC = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE = '32'");
                                        rowsQHP = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_PHU = '" + strMa_DDo + "' AND LOAI_QHE = '32'");

                                        if (rowsQHC.Length == 0 && rowsQHP.Length == 0)
                                        {
                                            continue;
                                        }
                                        else
                                        {
                                            if (rowsQHC.Length != 0 && rowsQHP.Length != 0)
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                //La diem do thoa man dieu kien tinh cosfi binh quan
                                                hc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                vc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")));
                                                //Kiem tra quan he 10, 11 va bu san luong tru phu cua cac diem do phu 10, 11
                                                if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                                {
                                                    DataView dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                                    dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                                    double hc_tp = 0;
                                                    foreach (DataRowView drTP in dwTP)
                                                    {
                                                        string strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                                        //Xu ly doi voi SHBB va SXD1
                                                        IsExistsSHBB = 0;
                                                        IsExistsSXD1 = 0;
                                                        //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                                        if (IsExistsParam == 1)
                                                        {
                                                            if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                                                            {
                                                                drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                                if (drDDo.Length > 0)
                                                                {
                                                                    IsExistsSHBB = 1;
                                                                }
                                                                else
                                                                {
                                                                    IsExistsSHBB = 0;
                                                                }

                                                                drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                                if (drDDo.Length > 0)
                                                                {
                                                                    IsExistsSXD1 = 1;
                                                                }
                                                                else
                                                                {
                                                                    IsExistsSXD1 = 0;
                                                                }

                                                                if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                                {
                                                                    heso_truphu = Convert.ToDecimal(1.1);
                                                                }
                                                                else
                                                                {
                                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                heso_truphu = Convert.ToDecimal(1.0);
                                                            }
                                                        }
                                                        else
                                                        {
                                                            heso_truphu = Convert.ToDecimal(1.0);
                                                        }

                                                        hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                                    }
                                                    hc = hc + hc_tp;
                                                }
                                                //Co ton tai chi so co san luong <> 0 hay khong
                                                if (hc != 0 || vc != 0)
                                                {
                                                    IsExistsCS = 1;
                                                }
                                                else
                                                {
                                                    IsExistsCS = 0;
                                                }

                                                if (rowsQHC.Length != 0)
                                                {
                                                    //La diem do chinh quan he cosfi binh quan
                                                    foreach (DataRow drQH in rowsQHC)
                                                    {
                                                        strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                        hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                        vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                    }

                                                    if (hc == 0)
                                                        if (vc == 0)
                                                            cosfi = 1;
                                                        else
                                                            cosfi = 0;
                                                    else
                                                    {
                                                        cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                    }

                                                    min = 1000;
                                                    kcosfi = 0;
                                                    foreach (DataRow drcosfi in dsStaticCatalog.Tables["D_COSFI"].Rows)
                                                    {
                                                        if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                        {
                                                            if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                            {
                                                                min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                            }
                                                        }
                                                    }

                                                    rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                    if (rowsDDoCosFi.Length != 0)
                                                    {
                                                        rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                        rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                        rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                        rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                    }
                                                    else
                                                    {
                                                        if (IsExistsCS == 1)
                                                        {
                                                            //Day du lieu vao HDN_HDONCOSFI    
                                                            string strMaSoGCS = "";
                                                            var arrMaSoGCS = dsCustomerData.Tables["HDG_DDO_SOGCS"].AsEnumerable().Where(c => c.Field<string>("MA_DDO") == dr["MA_DDO"].ToString().Trim());
                                                            if (arrMaSoGCS != null && arrMaSoGCS.Count() > 0)
                                                                strMaSoGCS = arrMaSoGCS.First()["MA_SOGCS"].ToString();
                                                            else strMaSoGCS = " ";
                                                            drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                            drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                            drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                            drHDonCosfi["ID_HDON"] = 0;
                                                            drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                            drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                            drHDonCosfi["MA_SOGCS"] = "";
                                                            drHDonCosfi["NAM"] = dr["NAM"];
                                                            drHDonCosfi["THANG"] = dr["THANG"];
                                                            drHDonCosfi["KY"] = dr["KY"];
                                                            drHDonCosfi["MA_KVUC"] = "";
                                                            drHDonCosfi["STT"] = "";
                                                            drHDonCosfi["MA_LO"] = "";
                                                            drHDonCosfi["MA_TRAM"] = "";
                                                            drHDonCosfi["MA_TO"] = "";
                                                            drHDonCosfi["HUU_CONG"] = hc;
                                                            drHDonCosfi["VO_CONG"] = vc;
                                                            drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                            drHDonCosfi["COSFI"] = cosfi;
                                                            drHDonCosfi["KCOSFI"] = kcosfi;
                                                            drHDonCosfi["TIEN_VOCONG"] = 0;
                                                            drHDonCosfi["KIMUA_CSPK"] = 0;
                                                            drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                            drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                            drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                            drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                            drHDonCosfi["MA_CNANG"] = 0;
                                                            dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    //La diem do phu quan he cosfi binh quan
                                                    if (rowsQHP.Length > 1)
                                                    {
                                                        //La diem do phu quan he cosfi binh quan cua 2 diem do chinh, khong duoc tinh
                                                        continue;
                                                    }
                                                    else
                                                    {
                                                        //San luong diem do chinh quan he cosfi binh quan
                                                        strMa_DDoTmp = Convert.ToString(rowsQHP[0]["MA_DDO_CHINH"]);
                                                        hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                        vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));

                                                        //San luong cac diem do phu quan he cosfi binh quan
                                                        rowsDDoPhu = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDoTmp + "' AND LOAI_QHE = '32' AND MA_DDO_PHU <> '" + strMa_DDo + "'");
                                                        foreach (DataRow drQH in rowsDDoPhu)
                                                        {
                                                            strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                            hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                            vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                        }

                                                        if (hc == 0)
                                                            if (vc == 0)
                                                                cosfi = 1;
                                                            else
                                                                cosfi = 0;
                                                        else
                                                        {
                                                            cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                        }

                                                        min = 1000;
                                                        kcosfi = 0;
                                                        foreach (DataRow drcosfi in dsStaticCatalog.Tables["D_COSFI"].Rows)
                                                        {
                                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                            {
                                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                {
                                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                }
                                                            }
                                                        }

                                                        rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                        if (rowsDDoCosFi.Length != 0)
                                                        {
                                                            rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                            rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                            rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                            rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                        }
                                                        else
                                                        {
                                                            if (IsExistsCS == 1)
                                                            {

                                                                //Day du lieu vao HDN_HDONCOSFI    
                                                                drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                drHDonCosfi["ID_HDON"] = 0;
                                                                drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                drHDonCosfi["MA_SOGCS"] = "";
                                                                drHDonCosfi["NAM"] = dr["NAM"];
                                                                drHDonCosfi["THANG"] = dr["THANG"];
                                                                drHDonCosfi["KY"] = dr["KY"];
                                                                drHDonCosfi["MA_KVUC"] = "";
                                                                drHDonCosfi["STT"] = "";
                                                                drHDonCosfi["MA_LO"] = "";
                                                                drHDonCosfi["MA_TRAM"] = "";
                                                                drHDonCosfi["MA_TO"] = "";
                                                                drHDonCosfi["HUU_CONG"] = hc;
                                                                drHDonCosfi["VO_CONG"] = vc;
                                                                drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                drHDonCosfi["COSFI"] = cosfi;
                                                                drHDonCosfi["KCOSFI"] = kcosfi;
                                                                drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                drHDonCosfi["MA_CNANG"] = 0;
                                                                dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                    }
                                }
                                #endregion
                                #region GCS_CHISO_GT
                                if (dsCustomerData.Tables["GCS_CHISO_GT"] != null && dsCustomerData.Tables["GCS_CHISO_GT"].Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) != strMa_DDo)
                                        {
                                            IsExistsCS = 0;
                                            strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                                            if (strMa_DDo == "PD01000009282001")
                                            {
                                                strMa_DDo = "PD01000009282001";
                                            }
                                            hc = 0;
                                            vc = 0;

                                            rowsQHC = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE = '32'");
                                            rowsQHP = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_PHU = '" + strMa_DDo + "' AND LOAI_QHE = '32'");

                                            if (rowsQHC.Length == 0 && rowsQHP.Length == 0)
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                if (rowsQHC.Length != 0 && rowsQHP.Length != 0)
                                                {
                                                    continue;
                                                }
                                                else
                                                {
                                                    //La diem do thoa man dieu kien tinh cosfi binh quan
                                                    hc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                    vc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")));
                                                    //Kiem tra quan he 10, 11 va bu san luong tru phu cua cac diem do phu 10, 11
                                                    if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                                    {
                                                        DataView dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                                        dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                                        double hc_tp = 0;
                                                        foreach (DataRowView drTP in dwTP)
                                                        {
                                                            string strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                                            //Xu ly doi voi SHBB va SXD1
                                                            IsExistsSHBB = 0;
                                                            IsExistsSXD1 = 0;
                                                            //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                                            if (IsExistsParam == 1)
                                                            {
                                                                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                                                                {
                                                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                                    if (drDDo.Length > 0)
                                                                    {
                                                                        IsExistsSHBB = 1;
                                                                    }
                                                                    else
                                                                    {
                                                                        IsExistsSHBB = 0;
                                                                    }

                                                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                                    if (drDDo.Length > 0)
                                                                    {
                                                                        IsExistsSXD1 = 1;
                                                                    }
                                                                    else
                                                                    {
                                                                        IsExistsSXD1 = 0;
                                                                    }

                                                                    if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                                    {
                                                                        heso_truphu = Convert.ToDecimal(1.1);
                                                                    }
                                                                    else
                                                                    {
                                                                        heso_truphu = Convert.ToDecimal(1.0);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                heso_truphu = Convert.ToDecimal(1.0);
                                                            }

                                                            hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                                        }
                                                        hc = hc + hc_tp;
                                                    }
                                                    //Co ton tai chi so co san luong <> 0 hay khong
                                                    if (hc != 0 || vc != 0)
                                                    {
                                                        IsExistsCS = 1;
                                                    }
                                                    else
                                                    {
                                                        IsExistsCS = 0;
                                                    }

                                                    if (rowsQHC.Length != 0)
                                                    {
                                                        //La diem do chinh quan he cosfi binh quan
                                                        foreach (DataRow drQH in rowsQHC)
                                                        {
                                                            strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                            hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                            vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                        }

                                                        if (hc == 0)
                                                            if (vc == 0)
                                                                cosfi = 1;
                                                            else
                                                                cosfi = 0;
                                                        else
                                                        {
                                                            cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                        }

                                                        min = 1000;
                                                        kcosfi = 0;
                                                        foreach (DataRow drcosfi in dsStaticCatalog.Tables["D_COSFI"].Rows)
                                                        {
                                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                            {
                                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                {
                                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                }
                                                            }
                                                        }

                                                        rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                        if (rowsDDoCosFi.Length != 0)
                                                        {
                                                            rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                            rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                            rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                            rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                        }
                                                        else
                                                        {
                                                            if (IsExistsCS == 1)
                                                            {
                                                                //Day du lieu vao HDN_HDONCOSFI    
                                                                string strMaSoGCS = "";
                                                                var arrMaSoGCS = dsCustomerData.Tables["HDG_DDO_SOGCS"].AsEnumerable().Where(c => c.Field<string>("MA_DDO") == dr["MA_DDO"].ToString().Trim());
                                                                if (arrMaSoGCS != null && arrMaSoGCS.Count() > 0)
                                                                    strMaSoGCS = arrMaSoGCS.First()["MA_SOGCS"].ToString();
                                                                else strMaSoGCS = " ";
                                                                drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                drHDonCosfi["ID_HDON"] = 0;
                                                                drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                drHDonCosfi["MA_SOGCS"] = "";
                                                                drHDonCosfi["NAM"] = dr["NAM"];
                                                                drHDonCosfi["THANG"] = dr["THANG"];
                                                                drHDonCosfi["KY"] = dr["KY"];
                                                                drHDonCosfi["MA_KVUC"] = "";
                                                                drHDonCosfi["STT"] = "";
                                                                drHDonCosfi["MA_LO"] = "";
                                                                drHDonCosfi["MA_TRAM"] = "";
                                                                drHDonCosfi["MA_TO"] = "";
                                                                drHDonCosfi["HUU_CONG"] = hc;
                                                                drHDonCosfi["VO_CONG"] = vc;
                                                                drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                drHDonCosfi["COSFI"] = cosfi;
                                                                drHDonCosfi["KCOSFI"] = kcosfi;
                                                                drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                drHDonCosfi["MA_CNANG"] = 0;
                                                                dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //La diem do phu quan he cosfi binh quan
                                                        if (rowsQHP.Length > 1)
                                                        {
                                                            //La diem do phu quan he cosfi binh quan cua 2 diem do chinh, khong duoc tinh
                                                            continue;
                                                        }
                                                        else
                                                        {
                                                            //San luong diem do chinh quan he cosfi binh quan
                                                            //Phai lay trong GCS_CHISO vi day la diem do phu cua QHGT -> SL ddo chinh nam trong GCS_CHISO
                                                            strMa_DDoTmp = Convert.ToString(rowsQHP[0]["MA_DDO_CHINH"]);
                                                            hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                            vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));

                                                            //San luong cac diem do phu quan he cosfi binh quan
                                                            rowsDDoPhu = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDoTmp + "' AND LOAI_QHE = '32' AND MA_DDO_PHU <> '" + strMa_DDo + "'");
                                                            foreach (DataRow drQH in rowsDDoPhu)
                                                            {
                                                                strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                            }

                                                            if (hc == 0)
                                                                if (vc == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRow drcosfi in dsStaticCatalog.Tables["D_COSFI"].Rows)
                                                            {
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }

                                                            rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                            if (rowsDDoCosFi.Length != 0)
                                                            {
                                                                rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                                rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                                rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                                rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                            }
                                                            else
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {
                                                                    //Day du lieu vao HDN_HDONCOSFI    
                                                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                    drHDonCosfi["ID_HDON"] = 0;
                                                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                    drHDonCosfi["MA_SOGCS"] = "";
                                                                    drHDonCosfi["NAM"] = dr["NAM"];
                                                                    drHDonCosfi["THANG"] = dr["THANG"];
                                                                    drHDonCosfi["KY"] = dr["KY"];
                                                                    drHDonCosfi["MA_KVUC"] = "";
                                                                    drHDonCosfi["STT"] = "";
                                                                    drHDonCosfi["MA_LO"] = "";
                                                                    drHDonCosfi["MA_TRAM"] = "";
                                                                    drHDonCosfi["MA_TO"] = "";
                                                                    drHDonCosfi["HUU_CONG"] = hc;
                                                                    drHDonCosfi["VO_CONG"] = vc;
                                                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                    drHDonCosfi["COSFI"] = cosfi;
                                                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                                                    drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                    drHDonCosfi["MA_CNANG"] = 0;
                                                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                #endregion
                            }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_7: " + ex.Message;
            }
            //finally
            //{
            //    dsInvoiceData.AcceptChanges();
            //    dsCustomerData.AcceptChanges();
            //}
        }
        //Tinh cosfi cua cac diem do chinh dung cho thang co doi he so phat CSPK
        public string RawDataCalculation_5(DataSet dsCustomerData, DataSet dsInvoiceData, DataSet dsStaticCatalog, string strTen_DNhap)
        {
            string strMa_DDo = "", strMa_DDoP = "";
            try
            {
                DataRow[] rows, drDDo, drParameters;
                DataRow drHDonCosfi;
                Double hc = 0, vc = 0, hc_tp = 0, hc_1358 = 0, hc_T = 0, vc_T = 0, hc_tp_T = 0, hc_1358_T = 0;
                Decimal cosfi = 0, kcosfi = 0;
                Decimal min = 0, heso_truphu;
                DataView dwTP, dwCSKT, dwCSVC, dwDDo_SoGCS, dwVTri_DDo, dwDDo, dwCosfi, dwCS;
                Int16 IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0, IsExistsTreoThao = 0, IsTinhCosfi = 0, IsExistsDoiHSPhat = 0;
                Int16 iKymua_CSPK = 0, iExistsCCS = 0;
                Int64 i64ID_CHISO_VC_T = 0, i64ID_CHISO_VC = 0;
                DateTime dtMinNgayDK, dtMaxNgayCK, dtDoiHSPhatCosfi, dtNgayDoiCSPK;
                if (dsStaticCatalog == null)
                    return "dsStaticCatalog"; //du lieu truyen vao bi null
                else
                    if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                        return "NotExistsD_COSFI"; //khong ton tai bang D_COSFI

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                        return "NotExistsGCS_CHISO"; //khong ton tai bang GCS_CHISO
                    else
                        if (dsCustomerData.Tables.Contains("HDG_DDO_SOGCS") == false)
                            return "NotExistsHDG_DDO_SOGCS";
                        else
                            if (dsCustomerData.Tables.Contains("HDG_VITRI_DDO") == false)
                                return "NotExistsHDG_VITRI_DDO";
                            else
                                if (dsCustomerData.Tables.Contains("HDG_DIEM_DO") == false)
                                    return "NotExistsHDG_DIEM_DO";

                if (dsInvoiceData == null)
                    return "dsInvoiceDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsInvoiceData.Tables.Contains("HDN_HDONCOSFI") == false)
                        return "NotExistsHDN_HDONCOSFI"; //khong ton tai bang HDN_HDONCOSFI

                //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                {
                    drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                    if (drParameters.Length > 0)
                    {
                        //Co ton tai tham so
                        IsExistsParam = 1;
                    }
                }

                //Khoi tao dataview
                dwCosfi = new DataView(dsStaticCatalog.Tables["D_COSFI"]);
                dwCosfi.Sort = "NGAY_ADUNG DESC, HS_COSFI ASC";
                dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwCS.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";
                dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwCSKT.RowFilter = "BCS = 'KT'";
                dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                dwCSVC.RowFilter = "BCS = 'VC'";
                dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                dwTP.RowFilter = "LOAI_QHE IN ('10','11')";

                dwDDo_SoGCS = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                if (dwDDo_SoGCS.Count != 0)
                {
                    dwDDo_SoGCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo_SoGCS[0]["MA_DVIQLY"]) + "'";
                }
                dwDDo_SoGCS.Sort = "NGAY_HLUC DESC";

                dwVTri_DDo = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                if (dwVTri_DDo.Count != 0)
                {
                    dwVTri_DDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwVTri_DDo[0]["MA_DVIQLY"]) + "'";
                }
                dwVTri_DDo.Sort = "NGAY_HLUC DESC";

                dwDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                if (dwDDo.Count != 0)
                {
                    dwDDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo[0]["MA_DVIQLY"]) + "'";
                }
                dwDDo.Sort = "NGAY_HLUC DESC";

                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                {
                    IsExistsDoiHSPhat = 0;
                    dtMinNgayDK = new DateTime(1900, 1, 1);
                    dtMaxNgayCK = new DateTime(1900, 1, 1);
                    dtDoiHSPhatCosfi = new DateTime(1900, 1, 1);
                    dtNgayDoiCSPK = new DateTime(1900, 1, 1);
                    hc = 0;
                    vc = 0;
                    hc_T = 0;
                    vc_T = 0;

                    iKymua_CSPK = 0;
                    iExistsCCS = 0;
                    strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                    if (strMa_DDo == "PA04DTDTC0116002")
                    {
                    }
                    //Dũng NT hiệu chỉnh ngày 06/11/2014 vụ đổi hệ số phạt 
                    //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                    dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                    dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                    foreach (DataRowView drvCosfi in dwCosfi)
                    {

                        DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                        if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                        {
                            //Có đổi hệ số phạt cosfi
                            IsExistsDoiHSPhat = 1;
                            //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                            dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                            break;
                        }
                    }
                    //End

                    rows = dsCustomerData.Tables["GCS_CHISO"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'");
                    if (rows.Length != 0)
                    {
                        //Co dong chi so vo cong
                        if (IsExistsDoiHSPhat == 1)
                        {
                            if (dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'").Length == 0)
                            {
                                //Có đổi hệ số phạt
                                //Kiểm tra nếu có ký mua CSPK thì phải tồn tại dòng CCS ứng với ngày đổi hệ số phạt
                                dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                //dw.Sort = "NGAY_HLUC DESC";
                                //if (dw.Count == 0)
                                if (dwDDo.Count == 0)
                                {
                                    iKymua_CSPK = 0;
                                }
                                else
                                {
                                    //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                    iKymua_CSPK = Utility.Int16Dbnull(dwDDo[0]["KIMUA_CSPK"]);
                                    if (dwDDo[0]["NGAY_DOI_CSPK"].ToString().Trim().Length > 0)
                                        dtNgayDoiCSPK = Convert.ToDateTime(dwDDo[0]["NGAY_DOI_CSPK"]);
                                }
                                int IsChotCS_CSPK = 0;
                                //Có ký mua CSPK, kiểm tra tồn tại dòng CCS, ít nhất phải chốt CCS VC
                                foreach (DataRow drTemp in rows)
                                {
                                    if (drTemp["LOAI_CHISO"].ToString().Trim() == "CCS")
                                    {
                                        DateTime dtNgayCKY_CCS = Convert.ToDateTime(drTemp["NGAY_CKY"]);
                                        if (dtNgayCKY_CCS == dtDoiHSPhatCosfi)
                                        {
                                            IsChotCS_CSPK = 1;

                                            break;
                                        }

                                    }
                                }
                                if (iKymua_CSPK == 1 && IsChotCS_CSPK == 0)
                                    return strMa_DDo + " Chưa chốt chỉ số đổi hệ số phạt CSPK."; //du lieu truyen vao bi null
                                //Thực hiện tính riêng cosfi
                                dwCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                //reset biên ID_CHISO VC
                                i64ID_CHISO_VC_T = 0;
                                i64ID_CHISO_VC = 0;
                                foreach (DataRowView drvCS in dwCS)
                                {
                                    if (drvCS["LOAI_CHISO"].ToString().Trim() == "CCS" && Convert.ToDateTime(drvCS["NGAY_CKY"]) == dtDoiHSPhatCosfi && iExistsCCS == 0)
                                    {
                                        //Có tồn tại chỉ số chốt đổi CSPK, thực hiện tính tách 2 thành phần
                                        iExistsCCS = 1;
                                    }
                                    if ("BT;CD;TD".Contains(drvCS["BCS"].ToString().Trim()))
                                    {
                                        if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                                        {
                                            //HC trước đổi HS phạt
                                            hc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                        }
                                        else
                                        {
                                            //HC sau đổi HS phạt
                                            hc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                        }
                                    }
                                    else if (drvCS["BCS"].ToString().Trim() == "VC")
                                    {
                                        if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                                        {
                                            if (Convert.ToDateTime(drvCS["NGAY_CKY"]) == dtDoiHSPhatCosfi)
                                                i64ID_CHISO_VC_T = Convert.ToInt64(drvCS["ID_CHISO"]);
                                            //VC trước đổi HS phạt
                                            vc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU"]);
                                        }
                                        else
                                        {
                                            if (i64ID_CHISO_VC < Convert.ToInt64(drvCS["ID_CHISO"]))
                                                i64ID_CHISO_VC = Convert.ToInt64(drvCS["ID_CHISO"]);
                                            //VC sau đổi HS phạt
                                            vc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU"]);
                                        }
                                    }
                                    else if (drvCS["BCS"].ToString().Trim() == "KT")
                                    {
                                        //Nếu là KT
                                        //Kiểm tra có VC cùng ngày đầu kỳ không
                                        Int16 IsExistsVC = 0;
                                        foreach (DataRowView drvCS_VC in dwCS)
                                        {
                                            if (drvCS_VC["BCS"].ToString().Trim() == "VC" && Convert.ToDateTime(drvCS_VC["NGAY_DKY"]) == Convert.ToDateTime(drvCS["NGAY_DKY"]))
                                            {
                                                IsExistsVC = 1;
                                                break;
                                            }
                                        }
                                        if (IsExistsVC == 1)
                                        {
                                            if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                                            {
                                                //HC trước đổi HS phạt
                                                hc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                            }
                                            else
                                            {
                                                //HC sau đổi HS phạt
                                                hc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                            }
                                        }
                                    }
                                }
                                //Nếu có tồn tại chỉ số chốt CCS đổi CSPK thì mới tách, nếu không thì cộng tổng lại
                                if (iExistsCCS == 0)
                                {
                                    hc = hc + hc_T;
                                    hc_T = 0;
                                    vc = vc + vc_T;
                                    vc_T = 0;
                                }
                                //Thực hiện tính cosfi
                                #region Trước dổi hệ số phạt
                                if (hc_T == 0)
                                    if (vc_T == 0)
                                        cosfi = 1;
                                    else
                                        cosfi = 0;
                                else
                                {
                                    cosfi = Math.Round(Convert.ToDecimal(hc_T / Math.Sqrt(Convert.ToDouble(hc_T * hc_T + vc_T * vc_T))), 2, MidpointRounding.AwayFromZero);
                                }

                                min = 1000;
                                kcosfi = 0;
                                foreach (DataRowView drcosfi in dwCosfi)
                                {
                                    if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtDoiHSPhatCosfi) continue;
                                    if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                    {
                                        if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                        {
                                            min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                            kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                        }
                                    }
                                }
                                if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                {
                                    cosfi = 1;
                                    kcosfi = 0;

                                }
                                if (hc_T != 0 || vc_T != 0)
                                {
                                    //Day du lieu vao HDN_HDONCOSFI    
                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                    drHDonCosfi["ID_HDON"] = 0;
                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                    drHDonCosfi["NAM"] = dr["NAM"];
                                    drHDonCosfi["THANG"] = dr["THANG"];
                                    drHDonCosfi["KY"] = dr["KY"];

                                    //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                    dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwDDo_SoGCS.Count == 0)
                                    {
                                        drHDonCosfi["MA_SOGCS"] = "";
                                        drHDonCosfi["MA_KVUC"] = "";
                                        drHDonCosfi["STT"] = "";
                                    }
                                    else
                                    {
                                        //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                        //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                        //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                        drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                        drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                        drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                    }

                                    //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                    dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwVTri_DDo.Count == 0)
                                    {
                                        drHDonCosfi["MA_LO"] = "";
                                        drHDonCosfi["MA_TRAM"] = "";
                                        drHDonCosfi["MA_TO"] = "";
                                    }
                                    else
                                    {
                                        //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                        //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                        //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                        drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                        drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                        drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                    }

                                    drHDonCosfi["HUU_CONG"] = hc_T;
                                    drHDonCosfi["VO_CONG"] = vc_T;
                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                    drHDonCosfi["COSFI"] = cosfi;
                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                    drHDonCosfi["TIEN_VOCONG"] = 0;

                                    //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                    dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    //if (dwDDo.Count == 0)
                                    //{
                                    //    drHDonCosfi["KIMUA_CSPK"] = 0;
                                    //}
                                    //else
                                    //{
                                    //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                    //if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                    //    drHDonCosfi["KIMUA_CSPK"] = "0";
                                    //else
                                    drHDonCosfi["KIMUA_CSPK"] = iKymua_CSPK.ToString();//Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                    //}

                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                    //if (hc_1358 != 0)
                                    //{
                                    //    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                    //    drHDonCosfi["MA_CNANG"] = 1;
                                    //}
                                    //else
                                    //{
                                    //Mac dinh la = 0
                                    drHDonCosfi["MA_CNANG"] = 0;
                                    drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC_T;
                                    //}
                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                }
                                #endregion

                                #region Sau đổi hệ số phạt
                                if (hc == 0)
                                    if (vc == 0)
                                        cosfi = 1;
                                    else
                                        cosfi = 0;
                                else
                                {
                                    cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                }

                                min = 1000;
                                kcosfi = 0;
                                foreach (DataRowView drcosfi in dwCosfi)
                                {
                                    if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                    if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                    {
                                        if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                        {
                                            min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                            kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                        }
                                    }
                                }
                                if (hc != 0 || vc != 0)
                                {
                                    //Day du lieu vao HDN_HDONCOSFI    
                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                    drHDonCosfi["ID_HDON"] = 0;
                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                    drHDonCosfi["NAM"] = dr["NAM"];
                                    drHDonCosfi["THANG"] = dr["THANG"];
                                    drHDonCosfi["KY"] = dr["KY"];

                                    //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                    dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwDDo_SoGCS.Count == 0)
                                    {
                                        drHDonCosfi["MA_SOGCS"] = "";
                                        drHDonCosfi["MA_KVUC"] = "";
                                        drHDonCosfi["STT"] = "";
                                    }
                                    else
                                    {
                                        //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                        //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                        //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                        drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                        drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                        drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                    }

                                    //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                    dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwVTri_DDo.Count == 0)
                                    {
                                        drHDonCosfi["MA_LO"] = "";
                                        drHDonCosfi["MA_TRAM"] = "";
                                        drHDonCosfi["MA_TO"] = "";
                                    }
                                    else
                                    {
                                        //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                        //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                        //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                        drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                        drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                        drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                    }

                                    drHDonCosfi["HUU_CONG"] = hc;
                                    drHDonCosfi["VO_CONG"] = vc;
                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                    drHDonCosfi["COSFI"] = cosfi;
                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                    drHDonCosfi["TIEN_VOCONG"] = 0;

                                    //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                    dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwDDo.Count == 0)
                                    {
                                        drHDonCosfi["KIMUA_CSPK"] = 0;
                                    }
                                    else
                                    {
                                        //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                        drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                    }

                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                    if (hc_1358 != 0)
                                    {
                                        //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                        drHDonCosfi["MA_CNANG"] = 1;
                                    }
                                    else
                                    {
                                        //Mac dinh la = 0
                                        drHDonCosfi["MA_CNANG"] = 0;
                                    }
                                    drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                }
                                #endregion

                            }
                        }
                        else
                        {
                            //Không đổi hệ số phạt
                            if (dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'").Length == 0)
                            {
                                hc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"));
                                vc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                //Kiem tra xem co treo thao tu loai 1 sang 3,5,8 hoac nguoc lai
                                hc_1358 = 0;
                                //dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCSKT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT'";
                                //dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                                if (dwCSKT.Count == 0)
                                {
                                    //Khong co dong KT
                                    hc_1358 = 0;
                                }
                                else
                                {
                                    //Co dong KT, thuc hien kiem tra xem co dong VC di kem hay khong
                                    //dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                    dwCSVC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'";
                                    //dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                                    //foreach (DataRowView drvCSKT in dwCSKT)
                                    //{
                                    //    IsExistsTreoThao = 0; //Khong ton tai treo thao tu cong to co sang cong to dien tu hoac nguoc lai
                                    //    foreach (DataRowView drvCSVC in dwCSVC)
                                    //    {
                                    //        if (Convert.ToDateTime(drvCSKT["NGAY_CKY"]) == Convert.ToDateTime(drvCSVC["NGAY_CKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) == Convert.ToDateTime(drvCSVC["NGAY_DKY"]))
                                    //        {
                                    //            IsExistsTreoThao = 1;
                                    //            break;
                                    //        }
                                    //    }
                                    //    //Khong ton tai VC cung ngay dau ky va ngay cuoi ky voi KT
                                    //    if (IsExistsTreoThao == 0)
                                    //    {
                                    //        hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                    //    }
                                    //}
                                    //Loc cac san luong KT khong dung de tinh cosfi
                                    foreach (DataRowView drvCSKT in dwCSKT)
                                    {
                                        IsTinhCosfi = 0; //Khong dung de tinh cosfi
                                        foreach (DataRowView drvCSVC in dwCSVC)
                                        {
                                            if (Convert.ToDateTime(drvCSKT["NGAY_DKY"]) >= Convert.ToDateTime(drvCSVC["NGAY_DKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) <= Convert.ToDateTime(drvCSVC["NGAY_CKY"]))
                                            {
                                                IsTinhCosfi = 1;
                                                break;
                                            }
                                        }
                                        //Khong ton tai VC chua ngay dau ky KT, loai bo san luong nay khoi thanh phan HC tinh cosfi
                                        if (IsTinhCosfi == 0)
                                        {
                                            //hc1358: tong cac san luong KT khong dung de tinh cosfi
                                            hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                        }
                                    }
                                }
                                hc = hc - hc_1358;

                                //Hieu chinh lai san luong hc va vc doi voi cac truong hop sau
                                //Diem do co quan he tru phu 10, 11 tuc la tru phu huu cong khi tinh tien dien, khong tru phu huu cong khi tinh cosfi
                                if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                {
                                    //dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                    dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                    hc_tp = 0;
                                    foreach (DataRowView drTP in dwTP)
                                    {
                                        strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                        //Xu ly doi voi SHBB va SXD1
                                        IsExistsSHBB = 0;
                                        IsExistsSXD1 = 0;
                                        //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                        if (IsExistsParam == 1)
                                        {
                                            if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                                            {
                                                drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                if (drDDo.Length > 0)
                                                {
                                                    IsExistsSHBB = 1;
                                                }
                                                else
                                                {
                                                    IsExistsSHBB = 0;
                                                }

                                                drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                if (drDDo.Length > 0)
                                                {
                                                    IsExistsSXD1 = 1;
                                                }
                                                else
                                                {
                                                    IsExistsSXD1 = 0;
                                                }

                                                if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                {
                                                    heso_truphu = Convert.ToDecimal(1.1);
                                                }
                                                else
                                                {
                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                }
                                            }
                                            else
                                            {
                                                heso_truphu = Convert.ToDecimal(1.0);
                                            }
                                        }
                                        else
                                        {
                                            heso_truphu = Convert.ToDecimal(1.0);
                                        }

                                        hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT') AND KY = " + drTP["KY_P"].ToString().Trim())) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT') AND KY = " + drTP["KY_P"].ToString().Trim()))), 0, MidpointRounding.AwayFromZero));
                                    }
                                    hc = hc + hc_tp;
                                }

                                if (hc == 0)
                                    if (vc == 0)
                                        cosfi = 1;
                                    else
                                        cosfi = 0;
                                else
                                {
                                    cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                }

                                min = 1000;
                                kcosfi = 0;
                                foreach (DataRowView drcosfi in dwCosfi)
                                {
                                    if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                    if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                    {
                                        if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                        {
                                            min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                            kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                        }
                                    }
                                }

                                if (hc != 0 || vc != 0)
                                {
                                    //Day du lieu vao HDN_HDONCOSFI    
                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                    drHDonCosfi["ID_HDON"] = 0;
                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                    drHDonCosfi["NAM"] = dr["NAM"];
                                    drHDonCosfi["THANG"] = dr["THANG"];
                                    drHDonCosfi["KY"] = dr["KY"];

                                    //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                    dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwDDo_SoGCS.Count == 0)
                                    {
                                        drHDonCosfi["MA_SOGCS"] = "";
                                        drHDonCosfi["MA_KVUC"] = "";
                                        drHDonCosfi["STT"] = "";
                                    }
                                    else
                                    {
                                        //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                        //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                        //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                        drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                        drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                        drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                    }

                                    //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                    dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwVTri_DDo.Count == 0)
                                    {
                                        drHDonCosfi["MA_LO"] = "";
                                        drHDonCosfi["MA_TRAM"] = "";
                                        drHDonCosfi["MA_TO"] = "";
                                    }
                                    else
                                    {
                                        //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                        //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                        //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                        drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                        drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                        drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                    }

                                    drHDonCosfi["HUU_CONG"] = hc;
                                    drHDonCosfi["VO_CONG"] = vc;
                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                    drHDonCosfi["COSFI"] = cosfi;
                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                    drHDonCosfi["TIEN_VOCONG"] = 0;

                                    //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                    dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                    //dw.Sort = "NGAY_HLUC DESC";
                                    //if (dw.Count == 0)
                                    if (dwDDo.Count == 0)
                                    {
                                        drHDonCosfi["KIMUA_CSPK"] = 0;
                                    }
                                    else
                                    {
                                        //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                        drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                    }

                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                    if (hc_1358 != 0)
                                    {
                                        //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                        drHDonCosfi["MA_CNANG"] = 1;
                                    }
                                    else
                                    {
                                        //Mac dinh la = 0
                                        drHDonCosfi["MA_CNANG"] = 0;
                                    }
                                    drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;

                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                }
                            }
                        }
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_5: " + ex.Message + " - " + strMa_DDo;
            }
            //finally
            //{
            //    dsInvoiceData.AcceptChanges();
            //    dsCustomerData.AcceptChanges();
            //}
        }
        public string RawDataCalculation_6(DataSet dsCustomerData, DataSet dsInvoiceData, DataSet dsStaticCatalog, string strTen_DNhap)
        {
            try
            {
                string strMa_DDo = "", strMa_DDoP = "";
                DataRow[] rows, drDDo, drParameters;
                DataRow drHDonCosfi;
                Double hc = 0, vc = 0, hc_tp = 0, hc_1358 = 0, hc_T = 0, vc_T = 0, hc_tp_T = 0, hc_1358_T = 0;
                Decimal cosfi = 0, kcosfi = 0;
                Decimal min = 0, heso_truphu;
                DataView dwTP, dwCSKT, dwCSVC, dwDDo_SoGCS, dwVTri_DDo, dwDDo, dwCosfi, dwCS;
                Int16 IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0, IsExistsTreoThao = 0, IsTinhCosfi = 0, IsExistsDoiHSPhat = 0;
                Int16 iKymua_CSPK = 0, iExistsCCS = 0;
                Int64 i64ID_CHISO_VC_T = 0, i64ID_CHISO_VC = 0;
                DateTime dtMinNgayDK, dtMaxNgayCK, dtDoiHSPhatCosfi, dtNgayDoiCSPK;
                if (dsStaticCatalog == null)
                    return "dsStaticCatalog"; //du lieu truyen vao bi null
                else
                    if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                        return "NotExistsD_COSFI"; //khong ton tai bang D_COSFI

                if (dsInvoiceData == null)
                    return "dsInvoiceDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsInvoiceData.Tables.Contains("HDN_HDONCOSFI") == false)
                        return "NotExistsHDN_HDONCOSFI"; //khong ton tai bang HDN_HDONCOSFI

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null                    
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                    //Co bang GCS_CHISO_GT
                    {
                        //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                        if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                        {
                            drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                            if (drParameters.Length > 0)
                            {
                                //Co ton tai tham so
                                IsExistsParam = 1;
                            }
                        }

                        //Khoi tao cac dataview
                        dwCosfi = new DataView(dsStaticCatalog.Tables["D_COSFI"]);
                        dwCosfi.Sort = "NGAY_ADUNG DESC, HS_COSFI ASC";
                        dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCS.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";
                        dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCSKT.RowFilter = "BCS = 'KT'";
                        dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                        dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                        dwCSVC.RowFilter = "BCS = 'VC'";
                        dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                        dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                        dwTP.RowFilter = "LOAI_QHE IN ('10','11')";

                        if (dsCustomerData.Tables.Contains("HDG_DDO_SOGCS_GT") == true)
                        {
                            dwDDo_SoGCS = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS_GT"]);
                            if (dwDDo_SoGCS.Count != 0)
                            {
                                dwDDo_SoGCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo_SoGCS[0]["MA_DVIQLY"]) + "'";
                            }
                            dwDDo_SoGCS.Sort = "NGAY_HLUC DESC";
                        }
                        else
                        {
                            dwDDo_SoGCS = null;
                        }

                        if (dsCustomerData.Tables.Contains("HDG_VITRI_DDO_GT") == true)
                        {
                            dwVTri_DDo = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO_GT"]);
                            if (dwVTri_DDo.Count != 0)
                            {
                                dwVTri_DDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwVTri_DDo[0]["MA_DVIQLY"]) + "'";
                            }
                            dwVTri_DDo.Sort = "NGAY_HLUC DESC";
                        }
                        else
                        {
                            dwVTri_DDo = null;
                        }

                        if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == true)
                        {
                            dwDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                            if (dwDDo.Count != 0)
                            {
                                dwDDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo[0]["MA_DVIQLY"]) + "'";
                            }
                            dwDDo.Sort = "NGAY_HLUC DESC";
                        }
                        else
                        {
                            dwDDo = null;
                        }

                        foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                        {
                            IsExistsDoiHSPhat = 0;
                            dtMinNgayDK = new DateTime(1900, 1, 1);
                            dtMaxNgayCK = new DateTime(1900, 1, 1);
                            dtDoiHSPhatCosfi = new DateTime(1900, 1, 1);
                            dtNgayDoiCSPK = new DateTime(1900, 1, 1);
                            hc = 0;
                            vc = 0;
                            hc_T = 0;
                            vc_T = 0;

                            iKymua_CSPK = 0;
                            iExistsCCS = 0;
                            strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                            string strMaSoGCS = "";
                            //Dũng NT hiệu chỉnh ngày 06/11/2014 vụ đổi hệ số phạt 
                            //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                            dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                            foreach (DataRowView drvCosfi in dwCosfi)
                            {

                                DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                {
                                    //Có đổi hệ số phạt cosfi
                                    IsExistsDoiHSPhat = 1;
                                    //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                    dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                    break;
                                }
                            }
                            //End
                            var arrMaSoGCS = dsCustomerData.Tables["HDG_DDO_SOGCS_GT"].AsEnumerable().Where(c => c.Field<string>("MA_DDO") == strMa_DDo);
                            if (arrMaSoGCS != null && arrMaSoGCS.Count() > 0)
                                strMaSoGCS = arrMaSoGCS.First()["MA_SOGCS"].ToString();
                            else strMaSoGCS = " ";
                            rows = dsCustomerData.Tables["GCS_CHISO_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'");
                            if (rows.Length != 0)
                            {
                                //Co dong chi so vo cong
                                if (IsExistsDoiHSPhat == 1)
                                {
                                    if (dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'").Length == 0)
                                    {
                                        //Có đổi hệ số phạt
                                        //Kiểm tra nếu có ký mua CSPK thì phải tồn tại dòng CCS ứng với ngày đổi hệ số phạt
                                        dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                        //dw.Sort = "NGAY_HLUC DESC";
                                        //if (dw.Count == 0)
                                        if (dwDDo.Count == 0)
                                        {
                                            iKymua_CSPK = 0;
                                        }
                                        else
                                        {
                                            //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                            iKymua_CSPK = Utility.Int16Dbnull(dwDDo[0]["KIMUA_CSPK"]);
                                            if (dwDDo[0]["NGAY_DOI_CSPK"].ToString().Trim().Length > 0)
                                                dtNgayDoiCSPK = Convert.ToDateTime(dwDDo[0]["NGAY_DOI_CSPK"]);
                                        }
                                        int IsChotCS_CSPK = 0;
                                        //Có ký mua CSPK, kiểm tra tồn tại dòng CCS, ít nhất phải chốt CCS VC
                                        foreach (DataRow drTemp in rows)
                                        {
                                            if (drTemp["LOAI_CHISO"].ToString().Trim() == "CCS")
                                            {
                                                DateTime dtNgayCKY_CCS = Convert.ToDateTime(drTemp["NGAY_CKY"]);
                                                if (dtNgayCKY_CCS == dtDoiHSPhatCosfi)
                                                {
                                                    IsChotCS_CSPK = 1;

                                                    break;
                                                }

                                            }
                                        }
                                        if (iKymua_CSPK == 1 && IsChotCS_CSPK == 0)
                                            return strMa_DDo + " Chưa chốt chỉ số đổi hệ số phạt CSPK."; //du lieu truyen vao bi null
                                        //Thực hiện tính riêng cosfi
                                        dwCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                        //reset biên ID_CHISO VC
                                        i64ID_CHISO_VC_T = 0;
                                        i64ID_CHISO_VC = 0;
                                        foreach (DataRowView drvCS in dwCS)
                                        {
                                            if (drvCS["LOAI_CHISO"].ToString().Trim() == "CCS" && Convert.ToDateTime(drvCS["NGAY_CKY"]) == dtDoiHSPhatCosfi && iExistsCCS == 0)
                                            {
                                                //Có tồn tại chỉ số chốt đổi CSPK, thực hiện tính tách 2 thành phần
                                                iExistsCCS = 1;
                                            }
                                            if ("BT;CD;TD".Contains(drvCS["BCS"].ToString().Trim()))
                                            {
                                                if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                                                {
                                                    //HC trước đổi HS phạt
                                                    hc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                                }
                                                else
                                                {
                                                    //HC sau đổi HS phạt
                                                    hc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                                }
                                            }
                                            else if (drvCS["BCS"].ToString().Trim() == "VC")
                                            {
                                                if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                                                {
                                                    if (Convert.ToDateTime(drvCS["NGAY_CKY"]) == dtDoiHSPhatCosfi)
                                                        i64ID_CHISO_VC_T = Convert.ToInt64(drvCS["ID_CHISO"]);
                                                    //VC trước đổi HS phạt
                                                    vc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU"]);
                                                }
                                                else
                                                {
                                                    if (i64ID_CHISO_VC < Convert.ToInt64(drvCS["ID_CHISO"]))
                                                        i64ID_CHISO_VC = Convert.ToInt64(drvCS["ID_CHISO"]);
                                                    //VC sau đổi HS phạt
                                                    vc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU"]);
                                                }
                                            }
                                            else if (drvCS["BCS"].ToString().Trim() == "KT")
                                            {
                                                //Nếu là KT
                                                //Kiểm tra có VC cùng ngày đầu kỳ không
                                                Int16 IsExistsVC = 0;
                                                foreach (DataRowView drvCS_VC in dwCS)
                                                {
                                                    if (drvCS_VC["BCS"].ToString().Trim() == "VC" && Convert.ToDateTime(drvCS_VC["NGAY_DKY"]) == Convert.ToDateTime(drvCS["NGAY_DKY"]))
                                                    {
                                                        IsExistsVC = 1;
                                                        break;
                                                    }
                                                }
                                                if (IsExistsVC == 1)
                                                {
                                                    if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                                                    {
                                                        //HC trước đổi HS phạt
                                                        hc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                                    }
                                                    else
                                                    {
                                                        //HC sau đổi HS phạt
                                                        hc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                                                    }
                                                }
                                            }
                                        }
                                        if (iExistsCCS == 0)
                                        {
                                            //Nếu không tồn tại chỉ số chốt CCS CSPK thì không tách riêng
                                            hc = hc + hc_T;
                                            hc_T = 0;
                                            vc = vc + vc_T;
                                            vc_T = 0;
                                        }
                                        //Thực hiện tính cosfi
                                        #region Trước dổi hệ số phạt
                                        if (hc_T == 0)
                                            if (vc_T == 0)
                                                cosfi = 1;
                                            else
                                                cosfi = 0;
                                        else
                                        {
                                            cosfi = Math.Round(Convert.ToDecimal(hc_T / Math.Sqrt(Convert.ToDouble(hc_T * hc_T + vc_T * vc_T))), 2, MidpointRounding.AwayFromZero);
                                        }

                                        min = 1000;
                                        kcosfi = 0;
                                        foreach (DataRowView drcosfi in dwCosfi)
                                        {
                                            if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtDoiHSPhatCosfi) continue;
                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                            {
                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                {
                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                }
                                            }
                                        }
                                        if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                        {
                                            //Trong tháng đổi hệ số phạt CSPK, nếu ngày đổi CSPK > ngày đổi hệ số phạt, khoảng trước không tính cosfi
                                            cosfi = 1;
                                            kcosfi = 0;
                                        }
                                        if (hc_T != 0 || vc_T != 0)
                                        {
                                            //Day du lieu vao HDN_HDONCOSFI    
                                            drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                            drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                            drHDonCosfi["ID_HDONCOSFI"] = 0;
                                            drHDonCosfi["ID_HDON"] = 0;
                                            drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                            drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                            drHDonCosfi["NAM"] = dr["NAM"];
                                            drHDonCosfi["THANG"] = dr["THANG"];
                                            drHDonCosfi["KY"] = dr["KY"];

                                            //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                            dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            //if (dw.Count == 0)
                                            if (dwDDo_SoGCS.Count == 0)
                                            {
                                                drHDonCosfi["MA_SOGCS"] = "";
                                                drHDonCosfi["MA_KVUC"] = "";
                                                drHDonCosfi["STT"] = "";
                                            }
                                            else
                                            {
                                                //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                            }

                                            //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                            dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            //if (dw.Count == 0)
                                            if (dwVTri_DDo.Count == 0)
                                            {
                                                drHDonCosfi["MA_LO"] = "";
                                                drHDonCosfi["MA_TRAM"] = "";
                                                drHDonCosfi["MA_TO"] = "";
                                            }
                                            else
                                            {
                                                //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                            }

                                            drHDonCosfi["HUU_CONG"] = hc_T;
                                            drHDonCosfi["VO_CONG"] = vc_T;
                                            drHDonCosfi["TIEN_HUUCONG"] = 0;
                                            drHDonCosfi["COSFI"] = cosfi;
                                            drHDonCosfi["KCOSFI"] = kcosfi;
                                            drHDonCosfi["TIEN_VOCONG"] = 0;

                                            //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                            dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            //if (dw.Count == 0)
                                            //if (dwDDo.Count == 0)
                                            //{
                                            //    drHDonCosfi["KIMUA_CSPK"] = 0;
                                            //}
                                            //else
                                            //{
                                            //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                            //if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                            //    drHDonCosfi["KIMUA_CSPK"] = "0";
                                            //else
                                            drHDonCosfi["KIMUA_CSPK"] = iKymua_CSPK.ToString();//Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                            //}

                                            drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                            drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                            drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                            drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                            //if (hc_1358 != 0)
                                            //{
                                            //    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                            //    drHDonCosfi["MA_CNANG"] = 1;
                                            //}
                                            //else
                                            //{
                                            //Mac dinh la = 0
                                            drHDonCosfi["MA_CNANG"] = 0;
                                            drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC_T;
                                            //}
                                            dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                        }
                                        #endregion

                                        #region Sau đổi hệ số phạt
                                        if (hc == 0)
                                            if (vc == 0)
                                                cosfi = 1;
                                            else
                                                cosfi = 0;
                                        else
                                        {
                                            cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                        }

                                        min = 1000;
                                        kcosfi = 0;
                                        foreach (DataRowView drcosfi in dwCosfi)
                                        {
                                            if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                            {
                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                {
                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                }
                                            }
                                        }
                                        if (hc != 0 || vc != 0)
                                        {
                                            //Day du lieu vao HDN_HDONCOSFI    
                                            drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                            drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                            drHDonCosfi["ID_HDONCOSFI"] = 0;
                                            drHDonCosfi["ID_HDON"] = 0;
                                            drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                            drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                            drHDonCosfi["NAM"] = dr["NAM"];
                                            drHDonCosfi["THANG"] = dr["THANG"];
                                            drHDonCosfi["KY"] = dr["KY"];

                                            //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                            dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            //if (dw.Count == 0)
                                            if (dwDDo_SoGCS.Count == 0)
                                            {
                                                drHDonCosfi["MA_SOGCS"] = "";
                                                drHDonCosfi["MA_KVUC"] = "";
                                                drHDonCosfi["STT"] = "";
                                            }
                                            else
                                            {
                                                //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                            }

                                            //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                            dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            //if (dw.Count == 0)
                                            if (dwVTri_DDo.Count == 0)
                                            {
                                                drHDonCosfi["MA_LO"] = "";
                                                drHDonCosfi["MA_TRAM"] = "";
                                                drHDonCosfi["MA_TO"] = "";
                                            }
                                            else
                                            {
                                                //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                            }

                                            drHDonCosfi["HUU_CONG"] = hc;
                                            drHDonCosfi["VO_CONG"] = vc;
                                            drHDonCosfi["TIEN_HUUCONG"] = 0;
                                            drHDonCosfi["COSFI"] = cosfi;
                                            drHDonCosfi["KCOSFI"] = kcosfi;
                                            drHDonCosfi["TIEN_VOCONG"] = 0;

                                            //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                            dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                            //dw.Sort = "NGAY_HLUC DESC";
                                            //if (dw.Count == 0)
                                            if (dwDDo.Count == 0)
                                            {
                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                            }
                                            else
                                            {
                                                //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                            }

                                            drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                            drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                            drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                            drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                            if (hc_1358 != 0)
                                            {
                                                //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                                drHDonCosfi["MA_CNANG"] = 1;
                                            }
                                            else
                                            {
                                                //Mac dinh la = 0
                                                drHDonCosfi["MA_CNANG"] = 0;
                                            }
                                            drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                            dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                        }
                                        #endregion

                                    }
                                }
                                else
                                {
                                    //Co dong chi so vo cong
                                    if (dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'").Length == 0)
                                    {
                                        hc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"));
                                        vc = Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) + Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")) - Convert.ToDouble(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                        i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                        //Kiem tra xem co treo thao tu loai 1 sang 3,5,8 hoac nguoc lai
                                        hc_1358 = 0;
                                        //dwCSKT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                        dwCSKT.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'KT'";
                                        //dwCSKT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                                        if (dwCSKT.Count == 0)
                                        {
                                            //Khong co dong KT
                                            hc_1358 = 0;
                                        }
                                        else
                                        {
                                            //Co dong KT, thuc hien kiem tra xem co dong VC di kem hay khong
                                            //dwCSVC = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                            dwCSVC.RowFilter = "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'";
                                            //dwCSVC.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";
                                            //foreach (DataRowView drvCSKT in dwCSKT)
                                            //{
                                            //    IsExistsTreoThao = 0; //Khong ton tai treo thao tu cong to co sang cong to dien tu hoac nguoc lai
                                            //    foreach (DataRowView drvCSVC in dwCSVC)
                                            //    {
                                            //        if (Convert.ToDateTime(drvCSKT["NGAY_CKY"]) == Convert.ToDateTime(drvCSVC["NGAY_CKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) == Convert.ToDateTime(drvCSVC["NGAY_DKY"]))
                                            //        {
                                            //            IsExistsTreoThao = 1;
                                            //            break;
                                            //        }
                                            //    }
                                            //    //Khong ton tai VC cung ngay dau ky va ngay cuoi ky voi KT
                                            //    if (IsExistsTreoThao == 0)
                                            //    {
                                            //        hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                            //    }
                                            //}

                                            //Loc cac san luong KT khong dung de tinh cosfi
                                            foreach (DataRowView drvCSKT in dwCSKT)
                                            {
                                                IsTinhCosfi = 0; //Khong dung de tinh cosfi
                                                foreach (DataRowView drvCSVC in dwCSVC)
                                                {
                                                    if (Convert.ToDateTime(drvCSKT["NGAY_DKY"]) >= Convert.ToDateTime(drvCSVC["NGAY_DKY"]) && Convert.ToDateTime(drvCSKT["NGAY_DKY"]) <= Convert.ToDateTime(drvCSVC["NGAY_CKY"]))
                                                    {
                                                        IsTinhCosfi = 1;
                                                        break;
                                                    }
                                                }
                                                //Khong ton tai VC chua ngay dau ky KT, loai bo san luong nay khoi thanh phan HC tinh cosfi
                                                if (IsTinhCosfi == 0)
                                                {
                                                    //hc1358: tong cac san luong KT khong dung de tinh cosfi
                                                    hc_1358 = hc_1358 + Convert.ToDouble(drvCSKT["SAN_LUONG"]) + Convert.ToDouble(drvCSKT["SLUONG_TTIEP"]) - Convert.ToDouble(drvCSKT["SLUONG_TRPHU"]);
                                                }
                                            }
                                        }
                                        hc = hc - hc_1358;

                                        //Hieu chinh lai san luong hc va vc doi voi cac truong hop sau
                                        //Diem do co quan he tru phu 10, 11 tuc la tru phu huu cong khi tinh tien dien, khong tru phu huu cong khi tinh cosfi
                                        if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                        {
                                            //dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                            dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                            hc_tp = 0;
                                            foreach (DataRowView drTP in dwTP)
                                            {
                                                strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                                //Xu ly doi voi SHBB va SXD1
                                                IsExistsSHBB = 0;
                                                IsExistsSXD1 = 0;
                                                //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                                if (IsExistsParam == 1)
                                                {
                                                    if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA_GT") == true)
                                                    {
                                                        drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA_GT"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                        if (drDDo.Length > 0)
                                                        {
                                                            IsExistsSHBB = 1;
                                                        }
                                                        else
                                                        {
                                                            IsExistsSHBB = 0;
                                                        }

                                                        drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                        if (drDDo.Length > 0)
                                                        {
                                                            IsExistsSXD1 = 1;
                                                        }
                                                        else
                                                        {
                                                            IsExistsSXD1 = 0;
                                                        }

                                                        if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                        {
                                                            heso_truphu = Convert.ToDecimal(1.1);
                                                        }
                                                        else
                                                        {
                                                            heso_truphu = Convert.ToDecimal(1.0);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        heso_truphu = Convert.ToDecimal(1.0);
                                                    }
                                                }
                                                else
                                                {
                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                }

                                                hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                            }
                                            hc = hc + hc_tp;
                                        }

                                        if (hc == 0)
                                            if (vc == 0)
                                                cosfi = 1;
                                            else
                                                cosfi = 0;
                                        else
                                        {
                                            cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                        }

                                        min = 1000;
                                        kcosfi = 0;
                                        foreach (DataRowView drcosfi in dwCosfi)
                                        {
                                            if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                            {
                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                {
                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                }
                                            }
                                        }

                                        if (hc != 0 || vc != 0)
                                        {
                                            //Day du lieu vao HDN_HDONCOSFI    
                                            drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                            drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                            drHDonCosfi["ID_HDONCOSFI"] = 0;
                                            drHDonCosfi["ID_HDON"] = 0;
                                            drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                            drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                            //drHDonCosfi["MA_SOGCS"] = strMaSoGCS;
                                            drHDonCosfi["NAM"] = dr["NAM"];
                                            drHDonCosfi["THANG"] = dr["THANG"];
                                            drHDonCosfi["KY"] = dr["KY"];

                                            if (dsCustomerData.Tables.Contains("HDG_DDO_SOGCS_GT") == true)
                                            {
                                                //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS_GT"]);
                                                dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                //dw.Sort = "NGAY_HLUC DESC";
                                                if (dwDDo_SoGCS.Count == 0)
                                                {
                                                    drHDonCosfi["MA_SOGCS"] = "";
                                                    drHDonCosfi["MA_KVUC"] = "";
                                                    drHDonCosfi["STT"] = "";
                                                }
                                                else
                                                {
                                                    drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                    drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                    drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                }
                                            }
                                            else
                                            {
                                                drHDonCosfi["MA_SOGCS"] = "";
                                                drHDonCosfi["MA_KVUC"] = "";
                                                drHDonCosfi["STT"] = "";
                                            }

                                            if (dsCustomerData.Tables.Contains("HDG_VITRI_DDO_GT") == true)
                                            {
                                                //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO_GT"]);
                                                dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                //dw.Sort = "NGAY_HLUC DESC";
                                                if (dwVTri_DDo.Count == 0)
                                                {
                                                    drHDonCosfi["MA_LO"] = "";
                                                    drHDonCosfi["MA_TRAM"] = "";
                                                    drHDonCosfi["MA_TO"] = "";
                                                }
                                                else
                                                {
                                                    drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                    drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                    drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                }
                                            }
                                            else
                                            {
                                                drHDonCosfi["MA_LO"] = "";
                                                drHDonCosfi["MA_TRAM"] = "";
                                                drHDonCosfi["MA_TO"] = "";
                                            }

                                            //drHDonCosfi["MA_KVUC"] = "";
                                            //drHDonCosfi["STT"] = "";
                                            //drHDonCosfi["MA_LO"] = "";
                                            //drHDonCosfi["MA_TRAM"] = "";
                                            //drHDonCosfi["MA_TO"] = "";

                                            drHDonCosfi["HUU_CONG"] = hc;
                                            drHDonCosfi["VO_CONG"] = vc;
                                            drHDonCosfi["TIEN_HUUCONG"] = 0;
                                            drHDonCosfi["COSFI"] = cosfi;
                                            drHDonCosfi["KCOSFI"] = kcosfi;
                                            drHDonCosfi["TIEN_VOCONG"] = 0;
                                            //drHDonCosfi["KIMUA_CSPK"] = 0;

                                            if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == false)
                                            {
                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                            }
                                            else
                                            {
                                                //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                                                dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                //dw.Sort = "NGAY_HLUC DESC";
                                                if (dwDDo.Count == 0)
                                                {
                                                    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                }
                                                else
                                                {
                                                    drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                }
                                            }

                                            drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                            drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                            drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                            drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                            drHDonCosfi["MA_CNANG"] = 0;
                                            drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                            dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                        }
                                    }
                                }
                            }
                        }
                    }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_6: " + ex.Message;
            }
            //finally
            //{
            //    dsInvoiceData.AcceptChanges();
            //    dsCustomerData.AcceptChanges();
            //}
        }
        public string RawDataCalculation_7(DataSet dsCustomerData, DataSet dsInvoiceData, DataSet dsStaticCatalog, string strTen_DNhap)
        {
            try
            {
                string strMa_DDo = "", strMa_DDoTmp = "";
                DataRow[] rowsQHC, rowsQHP, rowsDDoCosFi, rowsDDoPhu, drDDo, drParameters;
                DataRow drHDonCosfi;
                Double hc = 0, vc = 0, hc_T = 0, vc_T = 0, hc_tp_T = 0, hc_1358_T = 0; ;
                Decimal cosfi = 0, kcosfi = 0;
                Decimal min = 0, heso_truphu = 0;
                Int16 IsExistsCS = 0, IsExistsParam = 0, IsExistsSHBB = 0, IsExistsSXD1 = 0, IsTinhCosfi = 0, IsExistsDoiHSPhat = 0;
                Int16 iKymua_CSPK = 0, iKhoangCSPK = 0;//iKhoangCSPK=1: khoảng ngày trước ngày áp dụng CSPK Max
                //iKhoangCSPK=2: khoảng ngày sau ngày áp dụng CSPK Max
                Int64 i64ID_CHISO_VC_T = 0, i64ID_CHISO_VC = 0;
                DateTime dtMinNgayDK, dtMaxNgayCK, dtDoiHSPhatCosfi, dtNgayDoiCSPK;
                DataView dwCosfi, dwCS, dwCS_GT, dwCS_BQ, dwDDo, dwDDo_GT, dwDDo_SoGCS, dwVTri_DDo;
                DataRow drCosfiCCS = null, drCosfiDDK = null;
                dwDDo_GT = new DataView();
                dwCS_GT = new DataView();
                if (dsStaticCatalog == null)
                    return "dsStaticCatalog"; //du lieu truyen vao bi null
                else
                    if (dsStaticCatalog.Tables.Contains("D_COSFI") == false)
                        return "NotExistsD_COSFI"; //khong ton tai bang D_COSFI

                if (dsInvoiceData == null)
                    return "dsInvoiceDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsInvoiceData.Tables.Contains("HDN_HDONCOSFI") == false)
                        return "NotExistsHDN_HDONCOSFI"; //khong ton tai bang HDN_HDONCOSFI

                if (dsCustomerData == null)
                    return "dsCustomerDataIsNull"; //du lieu truyen vao bi null
                else
                    if (dsCustomerData.Tables.Contains("GCS_CHISO") == false)
                        return "NotExistsGCS_CHISO"; //khong ton tai bang GCS_CHISO
                    else
                        if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true)
                            //Co bang HDG_QHE_DDO
                            if (dsCustomerData.Tables.Contains("GCS_CHISO_BQ") == true)
                            //Co bang GCS_CHISO_BQ
                            {
                                //Khởi tạo các giá trị ban đầu
                                dwCosfi = new DataView(dsStaticCatalog.Tables["D_COSFI"]);
                                dwCosfi.Sort = "NGAY_ADUNG DESC, HS_COSFI ASC";
                                dwCS = new DataView(dsCustomerData.Tables["GCS_CHISO"]);
                                dwCS.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";
                                dwDDo = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                dwDDo_SoGCS = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                if (dwDDo_SoGCS.Count != 0)
                                {
                                    dwDDo_SoGCS.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo_SoGCS[0]["MA_DVIQLY"]) + "'";
                                }
                                dwDDo_SoGCS.Sort = "NGAY_HLUC DESC";

                                dwVTri_DDo = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                if (dwVTri_DDo.Count != 0)
                                {
                                    dwVTri_DDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwVTri_DDo[0]["MA_DVIQLY"]) + "'";
                                }
                                dwVTri_DDo.Sort = "NGAY_HLUC DESC";
                                if (dwDDo.Count != 0)
                                {
                                    dwDDo.RowFilter = "MA_DVIQLY = '" + Convert.ToString(dwDDo[0]["MA_DVIQLY"]) + "'";
                                }
                                dwDDo.Sort = "NGAY_HLUC DESC";
                                if (dsCustomerData.Tables.Contains("HDG_DIEM_DO_GT") == true)
                                {
                                    dwDDo_GT = new DataView(dsCustomerData.Tables["HDG_DIEM_DO_GT"]);
                                    dwDDo_GT.Sort = "NGAY_HLUC DESC";
                                }
                                if (dsCustomerData.Tables.Contains("GCS_CHISO_GT") == true)
                                {
                                    dwCS_GT = new DataView(dsCustomerData.Tables["GCS_CHISO_GT"]);
                                    dwCS_GT.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";
                                }

                                dwCS_BQ = new DataView(dsCustomerData.Tables["GCS_CHISO_BQ"]);
                                dwCS_BQ.Sort = "NGAY_DKY, NGAY_CKY, ID_CHISO";

                                //Kiem tra tham so he thong la 'G_TPSXD1_20100301' voi gia tri C
                                if (dsStaticCatalog.Tables.Contains("S_PARAMETER") == true)
                                {
                                    drParameters = dsStaticCatalog.Tables["S_PARAMETER"].Select("NAME = 'G_TPSXD1_20100301' AND (PRAVALUE = 'C' OR PRAVALUE = 'c')");
                                    if (drParameters.Length > 0)
                                    {
                                        //Co ton tai tham so
                                        IsExistsParam = 1;
                                    }
                                }
                                #region GCS_CHISO
                                foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO"].Rows)
                                {
                                    if (Convert.ToString(dr["MA_DDO"]) != strMa_DDo)
                                    {

                                        IsExistsDoiHSPhat = 0;
                                        dtMinNgayDK = new DateTime(1900, 1, 1);
                                        dtMaxNgayCK = new DateTime(1900, 1, 1);
                                        dtDoiHSPhatCosfi = new DateTime(1900, 1, 1);
                                        dtNgayDoiCSPK = new DateTime(1900, 1, 1);
                                        hc = 0;
                                        vc = 0;
                                        hc_T = 0;
                                        vc_T = 0;
                                        iKhoangCSPK = 0;
                                        iKymua_CSPK = 0;

                                        IsExistsCS = 0;
                                        strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                                        if (strMa_DDo == "PA04DTDTC0116002")
                                        {
                                            strMa_DDo = "PA04DTDTC0116002";
                                        }
                                        hc = 0;
                                        vc = 0;

                                        rowsQHC = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE = '32'");
                                        rowsQHP = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_PHU = '" + strMa_DDo + "' AND LOAI_QHE = '32'");

                                        if (rowsQHC.Length == 0 && rowsQHP.Length == 0)
                                        {
                                            continue;
                                        }
                                        else
                                        {
                                            if (rowsQHC.Length != 0 && rowsQHP.Length != 0)
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                //La diem do thoa man dieu kien tinh cosfi binh quan
                                                //Dũng NT hiệu chỉnh ngày 06/11/2014 vụ đổi hệ số phạt 
                                                //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                                dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                                foreach (DataRowView drvCosfi in dwCosfi)
                                                {

                                                    DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                    if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                    {
                                                        //Có đổi hệ số phạt cosfi
                                                        IsExistsDoiHSPhat = 1;
                                                        //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                        dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                        break;
                                                    }


                                                }
                                                //End
                                                if (IsExistsDoiHSPhat == 1)
                                                {
                                                    //Có đổi hệ số phạt
                                                    dwDDo.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                    //if (dw.Count == 0)
                                                    if (dwDDo.Count == 0)
                                                    {
                                                        iKymua_CSPK = 0;
                                                    }
                                                    else
                                                    {
                                                        //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                        iKymua_CSPK = Utility.Int16Dbnull(dwDDo[0]["KIMUA_CSPK"]);
                                                        if (dwDDo[0]["NGAY_DOI_CSPK"].ToString().Trim().Length > 0)
                                                            dtNgayDoiCSPK = Convert.ToDateTime(dwDDo[0]["NGAY_DOI_CSPK"]);
                                                    }
                                                    //Kiểm soát điểm đo chính cosfi BQ phải ký mua CSPK
                                                    if (iKymua_CSPK == 0)
                                                        return strMa_DDo + " có quan hệ cosfi bình quân, chưa ký mua CSPK.";
                                                    //Với dữ liệu bảng GCS_CHISO, mặc đinh đã qua kiểm tra chốt CSPK
                                                    //int IsChotCS_CSPK = 1;
                                                    TinhHC_VC(ref i64ID_CHISO_VC_T, ref i64ID_CHISO_VC, ref hc, ref vc, ref hc_T, ref vc_T, dwCS, strMa_DDo, true, dtDoiHSPhatCosfi);
                                                    if (hc != 0 || hc_T != 0 || vc != 0 || vc_T != 0)
                                                        IsExistsCS = 1;
                                                    else
                                                        IsExistsCS = 0;
                                                    if (rowsQHC.Length != 0)
                                                    {
                                                        //La diem do chinh quan he cosfi binh quan
                                                        foreach (DataRow drQH in rowsQHC)
                                                        {
                                                            strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                            //Không cần kiểm tra nữa, vì đã kiểm tra trong CheckValidData
                                                            //Kiểm tra có ký mua CSPK không, nếu không báo lỗi luôn, phải kiểm tra cả 2 bảng HDG_DIEM_DO và HDG_DIEM_DO_GT
                                                            //dwDDo.RowFilter = "MA_DDO = '" + strMa_DDoTmp + "'";
                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                            //if (dw.Count == 0)
                                                            //if (dwDDo.Count == 0)
                                                            //{
                                                            //    //Kiem tra trong GCS_CHISO_BQ
                                                            //    if (dsCustomerData.Tables["GCS_CHISO_BQ"].Columns["KIMUA_CSPK"] == null) return "Package chưa cập nhật chính xác, thiếu cột KIMUA_CSPK";
                                                            //    DataRow[] arrBQ = dsCustomerData.Tables["GCS_CHISO_BQ"].Select("MA_DDO='" + strMa_DDoTmp + "'");
                                                            //    if (arrBQ != null && arrBQ.Length > 0)
                                                            //    {
                                                            //        if (Utility.Int16Dbnull(arrBQ[0]["KIMUA_CSPK"]) == 0)
                                                            //        {
                                                            //            return strMa_DDoTmp + " là điểm đo phụ cosfi bình quân của " + strMa_DDo + " chưa ký mua CSPK.";
                                                            //        }
                                                            //        else
                                                            //        {
                                                            //            iKymua_CSPK = Utility.Int16Dbnull(arrBQ[0]["KIMUA_CSPK"]);
                                                            //        }
                                                            //    }
                                                            //    else
                                                            //        return strMa_DDoTmp + " là điểm đo phụ cosfi bình quân của " + strMa_DDo + " chưa ký mua CSPK.";


                                                            //}
                                                            //else
                                                            //{
                                                            //    if (Utility.Int16Dbnull(dwDDo[0]["KIMUA_CSPK"]) == 0)
                                                            //        return strMa_DDoTmp + " là điểm đo phụ cosfi bình quân của " + strMa_DDo + " chưa ký mua CSPK.";

                                                            //    iKymua_CSPK = Utility.Int16Dbnull(dwDDo[0]["KIMUA_CSPK"]);
                                                            //}
                                                            TinhHC_VC(ref i64ID_CHISO_VC_T, ref i64ID_CHISO_VC, ref hc, ref vc, ref hc_T, ref vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                        }
                                                        //Kiểm tra đã có dòng HDN_HDONCOSFI chưa
                                                        i64ID_CHISO_VC_T = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                                        i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                        DataRow[] arrCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                        if (arrCosfi == null || arrCosfi.Length == 0)
                                                        {
                                                            drCosfiCCS = null;
                                                            drCosfiDDK = null;
                                                        }
                                                        else if (arrCosfi.Length == 1)
                                                        {
                                                            //Đã có 1 dòng, day vao theo ID_CHISO
                                                            dwCS.RowFilter = "MA_DDO='" + strMa_DDo + "'";
                                                            if (dwCS != null && dwCS.Count > 0)
                                                            {
                                                                foreach (DataRowView drvTemp in dwCS)
                                                                {
                                                                    if (Convert.ToInt64(drvTemp["ID_CHISO"]) == Convert.ToInt64(arrCosfi[0]["ID_CHISO"]))
                                                                    {
                                                                        if (drvTemp["LOAI_CHISO"].ToString().Trim() != "DDK")
                                                                        {
                                                                            drCosfiCCS = arrCosfi[0];
                                                                            drCosfiDDK = null;
                                                                        }
                                                                        else
                                                                        {
                                                                            drCosfiCCS = null;
                                                                            drCosfiDDK = arrCosfi[0];
                                                                        }
                                                                        break;
                                                                    }
                                                                }
                                                            }
                                                            else
                                                            {
                                                                drCosfiCCS = null;
                                                                drCosfiDDK = arrCosfi[0];
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //Có 2 dòng HDN_HDONCOSFI
                                                            drCosfiCCS = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Min(b => b.Field<Int64>("ID_CHISO"))).First();
                                                            drCosfiDDK = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Max(b => b.Field<Int64>("ID_CHISO"))).First();
                                                        }


                                                        #region Trước đổi hệ số phạt
                                                        if (hc_T == 0)
                                                            if (vc_T == 0)
                                                                cosfi = 1;
                                                            else
                                                                cosfi = 0;
                                                        else
                                                        {
                                                            cosfi = Math.Round(Convert.ToDecimal(hc_T / Math.Sqrt(Convert.ToDouble(hc_T * hc_T + vc_T * vc_T))), 2, MidpointRounding.AwayFromZero);
                                                        }

                                                        min = 1000;
                                                        kcosfi = 0;
                                                        foreach (DataRowView drcosfi in dwCosfi)
                                                        {
                                                            if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtDoiHSPhatCosfi) continue;
                                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                            {
                                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                {
                                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                }
                                                            }
                                                        }
                                                        if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                                        {
                                                            cosfi = 1;
                                                            kcosfi = 0;
                                                        }
                                                        if (hc_T != 0 || vc_T != 0)
                                                        {
                                                            if (IsExistsCS == 1)
                                                            {
                                                                if (drCosfiCCS == null)
                                                                {
                                                                    //Day du lieu vao HDN_HDONCOSFI    
                                                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                    drHDonCosfi["ID_HDON"] = 0;
                                                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                    drHDonCosfi["NAM"] = dr["NAM"];
                                                                    drHDonCosfi["THANG"] = dr["THANG"];
                                                                    drHDonCosfi["KY"] = dr["KY"];

                                                                    //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                    dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                                    //if (dw.Count == 0)
                                                                    if (dwDDo_SoGCS.Count == 0)
                                                                    {
                                                                        drHDonCosfi["MA_SOGCS"] = "";
                                                                        drHDonCosfi["MA_KVUC"] = "";
                                                                        drHDonCosfi["STT"] = "";
                                                                    }
                                                                    else
                                                                    {
                                                                        //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                        //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                        //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                        drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                        drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                        drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                    }

                                                                    //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                    dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                                    //if (dw.Count == 0)
                                                                    if (dwVTri_DDo.Count == 0)
                                                                    {
                                                                        drHDonCosfi["MA_LO"] = "";
                                                                        drHDonCosfi["MA_TRAM"] = "";
                                                                        drHDonCosfi["MA_TO"] = "";
                                                                    }
                                                                    else
                                                                    {
                                                                        //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                        //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                        //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                        drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                        drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                        drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                    }

                                                                    drHDonCosfi["HUU_CONG"] = hc_T;
                                                                    drHDonCosfi["VO_CONG"] = vc_T;
                                                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                    drHDonCosfi["COSFI"] = cosfi;
                                                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                                                    drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                    //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                    dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                                    //if (dw.Count == 0)
                                                                    //if (dwDDo.Count == 0)
                                                                    //{
                                                                    //    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                    //}
                                                                    //else
                                                                    //{
                                                                    //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                    drHDonCosfi["KIMUA_CSPK"] = iKymua_CSPK.ToString();//Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                    //}

                                                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                    //if (hc_1358 != 0)
                                                                    //{
                                                                    //    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                                                    //    drHDonCosfi["MA_CNANG"] = 1;
                                                                    //}
                                                                    //else
                                                                    //{
                                                                    //Mac dinh la = 0
                                                                    drHDonCosfi["MA_CNANG"] = 0;
                                                                    drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC_T;
                                                                    //}
                                                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                }
                                                                else
                                                                {
                                                                    drCosfiCCS["HUU_CONG"] = hc_T;
                                                                    drCosfiCCS["VO_CONG"] = vc_T;
                                                                    drCosfiCCS["COSFI"] = cosfi;
                                                                    drCosfiCCS["KCOSFI"] = kcosfi;
                                                                }
                                                            }
                                                        }
                                                        #endregion

                                                        #region Sau đổi hệ số phạt
                                                        if (hc == 0)
                                                            if (vc == 0)
                                                                cosfi = 1;
                                                            else
                                                                cosfi = 0;
                                                        else
                                                        {
                                                            cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                        }

                                                        min = 1000;
                                                        kcosfi = 0;
                                                        foreach (DataRowView drcosfi in dwCosfi)
                                                        {
                                                            if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                            {
                                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                {
                                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                }
                                                            }
                                                        }
                                                        if (hc != 0 || vc != 0)
                                                        {
                                                            if (IsExistsCS == 1)
                                                            {
                                                                if (drCosfiDDK == null)
                                                                {
                                                                    //Day du lieu vao HDN_HDONCOSFI    
                                                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                    drHDonCosfi["ID_HDON"] = 0;
                                                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                    drHDonCosfi["NAM"] = dr["NAM"];
                                                                    drHDonCosfi["THANG"] = dr["THANG"];
                                                                    drHDonCosfi["KY"] = dr["KY"];

                                                                    //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                    dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                                    //if (dw.Count == 0)
                                                                    if (dwDDo_SoGCS.Count == 0)
                                                                    {
                                                                        drHDonCosfi["MA_SOGCS"] = "";
                                                                        drHDonCosfi["MA_KVUC"] = "";
                                                                        drHDonCosfi["STT"] = "";
                                                                    }
                                                                    else
                                                                    {
                                                                        //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                        //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                        //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                        drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                        drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                        drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                    }

                                                                    //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                    dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                                    //if (dw.Count == 0)
                                                                    if (dwVTri_DDo.Count == 0)
                                                                    {
                                                                        drHDonCosfi["MA_LO"] = "";
                                                                        drHDonCosfi["MA_TRAM"] = "";
                                                                        drHDonCosfi["MA_TO"] = "";
                                                                    }
                                                                    else
                                                                    {
                                                                        //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                        //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                        //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                        drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                        drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                        drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                    }

                                                                    drHDonCosfi["HUU_CONG"] = hc;
                                                                    drHDonCosfi["VO_CONG"] = vc;
                                                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                    drHDonCosfi["COSFI"] = cosfi;
                                                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                                                    drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                    //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                    dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                    //dw.Sort = "NGAY_HLUC DESC";
                                                                    //if (dw.Count == 0)
                                                                    if (dwDDo.Count == 0)
                                                                    {
                                                                        drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                    }
                                                                    else
                                                                    {
                                                                        //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                        drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                    }

                                                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;

                                                                    //Mac dinh la = 0
                                                                    drHDonCosfi["MA_CNANG"] = 0;

                                                                    drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                }
                                                                else
                                                                {
                                                                    drCosfiDDK["HUU_CONG"] = hc;
                                                                    drCosfiDDK["VO_CONG"] = vc;
                                                                    drCosfiDDK["COSFI"] = cosfi;
                                                                    drCosfiDDK["KCOSFI"] = kcosfi;
                                                                }
                                                            }
                                                        }

                                                        #endregion
                                                    }
                                                    else
                                                    {
                                                        //La diem do phu quan he cosfi binh quan
                                                        if (rowsQHP.Length > 1)
                                                        {
                                                            //La diem do phu quan he cosfi binh quan cua 2 diem do chinh, khong duoc tinh
                                                            continue;
                                                        }
                                                        else
                                                        {
                                                            //San luong diem do chinh quan he cosfi binh quan
                                                            strMa_DDoTmp = Convert.ToString(rowsQHP[0]["MA_DDO_CHINH"]);

                                                            TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);


                                                            //San luong cac diem do phu quan he cosfi binh quan
                                                            rowsDDoPhu = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDoTmp + "' AND LOAI_QHE = '32' AND MA_DDO_PHU <> '" + strMa_DDo + "'");
                                                            foreach (DataRow drQH in rowsDDoPhu)
                                                            {
                                                                strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                            }
                                                            i64ID_CHISO_VC_T = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                                            i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                            DataRow[] arrCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                            if (arrCosfi == null || arrCosfi.Length == 0)
                                                            {
                                                                drCosfiCCS = null;
                                                                drCosfiDDK = null;
                                                            }
                                                            else if (arrCosfi.Length == 1)
                                                            {
                                                                //Đã có 1 dòng, day vao theo ID_CHISO
                                                                dwCS.RowFilter = "MA_DDO='" + strMa_DDo + "'";
                                                                if (dwCS != null && dwCS.Count > 0)
                                                                {
                                                                    foreach (DataRowView drvTemp in dwCS)
                                                                    {
                                                                        if (Convert.ToInt64(drvTemp["ID_CHISO"]) == Convert.ToInt64(arrCosfi[0]["ID_CHISO"]))
                                                                        {
                                                                            if (drvTemp["LOAI_CHISO"].ToString().Trim() != "DDK")
                                                                            {
                                                                                drCosfiCCS = arrCosfi[0];
                                                                                drCosfiDDK = null;
                                                                            }
                                                                            else
                                                                            {
                                                                                drCosfiCCS = null;
                                                                                drCosfiDDK = arrCosfi[0];
                                                                            }
                                                                            break;
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    drCosfiCCS = null;
                                                                    drCosfiDDK = arrCosfi[0];
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //Có 2 dòng HDN_HDONCOSFI
                                                                drCosfiCCS = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Min(b => b.Field<Int64>("ID_CHISO"))).First();
                                                                drCosfiDDK = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Max(b => b.Field<Int64>("ID_CHISO"))).First();
                                                            }

                                                            #region Trước dổi hệ số phạt
                                                            if (hc_T == 0)
                                                                if (vc_T == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc_T / Math.Sqrt(Convert.ToDouble(hc_T * hc_T + vc_T * vc_T))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRowView drcosfi in dwCosfi)
                                                            {
                                                                if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtDoiHSPhatCosfi) continue;
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }
                                                            if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                                            {
                                                                cosfi = 1;
                                                                kcosfi = 0;
                                                            }
                                                            if (hc_T != 0 || vc_T != 0)
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {
                                                                    if (drCosfiCCS == null)
                                                                    {
                                                                        //Day du lieu vao HDN_HDONCOSFI    
                                                                        drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                        drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                        drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                        drHDonCosfi["ID_HDON"] = 0;
                                                                        drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                        drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                        drHDonCosfi["NAM"] = dr["NAM"];
                                                                        drHDonCosfi["THANG"] = dr["THANG"];
                                                                        drHDonCosfi["KY"] = dr["KY"];

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                        dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwDDo_SoGCS.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_SOGCS"] = "";
                                                                            drHDonCosfi["MA_KVUC"] = "";
                                                                            drHDonCosfi["STT"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                            //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                            //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                            drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                            drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                            drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                        }

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                        dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwVTri_DDo.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_LO"] = "";
                                                                            drHDonCosfi["MA_TRAM"] = "";
                                                                            drHDonCosfi["MA_TO"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                            //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                            //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                            drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                            drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                            drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                        }

                                                                        drHDonCosfi["HUU_CONG"] = hc_T;
                                                                        drHDonCosfi["VO_CONG"] = vc_T;
                                                                        drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                        drHDonCosfi["COSFI"] = cosfi;
                                                                        drHDonCosfi["KCOSFI"] = kcosfi;
                                                                        drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                        dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        //if (dwDDo.Count == 0)
                                                                        //{
                                                                        //    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                        //}
                                                                        //else
                                                                        //{
                                                                        //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                        drHDonCosfi["KIMUA_CSPK"] = iKymua_CSPK.ToString();//Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                        //}

                                                                        drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                        drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                        //if (hc_1358 != 0)
                                                                        //{
                                                                        //    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                                                        //    drHDonCosfi["MA_CNANG"] = 1;
                                                                        //}
                                                                        //else
                                                                        //{
                                                                        //Mac dinh la = 0
                                                                        drHDonCosfi["MA_CNANG"] = 0;
                                                                        drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC_T;
                                                                        //}
                                                                        dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                    }
                                                                    else
                                                                    {
                                                                        drCosfiCCS["HUU_CONG"] = hc_T;
                                                                        drCosfiCCS["VO_CONG"] = vc_T;
                                                                        drCosfiCCS["COSFI"] = cosfi;
                                                                        drCosfiCCS["KCOSFI"] = kcosfi;
                                                                    }
                                                                }
                                                            }
                                                            #endregion

                                                            #region Sau đổi hệ số phạt
                                                            if (hc == 0)
                                                                if (vc == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRowView drcosfi in dwCosfi)
                                                            {
                                                                if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }
                                                            if (hc != 0 || vc != 0)
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {
                                                                    if (drCosfiDDK == null)
                                                                    {
                                                                        //Day du lieu vao HDN_HDONCOSFI    
                                                                        drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                        drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                        drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                        drHDonCosfi["ID_HDON"] = 0;
                                                                        drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                        drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                        drHDonCosfi["NAM"] = dr["NAM"];
                                                                        drHDonCosfi["THANG"] = dr["THANG"];
                                                                        drHDonCosfi["KY"] = dr["KY"];

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                        dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwDDo_SoGCS.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_SOGCS"] = "";
                                                                            drHDonCosfi["MA_KVUC"] = "";
                                                                            drHDonCosfi["STT"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                            //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                            //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                            drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                            drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                            drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                        }

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                        dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwVTri_DDo.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_LO"] = "";
                                                                            drHDonCosfi["MA_TRAM"] = "";
                                                                            drHDonCosfi["MA_TO"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                            //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                            //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                            drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                            drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                            drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                        }

                                                                        drHDonCosfi["HUU_CONG"] = hc;
                                                                        drHDonCosfi["VO_CONG"] = vc;
                                                                        drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                        drHDonCosfi["COSFI"] = cosfi;
                                                                        drHDonCosfi["KCOSFI"] = kcosfi;
                                                                        drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                        dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwDDo.Count == 0)
                                                                        {
                                                                            drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                            drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                        }

                                                                        drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                        drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;

                                                                        //Mac dinh la = 0
                                                                        drHDonCosfi["MA_CNANG"] = 0;

                                                                        drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                                                        dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                    }
                                                                    else
                                                                    {
                                                                        drCosfiDDK["HUU_CONG"] = hc;
                                                                        drCosfiDDK["VO_CONG"] = vc;
                                                                        drCosfiDDK["COSFI"] = cosfi;
                                                                        drCosfiDDK["KCOSFI"] = kcosfi;
                                                                    }
                                                                }
                                                            }

                                                            #endregion
                                                        }
                                                    }

                                                }
                                                else
                                                {
                                                    //Tính như cũ
                                                    hc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                    vc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")));

                                                    //Kiem tra quan he 10, 11 va bu san luong tru phu cua cac diem do phu 10, 11
                                                    if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                                    {
                                                        DataView dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                                        dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                                        double hc_tp = 0;
                                                        foreach (DataRowView drTP in dwTP)
                                                        {
                                                            string strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                                            //Xu ly doi voi SHBB va SXD1
                                                            IsExistsSHBB = 0;
                                                            IsExistsSXD1 = 0;
                                                            //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                                            if (IsExistsParam == 1)
                                                            {
                                                                if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                                                                {
                                                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                                    if (drDDo.Length > 0)
                                                                    {
                                                                        IsExistsSHBB = 1;
                                                                    }
                                                                    else
                                                                    {
                                                                        IsExistsSHBB = 0;
                                                                    }

                                                                    drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                                    if (drDDo.Length > 0)
                                                                    {
                                                                        IsExistsSXD1 = 1;
                                                                    }
                                                                    else
                                                                    {
                                                                        IsExistsSXD1 = 0;
                                                                    }

                                                                    if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                                    {
                                                                        heso_truphu = Convert.ToDecimal(1.1);
                                                                    }
                                                                    else
                                                                    {
                                                                        heso_truphu = Convert.ToDecimal(1.0);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                heso_truphu = Convert.ToDecimal(1.0);
                                                            }

                                                            hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                                        }
                                                        hc = hc + hc_tp;
                                                    }

                                                    //Co ton tai chi so co san luong <> 0 hay khong
                                                    if (hc != 0 || vc != 0)
                                                    {
                                                        IsExistsCS = 1;
                                                    }
                                                    else
                                                    {
                                                        IsExistsCS = 0;
                                                    }
                                                    if (rowsQHC.Length != 0)
                                                    {
                                                        //La diem do chinh quan he cosfi binh quan
                                                        foreach (DataRow drQH in rowsQHC)
                                                        {
                                                            strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                            //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                            dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                            dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                            foreach (DataRowView drvCosfi in dwCosfi)
                                                            {

                                                                DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                                if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                                {
                                                                    //Có đổi hệ số phạt cosfi
                                                                    IsExistsDoiHSPhat = 1;
                                                                    //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                                    dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                                    break;
                                                                }
                                                            }
                                                            if (IsExistsDoiHSPhat == 1)
                                                            {
                                                                if (iKhoangCSPK == 1)
                                                                {
                                                                    //Khoảng ngày trước ngày đổi CSPK
                                                                    hc_T = hc;
                                                                    hc = 0;
                                                                    vc_T = vc;
                                                                    vc = 0;
                                                                }
                                                                else
                                                                {
                                                                }
                                                                TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                            }
                                                            //Lấy lại ID_CHISO_VC của điểm đo chính
                                                            else
                                                            {
                                                                hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                            }
                                                            i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                        }
                                                        if (hc == 0)
                                                            if (vc == 0)
                                                                cosfi = 1;
                                                            else
                                                                cosfi = 0;
                                                        else
                                                        {
                                                            cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                        }

                                                        min = 1000;
                                                        kcosfi = 0;
                                                        foreach (DataRowView drcosfi in dwCosfi)
                                                        {
                                                            if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                            if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                            {
                                                                if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                {
                                                                    min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                    kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                }
                                                            }
                                                        }

                                                        rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                        if (rowsDDoCosFi.Length != 0)
                                                        {
                                                            rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                            rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                            rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                            rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                        }
                                                        else
                                                        {
                                                            if (IsExistsCS == 1)
                                                            {
                                                                //Day du lieu vao HDN_HDONCOSFI    
                                                                string strMaSoGCS = "";
                                                                var arrMaSoGCS = dsCustomerData.Tables["HDG_DDO_SOGCS"].AsEnumerable().Where(c => c.Field<string>("MA_DDO") == dr["MA_DDO"].ToString().Trim());
                                                                if (arrMaSoGCS != null && arrMaSoGCS.Count() > 0)
                                                                    strMaSoGCS = arrMaSoGCS.First()["MA_SOGCS"].ToString();
                                                                else strMaSoGCS = " ";
                                                                drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                drHDonCosfi["ID_HDON"] = 0;
                                                                drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                drHDonCosfi["MA_SOGCS"] = "";
                                                                drHDonCosfi["NAM"] = dr["NAM"];
                                                                drHDonCosfi["THANG"] = dr["THANG"];
                                                                drHDonCosfi["KY"] = dr["KY"];
                                                                drHDonCosfi["MA_KVUC"] = "";
                                                                drHDonCosfi["STT"] = "";
                                                                drHDonCosfi["MA_LO"] = "";
                                                                drHDonCosfi["MA_TRAM"] = "";
                                                                drHDonCosfi["MA_TO"] = "";
                                                                drHDonCosfi["HUU_CONG"] = hc;
                                                                drHDonCosfi["VO_CONG"] = vc;
                                                                drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                drHDonCosfi["COSFI"] = cosfi;
                                                                drHDonCosfi["KCOSFI"] = kcosfi;
                                                                drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                drHDonCosfi["MA_CNANG"] = 0;
                                                                dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //La diem do phu quan he cosfi binh quan
                                                        //Bổ sung kiểm tra khoảng ngày của chỉ số hiện tại so với ngày áp dụng CSPK max
                                                        DateTime dtMaxADungCSPK = Convert.ToDateTime(dwCosfi.Table.Compute("MAX(NGAY_ADUNG)", "1=1"));
                                                        if (dtMinNgayDK >= dtMaxADungCSPK) iKhoangCSPK = 2;
                                                        else if (dtMaxNgayCK < dtMaxADungCSPK) iKhoangCSPK = 1;
                                                        else iKhoangCSPK = 0;

                                                        if (rowsQHP.Length > 1)
                                                        {
                                                            //La diem do phu quan he cosfi binh quan cua 2 diem do chinh, khong duoc tinh
                                                            continue;
                                                        }
                                                        else
                                                        {
                                                            //San luong diem do chinh quan he cosfi binh quan
                                                            strMa_DDoTmp = Convert.ToString(rowsQHP[0]["MA_DDO_CHINH"]);
                                                            //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                            if (dsCustomerData.Tables["GCS_CHISO_BQ"].Select("MA_DDO='" + strMa_DDoTmp + "'").Length > 0)
                                                            {
                                                                dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                            }
                                                            else
                                                            {
                                                                //Khong co kiem tra trong GCS_CHISO
                                                                dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));

                                                            }
                                                            foreach (DataRowView drvCosfi in dwCosfi)
                                                            {

                                                                DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                                if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                                {
                                                                    //Có đổi hệ số phạt cosfi
                                                                    IsExistsDoiHSPhat = 1;
                                                                    //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                                    dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                                    break;
                                                                }
                                                            }
                                                            if (IsExistsDoiHSPhat == 1)
                                                            {
                                                                if (iKhoangCSPK == 1)
                                                                {
                                                                    //hc của khoảng trước
                                                                    TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc_T, ref  vc_T, ref  hc, ref  hc, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                    hc_T = 0;
                                                                    vc_T = 0;
                                                                }
                                                                else
                                                                    TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                            }
                                                            else
                                                            {

                                                                hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));

                                                            }

                                                            //San luong cac diem do phu quan he cosfi binh quan
                                                            rowsDDoPhu = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDoTmp + "' AND LOAI_QHE = '32' AND MA_DDO_PHU <> '" + strMa_DDo + "'");
                                                            foreach (DataRow drQH in rowsDDoPhu)
                                                            {
                                                                strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                IsExistsDoiHSPhat = 0;
                                                                //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                                dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                foreach (DataRowView drvCosfi in dwCosfi)
                                                                {

                                                                    DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                                    if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                                    {
                                                                        //Có đổi hệ số phạt cosfi
                                                                        IsExistsDoiHSPhat = 1;
                                                                        //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                                        dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                                        break;
                                                                    }
                                                                }
                                                                //hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                //vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                                if (IsExistsDoiHSPhat == 1)
                                                                {
                                                                    if (iKhoangCSPK == 1)
                                                                    {
                                                                        //hc của khoảng trước
                                                                        TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc_T, ref  vc_T, ref  hc, ref  hc, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                        hc_T = 0;
                                                                        vc_T = 0;
                                                                    }
                                                                    else
                                                                        TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                }
                                                                else
                                                                {
                                                                    hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                    vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                                }
                                                            }
                                                            //Lấy lại ID_CHISO_VC của điểm đo đang xét
                                                            i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                            if (hc == 0)
                                                                if (vc == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRowView drcosfi in dwCosfi)
                                                            {
                                                                if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }

                                                            rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                            if (rowsDDoCosFi.Length != 0)
                                                            {
                                                                rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                                rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                                rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                                rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                            }
                                                            else
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {

                                                                    //Day du lieu vao HDN_HDONCOSFI    
                                                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                    drHDonCosfi["ID_HDON"] = 0;
                                                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                    drHDonCosfi["MA_SOGCS"] = "";
                                                                    drHDonCosfi["NAM"] = dr["NAM"];
                                                                    drHDonCosfi["THANG"] = dr["THANG"];
                                                                    drHDonCosfi["KY"] = dr["KY"];
                                                                    drHDonCosfi["MA_KVUC"] = "";
                                                                    drHDonCosfi["STT"] = "";
                                                                    drHDonCosfi["MA_LO"] = "";
                                                                    drHDonCosfi["MA_TRAM"] = "";
                                                                    drHDonCosfi["MA_TO"] = "";
                                                                    drHDonCosfi["HUU_CONG"] = hc;
                                                                    drHDonCosfi["VO_CONG"] = vc;
                                                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                    drHDonCosfi["COSFI"] = cosfi;
                                                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                                                    drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                    drHDonCosfi["MA_CNANG"] = 0;
                                                                    drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                    }
                                }
                                #endregion
                                #region GCS_CHISO_GT
                                if (dsCustomerData.Tables["GCS_CHISO_GT"] != null && dsCustomerData.Tables["GCS_CHISO_GT"].Rows.Count > 0)
                                {

                                    foreach (DataRow dr in dsCustomerData.Tables["GCS_CHISO_GT"].Rows)
                                    {
                                        if (Convert.ToString(dr["MA_DDO"]) != strMa_DDo)
                                        {
                                            IsExistsDoiHSPhat = 0;
                                            dtMinNgayDK = new DateTime(1900, 1, 1);
                                            dtMaxNgayCK = new DateTime(1900, 1, 1);
                                            dtDoiHSPhatCosfi = new DateTime(1900, 1, 1);
                                            dtNgayDoiCSPK = new DateTime(1900, 1, 1);
                                            hc = 0;
                                            vc = 0;
                                            hc_T = 0;
                                            vc_T = 0;
                                            iKhoangCSPK = 0;
                                            iKymua_CSPK = 0;

                                            IsExistsCS = 0;
                                            strMa_DDo = Convert.ToString(dr["MA_DDO"]);
                                            if (strMa_DDo == "PD01000011084002")
                                            {
                                                strMa_DDo = "PD01000011084002";
                                            }


                                            rowsQHC = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE = '32'");
                                            rowsQHP = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_PHU = '" + strMa_DDo + "' AND LOAI_QHE = '32'");

                                            if (rowsQHC.Length == 0 && rowsQHP.Length == 0)
                                            {
                                                continue;
                                            }
                                            else
                                            {
                                                if (rowsQHC.Length != 0 && rowsQHP.Length != 0)
                                                {
                                                    continue;
                                                }
                                                else
                                                {
                                                    //La diem do thoa man dieu kien tinh cosfi binh quan
                                                    //Dũng NT hiệu chỉnh ngày 06/11/2014 vụ đổi hệ số phạt 
                                                    //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                    dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                                    dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDo + "'"));
                                                    foreach (DataRowView drvCosfi in dwCosfi)
                                                    {

                                                        DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                        if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                        {
                                                            //Có đổi hệ số phạt cosfi
                                                            IsExistsDoiHSPhat = 1;
                                                            //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                            dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                            break;
                                                        }
                                                    }
                                                    //End
                                                    if (IsExistsDoiHSPhat == 1)
                                                    {
                                                        //Có đổi hệ số phạt
                                                        dwDDo_GT.RowFilter = "MA_DDO = '" + strMa_DDo + "'";
                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                        //if (dw.Count == 0)
                                                        if (dwDDo_GT.Count == 0)
                                                        {
                                                            iKymua_CSPK = 0;
                                                        }
                                                        else
                                                        {
                                                            //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                            iKymua_CSPK = Utility.Int16Dbnull(dwDDo_GT[0]["KIMUA_CSPK"]);
                                                            if (dwDDo_GT[0]["NGAY_DOI_CSPK"].ToString().Trim().Length > 0)
                                                                dtNgayDoiCSPK = Convert.ToDateTime(dwDDo_GT[0]["NGAY_DOI_CSPK"]);
                                                        }
                                                        //Kiểm soát điểm đo chính cosfi BQ phải ký mua CSPK
                                                        if (iKymua_CSPK == 0)
                                                            return strMa_DDo + " có quan hệ cosfi bình quân, chưa ký mua CSPK.";
                                                        //Với dữ liệu bảng GCS_CHISO, mặc đinh đã qua kiểm tra chốt CSPK
                                                        //int IsChotCS_CSPK = 1;
                                                        TinhHC_VC(ref i64ID_CHISO_VC_T, ref i64ID_CHISO_VC, ref hc, ref vc, ref hc_T, ref vc_T, dwCS_GT, strMa_DDo, true, dtDoiHSPhatCosfi);
                                                        if (hc != 0 || hc_T != 0 || vc != 0 || vc_T != 0)
                                                            IsExistsCS = 1;
                                                        else
                                                            IsExistsCS = 0;

                                                        if (rowsQHC.Length != 0)
                                                        {
                                                            //La diem do chinh quan he cosfi binh quan
                                                            foreach (DataRow drQH in rowsQHC)
                                                            {
                                                                strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                //Không cần kiểm tra nữa, vì đã kiểm tra trong CheckValidData

                                                                TinhHC_VC(ref i64ID_CHISO_VC_T, ref i64ID_CHISO_VC, ref hc, ref vc, ref hc_T, ref vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                            }
                                                            //Kiểm tra đã có dòng HDN_HDONCOSFI chưa
                                                            i64ID_CHISO_VC_T = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                                            i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                            DataRow[] arrCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                            if (arrCosfi == null || arrCosfi.Length == 0)
                                                            {
                                                                drCosfiCCS = null;
                                                                drCosfiDDK = null;
                                                            }
                                                            else if (arrCosfi.Length == 1)
                                                            {
                                                                //Đã có 1 dòng, day vao theo ID_CHISO
                                                                dwCS_GT.RowFilter = "MA_DDO='" + strMa_DDo + "'";
                                                                if (dwCS_GT != null && dwCS_GT.Count > 0)
                                                                {
                                                                    foreach (DataRowView drvTemp in dwCS_GT)
                                                                    {
                                                                        if (Convert.ToInt64(drvTemp["ID_CHISO"]) == Convert.ToInt64(arrCosfi[0]["ID_CHISO"]))
                                                                        {
                                                                            if (drvTemp["LOAI_CHISO"].ToString().Trim() != "DDK")
                                                                            {
                                                                                drCosfiCCS = arrCosfi[0];
                                                                                drCosfiDDK = null;
                                                                            }
                                                                            else
                                                                            {
                                                                                drCosfiCCS = null;
                                                                                drCosfiDDK = arrCosfi[0];
                                                                            }
                                                                            break;
                                                                        }
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    drCosfiCCS = null;
                                                                    drCosfiDDK = arrCosfi[0];
                                                                }
                                                            }
                                                            else
                                                            {
                                                                //Có 2 dòng HDN_HDONCOSFI
                                                                drCosfiCCS = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Min(b => b.Field<Int64>("ID_CHISO"))).First();
                                                                drCosfiDDK = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Max(b => b.Field<Int64>("ID_CHISO"))).First();
                                                            }


                                                            #region Trước dổi hệ số phạt
                                                            if (hc_T == 0)
                                                                if (vc_T == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc_T / Math.Sqrt(Convert.ToDouble(hc_T * hc_T + vc_T * vc_T))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRowView drcosfi in dwCosfi)
                                                            {
                                                                if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtDoiHSPhatCosfi) continue;
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }
                                                            if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                                            {
                                                                cosfi = 1;
                                                                kcosfi = 0;
                                                            }
                                                            if (hc_T != 0 || vc_T != 0)
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {
                                                                    if (drCosfiCCS == null)
                                                                    {
                                                                        //Day du lieu vao HDN_HDONCOSFI    
                                                                        drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                        drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                        drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                        drHDonCosfi["ID_HDON"] = 0;
                                                                        drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                        drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                        drHDonCosfi["NAM"] = dr["NAM"];
                                                                        drHDonCosfi["THANG"] = dr["THANG"];
                                                                        drHDonCosfi["KY"] = dr["KY"];

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                        dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwDDo_SoGCS.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_SOGCS"] = "";
                                                                            drHDonCosfi["MA_KVUC"] = "";
                                                                            drHDonCosfi["STT"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                            //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                            //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                            drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                            drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                            drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                        }

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                        dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwVTri_DDo.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_LO"] = "";
                                                                            drHDonCosfi["MA_TRAM"] = "";
                                                                            drHDonCosfi["MA_TO"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                            //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                            //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                            drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                            drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                            drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                        }

                                                                        drHDonCosfi["HUU_CONG"] = hc_T;
                                                                        drHDonCosfi["VO_CONG"] = vc_T;
                                                                        drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                        drHDonCosfi["COSFI"] = cosfi;
                                                                        drHDonCosfi["KCOSFI"] = kcosfi;
                                                                        drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                        dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        //if (dwDDo.Count == 0)
                                                                        //{
                                                                        //    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                        //}
                                                                        //else
                                                                        //{
                                                                        //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                        drHDonCosfi["KIMUA_CSPK"] = iKymua_CSPK.ToString();//Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                        //}

                                                                        drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                        drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                        //if (hc_1358 != 0)
                                                                        //{
                                                                        //    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                                                        //    drHDonCosfi["MA_CNANG"] = 1;
                                                                        //}
                                                                        //else
                                                                        //{
                                                                        //Mac dinh la = 0
                                                                        drHDonCosfi["MA_CNANG"] = 0;
                                                                        drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC_T;
                                                                        //}
                                                                        dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                    }
                                                                    else
                                                                    {
                                                                        drCosfiCCS["HUU_CONG"] = hc_T;
                                                                        drCosfiCCS["VO_CONG"] = vc_T;
                                                                        drCosfiCCS["COSFI"] = cosfi;
                                                                        drCosfiCCS["KCOSFI"] = kcosfi;
                                                                    }
                                                                }
                                                            }
                                                            #endregion

                                                            #region Sau đổi hệ số phạt
                                                            if (hc == 0)
                                                                if (vc == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRowView drcosfi in dwCosfi)
                                                            {
                                                                if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }
                                                            if (hc != 0 || vc != 0)
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {
                                                                    if (drCosfiDDK == null)
                                                                    {
                                                                        //Day du lieu vao HDN_HDONCOSFI    
                                                                        drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                        drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                        drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                        drHDonCosfi["ID_HDON"] = 0;
                                                                        drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                        drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                        drHDonCosfi["NAM"] = dr["NAM"];
                                                                        drHDonCosfi["THANG"] = dr["THANG"];
                                                                        drHDonCosfi["KY"] = dr["KY"];

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                        dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwDDo_SoGCS.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_SOGCS"] = "";
                                                                            drHDonCosfi["MA_KVUC"] = "";
                                                                            drHDonCosfi["STT"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                            //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                            //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                            drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                            drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                            drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                        }

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                        dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwVTri_DDo.Count == 0)
                                                                        {
                                                                            drHDonCosfi["MA_LO"] = "";
                                                                            drHDonCosfi["MA_TRAM"] = "";
                                                                            drHDonCosfi["MA_TO"] = "";
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                            //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                            //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                            drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                            drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                            drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                        }

                                                                        drHDonCosfi["HUU_CONG"] = hc;
                                                                        drHDonCosfi["VO_CONG"] = vc;
                                                                        drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                        drHDonCosfi["COSFI"] = cosfi;
                                                                        drHDonCosfi["KCOSFI"] = kcosfi;
                                                                        drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                        //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                        dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                        //dw.Sort = "NGAY_HLUC DESC";
                                                                        //if (dw.Count == 0)
                                                                        if (dwDDo.Count == 0)
                                                                        {
                                                                            drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                        }
                                                                        else
                                                                        {
                                                                            //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                            drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                        }

                                                                        drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                        drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;

                                                                        //Mac dinh la = 0
                                                                        drHDonCosfi["MA_CNANG"] = 0;

                                                                        drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                                                        dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                    }
                                                                    else
                                                                    {
                                                                        drCosfiDDK["HUU_CONG"] = hc;
                                                                        drCosfiDDK["VO_CONG"] = vc;
                                                                        drCosfiDDK["COSFI"] = cosfi;
                                                                        drCosfiDDK["KCOSFI"] = kcosfi;
                                                                    }
                                                                }
                                                            }

                                                            #endregion
                                                        }
                                                        else
                                                        {
                                                            //La diem do phu quan he cosfi binh quan
                                                            if (rowsQHP.Length > 1)
                                                            {
                                                                //La diem do phu quan he cosfi binh quan cua 2 diem do chinh, khong duoc tinh
                                                                continue;
                                                            }
                                                            else
                                                            {
                                                                //San luong diem do chinh quan he cosfi binh quan
                                                                //Lấy sản lượng điểm đo chính của điểm đo phụ quen hệ GT phải lấy trong bảng GCS_CHISO
                                                                strMa_DDoTmp = Convert.ToString(rowsQHP[0]["MA_DDO_CHINH"]);

                                                                TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS, strMa_DDoTmp, false, dtDoiHSPhatCosfi);


                                                                //San luong cac diem do phu quan he cosfi binh quan
                                                                rowsDDoPhu = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDoTmp + "' AND LOAI_QHE = '32' AND MA_DDO_PHU <> '" + strMa_DDo + "'");
                                                                foreach (DataRow drQH in rowsDDoPhu)
                                                                {
                                                                    strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                    TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);

                                                                }
                                                                i64ID_CHISO_VC_T = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MIN(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));
                                                                i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                                DataRow[] arrCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                                if (arrCosfi == null || arrCosfi.Length == 0)
                                                                {
                                                                    drCosfiCCS = null;
                                                                    drCosfiDDK = null;
                                                                }
                                                                else if (arrCosfi.Length == 1)
                                                                {
                                                                    //Đã có 1 dòng, day vao theo ID_CHISO
                                                                    dwCS_GT.RowFilter = "MA_DDO='" + strMa_DDo + "'";
                                                                    if (dwCS_GT != null && dwCS_GT.Count > 0)
                                                                    {
                                                                        foreach (DataRowView drvTemp in dwCS_GT)
                                                                        {
                                                                            if (Convert.ToInt64(drvTemp["ID_CHISO"]) == Convert.ToInt64(arrCosfi[0]["ID_CHISO"]))
                                                                            {
                                                                                if (drvTemp["LOAI_CHISO"].ToString().Trim() != "DDK")
                                                                                {
                                                                                    drCosfiCCS = arrCosfi[0];
                                                                                    drCosfiDDK = null;
                                                                                }
                                                                                else
                                                                                {
                                                                                    drCosfiCCS = null;
                                                                                    drCosfiDDK = arrCosfi[0];
                                                                                }
                                                                                break;
                                                                            }
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        drCosfiCCS = null;
                                                                        drCosfiDDK = arrCosfi[0];
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    //Có 2 dòng HDN_HDONCOSFI
                                                                    drCosfiCCS = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Min(b => b.Field<Int64>("ID_CHISO"))).First();
                                                                    drCosfiDDK = arrCosfi.Where(c => c.Field<Int64>("ID_CHISO") == arrCosfi.Max(b => b.Field<Int64>("ID_CHISO"))).First();
                                                                }

                                                                #region Trước dổi hệ số phạt
                                                                if (hc_T == 0)
                                                                    if (vc_T == 0)
                                                                        cosfi = 1;
                                                                    else
                                                                        cosfi = 0;
                                                                else
                                                                {
                                                                    cosfi = Math.Round(Convert.ToDecimal(hc_T / Math.Sqrt(Convert.ToDouble(hc_T * hc_T + vc_T * vc_T))), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                                min = 1000;
                                                                kcosfi = 0;
                                                                foreach (DataRowView drcosfi in dwCosfi)
                                                                {
                                                                    if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtDoiHSPhatCosfi) continue;
                                                                    if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                    {
                                                                        if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                        {
                                                                            min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                            kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                        }
                                                                    }
                                                                }
                                                                if (iKymua_CSPK == Convert.ToInt16(1) && dtNgayDoiCSPK > dtDoiHSPhatCosfi)
                                                                {
                                                                    cosfi = 1;
                                                                    kcosfi = 0;
                                                                }
                                                                if (hc_T != 0 || vc_T != 0)
                                                                {
                                                                    if (IsExistsCS == 1)
                                                                    {
                                                                        if (drCosfiCCS == null)
                                                                        {
                                                                            //Day du lieu vao HDN_HDONCOSFI    
                                                                            drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                            drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                            drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                            drHDonCosfi["ID_HDON"] = 0;
                                                                            drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                            drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                            drHDonCosfi["NAM"] = dr["NAM"];
                                                                            drHDonCosfi["THANG"] = dr["THANG"];
                                                                            drHDonCosfi["KY"] = dr["KY"];

                                                                            //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                            dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                                            //if (dw.Count == 0)
                                                                            if (dwDDo_SoGCS.Count == 0)
                                                                            {
                                                                                drHDonCosfi["MA_SOGCS"] = "";
                                                                                drHDonCosfi["MA_KVUC"] = "";
                                                                                drHDonCosfi["STT"] = "";
                                                                            }
                                                                            else
                                                                            {
                                                                                //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                                //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                                //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                                drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                                drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                                drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                            }

                                                                            //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                            dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                                            //if (dw.Count == 0)
                                                                            if (dwVTri_DDo.Count == 0)
                                                                            {
                                                                                drHDonCosfi["MA_LO"] = "";
                                                                                drHDonCosfi["MA_TRAM"] = "";
                                                                                drHDonCosfi["MA_TO"] = "";
                                                                            }
                                                                            else
                                                                            {
                                                                                //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                                //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                                //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                                drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                                drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                                drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                            }

                                                                            drHDonCosfi["HUU_CONG"] = hc_T;
                                                                            drHDonCosfi["VO_CONG"] = vc_T;
                                                                            drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                            drHDonCosfi["COSFI"] = cosfi;
                                                                            drHDonCosfi["KCOSFI"] = kcosfi;
                                                                            drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                            //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                            dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                                            //if (dw.Count == 0)
                                                                            //if (dwDDo.Count == 0)
                                                                            //{
                                                                            //    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                            //}
                                                                            //else
                                                                            //{
                                                                            //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                            drHDonCosfi["KIMUA_CSPK"] = iKymua_CSPK.ToString();//Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                            //}

                                                                            drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                            drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                            drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                            drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                            //if (hc_1358 != 0)
                                                                            //{
                                                                            //    //Treo thao doi loai cong to tu 1 -> 3,5,8 va nguoc lai
                                                                            //    drHDonCosfi["MA_CNANG"] = 1;
                                                                            //}
                                                                            //else
                                                                            //{
                                                                            //Mac dinh la = 0
                                                                            drHDonCosfi["MA_CNANG"] = 0;
                                                                            drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC_T;
                                                                            //}
                                                                            dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                        }
                                                                        else
                                                                        {
                                                                            drCosfiCCS["HUU_CONG"] = hc_T;
                                                                            drCosfiCCS["VO_CONG"] = vc_T;
                                                                            drCosfiCCS["COSFI"] = cosfi;
                                                                            drCosfiCCS["KCOSFI"] = kcosfi;
                                                                        }
                                                                    }
                                                                }
                                                                #endregion

                                                                #region Sau đổi hệ số phạt
                                                                if (hc == 0)
                                                                    if (vc == 0)
                                                                        cosfi = 1;
                                                                    else
                                                                        cosfi = 0;
                                                                else
                                                                {
                                                                    cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                                min = 1000;
                                                                kcosfi = 0;
                                                                foreach (DataRowView drcosfi in dwCosfi)
                                                                {
                                                                    if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                                    if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                    {
                                                                        if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                        {
                                                                            min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                            kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                        }
                                                                    }
                                                                }
                                                                if (hc != 0 || vc != 0)
                                                                {
                                                                    if (IsExistsCS == 1)
                                                                    {
                                                                        if (drCosfiDDK == null)
                                                                        {
                                                                            //Day du lieu vao HDN_HDONCOSFI    
                                                                            drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                            drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                            drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                            drHDonCosfi["ID_HDON"] = 0;
                                                                            drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                            drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                            drHDonCosfi["NAM"] = dr["NAM"];
                                                                            drHDonCosfi["THANG"] = dr["THANG"];
                                                                            drHDonCosfi["KY"] = dr["KY"];

                                                                            //dw = new DataView(dsCustomerData.Tables["HDG_DDO_SOGCS"]);
                                                                            dwDDo_SoGCS.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                                            //if (dw.Count == 0)
                                                                            if (dwDDo_SoGCS.Count == 0)
                                                                            {
                                                                                drHDonCosfi["MA_SOGCS"] = "";
                                                                                drHDonCosfi["MA_KVUC"] = "";
                                                                                drHDonCosfi["STT"] = "";
                                                                            }
                                                                            else
                                                                            {
                                                                                //drHDonCosfi["MA_SOGCS"] = Convert.ToString(dw[0]["MA_SOGCS"]);
                                                                                //drHDonCosfi["MA_KVUC"] = Convert.ToString(dw[0]["MA_KVUC"]);
                                                                                //drHDonCosfi["STT"] = Convert.ToString(dw[0]["STT"]);
                                                                                drHDonCosfi["MA_SOGCS"] = Convert.ToString(dwDDo_SoGCS[0]["MA_SOGCS"]);
                                                                                drHDonCosfi["MA_KVUC"] = Convert.ToString(dwDDo_SoGCS[0]["MA_KVUC"]);
                                                                                drHDonCosfi["STT"] = Convert.ToString(dwDDo_SoGCS[0]["STT"]);
                                                                            }

                                                                            //dw = new DataView(dsCustomerData.Tables["HDG_VITRI_DDO"]);
                                                                            dwVTri_DDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                                            //if (dw.Count == 0)
                                                                            if (dwVTri_DDo.Count == 0)
                                                                            {
                                                                                drHDonCosfi["MA_LO"] = "";
                                                                                drHDonCosfi["MA_TRAM"] = "";
                                                                                drHDonCosfi["MA_TO"] = "";
                                                                            }
                                                                            else
                                                                            {
                                                                                //drHDonCosfi["MA_LO"] = Convert.ToString(dw[0]["MA_LO"]);
                                                                                //drHDonCosfi["MA_TRAM"] = Convert.ToString(dw[0]["MA_TRAM"]);
                                                                                //drHDonCosfi["MA_TO"] = Convert.ToString(dw[0]["MA_TO"]);
                                                                                drHDonCosfi["MA_LO"] = Convert.ToString(dwVTri_DDo[0]["MA_LO"]);
                                                                                drHDonCosfi["MA_TRAM"] = Convert.ToString(dwVTri_DDo[0]["MA_TRAM"]);
                                                                                drHDonCosfi["MA_TO"] = Convert.ToString(dwVTri_DDo[0]["MA_TO"]);
                                                                            }

                                                                            drHDonCosfi["HUU_CONG"] = hc;
                                                                            drHDonCosfi["VO_CONG"] = vc;
                                                                            drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                            drHDonCosfi["COSFI"] = cosfi;
                                                                            drHDonCosfi["KCOSFI"] = kcosfi;
                                                                            drHDonCosfi["TIEN_VOCONG"] = 0;

                                                                            //dw = new DataView(dsCustomerData.Tables["HDG_DIEM_DO"]);
                                                                            dwDDo.RowFilter = "MA_DDO = '" + Convert.ToString(dr["MA_DDO"]) + "'";
                                                                            //dw.Sort = "NGAY_HLUC DESC";
                                                                            //if (dw.Count == 0)
                                                                            if (dwDDo.Count == 0)
                                                                            {
                                                                                drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                            }
                                                                            else
                                                                            {
                                                                                //drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dw[0]["KIMUA_CSPK"]);
                                                                                drHDonCosfi["KIMUA_CSPK"] = Convert.ToString(dwDDo[0]["KIMUA_CSPK"]);
                                                                            }

                                                                            drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                            drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                            drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                            drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;

                                                                            //Mac dinh la = 0
                                                                            drHDonCosfi["MA_CNANG"] = 0;

                                                                            drHDonCosfi["ID_CHISO"] = i64ID_CHISO_VC;
                                                                            dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                        }
                                                                        else
                                                                        {
                                                                            drCosfiDDK["HUU_CONG"] = hc;
                                                                            drCosfiDDK["VO_CONG"] = vc;
                                                                            drCosfiDDK["COSFI"] = cosfi;
                                                                            drCosfiDDK["KCOSFI"] = kcosfi;
                                                                        }
                                                                    }
                                                                }

                                                                #endregion
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        //Tính như cũ
                                                        hc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                        vc = Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'")));
                                                        //Bổ sung kiểm tra khoảng ngày của chỉ số hiện tại so với ngày áp dụng CSPK max
                                                        DateTime dtMaxADungCSPK = Convert.ToDateTime(dwCosfi.Table.Compute("MAX(NGAY_ADUNG)", "1=1"));
                                                        if (dtMinNgayDK >= dtMaxADungCSPK) iKhoangCSPK = 2;
                                                        else if (dtMaxNgayCK < dtMaxADungCSPK) iKhoangCSPK = 1;
                                                        else iKhoangCSPK = 0;
                                                        //Kiem tra quan he 10, 11 va bu san luong tru phu cua cac diem do phu 10, 11
                                                        if (dsCustomerData.Tables.Contains("HDG_QHE_DDO") == true && dsCustomerData.Tables.Contains("GCS_CHISO_TP") == true)
                                                        {
                                                            DataView dwTP = new DataView(dsCustomerData.Tables["HDG_QHE_DDO"]);
                                                            dwTP.RowFilter = "MA_DDO_CHINH = '" + strMa_DDo + "' AND LOAI_QHE IN ('10','11')";
                                                            double hc_tp = 0;
                                                            foreach (DataRowView drTP in dwTP)
                                                            {
                                                                string strMa_DDoP = Convert.ToString(drTP["MA_DDO_PHU"]);

                                                                //Xu ly doi voi SHBB va SXD1
                                                                IsExistsSHBB = 0;
                                                                IsExistsSXD1 = 0;
                                                                //Kiem tra diem do chinh la SHBB, diem do phu la SXD1
                                                                if (IsExistsParam == 1)
                                                                {
                                                                    if (dsCustomerData.Tables.Contains("HDG_BBAN_APGIA") == true)
                                                                    {
                                                                        drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDo + "' AND MA_NHOMNN = 'SHBB'");
                                                                        if (drDDo.Length > 0)
                                                                        {
                                                                            IsExistsSHBB = 1;
                                                                        }
                                                                        else
                                                                        {
                                                                            IsExistsSHBB = 0;
                                                                        }

                                                                        drDDo = dsCustomerData.Tables["HDG_BBAN_APGIA"].Select("MA_DDO = '" + strMa_DDoP + "' AND MA_NHOMNN = 'SXD1'");
                                                                        if (drDDo.Length > 0)
                                                                        {
                                                                            IsExistsSXD1 = 1;
                                                                        }
                                                                        else
                                                                        {
                                                                            IsExistsSXD1 = 0;
                                                                        }

                                                                        if (IsExistsSHBB == 1 && IsExistsSXD1 == 1)
                                                                        {
                                                                            heso_truphu = Convert.ToDecimal(1.1);
                                                                        }
                                                                        else
                                                                        {
                                                                            heso_truphu = Convert.ToDecimal(1.0);
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        heso_truphu = Convert.ToDecimal(1.0);
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    heso_truphu = Convert.ToDecimal(1.0);
                                                                }

                                                                hc_tp = hc_tp + Convert.ToDouble(Math.Round(heso_truphu * (Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')")) + Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_TP"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoP + "' AND BCS IN ('BT','CD','TD','KT')"))), 0, MidpointRounding.AwayFromZero));
                                                            }
                                                            hc = hc + hc_tp;
                                                        }
                                                        //Co ton tai chi so co san luong <> 0 hay khong
                                                        if (hc != 0 || vc != 0)
                                                        {
                                                            IsExistsCS = 1;
                                                        }
                                                        else
                                                        {
                                                            IsExistsCS = 0;
                                                        }

                                                        if (rowsQHC.Length != 0)
                                                        {
                                                            //La diem do chinh quan he cosfi binh quan
                                                            foreach (DataRow drQH in rowsQHC)
                                                            {
                                                                strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                                dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                foreach (DataRowView drvCosfi in dwCosfi)
                                                                {

                                                                    DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                                    if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                                    {
                                                                        //Có đổi hệ số phạt cosfi
                                                                        IsExistsDoiHSPhat = 1;
                                                                        //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                                        dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                                        break;
                                                                    }
                                                                }
                                                                if (IsExistsDoiHSPhat == 1)
                                                                {
                                                                    TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                }
                                                                //Lấy lại ID_CHISO_VC của điểm đo chính
                                                                else
                                                                {
                                                                    hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                    vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                                }
                                                                i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                            }

                                                            if (hc == 0)
                                                                if (vc == 0)
                                                                    cosfi = 1;
                                                                else
                                                                    cosfi = 0;
                                                            else
                                                            {
                                                                cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                            }

                                                            min = 1000;
                                                            kcosfi = 0;
                                                            foreach (DataRowView drcosfi in dwCosfi)
                                                            {
                                                                if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                                if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                {
                                                                    if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                    {
                                                                        min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                        kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                    }
                                                                }
                                                            }

                                                            rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                            if (rowsDDoCosFi.Length != 0)
                                                            {
                                                                rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                                rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                                rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                                rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                            }
                                                            else
                                                            {
                                                                if (IsExistsCS == 1)
                                                                {
                                                                    //Day du lieu vao HDN_HDONCOSFI    
                                                                    string strMaSoGCS = "";
                                                                    var arrMaSoGCS = dsCustomerData.Tables["HDG_DDO_SOGCS"].AsEnumerable().Where(c => c.Field<string>("MA_DDO") == dr["MA_DDO"].ToString().Trim());
                                                                    if (arrMaSoGCS != null && arrMaSoGCS.Count() > 0)
                                                                        strMaSoGCS = arrMaSoGCS.First()["MA_SOGCS"].ToString();
                                                                    else strMaSoGCS = " ";
                                                                    drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                    drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                    drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                    drHDonCosfi["ID_HDON"] = 0;
                                                                    drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                    drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                    drHDonCosfi["MA_SOGCS"] = "";
                                                                    drHDonCosfi["NAM"] = dr["NAM"];
                                                                    drHDonCosfi["THANG"] = dr["THANG"];
                                                                    drHDonCosfi["KY"] = dr["KY"];
                                                                    drHDonCosfi["MA_KVUC"] = "";
                                                                    drHDonCosfi["STT"] = "";
                                                                    drHDonCosfi["MA_LO"] = "";
                                                                    drHDonCosfi["MA_TRAM"] = "";
                                                                    drHDonCosfi["MA_TO"] = "";
                                                                    drHDonCosfi["HUU_CONG"] = hc;
                                                                    drHDonCosfi["VO_CONG"] = vc;
                                                                    drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                    drHDonCosfi["COSFI"] = cosfi;
                                                                    drHDonCosfi["KCOSFI"] = kcosfi;
                                                                    drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                    drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                    drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                    drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                    drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                    drHDonCosfi["MA_CNANG"] = 0;
                                                                    dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            //La diem do phu quan he cosfi binh quan
                                                            if (rowsQHP.Length > 1)
                                                            {
                                                                //La diem do phu quan he cosfi binh quan cua 2 diem do chinh, khong duoc tinh
                                                                continue;
                                                            }
                                                            else
                                                            {
                                                                //San luong diem do chinh quan he cosfi binh quan
                                                                //Phai lay trong GCS_CHISO vi day la diem do phu cua QHGT -> SL ddo chinh nam trong GCS_CHISO
                                                                strMa_DDoTmp = Convert.ToString(rowsQHP[0]["MA_DDO_CHINH"]);
                                                                //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                                //điểm đo chính của phụ ghép tổng luôn năm trong GCS_CHISO
                                                                dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                foreach (DataRowView drvCosfi in dwCosfi)
                                                                {

                                                                    DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                                    if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                                    {
                                                                        //Có đổi hệ số phạt cosfi
                                                                        IsExistsDoiHSPhat = 1;
                                                                        //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                                        dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                                        break;
                                                                    }
                                                                }
                                                                if (IsExistsDoiHSPhat == 1)
                                                                {
                                                                    if (iKhoangCSPK == 1)
                                                                    {
                                                                        //hc của khoảng trước
                                                                        TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc_T, ref  vc_T, ref  hc, ref  vc, dwCS, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                        hc_T = 0;
                                                                        vc_T = 0;
                                                                    }
                                                                    else
                                                                        TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                }
                                                                else
                                                                {
                                                                    hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                    vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                                }
                                                                //San luong cac diem do phu quan he cosfi binh quan
                                                                rowsDDoPhu = dsCustomerData.Tables["HDG_QHE_DDO"].Select("MA_DDO_CHINH = '" + strMa_DDoTmp + "' AND LOAI_QHE = '32' AND MA_DDO_PHU <> '" + strMa_DDo + "'");
                                                                foreach (DataRow drQH in rowsDDoPhu)
                                                                {
                                                                    strMa_DDoTmp = Convert.ToString(drQH["MA_DDO_PHU"]);
                                                                    IsExistsDoiHSPhat = 0;
                                                                    //Kiểm tra khoảng ngày có vắt qua đổi hệ số phạt cosfi không
                                                                    dtMinNgayDK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MIN(NGAY_DKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                    dtMaxNgayCK = Convert.ToDateTime(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("MAX(NGAY_CKY)", "MA_DDO = '" + strMa_DDoTmp + "'"));
                                                                    foreach (DataRowView drvCosfi in dwCosfi)
                                                                    {

                                                                        DateTime dtTemp = Convert.ToDateTime(drvCosfi["NGAY_ADUNG"]);
                                                                        if (dtMinNgayDK < dtTemp && dtMaxNgayCK >= dtTemp)
                                                                        {
                                                                            //Có đổi hệ số phạt cosfi
                                                                            IsExistsDoiHSPhat = 1;
                                                                            //Ngày đổi hệ số phạt = ngày áp dụng mới - 1
                                                                            dtDoiHSPhatCosfi = dtTemp.AddDays(-1);
                                                                            break;
                                                                        }
                                                                    }
                                                                    if (IsExistsDoiHSPhat == 1)
                                                                    {
                                                                        if (iKhoangCSPK == 1)
                                                                        {
                                                                            //hc của khoảng trước
                                                                            TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc_T, ref  vc_T, ref  hc, ref  vc, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                            hc_T = 0;
                                                                            vc_T = 0;
                                                                        }
                                                                        else
                                                                            TinhHC_VC(ref  i64ID_CHISO_VC_T, ref  i64ID_CHISO_VC, ref  hc, ref  vc, ref  hc_T, ref  vc_T, dwCS_BQ, strMa_DDoTmp, false, dtDoiHSPhatCosfi);
                                                                    }
                                                                    else
                                                                    {
                                                                        hc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS IN ('BT','CD','TD','KT')")));
                                                                        vc += Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SAN_LUONG)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) + Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TTIEP)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'"))) - Convert.ToDouble(Utility.DecimalDbnull(dsCustomerData.Tables["GCS_CHISO_BQ"].Compute("SUM(SLUONG_TRPHU)", "MA_DDO = '" + strMa_DDoTmp + "' AND BCS = 'VC'")));
                                                                    }
                                                                }
                                                                //Tính lại ID_CHISO_VC theo điểm đo đang xét
                                                                i64ID_CHISO_VC = Convert.ToInt64(dsCustomerData.Tables["GCS_CHISO_GT"].Compute("MAX(ID_CHISO)", "MA_DDO = '" + strMa_DDo + "' AND BCS = 'VC'"));

                                                                if (hc == 0)
                                                                    if (vc == 0)
                                                                        cosfi = 1;
                                                                    else
                                                                        cosfi = 0;
                                                                else
                                                                {
                                                                    cosfi = Math.Round(Convert.ToDecimal(hc / Math.Sqrt(Convert.ToDouble(hc * hc + vc * vc))), 2, MidpointRounding.AwayFromZero);
                                                                }

                                                                min = 1000;
                                                                kcosfi = 0;
                                                                foreach (DataRowView drcosfi in dwCosfi)
                                                                {
                                                                    if (Convert.ToDateTime(drcosfi["NGAY_ADUNG"]) > dtMaxNgayCK) continue;
                                                                    if (cosfi <= Convert.ToDecimal(drcosfi["HS_COSFI"]))
                                                                    {
                                                                        if (Convert.ToDecimal(drcosfi["HS_COSFI"]) < min)
                                                                        {
                                                                            min = Convert.ToDecimal(drcosfi["HS_COSFI"]);
                                                                            kcosfi = Convert.ToDecimal(drcosfi["KCOSFI"]);
                                                                        }
                                                                    }
                                                                }

                                                                rowsDDoCosFi = dsInvoiceData.Tables["HDN_HDONCOSFI"].Select("MA_DDO = '" + strMa_DDo + "'");
                                                                if (rowsDDoCosFi.Length != 0)
                                                                {
                                                                    rowsDDoCosFi[0]["HUU_CONG"] = hc;
                                                                    rowsDDoCosFi[0]["VO_CONG"] = vc;
                                                                    rowsDDoCosFi[0]["COSFI"] = cosfi;
                                                                    rowsDDoCosFi[0]["KCOSFI"] = kcosfi;
                                                                }
                                                                else
                                                                {
                                                                    if (IsExistsCS == 1)
                                                                    {
                                                                        //Day du lieu vao HDN_HDONCOSFI    
                                                                        drHDonCosfi = dsInvoiceData.Tables["HDN_HDONCOSFI"].NewRow();
                                                                        drHDonCosfi["MA_DVIQLY"] = dr["MA_DVIQLY"];
                                                                        drHDonCosfi["ID_HDONCOSFI"] = 0;
                                                                        drHDonCosfi["ID_HDON"] = 0;
                                                                        drHDonCosfi["MA_KHANG"] = dr["MA_KHANG"];
                                                                        drHDonCosfi["MA_DDO"] = dr["MA_DDO"];
                                                                        drHDonCosfi["MA_SOGCS"] = "";
                                                                        drHDonCosfi["NAM"] = dr["NAM"];
                                                                        drHDonCosfi["THANG"] = dr["THANG"];
                                                                        drHDonCosfi["KY"] = dr["KY"];
                                                                        drHDonCosfi["MA_KVUC"] = "";
                                                                        drHDonCosfi["STT"] = "";
                                                                        drHDonCosfi["MA_LO"] = "";
                                                                        drHDonCosfi["MA_TRAM"] = "";
                                                                        drHDonCosfi["MA_TO"] = "";
                                                                        drHDonCosfi["HUU_CONG"] = hc;
                                                                        drHDonCosfi["VO_CONG"] = vc;
                                                                        drHDonCosfi["TIEN_HUUCONG"] = 0;
                                                                        drHDonCosfi["COSFI"] = cosfi;
                                                                        drHDonCosfi["KCOSFI"] = kcosfi;
                                                                        drHDonCosfi["TIEN_VOCONG"] = 0;
                                                                        drHDonCosfi["KIMUA_CSPK"] = 0;
                                                                        drHDonCosfi["NGAY_TAO"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_TAO"] = strTen_DNhap;
                                                                        drHDonCosfi["NGAY_SUA"] = System.DateTime.Now;
                                                                        drHDonCosfi["NGUOI_SUA"] = strTen_DNhap;
                                                                        drHDonCosfi["MA_CNANG"] = 0;
                                                                        dsInvoiceData.Tables["HDN_HDONCOSFI"].Rows.Add(drHDonCosfi);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                #endregion
                            }
                return "";
            }
            catch (Exception ex)
            {
                return "RawDataCalculation_7: " + ex.Message;
            }
            //finally
            //{
            //    dsInvoiceData.AcceptChanges();
            //    dsCustomerData.AcceptChanges();
            //}
        }
        protected void TinhHC_VC(ref long i64ID_CHISO_VC_T, ref long i64ID_CHISO_VC, ref double hc, ref double vc, ref double hc_T, ref double vc_T, DataView dwCS, string strMa_DDo_Temp, bool isReset, DateTime dtDoiHSPhatCosfi)
        {
            dwCS.RowFilter = "MA_DDO ='" + strMa_DDo_Temp + "'";
            foreach (DataRowView drvCS in dwCS)
            {
                if ("BT;CD;TD".Contains(drvCS["BCS"].ToString().Trim()))
                {
                    if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                    {
                        //HC trước đổi HS phạt
                        hc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                    }
                    else
                    {
                        //HC sau đổi HS phạt
                        hc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                    }
                }
                else if (drvCS["BCS"].ToString().Trim() == "VC")
                {
                    if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                    {
                        if (Convert.ToDateTime(drvCS["NGAY_CKY"]) == dtDoiHSPhatCosfi)
                            i64ID_CHISO_VC_T = isReset ? Convert.ToInt64(drvCS["ID_CHISO"]) : i64ID_CHISO_VC_T;
                        //VC trước đổi HS phạt
                        vc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU"]);
                    }
                    else
                    {
                        if (i64ID_CHISO_VC < Convert.ToInt64(drvCS["ID_CHISO"]))
                            i64ID_CHISO_VC = isReset ? Convert.ToInt64(drvCS["ID_CHISO"]) : i64ID_CHISO_VC;
                        //VC sau đổi HS phạt
                        vc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU"]);
                    }
                }
                else if (drvCS["BCS"].ToString().Trim() == "KT")
                {
                    //Nếu là KT
                    //Kiểm tra có VC cùng ngày đầu kỳ không
                    Int16 IsExistsVC = 0;
                    foreach (DataRowView drvCS_VC in dwCS)
                    {
                        if (drvCS_VC["BCS"].ToString().Trim() == "VC" && Convert.ToDateTime(drvCS_VC["NGAY_DKY"]) == Convert.ToDateTime(drvCS["NGAY_DKY"]))
                        {
                            IsExistsVC = 1;
                            break;
                        }
                    }
                    if (IsExistsVC == 1)
                    {
                        if (Convert.ToDateTime(drvCS["NGAY_CKY"]) <= dtDoiHSPhatCosfi)
                        {
                            //HC trước đổi HS phạt
                            hc_T += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                        }
                        else
                        {
                            //HC sau đổi HS phạt
                            hc += Convert.ToDouble(drvCS["SAN_LUONG"]) + Convert.ToDouble(drvCS["SLUONG_TTIEP"]) - Convert.ToDouble(drvCS["SLUONG_TRPHU_COSFI"]);
                        }
                    }
                }
            }
        }



    }
}
